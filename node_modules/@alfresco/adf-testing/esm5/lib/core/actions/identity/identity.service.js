/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { UserModel } from '../../models/user.model';
var IdentityService = /** @class */ (function () {
    function IdentityService(api) {
        this.api = api;
    }
    /**
     * @param {?=} user
     * @return {?}
     */
    IdentityService.prototype.createIdentityUser = /**
     * @param {?=} user
     * @return {?}
     */
    function (user) {
        if (user === void 0) { user = new UserModel(); }
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var userIdentity;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.createUser(user)];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.getUserInfoByUsername(user.username)];
                    case 2:
                        userIdentity = _a.sent();
                        return [4 /*yield*/, this.resetPassword(userIdentity.id, user.password)];
                    case 3:
                        _a.sent();
                        user.idIdentityService = userIdentity.id;
                        return [2 /*return*/, user];
                }
            });
        });
    };
    /**
     * @param {?} user
     * @return {?}
     */
    IdentityService.prototype.createIdentityUserAndSyncECMBPM = /**
     * @param {?} user
     * @return {?}
     */
    function (user) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var createUser;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!(this.api.config.provider === 'ECM' || this.api.config.provider === 'ALL')) return [3 /*break*/, 2];
                        createUser = (/** @type {?} */ ({
                            firstName: user.firstName,
                            lastName: user.lastName,
                            password: user.password,
                            email: user.email,
                            id: user.email
                        }));
                        return [4 /*yield*/, this.api.apiService.core.peopleApi.addPerson(createUser)];
                    case 1:
                        _a.sent();
                        _a.label = 2;
                    case 2:
                        if (!(this.api.config.provider === 'BPM' || this.api.config.provider === 'ALL')) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.api.apiService.activiti.adminUsersApi.createNewUser({
                                email: user.email,
                                firstName: user.firstName,
                                lastName: user.lastName,
                                password: user.password,
                                type: 'enterprise',
                                tenantId: 1,
                                company: null
                            })];
                    case 3:
                        _a.sent();
                        _a.label = 4;
                    case 4: return [4 /*yield*/, this.createIdentityUser(user)];
                    case 5:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * @param {?} userId
     * @return {?}
     */
    IdentityService.prototype.deleteIdentityUser = /**
     * @param {?} userId
     * @return {?}
     */
    function (userId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.deleteUser(userId)];
                    case 1:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * @param {?} user
     * @return {?}
     */
    IdentityService.prototype.createUser = /**
     * @param {?} user
     * @return {?}
     */
    function (user) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var path, method, queryParams, postBody, data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        path = '/users';
                        method = 'POST';
                        queryParams = {};
                        postBody = {
                            'username': user.username,
                            'firstName': user.firstName,
                            'lastName': user.lastName,
                            'enabled': true,
                            'email': user.email
                        };
                        return [4 /*yield*/, this.api.performIdentityOperation(path, method, queryParams, postBody)];
                    case 1:
                        data = _a.sent();
                        return [2 /*return*/, data];
                }
            });
        });
    };
    /**
     * @param {?} userId
     * @return {?}
     */
    IdentityService.prototype.deleteUser = /**
     * @param {?} userId
     * @return {?}
     */
    function (userId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var path, method, queryParams, postBody, data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        path = "/users/" + userId;
                        method = 'DELETE';
                        queryParams = {};
                        postBody = {};
                        return [4 /*yield*/, this.api.performIdentityOperation(path, method, queryParams, postBody)];
                    case 1:
                        data = _a.sent();
                        return [2 /*return*/, data];
                }
            });
        });
    };
    /**
     * @param {?} username
     * @return {?}
     */
    IdentityService.prototype.getUserInfoByUsername = /**
     * @param {?} username
     * @return {?}
     */
    function (username) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var path, method, queryParams, postBody, data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        path = "/users";
                        method = 'GET';
                        queryParams = { 'username': username };
                        postBody = {};
                        return [4 /*yield*/, this.api.performIdentityOperation(path, method, queryParams, postBody)];
                    case 1:
                        data = _a.sent();
                        return [2 /*return*/, data[0]];
                }
            });
        });
    };
    /**
     * @param {?} id
     * @param {?} password
     * @return {?}
     */
    IdentityService.prototype.resetPassword = /**
     * @param {?} id
     * @param {?} password
     * @return {?}
     */
    function (id, password) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var path, method, queryParams, postBody, data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        path = "/users/" + id + "/reset-password";
                        method = 'PUT';
                        queryParams = {};
                        postBody = { 'type': 'password', 'value': password, 'temporary': false };
                        return [4 /*yield*/, this.api.performIdentityOperation(path, method, queryParams, postBody)];
                    case 1:
                        data = _a.sent();
                        return [2 /*return*/, data];
                }
            });
        });
    };
    /**
     * @param {?} userId
     * @param {?} roleId
     * @param {?} roleName
     * @return {?}
     */
    IdentityService.prototype.assignRole = /**
     * @param {?} userId
     * @param {?} roleId
     * @param {?} roleName
     * @return {?}
     */
    function (userId, roleId, roleName) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var path, method, queryParams, postBody, data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        path = "/users/" + userId + "/role-mappings/realm";
                        method = 'POST';
                        queryParams = {};
                        postBody = [{ 'id': roleId, 'name': roleName }];
                        return [4 /*yield*/, this.api.performIdentityOperation(path, method, queryParams, postBody)];
                    case 1:
                        data = _a.sent();
                        return [2 /*return*/, data];
                }
            });
        });
    };
    /**
     * @param {?} userId
     * @param {?} clientId
     * @param {?} roleId
     * @param {?} roleName
     * @return {?}
     */
    IdentityService.prototype.deleteClientRole = /**
     * @param {?} userId
     * @param {?} clientId
     * @param {?} roleId
     * @param {?} roleName
     * @return {?}
     */
    function (userId, clientId, roleId, roleName) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var path, method, queryParams, postBody, data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        path = "/users/" + userId + "/role-mappings/clients/" + clientId;
                        method = 'DELETE';
                        queryParams = {};
                        postBody = [{
                                'id': roleId,
                                'name': roleName,
                                'composite': false,
                                'clientRole': true,
                                'containerId': clientId
                            }];
                        return [4 /*yield*/, this.api.performIdentityOperation(path, method, queryParams, postBody)];
                    case 1:
                        data = _a.sent();
                        return [2 /*return*/, data];
                }
            });
        });
    };
    return IdentityService;
}());
export { IdentityService };
if (false) {
    /** @type {?} */
    IdentityService.prototype.api;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlbnRpdHkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtdGVzdGluZy8iLCJzb3VyY2VzIjpbImxpYi9jb3JlL2FjdGlvbnMvaWRlbnRpdHkvaWRlbnRpdHkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFrQkEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBR3BEO0lBSUkseUJBQVksR0FBZTtRQUN2QixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztJQUNuQixDQUFDOzs7OztJQUVLLDRDQUFrQjs7OztJQUF4QixVQUF5QixJQUFpQztRQUFqQyxxQkFBQSxFQUFBLFdBQXNCLFNBQVMsRUFBRTs7Ozs7NEJBQ3RELHFCQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUE7O3dCQUEzQixTQUEyQixDQUFDO3dCQUVQLHFCQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUE7O3dCQUE5RCxZQUFZLEdBQUcsU0FBK0M7d0JBQ3BFLHFCQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUE7O3dCQUF4RCxTQUF3RCxDQUFDO3dCQUN6RCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsWUFBWSxDQUFDLEVBQUUsQ0FBQzt3QkFDekMsc0JBQU8sSUFBSSxFQUFDOzs7O0tBQ2Y7Ozs7O0lBRUsseURBQStCOzs7O0lBQXJDLFVBQXNDLElBQWU7Ozs7Ozs2QkFDN0MsQ0FBQSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEtBQUssS0FBSyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsS0FBSyxLQUFLLENBQUEsRUFBeEUsd0JBQXdFO3dCQUNsRSxVQUFVLEdBQXFCLG1CQUFtQjs0QkFDcEQs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LEdBQUcsWUFBVSxNQUFNLCtCQUEwQixRQUFVO3dCQUMzRCxNQUFNLEdBQUcsUUFBUTt3QkFBRSxXQUFXLEdBQUcsRUFBRTt3QkFDckMsUUFBUSxHQUFHLENBQUM7Z0NBQ1IsSUFBSSxFQUFFLE1BQU07Z0NBQ1osTUFBTSxFQUFFLFFBQVE7Z0NBQ2hCLFdBQVcsRUFBRSxLQUFLO2dDQUNsQixZQUFZLEVBQUUsSUFBSTtnQ0FDbEIsYUFBYSxFQUFFLFFBQVE7NkJBQzFCLENBQUM7d0JBQ08scUJBQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxRQUFRLENBQUMsRUFBQTs7d0JBQW5GLElBQUksR0FBRyxTQUE0RTt3QkFDekYsc0JBQU8sSUFBSSxFQUFDOzs7O0tBQ2Y7SUFFTCxzQkFBQztBQUFELENBQUMsQUFqSEQsSUFpSEM7Ozs7SUEvR0csOEJBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQXBpU2VydmljZSB9IGZyb20gJy4uL2FwaS5zZXJ2aWNlJztcbmltcG9ydCB7IFVzZXJNb2RlbCB9IGZyb20gJy4uLy4uL21vZGVscy91c2VyLm1vZGVsJztcbmltcG9ydCB7IFBlcnNvbkJvZHlDcmVhdGUgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcblxuZXhwb3J0IGNsYXNzIElkZW50aXR5U2VydmljZSB7XG5cbiAgICBhcGk6IEFwaVNlcnZpY2U7XG5cbiAgICBjb25zdHJ1Y3RvcihhcGk6IEFwaVNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5hcGkgPSBhcGk7XG4gICAgfVxuXG4gICAgYXN5bmMgY3JlYXRlSWRlbnRpdHlVc2VyKHVzZXI6IFVzZXJNb2RlbCA9IG5ldyBVc2VyTW9kZWwoKSkge1xuICAgICAgICBhd2FpdCB0aGlzLmNyZWF0ZVVzZXIodXNlcik7XG5cbiAgICAgICAgY29uc3QgdXNlcklkZW50aXR5ID0gYXdhaXQgdGhpcy5nZXRVc2VySW5mb0J5VXNlcm5hbWUodXNlci51c2VybmFtZSk7XG4gICAgICAgIGF3YWl0IHRoaXMucmVzZXRQYXNzd29yZCh1c2VySWRlbnRpdHkuaWQsIHVzZXIucGFzc3dvcmQpO1xuICAgICAgICB1c2VyLmlkSWRlbnRpdHlTZXJ2aWNlID0gdXNlcklkZW50aXR5LmlkO1xuICAgICAgICByZXR1cm4gdXNlcjtcbiAgICB9XG5cbiAgICBhc3luYyBjcmVhdGVJZGVudGl0eVVzZXJBbmRTeW5jRUNNQlBNKHVzZXI6IFVzZXJNb2RlbCkge1xuICAgICAgICBpZiAodGhpcy5hcGkuY29uZmlnLnByb3ZpZGVyID09PSAnRUNNJyB8fCB0aGlzLmFwaS5jb25maWcucHJvdmlkZXIgPT09ICdBTEwnKSB7XG4gICAgICAgICAgICBjb25zdCBjcmVhdGVVc2VyOiBQZXJzb25Cb2R5Q3JlYXRlID0gPFBlcnNvbkJvZHlDcmVhdGU+IHtcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHVzZXIuZmlyc3ROYW1lLFxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB1c2VyLmxhc3ROYW1lLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB1c2VyLnBhc3N3b3JkLFxuICAgICAgICAgICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICAgICAgICAgIGlkOiB1c2VyLmVtYWlsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5hcGkuYXBpU2VydmljZS5jb3JlLnBlb3BsZUFwaS5hZGRQZXJzb24oY3JlYXRlVXNlcik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5hcGkuY29uZmlnLnByb3ZpZGVyID09PSAnQlBNJyB8fCB0aGlzLmFwaS5jb25maWcucHJvdmlkZXIgPT09ICdBTEwnKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmFwaS5hcGlTZXJ2aWNlLmFjdGl2aXRpLmFkbWluVXNlcnNBcGkuY3JlYXRlTmV3VXNlcih7XG4gICAgICAgICAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB1c2VyLmZpcnN0TmFtZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdXNlci5sYXN0TmFtZSxcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogdXNlci5wYXNzd29yZCxcbiAgICAgICAgICAgICAgICB0eXBlOiAnZW50ZXJwcmlzZScsXG4gICAgICAgICAgICAgICAgdGVuYW50SWQ6IDEsXG4gICAgICAgICAgICAgICAgY29tcGFueTogbnVsbFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLmNyZWF0ZUlkZW50aXR5VXNlcih1c2VyKTtcbiAgICB9XG5cbiAgICBhc3luYyBkZWxldGVJZGVudGl0eVVzZXIodXNlcklkKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZGVsZXRlVXNlcih1c2VySWQpO1xuICAgIH1cblxuICAgIGFzeW5jIGNyZWF0ZVVzZXIodXNlcjogVXNlck1vZGVsKSB7XG4gICAgICAgIGNvbnN0IHBhdGggPSAnL3VzZXJzJztcbiAgICAgICAgY29uc3QgbWV0aG9kID0gJ1BPU1QnO1xuICAgICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHt9LCBwb3N0Qm9keSA9IHtcbiAgICAgICAgICAgICd1c2VybmFtZSc6IHVzZXIudXNlcm5hbWUsXG4gICAgICAgICAgICAnZmlyc3ROYW1lJzogdXNlci5maXJzdE5hbWUsXG4gICAgICAgICAgICAnbGFzdE5hbWUnOiB1c2VyLmxhc3ROYW1lLFxuICAgICAgICAgICAgJ2VuYWJsZWQnOiB0cnVlLFxuICAgICAgICAgICAgJ2VtYWlsJzogdXNlci5lbWFpbFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5hcGkucGVyZm9ybUlkZW50aXR5T3BlcmF0aW9uKHBhdGgsIG1ldGhvZCwgcXVlcnlQYXJhbXMsIHBvc3RCb2R5KTtcbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuXG4gICAgYXN5bmMgZGVsZXRlVXNlcih1c2VySWQpIHtcbiAgICAgICAgY29uc3QgcGF0aCA9IGAvdXNlcnMvJHt1c2VySWR9YDtcbiAgICAgICAgY29uc3QgbWV0aG9kID0gJ0RFTEVURSc7XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0ge30sIHBvc3RCb2R5ID0ge307XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmFwaS5wZXJmb3JtSWRlbnRpdHlPcGVyYXRpb24ocGF0aCwgbWV0aG9kLCBxdWVyeVBhcmFtcywgcG9zdEJvZHkpO1xuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRVc2VySW5mb0J5VXNlcm5hbWUodXNlcm5hbWUpIHtcbiAgICAgICAgY29uc3QgcGF0aCA9IGAvdXNlcnNgO1xuICAgICAgICBjb25zdCBtZXRob2QgPSAnR0VUJztcbiAgICAgICAgY29uc3QgcXVlcnlQYXJhbXMgPSB7ICd1c2VybmFtZSc6IHVzZXJuYW1lIH0sIHBvc3RCb2R5ID0ge307XG5cbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuYXBpLnBlcmZvcm1JZGVudGl0eU9wZXJhdGlvbihwYXRoLCBtZXRob2QsIHF1ZXJ5UGFyYW1zLCBwb3N0Qm9keSk7XG4gICAgICAgIHJldHVybiBkYXRhWzBdO1xuICAgIH1cblxuICAgIGFzeW5jIHJlc2V0UGFzc3dvcmQoaWQsIHBhc3N3b3JkKSB7XG4gICAgICAgIGNvbnN0IHBhdGggPSBgL3VzZXJzLyR7aWR9L3Jlc2V0LXBhc3N3b3JkYDtcbiAgICAgICAgY29uc3QgbWV0aG9kID0gJ1BVVCc7XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0ge30sXG4gICAgICAgICAgICBwb3N0Qm9keSA9IHsgJ3R5cGUnOiAncGFzc3dvcmQnLCAndmFsdWUnOiBwYXNzd29yZCwgJ3RlbXBvcmFyeSc6IGZhbHNlIH07XG5cbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuYXBpLnBlcmZvcm1JZGVudGl0eU9wZXJhdGlvbihwYXRoLCBtZXRob2QsIHF1ZXJ5UGFyYW1zLCBwb3N0Qm9keSk7XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cblxuICAgIGFzeW5jIGFzc2lnblJvbGUodXNlcklkLCByb2xlSWQsIHJvbGVOYW1lKSB7XG4gICAgICAgIGNvbnN0IHBhdGggPSBgL3VzZXJzLyR7dXNlcklkfS9yb2xlLW1hcHBpbmdzL3JlYWxtYDtcbiAgICAgICAgY29uc3QgbWV0aG9kID0gJ1BPU1QnO1xuICAgICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHt9LFxuICAgICAgICAgICAgcG9zdEJvZHkgPSBbeyAnaWQnOiByb2xlSWQsICduYW1lJzogcm9sZU5hbWUgfV07XG5cbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuYXBpLnBlcmZvcm1JZGVudGl0eU9wZXJhdGlvbihwYXRoLCBtZXRob2QsIHF1ZXJ5UGFyYW1zLCBwb3N0Qm9keSk7XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cblxuICAgIGFzeW5jIGRlbGV0ZUNsaWVudFJvbGUodXNlcklkOiBzdHJpbmcsIGNsaWVudElkOiBzdHJpbmcsIHJvbGVJZDogc3RyaW5nLCByb2xlTmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHBhdGggPSBgL3VzZXJzLyR7dXNlcklkfS9yb2xlLW1hcHBpbmdzL2NsaWVudHMvJHtjbGllbnRJZH1gO1xuICAgICAgICBjb25zdCBtZXRob2QgPSAnREVMRVRFJywgcXVlcnlQYXJhbXMgPSB7fSxcbiAgICAgICAgICAgIHBvc3RCb2R5ID0gW3tcbiAgICAgICAgICAgICAgICAnaWQnOiByb2xlSWQsXG4gICAgICAgICAgICAgICAgJ25hbWUnOiByb2xlTmFtZSxcbiAgICAgICAgICAgICAgICAnY29tcG9zaXRlJzogZmFsc2UsXG4gICAgICAgICAgICAgICAgJ2NsaWVudFJvbGUnOiB0cnVlLFxuICAgICAgICAgICAgICAgICdjb250YWluZXJJZCc6IGNsaWVudElkXG4gICAgICAgICAgICB9XTtcbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuYXBpLnBlcmZvcm1JZGVudGl0eU9wZXJhdGlvbihwYXRoLCBtZXRob2QsIHF1ZXJ5UGFyYW1zLCBwb3N0Qm9keSk7XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cblxufVxuIl19