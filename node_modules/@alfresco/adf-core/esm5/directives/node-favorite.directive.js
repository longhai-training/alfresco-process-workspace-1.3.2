/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* tslint:disable:no-input-rename  */
import { Directive, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { from, forkJoin, of } from 'rxjs';
import { AlfrescoApiService } from '../services/alfresco-api.service';
import { catchError, map } from 'rxjs/operators';
var NodeFavoriteDirective = /** @class */ (function () {
    function NodeFavoriteDirective(alfrescoApiService) {
        this.alfrescoApiService = alfrescoApiService;
        this.favorites = [];
        /**
         * Array of nodes to toggle as favorites.
         */
        this.selection = [];
        /**
         * Emitted when the favorite setting is complete.
         */
        this.toggle = new EventEmitter();
        /**
         * Emitted when the favorite setting fails.
         */
        this.error = new EventEmitter();
    }
    /**
     * @return {?}
     */
    NodeFavoriteDirective.prototype.onClick = /**
     * @return {?}
     */
    function () {
        this.toggleFavorite();
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    NodeFavoriteDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        if (!changes.selection.currentValue.length) {
            this.favorites = [];
            return;
        }
        this.markFavoritesNodes(changes.selection.currentValue);
    };
    /**
     * @return {?}
     */
    NodeFavoriteDirective.prototype.toggleFavorite = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (!this.favorites.length) {
            return;
        }
        /** @type {?} */
        var every = this.favorites.every((/**
         * @param {?} selected
         * @return {?}
         */
        function (selected) { return selected.entry.isFavorite; }));
        if (every) {
            /** @type {?} */
            var batch = this.favorites.map((/**
             * @param {?} selected
             * @return {?}
             */
            function (selected) {
                // shared files have nodeId
                /** @type {?} */
                var id = ((/** @type {?} */ (selected))).entry.nodeId || selected.entry.id;
                return from(_this.alfrescoApiService.favoritesApi.removeFavoriteSite('-me-', id));
            }));
            forkJoin(batch).subscribe((/**
             * @return {?}
             */
            function () {
                _this.favorites.map((/**
                 * @param {?} selected
                 * @return {?}
                 */
                function (selected) { return selected.entry.isFavorite = false; }));
                _this.toggle.emit();
            }), (/**
             * @param {?} error
             * @return {?}
             */
            function (error) { return _this.error.emit(error); }));
        }
        if (!every) {
            /** @type {?} */
            var notFavorite_1 = this.favorites.filter((/**
             * @param {?} node
             * @return {?}
             */
            function (node) { return !node.entry.isFavorite; }));
            /** @type {?} */
            var body = notFavorite_1.map((/**
             * @param {?} node
             * @return {?}
             */
            function (node) { return _this.createFavoriteBody(node); }));
            from(this.alfrescoApiService.favoritesApi.addFavorite('-me-', (/** @type {?} */ (body))))
                .subscribe((/**
             * @return {?}
             */
            function () {
                notFavorite_1.map((/**
                 * @param {?} selected
                 * @return {?}
                 */
                function (selected) { return selected.entry.isFavorite = true; }));
                _this.toggle.emit();
            }), (/**
             * @param {?} error
             * @return {?}
             */
            function (error) { return _this.error.emit(error); }));
        }
    };
    /**
     * @param {?} selection
     * @return {?}
     */
    NodeFavoriteDirective.prototype.markFavoritesNodes = /**
     * @param {?} selection
     * @return {?}
     */
    function (selection) {
        var _this = this;
        if (selection.length <= this.favorites.length) {
            /** @type {?} */
            var newFavorites = this.reduce(this.favorites, selection);
            this.favorites = newFavorites;
        }
        /** @type {?} */
        var result = this.diff(selection, this.favorites);
        /** @type {?} */
        var batch = this.getProcessBatch(result);
        forkJoin(batch).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            var _a;
            (_a = _this.favorites).push.apply(_a, tslib_1.__spread(data));
        }));
    };
    /**
     * @return {?}
     */
    NodeFavoriteDirective.prototype.hasFavorites = /**
     * @return {?}
     */
    function () {
        if (this.favorites && !this.favorites.length) {
            return false;
        }
        return this.favorites.every((/**
         * @param {?} selected
         * @return {?}
         */
        function (selected) { return selected.entry.isFavorite; }));
    };
    /**
     * @private
     * @param {?} selection
     * @return {?}
     */
    NodeFavoriteDirective.prototype.getProcessBatch = /**
     * @private
     * @param {?} selection
     * @return {?}
     */
    function (selection) {
        var _this = this;
        return selection.map((/**
         * @param {?} selected
         * @return {?}
         */
        function (selected) { return _this.getFavorite(selected); }));
    };
    /**
     * @private
     * @param {?} selected
     * @return {?}
     */
    NodeFavoriteDirective.prototype.getFavorite = /**
     * @private
     * @param {?} selected
     * @return {?}
     */
    function (selected) {
        /** @type {?} */
        var node = selected.entry;
        // ACS 6.x with 'isFavorite' include
        if (node && node.hasOwnProperty('isFavorite')) {
            return of(selected);
        }
        // ACS 5.x and 6.x without 'isFavorite' include
        var _a = (/** @type {?} */ (node)), name = _a.name, isFile = _a.isFile, isFolder = _a.isFolder;
        /** @type {?} */
        var id = ((/** @type {?} */ (node))).nodeId || node.id;
        /** @type {?} */
        var promise = this.alfrescoApiService.favoritesApi.getFavorite('-me-', id);
        return from(promise).pipe(map((/**
         * @return {?}
         */
        function () { return ({
            entry: {
                id: id,
                isFolder: isFolder,
                isFile: isFile,
                name: name,
                isFavorite: true
            }
        }); })), catchError((/**
         * @return {?}
         */
        function () {
            return of({
                entry: {
                    id: id,
                    isFolder: isFolder,
                    isFile: isFile,
                    name: name,
                    isFavorite: false
                }
            });
        })));
    };
    /**
     * @private
     * @param {?} node
     * @return {?}
     */
    NodeFavoriteDirective.prototype.createFavoriteBody = /**
     * @private
     * @param {?} node
     * @return {?}
     */
    function (node) {
        var _a;
        /** @type {?} */
        var type = this.getNodeType(node);
        // shared files have nodeId
        /** @type {?} */
        var id = node.entry.nodeId || node.entry.id;
        return {
            target: (_a = {},
                _a[type] = {
                    guid: id
                },
                _a)
        };
    };
    /**
     * @private
     * @param {?} node
     * @return {?}
     */
    NodeFavoriteDirective.prototype.getNodeType = /**
     * @private
     * @param {?} node
     * @return {?}
     */
    function (node) {
        // shared could only be files
        if (!node.entry.isFile && !node.entry.isFolder) {
            return 'file';
        }
        return node.entry.isFile ? 'file' : 'folder';
    };
    /**
     * @private
     * @param {?} list
     * @param {?} patch
     * @return {?}
     */
    NodeFavoriteDirective.prototype.diff = /**
     * @private
     * @param {?} list
     * @param {?} patch
     * @return {?}
     */
    function (list, patch) {
        /** @type {?} */
        var ids = patch.map((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return item.entry.id; }));
        return list.filter((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return ids.includes(item.entry.id) ? null : item; }));
    };
    /**
     * @private
     * @param {?} patch
     * @param {?} comparator
     * @return {?}
     */
    NodeFavoriteDirective.prototype.reduce = /**
     * @private
     * @param {?} patch
     * @param {?} comparator
     * @return {?}
     */
    function (patch, comparator) {
        /** @type {?} */
        var ids = comparator.map((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return item.entry.id; }));
        return patch.filter((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return ids.includes(item.entry.id) ? item : null; }));
    };
    NodeFavoriteDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[adf-node-favorite]',
                    exportAs: 'adfFavorite'
                },] }
    ];
    /** @nocollapse */
    NodeFavoriteDirective.ctorParameters = function () { return [
        { type: AlfrescoApiService }
    ]; };
    NodeFavoriteDirective.propDecorators = {
        selection: [{ type: Input, args: ['adf-node-favorite',] }],
        toggle: [{ type: Output }],
        error: [{ type: Output }],
        onClick: [{ type: HostListener, args: ['click',] }]
    };
    return NodeFavoriteDirective;
}());
export { NodeFavoriteDirective };
if (false) {
    /** @type {?} */
    NodeFavoriteDirective.prototype.favorites;
    /**
     * Array of nodes to toggle as favorites.
     * @type {?}
     */
    NodeFavoriteDirective.prototype.selection;
    /**
     * Emitted when the favorite setting is complete.
     * @type {?}
     */
    NodeFavoriteDirective.prototype.toggle;
    /**
     * Emitted when the favorite setting fails.
     * @type {?}
     */
    NodeFavoriteDirective.prototype.error;
    /**
     * @type {?}
     * @private
     */
    NodeFavoriteDirective.prototype.alfrescoApiService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1mYXZvcml0ZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvcmUvIiwic291cmNlcyI6WyJkaXJlY3RpdmVzL25vZGUtZmF2b3JpdGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFtQkEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBYSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFaEcsT0FBTyxFQUFjLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFakQ7SUFzQkksK0JBQW9CLGtCQUFzQztRQUF0Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBakIxRCxjQUFTLEdBQVUsRUFBRSxDQUFDOzs7O1FBSXRCLGNBQVMsR0FBZ0IsRUFBRSxDQUFDOzs7O1FBR2xCLFdBQU0sR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQzs7OztRQUcvQyxVQUFLLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7SUFReEQsQ0FBQzs7OztJQUxELHVDQUFPOzs7SUFEUDtRQUVJLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUMxQixDQUFDOzs7OztJQUtELDJDQUFXOzs7O0lBQVgsVUFBWSxPQUFPO1FBQ2YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRTtZQUN4QyxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztZQUVwQixPQUFPO1NBQ1Y7UUFFRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUM1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Qix1Q0FBeUQ7Ozs7O0lBR3pELHNDQUF3RDs7Ozs7SUFPNUMsbURBQThDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLyogdHNsaW50OmRpc2FibGU6bm8taW5wdXQtcmVuYW1lICAqL1xuXG5pbXBvcnQgeyBEaXJlY3RpdmUsIEV2ZW50RW1pdHRlciwgSG9zdExpc3RlbmVyLCBJbnB1dCwgT25DaGFuZ2VzLCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZhdm9yaXRlQm9keSwgTm9kZUVudHJ5LCBTaGFyZWRMaW5rRW50cnksIE5vZGUsIFNoYXJlZExpbmsgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIGZvcmtKb2luLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYWxmcmVzY28tYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1thZGYtbm9kZS1mYXZvcml0ZV0nLFxuICAgIGV4cG9ydEFzOiAnYWRmRmF2b3JpdGUnXG59KVxuZXhwb3J0IGNsYXNzIE5vZGVGYXZvcml0ZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcyB7XG4gICAgZmF2b3JpdGVzOiBhbnlbXSA9IFtdO1xuXG4gICAgLyoqIEFycmF5IG9mIG5vZGVzIHRvIHRvZ2dsZSBhcyBmYXZvcml0ZXMuICovXG4gICAgQElucHV0KCdhZGYtbm9kZS1mYXZvcml0ZScpXG4gICAgc2VsZWN0aW9uOiBOb2RlRW50cnlbXSA9IFtdO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgZmF2b3JpdGUgc2V0dGluZyBpcyBjb21wbGV0ZS4gKi9cbiAgICBAT3V0cHV0KCkgdG9nZ2xlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gdGhlIGZhdm9yaXRlIHNldHRpbmcgZmFpbHMuICovXG4gICAgQE91dHB1dCgpIGVycm9yOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJylcbiAgICBvbkNsaWNrKCkge1xuICAgICAgICB0aGlzLnRvZ2dsZUZhdm9yaXRlKCk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhbGZyZXNjb0FwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSkge1xuICAgIH1cblxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXMpIHtcbiAgICAgICAgaWYgKCFjaGFuZ2VzLnNlbGVjdGlvbi5jdXJyZW50VmFsdWUubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmZhdm9yaXRlcyA9IFtdO1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm1hcmtGYXZvcml0ZXNOb2RlcyhjaGFuZ2VzLnNlbGVjdGlvbi5jdXJyZW50VmFsdWUpO1xuICAgIH1cblxuICAgIHRvZ2dsZUZhdm9yaXRlKCkge1xuICAgICAgICBpZiAoIXRoaXMuZmF2b3JpdGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZXZlcnkgPSB0aGlzLmZhdm9yaXRlcy5ldmVyeSgoc2VsZWN0ZWQpID0+IHNlbGVjdGVkLmVudHJ5LmlzRmF2b3JpdGUpO1xuXG4gICAgICAgIGlmIChldmVyeSkge1xuICAgICAgICAgICAgY29uc3QgYmF0Y2ggPSB0aGlzLmZhdm9yaXRlcy5tYXAoKHNlbGVjdGVkOiBOb2RlRW50cnkgfCBTaGFyZWRMaW5rRW50cnkpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBzaGFyZWQgZmlsZXMgaGF2ZSBub2RlSWRcbiAgICAgICAgICAgICAgICBjb25zdCBpZCA9ICg8U2hhcmVkTGlua0VudHJ5PiBzZWxlY3RlZCkuZW50cnkubm9kZUlkIHx8IHNlbGVjdGVkLmVudHJ5LmlkO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZmF2b3JpdGVzQXBpLnJlbW92ZUZhdm9yaXRlU2l0ZSgnLW1lLScsIGlkKSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgZm9ya0pvaW4oYmF0Y2gpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmF2b3JpdGVzLm1hcCgoc2VsZWN0ZWQpID0+IHNlbGVjdGVkLmVudHJ5LmlzRmF2b3JpdGUgPSBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlLmVtaXQoKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIChlcnJvcikgPT4gdGhpcy5lcnJvci5lbWl0KGVycm9yKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghZXZlcnkpIHtcbiAgICAgICAgICAgIGNvbnN0IG5vdEZhdm9yaXRlID0gdGhpcy5mYXZvcml0ZXMuZmlsdGVyKChub2RlKSA9PiAhbm9kZS5lbnRyeS5pc0Zhdm9yaXRlKTtcbiAgICAgICAgICAgIGNvbnN0IGJvZHk6IEZhdm9yaXRlQm9keVtdID0gbm90RmF2b3JpdGUubWFwKChub2RlKSA9PiB0aGlzLmNyZWF0ZUZhdm9yaXRlQm9keShub2RlKSk7XG5cbiAgICAgICAgICAgIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZmF2b3JpdGVzQXBpLmFkZEZhdm9yaXRlKCctbWUtJywgPGFueT4gYm9keSkpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbm90RmF2b3JpdGUubWFwKChzZWxlY3RlZCkgPT4gc2VsZWN0ZWQuZW50cnkuaXNGYXZvcml0ZSA9IHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50b2dnbGUuZW1pdCgpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAoZXJyb3IpID0+IHRoaXMuZXJyb3IuZW1pdChlcnJvcilcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbWFya0Zhdm9yaXRlc05vZGVzKHNlbGVjdGlvbjogTm9kZUVudHJ5W10pIHtcbiAgICAgICAgaWYgKHNlbGVjdGlvbi5sZW5ndGggPD0gdGhpcy5mYXZvcml0ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICBjb25zdCBuZXdGYXZvcml0ZXMgPSB0aGlzLnJlZHVjZSh0aGlzLmZhdm9yaXRlcywgc2VsZWN0aW9uKTtcbiAgICAgICAgICAgIHRoaXMuZmF2b3JpdGVzID0gbmV3RmF2b3JpdGVzO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5kaWZmKHNlbGVjdGlvbiwgdGhpcy5mYXZvcml0ZXMpO1xuICAgICAgICBjb25zdCBiYXRjaCA9IHRoaXMuZ2V0UHJvY2Vzc0JhdGNoKHJlc3VsdCk7XG5cbiAgICAgICAgZm9ya0pvaW4oYmF0Y2gpLnN1YnNjcmliZSgoZGF0YSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5mYXZvcml0ZXMucHVzaCguLi5kYXRhKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgaGFzRmF2b3JpdGVzKCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodGhpcy5mYXZvcml0ZXMgJiYgIXRoaXMuZmF2b3JpdGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZmF2b3JpdGVzLmV2ZXJ5KChzZWxlY3RlZCkgPT4gc2VsZWN0ZWQuZW50cnkuaXNGYXZvcml0ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRQcm9jZXNzQmF0Y2goc2VsZWN0aW9uKTogYW55W10ge1xuICAgICAgICByZXR1cm4gc2VsZWN0aW9uLm1hcCgoc2VsZWN0ZWQ6IE5vZGVFbnRyeSkgPT4gdGhpcy5nZXRGYXZvcml0ZShzZWxlY3RlZCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RmF2b3JpdGUoc2VsZWN0ZWQ6IE5vZGVFbnRyeSB8IFNoYXJlZExpbmtFbnRyeSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IG5vZGU6IE5vZGUgfCBTaGFyZWRMaW5rID0gc2VsZWN0ZWQuZW50cnk7XG5cbiAgICAgICAgLy8gQUNTIDYueCB3aXRoICdpc0Zhdm9yaXRlJyBpbmNsdWRlXG4gICAgICAgIGlmIChub2RlICYmIG5vZGUuaGFzT3duUHJvcGVydHkoJ2lzRmF2b3JpdGUnKSkge1xuICAgICAgICAgICAgcmV0dXJuIG9mKHNlbGVjdGVkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEFDUyA1LnggYW5kIDYueCB3aXRob3V0ICdpc0Zhdm9yaXRlJyBpbmNsdWRlXG4gICAgICAgIGNvbnN0IHsgbmFtZSwgaXNGaWxlLCBpc0ZvbGRlciB9ID0gPE5vZGU+IG5vZGU7XG4gICAgICAgIGNvbnN0IGlkID0gICg8U2hhcmVkTGluaz4gbm9kZSkubm9kZUlkIHx8IG5vZGUuaWQ7XG5cbiAgICAgICAgY29uc3QgcHJvbWlzZSA9IHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLmZhdm9yaXRlc0FwaS5nZXRGYXZvcml0ZSgnLW1lLScsIGlkKTtcblxuICAgICAgICByZXR1cm4gZnJvbShwcm9taXNlKS5waXBlKFxuICAgICAgICAgICAgbWFwKCgpID0+ICh7XG4gICAgICAgICAgICAgICAgZW50cnk6IHtcbiAgICAgICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgICAgIGlzRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICBpc0ZpbGUsXG4gICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGlzRmF2b3JpdGU6IHRydWVcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSksXG4gICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2Yoe1xuICAgICAgICAgICAgICAgICAgICBlbnRyeToge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzRmlsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0Zhdm9yaXRlOiBmYWxzZVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlRmF2b3JpdGVCb2R5KG5vZGUpOiBGYXZvcml0ZUJvZHkge1xuICAgICAgICBjb25zdCB0eXBlID0gdGhpcy5nZXROb2RlVHlwZShub2RlKTtcbiAgICAgICAgLy8gc2hhcmVkIGZpbGVzIGhhdmUgbm9kZUlkXG4gICAgICAgIGNvbnN0IGlkID0gbm9kZS5lbnRyeS5ub2RlSWQgfHwgbm9kZS5lbnRyeS5pZDtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGFyZ2V0OiB7XG4gICAgICAgICAgICAgICAgW3R5cGVdOiB7XG4gICAgICAgICAgICAgICAgICAgIGd1aWQ6IGlkXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Tm9kZVR5cGUobm9kZSk6IHN0cmluZyB7XG4gICAgICAgIC8vIHNoYXJlZCBjb3VsZCBvbmx5IGJlIGZpbGVzXG4gICAgICAgIGlmICghbm9kZS5lbnRyeS5pc0ZpbGUgJiYgIW5vZGUuZW50cnkuaXNGb2xkZXIpIHtcbiAgICAgICAgICAgIHJldHVybiAnZmlsZSc7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbm9kZS5lbnRyeS5pc0ZpbGUgPyAnZmlsZScgOiAnZm9sZGVyJztcbiAgICB9XG5cbiAgICBwcml2YXRlIGRpZmYobGlzdCwgcGF0Y2gpOiBhbnlbXSB7XG4gICAgICAgIGNvbnN0IGlkcyA9IHBhdGNoLm1hcCgoaXRlbSkgPT4gaXRlbS5lbnRyeS5pZCk7XG5cbiAgICAgICAgcmV0dXJuIGxpc3QuZmlsdGVyKChpdGVtKSA9PiBpZHMuaW5jbHVkZXMoaXRlbS5lbnRyeS5pZCkgPyBudWxsIDogaXRlbSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWR1Y2UocGF0Y2gsIGNvbXBhcmF0b3IpOiBhbnlbXSB7XG4gICAgICAgIGNvbnN0IGlkcyA9IGNvbXBhcmF0b3IubWFwKChpdGVtKSA9PiBpdGVtLmVudHJ5LmlkKTtcblxuICAgICAgICByZXR1cm4gcGF0Y2guZmlsdGVyKChpdGVtKSA9PiBpZHMuaW5jbHVkZXMoaXRlbS5lbnRyeS5pZCkgPyBpdGVtIDogbnVsbCk7XG4gICAgfVxufVxuIl19