/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
import { AlfrescoApiService } from '../../services/alfresco-api.service';
import { LogService } from '../../services/log.service';
import * as i0 from "@angular/core";
import * as i1 from "../../services/alfresco-api.service";
import * as i2 from "../../services/log.service";
var ViewUtilService = /** @class */ (function () {
    function ViewUtilService(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
        /**
         * Based on ViewerComponent Implementation, this value is used to determine how many times we try
         * to get the rendition of a file for preview, or printing.
         */
        this.maxRetries = 5;
        /**
         * Mime-type grouping based on the ViewerComponent.
         */
        this.mimeTypes = {
            text: ['text/plain', 'text/csv', 'text/xml', 'text/html', 'application/x-javascript'],
            pdf: ['application/pdf'],
            image: ['image/png', 'image/jpeg', 'image/gif', 'image/bmp', 'image/svg+xml'],
            media: ['video/mp4', 'video/webm', 'video/ogg', 'audio/mpeg', 'audio/ogg', 'audio/wav']
        };
    }
    /**
     * This method takes a url to trigger the print dialog against, and the type of artifact that it
     * is.
     * This URL should be one that can be rendered in the browser, for example PDF, Image, or Text
     */
    /**
     * This method takes a url to trigger the print dialog against, and the type of artifact that it
     * is.
     * This URL should be one that can be rendered in the browser, for example PDF, Image, or Text
     * @param {?} url
     * @param {?} type
     * @return {?}
     */
    ViewUtilService.prototype.printFile = /**
     * This method takes a url to trigger the print dialog against, and the type of artifact that it
     * is.
     * This URL should be one that can be rendered in the browser, for example PDF, Image, or Text
     * @param {?} url
     * @param {?} type
     * @return {?}
     */
    function (url, type) {
        /** @type {?} */
        var pwa = window.open(url, ViewUtilService.TARGET);
        if (pwa) {
            // Because of the way chrome focus and close image window vs. pdf preview window
            if (type === ViewUtilService.ContentGroup.IMAGE) {
                pwa.onfocus = (/**
                 * @return {?}
                 */
                function () {
                    setTimeout((/**
                     * @return {?}
                     */
                    function () {
                        pwa.close();
                    }), 500);
                });
            }
            pwa.onload = (/**
             * @return {?}
             */
            function () {
                pwa.print();
            });
        }
    };
    /**
     * Launch the File Print dialog from anywhere other than the preview service, which resolves the
     * rendition of the object that can be printed from a web browser.
     * These are: images, PDF files, or PDF rendition of files.
     * We also force PDF rendition for TEXT type objects, otherwise the default URL is to download.
     * TODO there are different TEXT type objects, (HTML, plaintext, xml, etc. we should determine how these are handled)
     */
    /**
     * Launch the File Print dialog from anywhere other than the preview service, which resolves the
     * rendition of the object that can be printed from a web browser.
     * These are: images, PDF files, or PDF rendition of files.
     * We also force PDF rendition for TEXT type objects, otherwise the default URL is to download.
     * TODO there are different TEXT type objects, (HTML, plaintext, xml, etc. we should determine how these are handled)
     * @param {?} objectId
     * @param {?} mimeType
     * @return {?}
     */
    ViewUtilService.prototype.printFileGeneric = /**
     * Launch the File Print dialog from anywhere other than the preview service, which resolves the
     * rendition of the object that can be printed from a web browser.
     * These are: images, PDF files, or PDF rendition of files.
     * We also force PDF rendition for TEXT type objects, otherwise the default URL is to download.
     * TODO there are different TEXT type objects, (HTML, plaintext, xml, etc. we should determine how these are handled)
     * @param {?} objectId
     * @param {?} mimeType
     * @return {?}
     */
    function (objectId, mimeType) {
        var _this = this;
        /** @type {?} */
        var nodeId = objectId;
        /** @type {?} */
        var type = this.getViewerTypeByMimeType(mimeType);
        this.getRendition(nodeId, ViewUtilService.ContentGroup.PDF)
            .then((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            /** @type {?} */
            var url = _this.getRenditionUrl(nodeId, type, (value ? true : false));
            /** @type {?} */
            var printType = (type === ViewUtilService.ContentGroup.PDF
                || type === ViewUtilService.ContentGroup.TEXT)
                ? ViewUtilService.ContentGroup.PDF : type;
            _this.printFile(url, printType);
        }))
            .catch((/**
         * @param {?} err
         * @return {?}
         */
        function (err) {
            _this.logService.error('Error with Printing');
            _this.logService.error(err);
        }));
    };
    /**
     * @param {?} nodeId
     * @param {?} type
     * @param {?} renditionExists
     * @return {?}
     */
    ViewUtilService.prototype.getRenditionUrl = /**
     * @param {?} nodeId
     * @param {?} type
     * @param {?} renditionExists
     * @return {?}
     */
    function (nodeId, type, renditionExists) {
        return (renditionExists && type !== ViewUtilService.ContentGroup.IMAGE) ?
            this.apiService.contentApi.getRenditionUrl(nodeId, ViewUtilService.ContentGroup.PDF) :
            this.apiService.contentApi.getContentUrl(nodeId, false);
    };
    /**
     * @private
     * @param {?} nodeId
     * @param {?} renditionId
     * @param {?} retries
     * @return {?}
     */
    ViewUtilService.prototype.waitRendition = /**
     * @private
     * @param {?} nodeId
     * @param {?} renditionId
     * @param {?} retries
     * @return {?}
     */
    function (nodeId, renditionId, retries) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var rendition, status_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.apiService.renditionsApi.getRendition(nodeId, renditionId)];
                    case 1:
                        rendition = _a.sent();
                        if (!(this.maxRetries < retries)) return [3 /*break*/, 5];
                        status_1 = rendition.entry.status.toString();
                        if (!(status_1 === 'CREATED')) return [3 /*break*/, 2];
                        return [2 /*return*/, rendition];
                    case 2:
                        retries += 1;
                        return [4 /*yield*/, this.wait(1000)];
                    case 3:
                        _a.sent();
                        return [4 /*yield*/, this.waitRendition(nodeId, renditionId, retries)];
                    case 4: return [2 /*return*/, _a.sent()];
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * @param {?} mimeType
     * @return {?}
     */
    ViewUtilService.prototype.getViewerTypeByMimeType = /**
     * @param {?} mimeType
     * @return {?}
     */
    function (mimeType) {
        var e_1, _a;
        if (mimeType) {
            mimeType = mimeType.toLowerCase();
            /** @type {?} */
            var editorTypes = Object.keys(this.mimeTypes);
            try {
                for (var editorTypes_1 = tslib_1.__values(editorTypes), editorTypes_1_1 = editorTypes_1.next(); !editorTypes_1_1.done; editorTypes_1_1 = editorTypes_1.next()) {
                    var type = editorTypes_1_1.value;
                    if (this.mimeTypes[type].indexOf(mimeType) >= 0) {
                        return type;
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (editorTypes_1_1 && !editorTypes_1_1.done && (_a = editorTypes_1.return)) _a.call(editorTypes_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        return 'unknown';
    };
    /**
     * @param {?} ms
     * @return {?}
     */
    ViewUtilService.prototype.wait = /**
     * @param {?} ms
     * @return {?}
     */
    function (ms) {
        return new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        function (resolve) { return setTimeout(resolve, ms); }));
    };
    /**
     * @param {?} nodeId
     * @param {?} renditionId
     * @return {?}
     */
    ViewUtilService.prototype.getRendition = /**
     * @param {?} nodeId
     * @param {?} renditionId
     * @return {?}
     */
    function (nodeId, renditionId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var renditionPaging, rendition, status_2, err_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.apiService.renditionsApi.getRenditions(nodeId)];
                    case 1:
                        renditionPaging = _a.sent();
                        rendition = renditionPaging.list.entries.find((/**
                         * @param {?} renditionEntry
                         * @return {?}
                         */
                        function (renditionEntry) { return renditionEntry.entry.id.toLowerCase() === renditionId; }));
                        if (!rendition) return [3 /*break*/, 6];
                        status_2 = rendition.entry.status.toString();
                        if (!(status_2 === 'NOT_CREATED')) return [3 /*break*/, 6];
                        _a.label = 2;
                    case 2:
                        _a.trys.push([2, 5, , 6]);
                        return [4 /*yield*/, this.apiService.renditionsApi.createRendition(nodeId, { id: renditionId })];
                    case 3:
                        _a.sent();
                        return [4 /*yield*/, this.waitRendition(nodeId, renditionId, 0)];
                    case 4:
                        rendition = _a.sent();
                        return [3 /*break*/, 6];
                    case 5:
                        err_1 = _a.sent();
                        this.logService.error(err_1);
                        return [3 /*break*/, 6];
                    case 6: return [2 /*return*/, new Promise((/**
                         * @param {?} resolve
                         * @return {?}
                         */
                        function (resolve) { return resolve(rendition); }))];
                }
            });
        });
    };
    ViewUtilService.TARGET = '_new';
    /**
     * Content groups based on categorization of files that can be viewed in the web browser. This
     * implementation or grouping is tied to the definition the ng component: ViewerComponent
     */
    // tslint:disable-next-line:variable-name
    ViewUtilService.ContentGroup = {
        IMAGE: 'image',
        MEDIA: 'media',
        PDF: 'pdf',
        TEXT: 'text'
    };
    ViewUtilService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    ViewUtilService.ctorParameters = function () { return [
        { type: AlfrescoApiService },
        { type: LogService }
    ]; };
    /** @nocollapse */ ViewUtilService.ngInjectableDef = i0.defineInjectable({ factory: function ViewUtilService_Factory() { return new ViewUtilService(i0.inject(i1.AlfrescoApiService), i0.inject(i2.LogService)); }, token: ViewUtilService, providedIn: "root" });
    return ViewUtilService;
}());
export { ViewUtilService };
if (false) {
    /** @type {?} */
    ViewUtilService.TARGET;
    /**
     * Content groups based on categorization of files that can be viewed in the web browser. This
     * implementation or grouping is tied to the definition the ng component: ViewerComponent
     * @type {?}
     */
    ViewUtilService.ContentGroup;
    /**
     * Based on ViewerComponent Implementation, this value is used to determine how many times we try
     * to get the rendition of a file for preview, or printing.
     * @type {?}
     */
    ViewUtilService.prototype.maxRetries;
    /**
     * Mime-type grouping based on the ViewerComponent.
     * @type {?}
     * @private
     */
    ViewUtilService.prototype.mimeTypes;
    /**
     * @type {?}
     * @private
     */
    ViewUtilService.prototype.apiService;
    /**
     * @type {?}
     * @private
     */
    ViewUtilService.prototype.logService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy11dGlsLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvcmUvIiwic291cmNlcyI6WyJ2aWV3ZXIvc2VydmljZXMvdmlldy11dGlsLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDekUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDRCQUE0QixDQUFDOzs7O0FBRXhEO0lBa0NJLHlCQUFvQixVQUE4QixFQUM5QixVQUFzQjtRQUR0QixlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUM5QixlQUFVLEdBQVYsVUFBVSxDQUFZOzs7OztRQWIxQyxlQUFVLEdBQUcsQ0FBQyxDQUFDOzs7O1FBS1AsY0FBUyxHQUFHO1lBQ2hCLElBQUksRUFBRSxDQUFDLFlBQVksRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSwwQkFBMEIsQ0FBQztZQUNyRixHQUFHLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQztZQUN4QixLQUFLLEVBQUUsQ0FBQyxXQUFXLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsZUFBZSxDQUFDO1lBQzdFLEtBQUssRUFBRSxDQUFDLFdBQVcsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsV0FBVyxDQUFDO1NBQzFGLENBQUM7SUFJRixDQUFDO0lBRUQ7Ozs7T0FJRzs7Ozs7Ozs7O0lBQ0gsbUNBQVM7Ozs7Ozs7O0lBQVQsVUFBVSxHQUFXLEVBQUUsSUFBWTs7WUFDekIsR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLGVBQWUsQ0FBQyxNQUFNLENBQUM7UUFDcEQsSUFBSSxHQUFHLEVBQUU7WUFDTCxnRkFBZ0Y7WUFDaEYsSUFB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bnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSZW5kaXRpb25FbnRyeSwgUmVuZGl0aW9uUGFnaW5nIH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9hbGZyZXNjby1hcGkuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvbG9nLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFZpZXdVdGlsU2VydmljZSB7XG4gICAgc3RhdGljIFRBUkdFVCA9ICdfbmV3JztcblxuICAgIC8qKlxuICAgICAqIENvbnRlbnQgZ3JvdXBzIGJhc2VkIG9uIGNhdGVnb3JpemF0aW9uIG9mIGZpbGVzIHRoYXQgY2FuIGJlIHZpZXdlZCBpbiB0aGUgd2ViIGJyb3dzZXIuIFRoaXNcbiAgICAgKiBpbXBsZW1lbnRhdGlvbiBvciBncm91cGluZyBpcyB0aWVkIHRvIHRoZSBkZWZpbml0aW9uIHRoZSBuZyBjb21wb25lbnQ6IFZpZXdlckNvbXBvbmVudFxuICAgICAqL1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dmFyaWFibGUtbmFtZVxuICAgIHN0YXRpYyBDb250ZW50R3JvdXAgPSB7XG4gICAgICAgIElNQUdFOiAnaW1hZ2UnLFxuICAgICAgICBNRURJQTogJ21lZGlhJyxcbiAgICAgICAgUERGOiAncGRmJyxcbiAgICAgICAgVEVYVDogJ3RleHQnXG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEJhc2VkIG9uIFZpZXdlckNvbXBvbmVudCBJbXBsZW1lbnRhdGlvbiwgdGhpcyB2YWx1ZSBpcyB1c2VkIHRvIGRldGVybWluZSBob3cgbWFueSB0aW1lcyB3ZSB0cnlcbiAgICAgKiB0byBnZXQgdGhlIHJlbmRpdGlvbiBvZiBhIGZpbGUgZm9yIHByZXZpZXcsIG9yIHByaW50aW5nLlxuICAgICAqL1xuICAgIG1heFJldHJpZXMgPSA1O1xuXG4gICAgLyoqXG4gICAgICogTWltZS10eXBlIGdyb3VwaW5nIGJhc2VkIG9uIHRoZSBWaWV3ZXJDb21wb25lbnQuXG4gICAgICovXG4gICAgcHJpdmF0ZSBtaW1lVHlwZXMgPSB7XG4gICAgICAgIHRleHQ6IFsndGV4dC9wbGFpbicsICd0ZXh0L2NzdicsICd0ZXh0L3htbCcsICd0ZXh0L2h0bWwnLCAnYXBwbGljYXRpb24veC1qYXZhc2NyaXB0J10sXG4gICAgICAgIHBkZjogWydhcHBsaWNhdGlvbi9wZGYnXSxcbiAgICAgICAgaW1hZ2U6IFsnaW1hZ2UvcG5nJywgJ2ltYWdlL2pwZWcnLCAnaW1hZ2UvZ2lmJywgJ2ltYWdlL2JtcCcsICdpbWFnZS9zdmcreG1sJ10sXG4gICAgICAgIG1lZGlhOiBbJ3ZpZGVvL21wNCcsICd2aWRlby93ZWJtJywgJ3ZpZGVvL29nZycsICdhdWRpby9tcGVnJywgJ2F1ZGlvL29nZycsICdhdWRpby93YXYnXVxuICAgIH07XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIG1ldGhvZCB0YWtlcyBhIHVybCB0byB0cmlnZ2VyIHRoZSBwcmludCBkaWFsb2cgYWdhaW5zdCwgYW5kIHRoZSB0eXBlIG9mIGFydGlmYWN0IHRoYXQgaXRcbiAgICAgKiBpcy5cbiAgICAgKiBUaGlzIFVSTCBzaG91bGQgYmUgb25lIHRoYXQgY2FuIGJlIHJlbmRlcmVkIGluIHRoZSBicm93c2VyLCBmb3IgZXhhbXBsZSBQREYsIEltYWdlLCBvciBUZXh0XG4gICAgICovXG4gICAgcHJpbnRGaWxlKHVybDogc3RyaW5nLCB0eXBlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcHdhID0gd2luZG93Lm9wZW4odXJsLCBWaWV3VXRpbFNlcnZpY2UuVEFSR0VUKTtcbiAgICAgICAgaWYgKHB3YSkge1xuICAgICAgICAgICAgLy8gQmVjYXVzZSBvZiB0aGUgd2F5IGNocm9tZSBmb2N1cyBhbmQgY2xvc2UgaW1hZ2Ugd2luZG93IHZzLiBwZGYgcHJldmlldyB3aW5kb3dcbiAgICAgICAgICAgIGlmICh0eXBlID09PSBWaWV3VXRpbFNlcnZpY2UuQ29udGVudEdyb3VwLklNQUdFKSB7XG4gICAgICAgICAgICAgICAgcHdhLm9uZm9jdXMgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHdhLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDUwMCk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcHdhLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICBwd2EucHJpbnQoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMYXVuY2ggdGhlIEZpbGUgUHJpbnQgZGlhbG9nIGZyb20gYW55d2hlcmUgb3RoZXIgdGhhbiB0aGUgcHJldmlldyBzZXJ2aWNlLCB3aGljaCByZXNvbHZlcyB0aGVcbiAgICAgKiByZW5kaXRpb24gb2YgdGhlIG9iamVjdCB0aGF0IGNhbiBiZSBwcmludGVkIGZyb20gYSB3ZWIgYnJvd3Nlci5cbiAgICAgKiBUaGVzZSBhcmU6IGltYWdlcywgUERGIGZpbGVzLCBvciBQREYgcmVuZGl0aW9uIG9mIGZpbGVzLlxuICAgICAqIFdlIGFsc28gZm9yY2UgUERGIHJlbmRpdGlvbiBmb3IgVEVYVCB0eXBlIG9iamVjdHMsIG90aGVyd2lzZSB0aGUgZGVmYXVsdCBVUkwgaXMgdG8gZG93bmxvYWQuXG4gICAgICogVE9ETyB0aGVyZSBhcmUgZGlmZmVyZW50IFRFWFQgdHlwZSBvYmplY3RzLCAoSFRNTCwgcGxhaW50ZXh0LCB4bWwsIGV0Yy4gd2Ugc2hvdWxkIGRldGVybWluZSBob3cgdGhlc2UgYXJlIGhhbmRsZWQpXG4gICAgICovXG4gICAgcHJpbnRGaWxlR2VuZXJpYyhvYmplY3RJZDogc3RyaW5nLCBtaW1lVHlwZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IG5vZGVJZCA9IG9iamVjdElkO1xuICAgICAgICBjb25zdCB0eXBlOiBzdHJpbmcgPSB0aGlzLmdldFZpZXdlclR5cGVCeU1pbWVUeXBlKG1pbWVUeXBlKTtcblxuICAgICAgICB0aGlzLmdldFJlbmRpdGlvbihub2RlSWQsIFZpZXdVdGlsU2VydmljZS5Db250ZW50R3JvdXAuUERGKVxuICAgICAgICAgICAgLnRoZW4oKHZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgdXJsOiBzdHJpbmcgPSB0aGlzLmdldFJlbmRpdGlvblVybChub2RlSWQsIHR5cGUsICh2YWx1ZSA/IHRydWUgOiBmYWxzZSkpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHByaW50VHlwZSA9ICh0eXBlID09PSBWaWV3VXRpbFNlcnZpY2UuQ29udGVudEdyb3VwLlBERlxuICAgICAgICAgICAgICAgICAgICB8fCB0eXBlID09PSBWaWV3VXRpbFNlcnZpY2UuQ29udGVudEdyb3VwLlRFWFQpXG4gICAgICAgICAgICAgICAgICAgID8gVmlld1V0aWxTZXJ2aWNlLkNvbnRlbnRHcm91cC5QREYgOiB0eXBlO1xuICAgICAgICAgICAgICAgIHRoaXMucHJpbnRGaWxlKHVybCwgcHJpbnRUeXBlKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignRXJyb3Igd2l0aCBQcmludGluZycpO1xuICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0UmVuZGl0aW9uVXJsKG5vZGVJZDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIHJlbmRpdGlvbkV4aXN0czogYm9vbGVhbik6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAocmVuZGl0aW9uRXhpc3RzICYmIHR5cGUgIT09IFZpZXdVdGlsU2VydmljZS5Db250ZW50R3JvdXAuSU1BR0UpID9cbiAgICAgICAgICAgIHRoaXMuYXBpU2VydmljZS5jb250ZW50QXBpLmdldFJlbmRpdGlvblVybChub2RlSWQsIFZpZXdVdGlsU2VydmljZS5Db250ZW50R3JvdXAuUERGKSA6XG4gICAgICAgICAgICB0aGlzLmFwaVNlcnZpY2UuY29udGVudEFwaS5nZXRDb250ZW50VXJsKG5vZGVJZCwgZmFsc2UpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgd2FpdFJlbmRpdGlvbihub2RlSWQ6IHN0cmluZywgcmVuZGl0aW9uSWQ6IHN0cmluZywgcmV0cmllczogbnVtYmVyKTogUHJvbWlzZTxSZW5kaXRpb25FbnRyeT4ge1xuICAgICAgICBjb25zdCByZW5kaXRpb24gPSBhd2FpdCB0aGlzLmFwaVNlcnZpY2UucmVuZGl0aW9uc0FwaS5nZXRSZW5kaXRpb24obm9kZUlkLCByZW5kaXRpb25JZCk7XG5cbiAgICAgICAgaWYgKHRoaXMubWF4UmV0cmllcyA8IHJldHJpZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IHJlbmRpdGlvbi5lbnRyeS5zdGF0dXMudG9TdHJpbmcoKTtcblxuICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gJ0NSRUFURUQnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlbmRpdGlvbjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0cmllcyArPSAxO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMud2FpdCgxMDAwKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy53YWl0UmVuZGl0aW9uKG5vZGVJZCwgcmVuZGl0aW9uSWQsIHJldHJpZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0Vmlld2VyVHlwZUJ5TWltZVR5cGUobWltZVR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGlmIChtaW1lVHlwZSkge1xuICAgICAgICAgICAgbWltZVR5cGUgPSBtaW1lVHlwZS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgICAgICBjb25zdCBlZGl0b3JUeXBlcyA9IE9iamVjdC5rZXlzKHRoaXMubWltZVR5cGVzKTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgdHlwZSBvZiBlZGl0b3JUeXBlcykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLm1pbWVUeXBlc1t0eXBlXS5pbmRleE9mKG1pbWVUeXBlKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0eXBlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gJ3Vua25vd24nO1xuICAgIH1cblxuICAgIHdhaXQobXM6IG51bWJlcik6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldFJlbmRpdGlvbihub2RlSWQ6IHN0cmluZywgcmVuZGl0aW9uSWQ6IHN0cmluZyk6IFByb21pc2U8UmVuZGl0aW9uRW50cnk+IHtcbiAgICAgICAgY29uc3QgcmVuZGl0aW9uUGFnaW5nOiBSZW5kaXRpb25QYWdpbmcgPSBhd2FpdCB0aGlzLmFwaVNlcnZpY2UucmVuZGl0aW9uc0FwaS5nZXRSZW5kaXRpb25zKG5vZGVJZCk7XG4gICAgICAgIGxldCByZW5kaXRpb246IFJlbmRpdGlvbkVudHJ5ID0gcmVuZGl0aW9uUGFnaW5nLmxpc3QuZW50cmllcy5maW5kKChyZW5kaXRpb25FbnRyeTogUmVuZGl0aW9uRW50cnkpID0+IHJlbmRpdGlvbkVudHJ5LmVudHJ5LmlkLnRvTG93ZXJDYXNlKCkgPT09IHJlbmRpdGlvbklkKTtcblxuICAgICAgICBpZiAocmVuZGl0aW9uKSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0dXMgPSByZW5kaXRpb24uZW50cnkuc3RhdHVzLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgICAgIGlmIChzdGF0dXMgPT09ICdOT1RfQ1JFQVRFRCcpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFwaVNlcnZpY2UucmVuZGl0aW9uc0FwaS5jcmVhdGVSZW5kaXRpb24obm9kZUlkLCB7IGlkOiByZW5kaXRpb25JZCB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmVuZGl0aW9uID0gYXdhaXQgdGhpcy53YWl0UmVuZGl0aW9uKG5vZGVJZCwgcmVuZGl0aW9uSWQsIDApO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPFJlbmRpdGlvbkVudHJ5PigocmVzb2x2ZSkgPT4gcmVzb2x2ZShyZW5kaXRpb24pKTtcbiAgICB9XG5cbn1cbiJdfQ==