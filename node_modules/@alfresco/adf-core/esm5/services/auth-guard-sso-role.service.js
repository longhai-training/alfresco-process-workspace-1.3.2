/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
import { JwtHelperService } from './jwt-helper.service';
import { Router } from '@angular/router';
import { StorageService } from './storage.service';
import * as i0 from "@angular/core";
import * as i1 from "./storage.service";
import * as i2 from "./jwt-helper.service";
import * as i3 from "@angular/router";
var AuthGuardSsoRoleService = /** @class */ (function () {
    function AuthGuardSsoRoleService(storageService, jwtHelperService, router) {
        this.storageService = storageService;
        this.jwtHelperService = jwtHelperService;
        this.router = router;
    }
    /**
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    AuthGuardSsoRoleService.prototype.canActivate = /**
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    function (route, state) {
        /** @type {?} */
        var hasRole = false;
        /** @type {?} */
        var hasRealmRole = false;
        /** @type {?} */
        var hasClientRole = true;
        if (route.data) {
            if (route.data['roles']) {
                /** @type {?} */
                var rolesToCheck = route.data['roles'];
                hasRealmRole = this.hasRealmRoles(rolesToCheck);
            }
            if (route.data['clientRoles']) {
                /** @type {?} */
                var clientRoleName = route.params[route.data['clientRoles']];
                /** @type {?} */
                var rolesToCheck = route.data['roles'];
                hasClientRole = this.hasRealmRolesForClientRole(clientRoleName, rolesToCheck);
            }
        }
        hasRole = hasRealmRole && hasClientRole;
        if (!hasRole && route.data && route.data['redirectUrl']) {
            this.router.navigate(['/' + route.data['redirectUrl']]);
        }
        return hasRole;
    };
    /**
     * @return {?}
     */
    AuthGuardSsoRoleService.prototype.getRealmRoles = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var access = this.getValueFromToken('realm_access');
        /** @type {?} */
        var roles = access ? access['roles'] : [];
        return roles;
    };
    /**
     * @param {?} client
     * @return {?}
     */
    AuthGuardSsoRoleService.prototype.getClientRoles = /**
     * @param {?} client
     * @return {?}
     */
    function (client) {
        /** @type {?} */
        var clientRole = this.getValueFromToken('resource_access')[client];
        /** @type {?} */
        var roles = clientRole ? clientRole['roles'] : [];
        return roles;
    };
    /**
     * @return {?}
     */
    AuthGuardSsoRoleService.prototype.getAccessToken = /**
     * @return {?}
     */
    function () {
        return this.storageService.getItem('access_token');
    };
    /**
     * @param {?} role
     * @return {?}
     */
    AuthGuardSsoRoleService.prototype.hasRealmRole = /**
     * @param {?} role
     * @return {?}
     */
    function (role) {
        /** @type {?} */
        var hasRole = false;
        if (this.getAccessToken()) {
            /** @type {?} */
            var realmRoles = this.getRealmRoles();
            hasRole = realmRoles.some((/**
             * @param {?} currentRole
             * @return {?}
             */
            function (currentRole) {
                return currentRole === role;
            }));
        }
        return hasRole;
    };
    /**
     * @param {?} rolesToCheck
     * @return {?}
     */
    AuthGuardSsoRoleService.prototype.hasRealmRoles = /**
     * @param {?} rolesToCheck
     * @return {?}
     */
    function (rolesToCheck) {
        var _this = this;
        return rolesToCheck.some((/**
         * @param {?} currentRole
         * @return {?}
         */
        function (currentRole) {
            return _this.hasRealmRole(currentRole);
        }));
    };
    /**
     * @param {?} clientRole
     * @param {?} rolesToCheck
     * @return {?}
     */
    AuthGuardSsoRoleService.prototype.hasRealmRolesForClientRole = /**
     * @param {?} clientRole
     * @param {?} rolesToCheck
     * @return {?}
     */
    function (clientRole, rolesToCheck) {
        var _this = this;
        return rolesToCheck.some((/**
         * @param {?} currentRole
         * @return {?}
         */
        function (currentRole) {
            return _this.hasClientRole(clientRole, currentRole);
        }));
    };
    /**
     * @param {?} clientRole
     * @param {?} role
     * @return {?}
     */
    AuthGuardSsoRoleService.prototype.hasClientRole = /**
     * @param {?} clientRole
     * @param {?} role
     * @return {?}
     */
    function (clientRole, role) {
        /** @type {?} */
        var hasRole = false;
        if (this.getAccessToken()) {
            /** @type {?} */
            var clientRoles = this.getClientRoles(clientRole);
            hasRole = clientRoles.some((/**
             * @param {?} currentRole
             * @return {?}
             */
            function (currentRole) {
                return currentRole === role;
            }));
        }
        return hasRole;
    };
    /**
     * @template T
     * @param {?} key
     * @return {?}
     */
    AuthGuardSsoRoleService.prototype.getValueFromToken = /**
     * @template T
     * @param {?} key
     * @return {?}
     */
    function (key) {
        /** @type {?} */
        var value;
        /** @type {?} */
        var accessToken = this.getAccessToken();
        if (accessToken) {
            /** @type {?} */
            var tokenPayload = this.jwtHelperService.decodeToken(accessToken);
            value = tokenPayload[key];
        }
        return (/** @type {?} */ (value));
    };
    AuthGuardSsoRoleService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    AuthGuardSsoRoleService.ctorParameters = function () { return [
        { type: StorageService },
        { type: JwtHelperService },
        { type: Router }
    ]; };
    /** @nocollapse */ AuthGuardSsoRoleService.ngInjectableDef = i0.defineInjectable({ factory: function AuthGuardSsoRoleService_Factory() { return new AuthGuardSsoRoleService(i0.inject(i1.StorageService), i0.inject(i2.JwtHelperService), i0.inject(i3.Router)); }, token: AuthGuardSsoRoleService, providedIn: "root" });
    return AuthGuardSsoRoleService;
}());
export { AuthGuardSsoRoleService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    AuthGuardSsoRoleService.prototype.storageService;
    /**
     * @type {?}
     * @private
     */
    AuthGuardSsoRoleService.prototype.jwtHelperService;
    /**
     * @type {?}
     * @private
     */
    AuthGuardSsoRoleService.prototype.router;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1ndWFyZC1zc28tcm9sZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFsZnJlc2NvL2FkZi1jb3JlLyIsInNvdXJjZXMiOlsic2VydmljZXMvYXV0aC1ndWFyZC1zc28tcm9sZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUF1QyxNQUFNLEVBQXVCLE1BQU0saUJBQWlCLENBQUM7QUFDbkcsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7OztBQUVuRDtJQWdDSSxpQ0FBb0IsY0FBOEIsRUFBVSxnQkFBa0MsRUFBVSxNQUFjO1FBQWxHLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUFVLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFRO0lBQ3RILENBQUM7Ozs7OztJQTVCRCw2Q0FBVzs7Ozs7SUFBWCxVQUFZLEtBQTZCLEVBQUUsS0FBMEI7O1lBQzdELE9BQU8sR0FBRyxLQUFLOztZQUNmLFlBQVksR0FBRyxLQUFLOztZQUNwQixhQUFhLEdBQUcsSUFBSTtRQUV4QixJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUU7WUFDWixJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUU7O29CQUNmLFlBQVksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDeEMsWUFBWSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDbkQ7WUFFRCxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUU7O29CQUNyQixjQUFjLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFB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OztJQUFqQixVQUFxQixHQUFXOztZQUN4QixLQUFLOztZQUNILFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ3pDLElBQUksV0FBVyxFQUFFOztnQkFDUCxZQUFZLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUM7WUFDbkUsS0FBSyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUM3QjtRQUNELE9BQU8sbUJBQUksS0FBSyxFQUFBLENBQUM7SUFDckIsQ0FBQzs7Z0JBN0ZKLFVBQVUsU0FBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckI7Ozs7Z0JBSlEsY0FBYztnQkFGZCxnQkFBZ0I7Z0JBQ3FCLE1BQU07OztrQ0FuQnBEO0NBb0hDLEFBOUZELElBOEZDO1NBM0ZZLHVCQUF1Qjs7Ozs7O0lBNkJwQixpREFBc0M7Ozs7O0lBQUUsbURBQTBDOzs7OztJQUFFLHlDQUFzQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEp3dEhlbHBlclNlcnZpY2UgfSBmcm9tICcuL2p3dC1oZWxwZXIuc2VydmljZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBDYW5BY3RpdmF0ZSwgUm91dGVyLCBSb3V0ZXJTdGF0ZVNuYXBzaG90IH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9zdG9yYWdlLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEF1dGhHdWFyZFNzb1JvbGVTZXJ2aWNlIGltcGxlbWVudHMgQ2FuQWN0aXZhdGUge1xuXG4gICAgY2FuQWN0aXZhdGUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIHN0YXRlOiBSb3V0ZXJTdGF0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBoYXNSb2xlID0gZmFsc2U7XG4gICAgICAgIGxldCBoYXNSZWFsbVJvbGUgPSBmYWxzZTtcbiAgICAgICAgbGV0IGhhc0NsaWVudFJvbGUgPSB0cnVlO1xuXG4gICAgICAgIGlmIChyb3V0ZS5kYXRhKSB7XG4gICAgICAgICAgICBpZiAocm91dGUuZGF0YVsncm9sZXMnXSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJvbGVzVG9DaGVjayA9IHJvdXRlLmRhdGFbJ3JvbGVzJ107XG4gICAgICAgICAgICAgICAgaGFzUmVhbG1Sb2xlID0gdGhpcy5oYXNSZWFsbVJvbGVzKHJvbGVzVG9DaGVjayk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyb3V0ZS5kYXRhWydjbGllbnRSb2xlcyddKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2xpZW50Um9sZU5hbWUgPSByb3V0ZS5wYXJhbXNbcm91dGUuZGF0YVsnY2xpZW50Um9sZXMnXV07XG4gICAgICAgICAgICAgICAgY29uc3Qgcm9sZXNUb0NoZWNrID0gcm91dGUuZGF0YVsncm9sZXMnXTtcbiAgICAgICAgICAgICAgICBoYXNDbGllbnRSb2xlID0gdGhpcy5oYXNSZWFsbVJvbGVzRm9yQ2xpZW50Um9sZShjbGllbnRSb2xlTmFtZSwgcm9sZXNUb0NoZWNrKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGhhc1JvbGUgPSBoYXNSZWFsbVJvbGUgJiYgaGFzQ2xpZW50Um9sZTtcblxuICAgICAgICBpZiAoIWhhc1JvbGUgJiYgcm91dGUuZGF0YSAmJiByb3V0ZS5kYXRhWydyZWRpcmVjdFVybCddKSB7XG4gICAgICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJy8nICsgcm91dGUuZGF0YVsncmVkaXJlY3RVcmwnXV0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGhhc1JvbGU7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBzdG9yYWdlU2VydmljZTogU3RvcmFnZVNlcnZpY2UsIHByaXZhdGUgand0SGVscGVyU2VydmljZTogSnd0SGVscGVyU2VydmljZSwgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcikge1xuICAgIH1cblxuICAgIGdldFJlYWxtUm9sZXMoKTogc3RyaW5nW10ge1xuICAgICAgICBjb25zdCBhY2Nlc3MgPSB0aGlzLmdldFZhbHVlRnJvbVRva2VuPGFueT4oJ3JlYWxtX2FjY2VzcycpO1xuICAgICAgICBjb25zdCByb2xlcyA9IGFjY2VzcyA/IGFjY2Vzc1sncm9sZXMnXSA6IFtdO1xuICAgICAgICByZXR1cm4gcm9sZXM7XG4gICAgfVxuXG4gICAgZ2V0Q2xpZW50Um9sZXMoY2xpZW50OiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgICAgIGNvbnN0IGNsaWVudFJvbGUgPSB0aGlzLmdldFZhbHVlRnJvbVRva2VuPGFueT4oJ3Jlc291cmNlX2FjY2VzcycpW2NsaWVudF07XG4gICAgICAgIGNvbnN0IHJvbGVzID0gY2xpZW50Um9sZSA/IGNsaWVudFJvbGVbJ3JvbGVzJ10gOiBbXTtcbiAgICAgICAgcmV0dXJuIHJvbGVzO1xuICAgIH1cblxuICAgIGdldEFjY2Vzc1Rva2VuKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0b3JhZ2VTZXJ2aWNlLmdldEl0ZW0oJ2FjY2Vzc190b2tlbicpO1xuICAgIH1cblxuICAgIGhhc1JlYWxtUm9sZShyb2xlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGhhc1JvbGUgPSBmYWxzZTtcbiAgICAgICAgaWYgKHRoaXMuZ2V0QWNjZXNzVG9rZW4oKSkge1xuICAgICAgICAgICAgY29uc3QgcmVhbG1Sb2xlcyA9IHRoaXMuZ2V0UmVhbG1Sb2xlcygpO1xuICAgICAgICAgICAgaGFzUm9sZSA9IHJlYWxtUm9sZXMuc29tZSgoY3VycmVudFJvbGUpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFJvbGUgPT09IHJvbGU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaGFzUm9sZTtcbiAgICB9XG5cbiAgICBoYXNSZWFsbVJvbGVzKHJvbGVzVG9DaGVjazogc3RyaW5nIFtdKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiByb2xlc1RvQ2hlY2suc29tZSgoY3VycmVudFJvbGUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmhhc1JlYWxtUm9sZShjdXJyZW50Um9sZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGhhc1JlYWxtUm9sZXNGb3JDbGllbnRSb2xlKGNsaWVudFJvbGU6IHN0cmluZywgcm9sZXNUb0NoZWNrOiBzdHJpbmcgW10pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHJvbGVzVG9DaGVjay5zb21lKChjdXJyZW50Um9sZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGFzQ2xpZW50Um9sZShjbGllbnRSb2xlLCBjdXJyZW50Um9sZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGhhc0NsaWVudFJvbGUoY2xpZW50Um9sZSwgcm9sZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBoYXNSb2xlID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLmdldEFjY2Vzc1Rva2VuKCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudFJvbGVzID0gdGhpcy5nZXRDbGllbnRSb2xlcyhjbGllbnRSb2xlKTtcbiAgICAgICAgICAgIGhhc1JvbGUgPSBjbGllbnRSb2xlcy5zb21lKChjdXJyZW50Um9sZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50Um9sZSA9PT0gcm9sZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBoYXNSb2xlO1xuICAgIH1cblxuICAgIGdldFZhbHVlRnJvbVRva2VuPFQ+KGtleTogc3RyaW5nKTogVCB7XG4gICAgICAgIGxldCB2YWx1ZTtcbiAgICAgICAgY29uc3QgYWNjZXNzVG9rZW4gPSB0aGlzLmdldEFjY2Vzc1Rva2VuKCk7XG4gICAgICAgIGlmIChhY2Nlc3NUb2tlbikge1xuICAgICAgICAgICAgY29uc3QgdG9rZW5QYXlsb2FkID0gdGhpcy5qd3RIZWxwZXJTZXJ2aWNlLmRlY29kZVRva2VuKGFjY2Vzc1Rva2VuKTtcbiAgICAgICAgICAgIHZhbHVlID0gdG9rZW5QYXlsb2FkW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIDxUPiB2YWx1ZTtcbiAgICB9XG59XG4iXX0=