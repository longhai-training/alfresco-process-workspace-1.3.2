/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
import { JwtHelperService } from './jwt-helper.service';
import { Router } from '@angular/router';
import { StorageService } from './storage.service';
import * as i0 from "@angular/core";
import * as i1 from "./storage.service";
import * as i2 from "./jwt-helper.service";
import * as i3 from "@angular/router";
export class AuthGuardSsoRoleService {
    /**
     * @param {?} storageService
     * @param {?} jwtHelperService
     * @param {?} router
     */
    constructor(storageService, jwtHelperService, router) {
        this.storageService = storageService;
        this.jwtHelperService = jwtHelperService;
        this.router = router;
    }
    /**
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    canActivate(route, state) {
        /** @type {?} */
        let hasRole = false;
        /** @type {?} */
        let hasRealmRole = false;
        /** @type {?} */
        let hasClientRole = true;
        if (route.data) {
            if (route.data['roles']) {
                /** @type {?} */
                const rolesToCheck = route.data['roles'];
                hasRealmRole = this.hasRealmRoles(rolesToCheck);
            }
            if (route.data['clientRoles']) {
                /** @type {?} */
                const clientRoleName = route.params[route.data['clientRoles']];
                /** @type {?} */
                const rolesToCheck = route.data['roles'];
                hasClientRole = this.hasRealmRolesForClientRole(clientRoleName, rolesToCheck);
            }
        }
        hasRole = hasRealmRole && hasClientRole;
        if (!hasRole && route.data && route.data['redirectUrl']) {
            this.router.navigate(['/' + route.data['redirectUrl']]);
        }
        return hasRole;
    }
    /**
     * @return {?}
     */
    getRealmRoles() {
        /** @type {?} */
        const access = this.getValueFromToken('realm_access');
        /** @type {?} */
        const roles = access ? access['roles'] : [];
        return roles;
    }
    /**
     * @param {?} client
     * @return {?}
     */
    getClientRoles(client) {
        /** @type {?} */
        const clientRole = this.getValueFromToken('resource_access')[client];
        /** @type {?} */
        const roles = clientRole ? clientRole['roles'] : [];
        return roles;
    }
    /**
     * @return {?}
     */
    getAccessToken() {
        return this.storageService.getItem('access_token');
    }
    /**
     * @param {?} role
     * @return {?}
     */
    hasRealmRole(role) {
        /** @type {?} */
        let hasRole = false;
        if (this.getAccessToken()) {
            /** @type {?} */
            const realmRoles = this.getRealmRoles();
            hasRole = realmRoles.some((/**
             * @param {?} currentRole
             * @return {?}
             */
            (currentRole) => {
                return currentRole === role;
            }));
        }
        return hasRole;
    }
    /**
     * @param {?} rolesToCheck
     * @return {?}
     */
    hasRealmRoles(rolesToCheck) {
        return rolesToCheck.some((/**
         * @param {?} currentRole
         * @return {?}
         */
        (currentRole) => {
            return this.hasRealmRole(currentRole);
        }));
    }
    /**
     * @param {?} clientRole
     * @param {?} rolesToCheck
     * @return {?}
     */
    hasRealmRolesForClientRole(clientRole, rolesToCheck) {
        return rolesToCheck.some((/**
         * @param {?} currentRole
         * @return {?}
         */
        (currentRole) => {
            return this.hasClientRole(clientRole, currentRole);
        }));
    }
    /**
     * @param {?} clientRole
     * @param {?} role
     * @return {?}
     */
    hasClientRole(clientRole, role) {
        /** @type {?} */
        let hasRole = false;
        if (this.getAccessToken()) {
            /** @type {?} */
            const clientRoles = this.getClientRoles(clientRole);
            hasRole = clientRoles.some((/**
             * @param {?} currentRole
             * @return {?}
             */
            (currentRole) => {
                return currentRole === role;
            }));
        }
        return hasRole;
    }
    /**
     * @template T
     * @param {?} key
     * @return {?}
     */
    getValueFromToken(key) {
        /** @type {?} */
        let value;
        /** @type {?} */
        const accessToken = this.getAccessToken();
        if (accessToken) {
            /** @type {?} */
            const tokenPayload = this.jwtHelperService.decodeToken(accessToken);
            value = tokenPayload[key];
        }
        return (/** @type {?} */ (value));
    }
}
AuthGuardSsoRoleService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
AuthGuardSsoRoleService.ctorParameters = () => [
    { type: StorageService },
    { type: JwtHelperService },
    { type: Router }
];
/** @nocollapse */ AuthGuardSsoRoleService.ngInjectableDef = i0.defineInjectable({ factory: function AuthGuardSsoRoleService_Factory() { return new AuthGuardSsoRoleService(i0.inject(i1.StorageService), i0.inject(i2.JwtHelperService), i0.inject(i3.Router)); }, token: AuthGuardSsoRoleService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    AuthGuardSsoRoleService.prototype.storageService;
    /**
     * @type {?}
     * @private
     */
    AuthGuardSsoRoleService.prototype.jwtHelperService;
    /**
     * @type {?}
     * @private
     */
    AuthGuardSsoRoleService.prototype.router;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1ndWFyZC1zc28tcm9sZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFsZnJlc2NvL2FkZi1jb3JlLyIsInNvdXJjZXMiOlsic2VydmljZXMvYXV0aC1ndWFyZC1zc28tcm9sZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUF1QyxNQUFNLEVBQXVCLE1BQU0saUJBQWlCLENBQUM7QUFDbkcsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7OztBQUtuRCxNQUFNLE9BQU8sdUJBQXVCOzs7Ozs7SUE2QmhDLFlBQW9CLGNBQThCLEVBQVUsZ0JBQWtDLEVBQVUsTUFBYztRQUFsRyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFBVSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtJQUN0SCxDQUFDOzs7Ozs7SUE1QkQsV0FBVyxDQUFDLEtBQTZCLEVBQUUsS0FBMEI7O1lBQzdELE9BQU8sR0FBRyxLQUFLOztZQUNmLFlBQVksR0FBRyxLQUFLOztZQUNwQixhQUFhLEdBQUcsSUFBSTtRQUV4QixJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUU7WUFDWixJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUU7O3NCQUNmLFlBQVksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDeEMsWUFBWSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDbkQ7WUFFRCxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUU7O3NCQUNyQixjQUFjLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxL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RyxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ3pDLElBQUksV0FBVyxFQUFFOztrQkFDUCxZQUFZLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUM7WUFDbkUsS0FBSyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUM3QjtRQUNELE9BQU8sbUJBQUksS0FBSyxFQUFBLENBQUM7SUFDckIsQ0FBQzs7O1lBN0ZKLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7OztZQUpRLGNBQWM7WUFGZCxnQkFBZ0I7WUFDcUIsTUFBTTs7Ozs7Ozs7SUFtQ3BDLGlEQUFzQzs7Ozs7SUFBRSxtREFBMEM7Ozs7O0lBQUUseUNBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSnd0SGVscGVyU2VydmljZSB9IGZyb20gJy4vand0LWhlbHBlci5zZXJ2aWNlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIENhbkFjdGl2YXRlLCBSb3V0ZXIsIFJvdXRlclN0YXRlU25hcHNob3QgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL3N0b3JhZ2Uuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQXV0aEd1YXJkU3NvUm9sZVNlcnZpY2UgaW1wbGVtZW50cyBDYW5BY3RpdmF0ZSB7XG5cbiAgICBjYW5BY3RpdmF0ZShyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3QpOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGhhc1JvbGUgPSBmYWxzZTtcbiAgICAgICAgbGV0IGhhc1JlYWxtUm9sZSA9IGZhbHNlO1xuICAgICAgICBsZXQgaGFzQ2xpZW50Um9sZSA9IHRydWU7XG5cbiAgICAgICAgaWYgKHJvdXRlLmRhdGEpIHtcbiAgICAgICAgICAgIGlmIChyb3V0ZS5kYXRhWydyb2xlcyddKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgcm9sZXNUb0NoZWNrID0gcm91dGUuZGF0YVsncm9sZXMnXTtcbiAgICAgICAgICAgICAgICBoYXNSZWFsbVJvbGUgPSB0aGlzLmhhc1JlYWxtUm9sZXMocm9sZXNUb0NoZWNrKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJvdXRlLmRhdGFbJ2NsaWVudFJvbGVzJ10pIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRSb2xlTmFtZSA9IHJvdXRlLnBhcmFtc1tyb3V0ZS5kYXRhWydjbGllbnRSb2xlcyddXTtcbiAgICAgICAgICAgICAgICBjb25zdCByb2xlc1RvQ2hlY2sgPSByb3V0ZS5kYXRhWydyb2xlcyddO1xuICAgICAgICAgICAgICAgIGhhc0NsaWVudFJvbGUgPSB0aGlzLmhhc1JlYWxtUm9sZXNGb3JDbGllbnRSb2xlKGNsaWVudFJvbGVOYW1lLCByb2xlc1RvQ2hlY2spO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaGFzUm9sZSA9IGhhc1JlYWxtUm9sZSAmJiBoYXNDbGllbnRSb2xlO1xuXG4gICAgICAgIGlmICghaGFzUm9sZSAmJiByb3V0ZS5kYXRhICYmIHJvdXRlLmRhdGFbJ3JlZGlyZWN0VXJsJ10pIHtcbiAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnLycgKyByb3V0ZS5kYXRhWydyZWRpcmVjdFVybCddXSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaGFzUm9sZTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHN0b3JhZ2VTZXJ2aWNlOiBTdG9yYWdlU2VydmljZSwgcHJpdmF0ZSBqd3RIZWxwZXJTZXJ2aWNlOiBKd3RIZWxwZXJTZXJ2aWNlLCBwcml2YXRlIHJvdXRlcjogUm91dGVyKSB7XG4gICAgfVxuXG4gICAgZ2V0UmVhbG1Sb2xlcygpOiBzdHJpbmdbXSB7XG4gICAgICAgIGNvbnN0IGFjY2VzcyA9IHRoaXMuZ2V0VmFsdWVGcm9tVG9rZW48YW55PigncmVhbG1fYWNjZXNzJyk7XG4gICAgICAgIGNvbnN0IHJvbGVzID0gYWNjZXNzID8gYWNjZXNzWydyb2xlcyddIDogW107XG4gICAgICAgIHJldHVybiByb2xlcztcbiAgICB9XG5cbiAgICBnZXRDbGllbnRSb2xlcyhjbGllbnQ6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICAgICAgY29uc3QgY2xpZW50Um9sZSA9IHRoaXMuZ2V0VmFsdWVGcm9tVG9rZW48YW55PigncmVzb3VyY2VfYWNjZXNzJylbY2xpZW50XTtcbiAgICAgICAgY29uc3Qgcm9sZXMgPSBjbGllbnRSb2xlID8gY2xpZW50Um9sZVsncm9sZXMnXSA6IFtdO1xuICAgICAgICByZXR1cm4gcm9sZXM7XG4gICAgfVxuXG4gICAgZ2V0QWNjZXNzVG9rZW4oKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0SXRlbSgnYWNjZXNzX3Rva2VuJyk7XG4gICAgfVxuXG4gICAgaGFzUmVhbG1Sb2xlKHJvbGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgaGFzUm9sZSA9IGZhbHNlO1xuICAgICAgICBpZiAodGhpcy5nZXRBY2Nlc3NUb2tlbigpKSB7XG4gICAgICAgICAgICBjb25zdCByZWFsbVJvbGVzID0gdGhpcy5nZXRSZWFsbVJvbGVzKCk7XG4gICAgICAgICAgICBoYXNSb2xlID0gcmVhbG1Sb2xlcy5zb21lKChjdXJyZW50Um9sZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50Um9sZSA9PT0gcm9sZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBoYXNSb2xlO1xuICAgIH1cblxuICAgIGhhc1JlYWxtUm9sZXMocm9sZXNUb0NoZWNrOiBzdHJpbmcgW10pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHJvbGVzVG9DaGVjay5zb21lKChjdXJyZW50Um9sZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGFzUmVhbG1Sb2xlKGN1cnJlbnRSb2xlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgaGFzUmVhbG1Sb2xlc0ZvckNsaWVudFJvbGUoY2xpZW50Um9sZTogc3RyaW5nLCByb2xlc1RvQ2hlY2s6IHN0cmluZyBbXSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gcm9sZXNUb0NoZWNrLnNvbWUoKGN1cnJlbnRSb2xlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5oYXNDbGllbnRSb2xlKGNsaWVudFJvbGUsIGN1cnJlbnRSb2xlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgaGFzQ2xpZW50Um9sZShjbGllbnRSb2xlLCByb2xlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGhhc1JvbGUgPSBmYWxzZTtcbiAgICAgICAgaWYgKHRoaXMuZ2V0QWNjZXNzVG9rZW4oKSkge1xuICAgICAgICAgICAgY29uc3QgY2xpZW50Um9sZXMgPSB0aGlzLmdldENsaWVudFJvbGVzKGNsaWVudFJvbGUpO1xuICAgICAgICAgICAgaGFzUm9sZSA9IGNsaWVudFJvbGVzLnNvbWUoKGN1cnJlbnRSb2xlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRSb2xlID09PSByb2xlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGhhc1JvbGU7XG4gICAgfVxuXG4gICAgZ2V0VmFsdWVGcm9tVG9rZW48VD4oa2V5OiBzdHJpbmcpOiBUIHtcbiAgICAgICAgbGV0IHZhbHVlO1xuICAgICAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IHRoaXMuZ2V0QWNjZXNzVG9rZW4oKTtcbiAgICAgICAgaWYgKGFjY2Vzc1Rva2VuKSB7XG4gICAgICAgICAgICBjb25zdCB0b2tlblBheWxvYWQgPSB0aGlzLmp3dEhlbHBlclNlcnZpY2UuZGVjb2RlVG9rZW4oYWNjZXNzVG9rZW4pO1xuICAgICAgICAgICAgdmFsdWUgPSB0b2tlblBheWxvYWRba2V5XTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gPFQ+IHZhbHVlO1xuICAgIH1cbn1cbiJdfQ==