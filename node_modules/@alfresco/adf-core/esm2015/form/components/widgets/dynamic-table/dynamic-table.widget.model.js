/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* tslint:disable:component-selector  */
import moment from 'moment-es6';
import { ValidateDynamicTableRowEvent } from '../../../events/validate-dynamic-table-row.event';
import { FormWidgetModel } from './../core/form-widget.model';
import { DateCellValidator } from './date-cell-validator-model';
import { DynamicRowValidationSummary } from './dynamic-row-validation-summary.model';
import { NumberCellValidator } from './number-cell-validator.model';
import { RequiredCellValidator } from './required-cell-validator.model';
export class DynamicTableModel extends FormWidgetModel {
    /**
     * @param {?} field
     * @param {?} formService
     */
    constructor(field, formService) {
        super(field.form, field.json);
        this.formService = formService;
        this.columns = [];
        this.visibleColumns = [];
        this.rows = [];
        this._validators = [];
        this.field = field;
        if (field.json) {
            /** @type {?} */
            const columns = this.getColumns(field);
            if (columns) {
                this.columns = columns;
                this.visibleColumns = this.columns.filter((/**
                 * @param {?} col
                 * @return {?}
                 */
                (col) => col.visible));
            }
            if (field.json.value) {
                this.rows = field.json.value.map((/**
                 * @param {?} obj
                 * @return {?}
                 */
                (obj) => (/** @type {?} */ ({ selected: false, value: obj }))));
            }
        }
        this._validators = [
            new RequiredCellValidator(),
            new DateCellValidator(),
            new NumberCellValidator()
        ];
    }
    /**
     * @return {?}
     */
    get selectedRow() {
        return this._selectedRow;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set selectedRow(value) {
        if (this._selectedRow && this._selectedRow === value) {
            this._selectedRow.selected = false;
            this._selectedRow = null;
            return;
        }
        this.rows.forEach((/**
         * @param {?} row
         * @return {?}
         */
        (row) => row.selected = false));
        this._selectedRow = value;
        if (value) {
            this._selectedRow.selected = true;
        }
    }
    /**
     * @private
     * @param {?} field
     * @return {?}
     */
    getColumns(field) {
        if (field && field.json) {
            /** @type {?} */
            let definitions = field.json.columnDefinitions;
            if (!definitions && field.json.params && field.json.params.field) {
                definitions = field.json.params.field.columnDefinitions;
            }
            if (definitions) {
                return definitions.map((/**
                 * @param {?} obj
                 * @return {?}
                 */
                (obj) => (/** @type {?} */ (obj))));
            }
        }
        return null;
    }
    /**
     * @return {?}
     */
    flushValue() {
        if (this.field) {
            this.field.value = this.rows.map((/**
             * @param {?} r
             * @return {?}
             */
            (r) => r.value));
            this.field.updateForm();
        }
    }
    /**
     * @param {?} row
     * @param {?} offset
     * @return {?}
     */
    moveRow(row, offset) {
        /** @type {?} */
        const oldIndex = this.rows.indexOf(row);
        if (oldIndex > -1) {
            /** @type {?} */
            let newIndex = (oldIndex + offset);
            if (newIndex < 0) {
                newIndex = 0;
            }
            else if (newIndex >= this.rows.length) {
                newIndex = this.rows.length;
            }
            /** @type {?} */
            const arr = this.rows.slice();
            arr.splice(oldIndex, 1);
            arr.splice(newIndex, 0, row);
            this.rows = arr;
            this.flushValue();
        }
    }
    /**
     * @param {?} row
     * @return {?}
     */
    deleteRow(row) {
        if (row) {
            if (this.selectedRow === row) {
                this.selectedRow = null;
            }
            /** @type {?} */
            const idx = this.rows.indexOf(row);
            if (idx > -1) {
                this.rows.splice(idx, 1);
                this.flushValue();
            }
        }
    }
    /**
     * @param {?} row
     * @return {?}
     */
    addRow(row) {
        if (row) {
            this.rows.push(row);
            // this.selectedRow = row;
        }
    }
    /**
     * @param {?} row
     * @return {?}
     */
    validateRow(row) {
        /** @type {?} */
        const summary = new DynamicRowValidationSummary({
            isValid: true,
            message: null
        });
        /** @type {?} */
        const event = new ValidateDynamicTableRowEvent(this.form, this.field, row, summary);
        this.formService.validateDynamicTableRow.next(event);
        if (event.defaultPrevented || !summary.isValid) {
            return summary;
        }
        if (row) {
            for (const col of this.columns) {
                for (const validator of this._validators) {
                    if (!validator.validate(row, col, summary)) {
                        return summary;
                    }
                }
            }
        }
        return summary;
    }
    /**
     * @param {?} row
     * @param {?} column
     * @return {?}
     */
    getCellValue(row, column) {
        /** @type {?} */
        const rowValue = row.value[column.id];
        if (column.type === 'Dropdown') {
            if (rowValue) {
                return rowValue.name;
            }
        }
        if (column.type === 'Boolean') {
            return rowValue ? true : false;
        }
        if (column.type === 'Date') {
            if (rowValue) {
                return moment(rowValue.split('T')[0], 'YYYY-MM-DD').format('DD-MM-YYYY');
            }
        }
        return rowValue || '';
    }
    /**
     * @param {?} column
     * @return {?}
     */
    getDisplayText(column) {
        /** @type {?} */
        let columnName = column.name;
        if (column.type === 'Amount') {
            /** @type {?} */
            const currency = column.amountCurrency || '$';
            columnName = `${column.name} (${currency})`;
        }
        return columnName;
    }
}
if (false) {
    /** @type {?} */
    DynamicTableModel.prototype.field;
    /** @type {?} */
    DynamicTableModel.prototype.columns;
    /** @type {?} */
    DynamicTableModel.prototype.visibleColumns;
    /** @type {?} */
    DynamicTableModel.prototype.rows;
    /**
     * @type {?}
     * @private
     */
    DynamicTableModel.prototype._selectedRow;
    /**
     * @type {?}
     * @private
     */
    DynamicTableModel.prototype._validators;
    /**
     * @type {?}
     * @private
     */
    DynamicTableModel.prototype.formService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy10YWJsZS53aWRnZXQubW9kZWwuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvcmUvIiwic291cmNlcyI6WyJmb3JtL2NvbXBvbmVudHMvd2lkZ2V0cy9keW5hbWljLXRhYmxlL2R5bmFtaWMtdGFibGUud2lkZ2V0Lm1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW1CQSxPQUFPLE1BQU0sTUFBTSxZQUFZLENBQUM7QUFDaEMsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFHaEcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRTlELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ2hFLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBR3JGLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRXhFLE1BQU0sT0FBTyxpQkFBa0IsU0FBUSxlQUFlOzs7OztJQThCbEQsWUFBWSxLQUFxQixFQUFVLFdBQXdCO1FBQy9ELEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQURTLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBM0JuRSxZQUFPLEdBQXlCLEVBQUUsQ0FBQztRQUNuQyxtQkFBYyxHQUF5QixFQUFFLENBQUM7UUFDMUMsU0FBSSxHQUFzQixFQUFFLENBQUM7UUFHckIsZ0JBQVcsR0FBb0IsRUFBRSxDQUFDO1FBd0J0QyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUU7O2tCQUNOLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQztZQUN0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SyxNQUFNLEVBQUU7WUFDeEIsSUFBSSxRQUFRLEVBQUU7Z0JBQ1YsT0FBTyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxZQUFZLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDNUU7U0FDSjtRQUVELE9BQU8sUUFBUSxJQUFJLEVBQUUsQ0FBQztJQUMxQixDQUFDOzs7OztJQUVELGNBQWMsQ0FBQyxNQUEwQjs7WUFDakMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJO1FBQzVCLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7O2tCQUNwQixRQUFRLEdBQUcsTUFBTSxDQUFDLGNBQWMsSUFBSSxHQUFHO1lBQzdDLFVBQVUsR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEtBQUssUUFBUSxHQUFHLENBQUM7U0FDL0M7UUFDRCxPQUFPLFVBQVUsQ0FBQztJQUN0QixDQUFDO0NBQ0o7OztJQXhLRyxrQ0FBc0I7O0lBQ3RCLG9DQUFtQzs7SUFDbkMsMkNBQTBDOztJQUMxQyxpQ0FBNkI7Ozs7O0lBRTdCLHlDQUFzQzs7Ozs7SUFDdEMsd0NBQTBDOzs7OztJQXNCUCx3Q0FBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4gLyogdHNsaW50OmRpc2FibGU6Y29tcG9uZW50LXNlbGVjdG9yICAqL1xuXG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudC1lczYnO1xuaW1wb3J0IHsgVmFsaWRhdGVEeW5hbWljVGFibGVSb3dFdmVudCB9IGZyb20gJy4uLy4uLy4uL2V2ZW50cy92YWxpZGF0ZS1keW5hbWljLXRhYmxlLXJvdy5ldmVudCc7XG5pbXBvcnQgeyBGb3JtU2VydmljZSB9IGZyb20gJy4vLi4vLi4vLi4vc2VydmljZXMvZm9ybS5zZXJ2aWNlJztcbmltcG9ydCB7IEZvcm1GaWVsZE1vZGVsIH0gZnJvbSAnLi8uLi9jb3JlL2Zvcm0tZmllbGQubW9kZWwnO1xuaW1wb3J0IHsgRm9ybVdpZGdldE1vZGVsIH0gZnJvbSAnLi8uLi9jb3JlL2Zvcm0td2lkZ2V0Lm1vZGVsJztcbmltcG9ydCB7IENlbGxWYWxpZGF0b3IgfSBmcm9tICcuL2NlbGwtdmFsaWRhdG9yLm1vZGVsJztcbmltcG9ydCB7IERhdGVDZWxsVmFsaWRhdG9yIH0gZnJvbSAnLi9kYXRlLWNlbGwtdmFsaWRhdG9yLW1vZGVsJztcbmltcG9ydCB7IER5bmFtaWNSb3dWYWxpZGF0aW9uU3VtbWFyeSB9IGZyb20gJy4vZHluYW1pYy1yb3ctdmFsaWRhdGlvbi1zdW1tYXJ5Lm1vZGVsJztcbmltcG9ydCB7IER5bmFtaWNUYWJsZUNvbHVtbiB9IGZyb20gJy4vZHluYW1pYy10YWJsZS1jb2x1bW4ubW9kZWwnO1xuaW1wb3J0IHsgRHluYW1pY1RhYmxlUm93IH0gZnJvbSAnLi9keW5hbWljLXRhYmxlLXJvdy5tb2RlbCc7XG5pbXBvcnQgeyBOdW1iZXJDZWxsVmFsaWRhdG9yIH0gZnJvbSAnLi9udW1iZXItY2VsbC12YWxpZGF0b3IubW9kZWwnO1xuaW1wb3J0IHsgUmVxdWlyZWRDZWxsVmFsaWRhdG9yIH0gZnJvbSAnLi9yZXF1aXJlZC1jZWxsLXZhbGlkYXRvci5tb2RlbCc7XG5cbmV4cG9ydCBjbGFzcyBEeW5hbWljVGFibGVNb2RlbCBleHRlbmRzIEZvcm1XaWRnZXRNb2RlbCB7XG5cbiAgICBmaWVsZDogRm9ybUZpZWxkTW9kZWw7XG4gICAgY29sdW1uczogRHluYW1pY1RhYmxlQ29sdW1uW10gPSBbXTtcbiAgICB2aXNpYmxlQ29sdW1uczogRHluYW1pY1RhYmxlQ29sdW1uW10gPSBbXTtcbiAgICByb3dzOiBEeW5hbWljVGFibGVSb3dbXSA9IFtdO1xuXG4gICAgcHJpdmF0ZSBfc2VsZWN0ZWRSb3c6IER5bmFtaWNUYWJsZVJvdztcbiAgICBwcml2YXRlIF92YWxpZGF0b3JzOiBDZWxsVmFsaWRhdG9yW10gPSBbXTtcblxuICAgIGdldCBzZWxlY3RlZFJvdygpOiBEeW5hbWljVGFibGVSb3cge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0ZWRSb3c7XG4gICAgfVxuXG4gICAgc2V0IHNlbGVjdGVkUm93KHZhbHVlOiBEeW5hbWljVGFibGVSb3cpIHtcbiAgICAgICAgaWYgKHRoaXMuX3NlbGVjdGVkUm93ICYmIHRoaXMuX3NlbGVjdGVkUm93ID09PSB2YWx1ZSkge1xuICAgICAgICAgICAgdGhpcy5fc2VsZWN0ZWRSb3cuc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMuX3NlbGVjdGVkUm93ID0gbnVsbDtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucm93cy5mb3JFYWNoKChyb3cpID0+IHJvdy5zZWxlY3RlZCA9IGZhbHNlKTtcblxuICAgICAgICB0aGlzLl9zZWxlY3RlZFJvdyA9IHZhbHVlO1xuXG4gICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgdGhpcy5fc2VsZWN0ZWRSb3cuc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoZmllbGQ6IEZvcm1GaWVsZE1vZGVsLCBwcml2YXRlIGZvcm1TZXJ2aWNlOiBGb3JtU2VydmljZSkge1xuICAgICAgICBzdXBlcihmaWVsZC5mb3JtLCBmaWVsZC5qc29uKTtcbiAgICAgICAgdGhpcy5maWVsZCA9IGZpZWxkO1xuXG4gICAgICAgIGlmIChmaWVsZC5qc29uKSB7XG4gICAgICAgICAgICBjb25zdCBjb2x1bW5zID0gdGhpcy5nZXRDb2x1bW5zKGZpZWxkKTtcbiAgICAgICAgICAgIGlmIChjb2x1bW5zKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb2x1bW5zID0gY29sdW1ucztcbiAgICAgICAgICAgICAgICB0aGlzLnZpc2libGVDb2x1bW5zID0gdGhpcy5jb2x1bW5zLmZpbHRlcigoY29sKSA9PiBjb2wudmlzaWJsZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChmaWVsZC5qc29uLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yb3dzID0gZmllbGQuanNvbi52YWx1ZS5tYXAoKG9iaikgPT4gPER5bmFtaWNUYWJsZVJvdz4ge3NlbGVjdGVkOiBmYWxzZSwgdmFsdWU6IG9ian0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fdmFsaWRhdG9ycyA9IFtcbiAgICAgICAgICAgIG5ldyBSZXF1aXJlZENlbGxWYWxpZGF0b3IoKSxcbiAgICAgICAgICAgIG5ldyBEYXRlQ2VsbFZhbGlkYXRvcigpLFxuICAgICAgICAgICAgbmV3IE51bWJlckNlbGxWYWxpZGF0b3IoKVxuICAgICAgICBdO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Q29sdW1ucyhmaWVsZDogRm9ybUZpZWxkTW9kZWwpOiBEeW5hbWljVGFibGVDb2x1bW5bXSB7XG4gICAgICAgIGlmIChmaWVsZCAmJiBmaWVsZC5qc29uKSB7XG4gICAgICAgICAgICBsZXQgZGVmaW5pdGlvbnMgPSBmaWVsZC5qc29uLmNvbHVtbkRlZmluaXRpb25zO1xuICAgICAgICAgICAgaWYgKCFkZWZpbml0aW9ucyAmJiBmaWVsZC5qc29uLnBhcmFtcyAmJiBmaWVsZC5qc29uLnBhcmFtcy5maWVsZCkge1xuICAgICAgICAgICAgICAgIGRlZmluaXRpb25zID0gZmllbGQuanNvbi5wYXJhbXMuZmllbGQuY29sdW1uRGVmaW5pdGlvbnM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChkZWZpbml0aW9ucykge1xuICAgICAgICAgICAgICAgIHJldHVybiBkZWZpbml0aW9ucy5tYXAoKG9iaikgPT4gPER5bmFtaWNUYWJsZUNvbHVtbj4gb2JqKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBmbHVzaFZhbHVlKCkge1xuICAgICAgICBpZiAodGhpcy5maWVsZCkge1xuICAgICAgICAgICAgdGhpcy5maWVsZC52YWx1ZSA9IHRoaXMucm93cy5tYXAoKHIpID0+IHIudmFsdWUpO1xuICAgICAgICAgICAgdGhpcy5maWVsZC51cGRhdGVGb3JtKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBtb3ZlUm93KHJvdzogRHluYW1pY1RhYmxlUm93LCBvZmZzZXQ6IG51bWJlcikge1xuICAgICAgICBjb25zdCBvbGRJbmRleCA9IHRoaXMucm93cy5pbmRleE9mKHJvdyk7XG4gICAgICAgIGlmIChvbGRJbmRleCA+IC0xKSB7XG4gICAgICAgICAgICBsZXQgbmV3SW5kZXggPSAob2xkSW5kZXggKyBvZmZzZXQpO1xuXG4gICAgICAgICAgICBpZiAobmV3SW5kZXggPCAwKSB7XG4gICAgICAgICAgICAgICAgbmV3SW5kZXggPSAwO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChuZXdJbmRleCA+PSB0aGlzLnJvd3MubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgbmV3SW5kZXggPSB0aGlzLnJvd3MubGVuZ3RoO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBhcnIgPSB0aGlzLnJvd3Muc2xpY2UoKTtcbiAgICAgICAgICAgIGFyci5zcGxpY2Uob2xkSW5kZXgsIDEpO1xuICAgICAgICAgICAgYXJyLnNwbGljZShuZXdJbmRleCwgMCwgcm93KTtcbiAgICAgICAgICAgIHRoaXMucm93cyA9IGFycjtcblxuICAgICAgICAgICAgdGhpcy5mbHVzaFZhbHVlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkZWxldGVSb3cocm93OiBEeW5hbWljVGFibGVSb3cpIHtcbiAgICAgICAgaWYgKHJvdykge1xuICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRSb3cgPT09IHJvdykge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRSb3cgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgaWR4ID0gdGhpcy5yb3dzLmluZGV4T2Yocm93KTtcbiAgICAgICAgICAgIGlmIChpZHggPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMucm93cy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZsdXNoVmFsdWUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFkZFJvdyhyb3c6IER5bmFtaWNUYWJsZVJvdykge1xuICAgICAgICBpZiAocm93KSB7XG4gICAgICAgICAgICB0aGlzLnJvd3MucHVzaChyb3cpO1xuICAgICAgICAgICAgLy8gdGhpcy5zZWxlY3RlZFJvdyA9IHJvdztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHZhbGlkYXRlUm93KHJvdzogRHluYW1pY1RhYmxlUm93KTogRHluYW1pY1Jvd1ZhbGlkYXRpb25TdW1tYXJ5IHtcbiAgICAgICAgY29uc3Qgc3VtbWFyeSA9IG5ldyBEeW5hbWljUm93VmFsaWRhdGlvblN1bW1hcnkoIHtcbiAgICAgICAgICAgIGlzVmFsaWQ6IHRydWUsXG4gICAgICAgICAgICBtZXNzYWdlOiBudWxsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGV2ZW50ID0gbmV3IFZhbGlkYXRlRHluYW1pY1RhYmxlUm93RXZlbnQodGhpcy5mb3JtLCB0aGlzLmZpZWxkLCByb3csIHN1bW1hcnkpO1xuICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlLnZhbGlkYXRlRHluYW1pY1RhYmxlUm93Lm5leHQoZXZlbnQpO1xuXG4gICAgICAgIGlmIChldmVudC5kZWZhdWx0UHJldmVudGVkIHx8ICFzdW1tYXJ5LmlzVmFsaWQpIHtcbiAgICAgICAgICAgIHJldHVybiBzdW1tYXJ5O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJvdykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBjb2wgb2YgdGhpcy5jb2x1bW5zKSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCB2YWxpZGF0b3Igb2YgdGhpcy5fdmFsaWRhdG9ycykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkYXRvci52YWxpZGF0ZShyb3csIGNvbCwgc3VtbWFyeSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdW1tYXJ5O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHN1bW1hcnk7XG4gICAgfVxuXG4gICAgZ2V0Q2VsbFZhbHVlKHJvdzogRHluYW1pY1RhYmxlUm93LCBjb2x1bW46IER5bmFtaWNUYWJsZUNvbHVtbik6IGFueSB7XG4gICAgICAgIGNvbnN0IHJvd1ZhbHVlID0gcm93LnZhbHVlW2NvbHVtbi5pZF07XG5cbiAgICAgICAgaWYgKGNvbHVtbi50eXBlID09PSAnRHJvcGRvd24nKSB7XG4gICAgICAgICAgICBpZiAocm93VmFsdWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcm93VmFsdWUubmFtZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb2x1bW4udHlwZSA9PT0gJ0Jvb2xlYW4nKSB7XG4gICAgICAgICAgICByZXR1cm4gcm93VmFsdWUgPyB0cnVlIDogZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29sdW1uLnR5cGUgPT09ICdEYXRlJykge1xuICAgICAgICAgICAgaWYgKHJvd1ZhbHVlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG1vbWVudChyb3dWYWx1ZS5zcGxpdCgnVCcpWzBdLCAnWVlZWS1NTS1ERCcpLmZvcm1hdCgnREQtTU0tWVlZWScpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJvd1ZhbHVlIHx8ICcnO1xuICAgIH1cblxuICAgIGdldERpc3BsYXlUZXh0KGNvbHVtbjogRHluYW1pY1RhYmxlQ29sdW1uKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IGNvbHVtbk5hbWUgPSBjb2x1bW4ubmFtZTtcbiAgICAgICAgaWYgKGNvbHVtbi50eXBlID09PSAnQW1vdW50Jykge1xuICAgICAgICAgICAgY29uc3QgY3VycmVuY3kgPSBjb2x1bW4uYW1vdW50Q3VycmVuY3kgfHwgJyQnO1xuICAgICAgICAgICAgY29sdW1uTmFtZSA9IGAke2NvbHVtbi5uYW1lfSAoJHtjdXJyZW5jeX0pYDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29sdW1uTmFtZTtcbiAgICB9XG59XG4iXX0=