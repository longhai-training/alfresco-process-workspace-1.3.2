/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { HttpClient } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { ObjectUtils } from '../utils/object-utils';
import { Subject } from 'rxjs';
import { map, distinctUntilChanged } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
/** @enum {string} */
const AppConfigValues = {
    APP_CONFIG_LANGUAGES_KEY: 'languages',
    PROVIDERS: 'providers',
    OAUTHCONFIG: 'oauth2',
    ECMHOST: 'ecmHost',
    BASESHAREURL: 'baseShareUrl',
    BPMHOST: 'bpmHost',
    IDENTITY_HOST: 'identityHost',
    AUTHTYPE: 'authType',
    CONTEXTROOTECM: 'contextRootEcm',
    CONTEXTROOTBPM: 'contextRootBpm',
    ALFRESCO_REPOSITORY_NAME: 'alfrescoRepositoryName',
    LOG_LEVEL: 'logLevel',
    LOGIN_ROUTE: 'loginRoute',
    DISABLECSRF: 'disableCSRF',
    AUTH_WITH_CREDENTIALS: 'auth.withCredentials',
    APPLICATION: 'application',
    NOTIFY_DURATION: 'notificationDefaultDuration',
};
export { AppConfigValues };
/** @enum {string} */
const Status = {
    INIT: 'init',
    LOADING: 'loading',
    LOADED: 'loaded',
};
export { Status };
/* spellchecker: enable */
export class AppConfigService {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
        this.config = {
            application: {
                name: 'Alfresco ADF Application'
            },
            ecmHost: 'http://{hostname}{:port}/ecm',
            bpmHost: 'http://{hostname}{:port}/bpm',
            logLevel: 'silent',
            alfrescoRepositoryName: 'alfresco-1'
        };
        this.status = Status.INIT;
        this.onLoadSubject = new Subject();
        this.onLoad = this.onLoadSubject.asObservable();
    }
    /**
     * Requests notification of a property value when it is loaded.
     * @param {?} property The desired property value
     * @return {?} Property value, when loaded
     */
    select(property) {
        return this.onLoadSubject
            .pipe(map((/**
         * @param {?} config
         * @return {?}
         */
        (config) => config[property])), distinctUntilChanged());
    }
    /**
     * Gets the value of a named property.
     * @template T
     * @param {?} key Name of the property
     * @param {?=} defaultValue Value to return if the key is not found
     * @return {?} Value of the property
     */
    get(key, defaultValue) {
        /** @type {?} */
        let result = ObjectUtils.getValue(this.config, key);
        if (typeof result === 'string') {
            /** @type {?} */
            const keywords = new Map();
            keywords.set('hostname', this.getLocationHostname());
            keywords.set(':port', this.getLocationPort(':'));
            keywords.set('port', this.getLocationPort());
            keywords.set('protocol', this.getLocationProtocol());
            result = this.formatString(result, keywords);
        }
        if (result === undefined) {
            return defaultValue;
        }
        return (/** @type {?} */ (result));
    }
    /**
     * Gets the location.protocol value.
     * @return {?} The location.protocol string
     */
    getLocationProtocol() {
        return location.protocol;
    }
    /**
     * Gets the location.hostname property.
     * @return {?} Value of the property
     */
    getLocationHostname() {
        return location.hostname;
    }
    /**
     * Gets the location.port property.
     * @param {?=} prefix Text added before port value
     * @return {?} Port with prefix
     */
    getLocationPort(prefix = '') {
        return location.port ? prefix + location.port : '';
    }
    /**
     * Loads the config file.
     * @return {?} Notification when loading is complete
     */
    load() {
        return new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        (resolve) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const configUrl = `app.config.json?v=${Date.now()}`;
            if (this.status === Status.INIT) {
                this.status = Status.LOADING;
                yield this.http.get(configUrl).subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                (data) => {
                    this.status = Status.LOADED;
                    this.config = Object.assign({}, this.config, data || {});
                    this.onLoadSubject.next(this.config);
                    resolve(this.config);
                }), (/**
                 * @return {?}
                 */
                () => {
                    resolve(this.config);
                }));
            }
            else if (this.status === Status.LOADED) {
                resolve(this.config);
            }
            else if (this.status === Status.LOADING) {
                this.onLoad.subscribe((/**
                 * @return {?}
                 */
                () => {
                    resolve(this.config);
                }));
            }
        })));
    }
    /**
     * @private
     * @param {?} str
     * @param {?} keywords
     * @return {?}
     */
    formatString(str, keywords) {
        /** @type {?} */
        let result = str;
        keywords.forEach((/**
         * @param {?} value
         * @param {?} key
         * @return {?}
         */
        (value, key) => {
            /** @type {?} */
            const expr = new RegExp('{' + key + '}', 'gm');
            result = result.replace(expr, value);
        }));
        return result;
    }
}
AppConfigService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
AppConfigService.ctorParameters = () => [
    { type: HttpClient }
];
/** @nocollapse */ AppConfigService.ngInjectableDef = i0.defineInjectable({ factory: function AppConfigService_Factory() { return new AppConfigService(i0.inject(i1.HttpClient)); }, token: AppConfigService, providedIn: "root" });
if (false) {
    /** @type {?} */
    AppConfigService.prototype.config;
    /** @type {?} */
    AppConfigService.prototype.status;
    /**
     * @type {?}
     * @protected
     */
    AppConfigService.prototype.onLoadSubject;
    /** @type {?} */
    AppConfigService.prototype.onLoad;
    /**
     * @type {?}
     * @private
     */
    AppConfigService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLWNvbmZpZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFsZnJlc2NvL2FkZi1jb3JlLyIsInNvdXJjZXMiOlsiYXBwLWNvbmZpZy9hcHAtY29uZmlnLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNwRCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxHQUFHLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7SUFJdkQsMEJBQTJCLFdBQVc7SUFDdEMsV0FBWSxXQUFXO0lBQ3ZCLGFBQWMsUUFBUTtJQUN0QixTQUFVLFNBQVM7SUFDbkIsY0FBZSxjQUFjO0lBQzdCLFNBQVUsU0FBUztJQUNuQixlQUFnQixjQUFjO0lBQzlCLFVBQVcsVUFBVTtJQUNyQixnQkFBaUIsZ0JBQWdCO0lBQ2pDLGdCQUFpQixnQkFBZ0I7SUFDakMsMEJBQTJCLHdCQUF3QjtJQUNuRCxXQUFZLFVBQVU7SUFDdEIsYUFBYyxZQUFZO0lBQzFCLGFBQWMsYUFBYTtJQUMzQix1QkFBd0Isc0JBQXNCO0lBQzlDLGFBQWMsYUFBYTtJQUMzQixpQkFBa0IsNkJBQTZCOzs7OztJQUkvQyxNQUFPLE1BQU07SUFDYixTQUFVLFNBQVM7SUFDbkIsUUFBUyxRQUFROzs7O0FBUXJCLE1BQU0sT0FBTyxnQkFBZ0I7Ozs7SUFnQnpCLFlBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7UUFkcEMsV0FBTSxHQUFRO1lBQ1YsV0FBVyxFQUFFO2dCQUNULElBQUksRUFBRSwwQkFBMEI7YUFDbkM7WUFDRCxPQUFPLEVBQUUsOEJB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bnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JqZWN0VXRpbHMgfSBmcm9tICcuLi91dGlscy9vYmplY3QtdXRpbHMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuLyogc3BlbGxjaGVja2VyOiBkaXNhYmxlICovXG5leHBvcnQgZW51bSBBcHBDb25maWdWYWx1ZXMge1xuICAgIEFQUF9DT05GSUdfTEFOR1VBR0VTX0tFWSA9ICdsYW5ndWFnZXMnLFxuICAgIFBST1ZJREVSUyA9ICdwcm92aWRlcnMnLFxuICAgIE9BVVRIQ09ORklHID0gJ29hdXRoMicsXG4gICAgRUNNSE9TVCA9ICdlY21Ib3N0JyxcbiAgICBCQVNFU0hBUkVVUkwgPSAnYmFzZVNoYXJlVXJsJyxcbiAgICBCUE1IT1NUID0gJ2JwbUhvc3QnLFxuICAgIElERU5USVRZX0hPU1QgPSAnaWRlbnRpdHlIb3N0JyxcbiAgICBBVVRIVFlQRSA9ICdhdXRoVHlwZScsXG4gICAgQ09OVEVYVFJPT1RFQ00gPSAnY29udGV4dFJvb3RFY20nLFxuICAgIENPTlRFWFRST09UQlBNID0gJ2NvbnRleHRSb290QnBtJyxcbiAgICBBTEZSRVNDT19SRVBPU0lUT1JZX05BTUUgPSAnYWxmcmVzY29SZXBvc2l0b3J5TmFtZScsXG4gICAgTE9HX0xFVkVMID0gJ2xvZ0xldmVsJyxcbiAgICBMT0dJTl9ST1VURSA9ICdsb2dpblJvdXRlJyxcbiAgICBESVNBQkxFQ1NSRiA9ICdkaXNhYmxlQ1NSRicsXG4gICAgQVVUSF9XSVRIX0NSRURFTlRJQUxTID0gJ2F1dGgud2l0aENyZWRlbnRpYWxzJyxcbiAgICBBUFBMSUNBVElPTiA9ICdhcHBsaWNhdGlvbicsXG4gICAgTk9USUZZX0RVUkFUSU9OID0gJ25vdGlmaWNhdGlvbkRlZmF1bHREdXJhdGlvbidcbn1cblxuZXhwb3J0IGVudW0gU3RhdHVzIHtcbiAgICBJTklUID0gJ2luaXQnLFxuICAgIExPQURJTkcgPSAnbG9hZGluZycsXG4gICAgTE9BREVEID0gJ2xvYWRlZCdcbn1cblxuLyogc3BlbGxjaGVja2VyOiBlbmFibGUgKi9cblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBBcHBDb25maWdTZXJ2aWNlIHtcblxuICAgIGNvbmZpZzogYW55ID0ge1xuICAgICAgICBhcHBsaWNhdGlvbjoge1xuICAgICAgICAgICAgbmFtZTogJ0FsZnJlc2NvIEFERiBBcHBsaWNhdGlvbidcbiAgICAgICAgfSxcbiAgICAgICAgZWNtSG9zdDogJ2h0dHA6Ly97aG9zdG5hbWV9ezpwb3J0fS9lY20nLFxuICAgICAgICBicG1Ib3N0OiAnaHR0cDovL3tob3N0bmFtZX17OnBvcnR9L2JwbScsXG4gICAgICAgIGxvZ0xldmVsOiAnc2lsZW50JyxcbiAgICAgICAgYWxmcmVzY29SZXBvc2l0b3J5TmFtZTogJ2FsZnJlc2NvLTEnXG4gICAgfTtcblxuICAgIHN0YXR1czogU3RhdHVzID0gU3RhdHVzLklOSVQ7XG4gICAgcHJvdGVjdGVkIG9uTG9hZFN1YmplY3Q6IFN1YmplY3Q8YW55PjtcbiAgICBvbkxvYWQ6IE9ic2VydmFibGU8YW55PjtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCkge1xuICAgICAgICB0aGlzLm9uTG9hZFN1YmplY3QgPSBuZXcgU3ViamVjdCgpO1xuICAgICAgICB0aGlzLm9uTG9hZCA9IHRoaXMub25Mb2FkU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXF1ZXN0cyBub3RpZmljYXRpb24gb2YgYSBwcm9wZXJ0eSB2YWx1ZSB3aGVuIGl0IGlzIGxvYWRlZC5cbiAgICAgKiBAcGFyYW0gcHJvcGVydHkgVGhlIGRlc2lyZWQgcHJvcGVydHkgdmFsdWVcbiAgICAgKiBAcmV0dXJucyBQcm9wZXJ0eSB2YWx1ZSwgd2hlbiBsb2FkZWRcbiAgICAgKi9cbiAgICBzZWxlY3QocHJvcGVydHk6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uTG9hZFN1YmplY3RcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgoY29uZmlnKSA9PiBjb25maWdbcHJvcGVydHldKSxcbiAgICAgICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHZhbHVlIG9mIGEgbmFtZWQgcHJvcGVydHkuXG4gICAgICogQHBhcmFtIGtleSBOYW1lIG9mIHRoZSBwcm9wZXJ0eVxuICAgICAqIEBwYXJhbSBkZWZhdWx0VmFsdWUgVmFsdWUgdG8gcmV0dXJuIGlmIHRoZSBrZXkgaXMgbm90IGZvdW5kXG4gICAgICogQHJldHVybnMgVmFsdWUgb2YgdGhlIHByb3BlcnR5XG4gICAgICovXG4gICAgZ2V0PFQ+KGtleTogc3RyaW5nLCBkZWZhdWx0VmFsdWU/OiBUKTogVCB7XG4gICAgICAgIGxldCByZXN1bHQ6IGFueSA9IE9iamVjdFV0aWxzLmdldFZhbHVlKHRoaXMuY29uZmlnLCBrZXkpO1xuICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGNvbnN0IGtleXdvcmRzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgICAgICAgICAgIGtleXdvcmRzLnNldCgnaG9zdG5hbWUnLCB0aGlzLmdldExvY2F0aW9uSG9zdG5hbWUoKSk7XG4gICAgICAgICAgICBrZXl3b3Jkcy5zZXQoJzpwb3J0JywgdGhpcy5nZXRMb2NhdGlvblBvcnQoJzonKSk7XG4gICAgICAgICAgICBrZXl3b3Jkcy5zZXQoJ3BvcnQnLCB0aGlzLmdldExvY2F0aW9uUG9ydCgpKTtcbiAgICAgICAgICAgIGtleXdvcmRzLnNldCgncHJvdG9jb2wnLCB0aGlzLmdldExvY2F0aW9uUHJvdG9jb2woKSk7XG4gICAgICAgICAgICByZXN1bHQgPSB0aGlzLmZvcm1hdFN0cmluZyhyZXN1bHQsIGtleXdvcmRzKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIDxUPiByZXN1bHQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgbG9jYXRpb24ucHJvdG9jb2wgdmFsdWUuXG4gICAgICogQHJldHVybnMgVGhlIGxvY2F0aW9uLnByb3RvY29sIHN0cmluZ1xuICAgICAqL1xuICAgIGdldExvY2F0aW9uUHJvdG9jb2woKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGxvY2F0aW9uLnByb3RvY29sO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGxvY2F0aW9uLmhvc3RuYW1lIHByb3BlcnR5LlxuICAgICAqIEByZXR1cm5zIFZhbHVlIG9mIHRoZSBwcm9wZXJ0eVxuICAgICAqL1xuICAgIGdldExvY2F0aW9uSG9zdG5hbWUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGxvY2F0aW9uLmhvc3RuYW1lO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGxvY2F0aW9uLnBvcnQgcHJvcGVydHkuXG4gICAgICogQHBhcmFtIHByZWZpeCBUZXh0IGFkZGVkIGJlZm9yZSBwb3J0IHZhbHVlXG4gICAgICogQHJldHVybnMgUG9ydCB3aXRoIHByZWZpeFxuICAgICAqL1xuICAgIGdldExvY2F0aW9uUG9ydChwcmVmaXg6IHN0cmluZyA9ICcnKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGxvY2F0aW9uLnBvcnQgPyBwcmVmaXggKyBsb2NhdGlvbi5wb3J0IDogJyc7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZHMgdGhlIGNvbmZpZyBmaWxlLlxuICAgICAqIEByZXR1cm5zIE5vdGlmaWNhdGlvbiB3aGVuIGxvYWRpbmcgaXMgY29tcGxldGVcbiAgICAgKi9cbiAgICBsb2FkKCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29uZmlnVXJsID0gYGFwcC5jb25maWcuanNvbj92PSR7RGF0ZS5ub3coKX1gO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMgPT09IFN0YXR1cy5JTklUKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSBTdGF0dXMuTE9BRElORztcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmh0dHAuZ2V0KGNvbmZpZ1VybCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICAgICAoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cyA9IFN0YXR1cy5MT0FERUQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuY29uZmlnLCBkYXRhIHx8IHt9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25Mb2FkU3ViamVjdC5uZXh0KHRoaXMuY29uZmlnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5jb25maWcpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRoaXMuY29uZmlnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdHVzID09PSBTdGF0dXMuTE9BREVEKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLmNvbmZpZyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdHVzID09PSBTdGF0dXMuTE9BRElORykge1xuICAgICAgICAgICAgICAgIHRoaXMub25Mb2FkLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5jb25maWcpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcm1hdFN0cmluZyhzdHI6IHN0cmluZywga2V5d29yZHM6IE1hcDxzdHJpbmcsIHN0cmluZz4pOiBzdHJpbmcge1xuICAgICAgICBsZXQgcmVzdWx0ID0gc3RyO1xuXG4gICAgICAgIGtleXdvcmRzLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGV4cHIgPSBuZXcgUmVnRXhwKCd7JyArIGtleSArICd9JywgJ2dtJyk7XG4gICAgICAgICAgICByZXN1bHQgPSByZXN1bHQucmVwbGFjZShleHByLCB2YWx1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxufVxuIl19