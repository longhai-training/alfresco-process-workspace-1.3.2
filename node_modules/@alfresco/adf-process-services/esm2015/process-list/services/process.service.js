/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { AlfrescoApiService } from '@alfresco/adf-core';
import { Injectable } from '@angular/core';
import { from, throwError, of } from 'rxjs';
import { ProcessDefinitionRepresentation } from '../models/process-definition.model';
import { ProcessInstanceVariable } from '../models/process-instance-variable.model';
import { ProcessInstance } from '../models/process-instance.model';
import { ProcessListModel } from '../models/process-list.model';
import { map, catchError } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class ProcessService {
    /**
     * @param {?} alfrescoApiService
     */
    constructor(alfrescoApiService) {
        this.alfrescoApiService = alfrescoApiService;
    }
    /**
     * Gets process instances for a filter and optionally a process definition.
     * @param {?} requestNode Filter for instances
     * @param {?=} processDefinitionKey Limits returned instances to a process definition
     * @return {?} List of process instances
     */
    getProcessInstances(requestNode, processDefinitionKey) {
        return from(this.alfrescoApiService.getInstance().activiti.processApi.getProcessInstances(requestNode))
            .pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        (res) => {
            if (processDefinitionKey) {
                /** @type {?} */
                const filtered = res.data.filter((/**
                 * @param {?} process
                 * @return {?}
                 */
                (process) => process.processDefinitionKey === processDefinitionKey));
                res.data = filtered;
                return res;
            }
            else {
                return res;
            }
        })), catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * Gets processes for a filter and optionally a process definition.
     * @param {?} requestNode Filter for instances
     * @param {?=} processDefinitionKey Limits returned instances to a process definition
     * @return {?} List of processes
     */
    getProcesses(requestNode, processDefinitionKey) {
        return this.getProcessInstances(requestNode, processDefinitionKey)
            .pipe(catchError((/**
         * @return {?}
         */
        () => {
            return of(new ProcessListModel({}));
        })));
    }
    /**
     * Fetches the Process Audit information as a PDF.
     * @param {?} processId ID of the target process
     * @return {?} Binary PDF data
     */
    fetchProcessAuditPdfById(processId) {
        return from(this.alfrescoApiService.getInstance().activiti.processApi.getProcessAuditPdf(processId))
            .pipe(catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * Fetches the Process Audit information in a JSON format.
     * @param {?} processId ID of the target process
     * @return {?} JSON data
     */
    fetchProcessAuditJsonById(processId) {
        return from(this.alfrescoApiService.getInstance().activiti.processApi.getProcessAuditJson(processId))
            .pipe(catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * Gets Process Instance metadata.
     * @param {?} processInstanceId ID of the target process
     * @return {?} Metadata for the instance
     */
    getProcess(processInstanceId) {
        return from(this.alfrescoApiService.getInstance().activiti.processApi.getProcessInstance(processInstanceId))
            .pipe(catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * Gets task instances for a process instance.
     * @param {?} processInstanceId ID of the process instance
     * @param {?=} state Task state filter (can be "active" or "completed")
     * @return {?} Array of task instance details
     */
    getProcessTasks(processInstanceId, state) {
        /** @type {?} */
        const taskOpts = state ? {
            processInstanceId: processInstanceId,
            state: state
        } : {
            processInstanceId: processInstanceId
        };
        return from(this.alfrescoApiService.getInstance().activiti.taskApi.listTasks(taskOpts))
            .pipe(map(this.extractData), map((/**
         * @param {?} tasks
         * @return {?}
         */
        (tasks) => tasks.map((/**
         * @param {?} task
         * @return {?}
         */
        (task) => {
            task.created = moment(task.created, 'YYYY-MM-DD').format();
            return task;
        })))), catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * Gets process definitions associated with an app.
     * @param {?=} appId ID of a target app
     * @return {?} Array of process definitions
     */
    getProcessDefinitions(appId) {
        /** @type {?} */
        const opts = appId ? {
            latest: true,
            appDefinitionId: appId
        } : {
            latest: true
        };
        return from(this.alfrescoApiService.getInstance().activiti.processApi.getProcessDefinitions(opts))
            .pipe(map(this.extractData), map((/**
         * @param {?} processDefs
         * @return {?}
         */
        (processDefs) => processDefs.map((/**
         * @param {?} pd
         * @return {?}
         */
        (pd) => new ProcessDefinitionRepresentation(pd))))), catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * Starts a process based on a process definition, name, form values or variables.
     * @param {?} processDefinitionId Process definition ID
     * @param {?} name Process name
     * @param {?=} outcome Process outcome
     * @param {?=} startFormValues Values for the start form
     * @param {?=} variables Array of process instance variables
     * @return {?} Details of the process instance just started
     */
    startProcess(processDefinitionId, name, outcome, startFormValues, variables) {
        /** @type {?} */
        const startRequest = {
            name: name,
            processDefinitionId: processDefinitionId
        };
        if (outcome) {
            startRequest.outcome = outcome;
        }
        if (startFormValues) {
            startRequest.values = startFormValues;
        }
        if (variables) {
            startRequest.variables = variables;
        }
        return from(this.alfrescoApiService.getInstance().activiti.processApi.startNewProcessInstance(startRequest))
            .pipe(map((/**
         * @param {?} pd
         * @return {?}
         */
        (pd) => new ProcessInstance(pd))), catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * Cancels a process instance.
     * @param {?} processInstanceId ID of process to cancel
     * @return {?} Null response notifying when the operation is complete
     */
    cancelProcess(processInstanceId) {
        return from(this.alfrescoApiService.getInstance().activiti.processApi.deleteProcessInstance(processInstanceId))
            .pipe(catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * Gets the variables for a process instance.
     * @param {?} processInstanceId ID of the target process
     * @return {?} Array of instance variable info
     */
    getProcessInstanceVariables(processInstanceId) {
        return from(this.alfrescoApiService.getInstance().activiti.processInstanceVariablesApi.getProcessInstanceVariables(processInstanceId))
            .pipe(map((/**
         * @param {?} processVars
         * @return {?}
         */
        (processVars) => processVars.map((/**
         * @param {?} currentProcessVar
         * @return {?}
         */
        (currentProcessVar) => new ProcessInstanceVariable(currentProcessVar))))), catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * Creates or updates variables for a process instance.
     * @param {?} processInstanceId ID of the target process
     * @param {?} variables Variables to update
     * @return {?} Array of instance variable info
     */
    createOrUpdateProcessInstanceVariables(processInstanceId, variables) {
        return from(this.alfrescoApiService.getInstance().activiti.processInstanceVariablesApi.createOrUpdateProcessInstanceVariables(processInstanceId, variables)).pipe(catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * Deletes a variable for a process instance.
     * @param {?} processInstanceId ID of the target process
     * @param {?} variableName Name of the variable to delete
     * @return {?} Null response notifying when the operation is complete
     */
    deleteProcessInstanceVariable(processInstanceId, variableName) {
        return from(this.alfrescoApiService.getInstance().activiti.processInstanceVariablesApi.deleteProcessInstanceVariable(processInstanceId, variableName))
            .pipe(catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => this.handleProcessError(err))));
    }
    /**
     * @private
     * @param {?} res
     * @return {?}
     */
    extractData(res) {
        return res.data || {};
    }
    /**
     * @private
     * @param {?} error
     * @return {?}
     */
    handleProcessError(error) {
        return throwError(error || 'Server error');
    }
}
ProcessService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
ProcessService.ctorParameters = () => [
    { type: AlfrescoApiService }
];
/** @nocollapse */ ProcessService.ngInjectableDef = i0.defineInjectable({ factory: function ProcessService_Factory() { return new ProcessService(i0.inject(i1.AlfrescoApiService)); }, token: ProcessService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    ProcessService.prototype.alfrescoApiService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFsZnJlc2NvL2FkZi1wcm9jZXNzLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsicHJvY2Vzcy1saXN0L3NlcnZpY2VzL3Byb2Nlc3Muc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQUUsa0JBQWtCLEVBQWMsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBYyxJQUFJLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUd4RCxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUNyRixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUNwRixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDbkUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDaEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7O0FBT2pELE1BQU0sT0FBTyxjQUFjOzs7O0lBRXZCLFlBQW9CLGtCQUFzQztRQUF0Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO0lBQzFELENBQUM7Ozs7Ozs7SUFRRCxtQkFBbUIsQ0FBQyxXQUFrRCxFQUFFLG9CQUE2QjtRQUNqRyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUNsRyxJQUFJLENBQ0QsR0FBRzs7OztRQUFDLENBQUMsR0FBUSxFQUFFLEVBQUU7WUFDYixJQUFJLG9CQUFvQixFQUFFOztzQkFDaEIsUUFBUSxHQUFHLEdBQUcsQ0FB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b3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UsIEZvcm1WYWx1ZXMgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUmVzdFZhcmlhYmxlIH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tLCB0aHJvd0Vycm9yLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgVGFza0RldGFpbHNNb2RlbCB9IGZyb20gJy4uLy4uL3Rhc2stbGlzdCc7XG5pbXBvcnQgeyBQcm9jZXNzRmlsdGVyUGFyYW1SZXByZXNlbnRhdGlvbk1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2ZpbHRlci1wcm9jZXNzLm1vZGVsJztcbmltcG9ydCB7IFByb2Nlc3NEZWZpbml0aW9uUmVwcmVzZW50YXRpb24gfSBmcm9tICcuLi9tb2RlbHMvcHJvY2Vzcy1kZWZpbml0aW9uLm1vZGVsJztcbmltcG9ydCB7IFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlIH0gZnJvbSAnLi4vbW9kZWxzL3Byb2Nlc3MtaW5zdGFuY2UtdmFyaWFibGUubW9kZWwnO1xuaW1wb3J0IHsgUHJvY2Vzc0luc3RhbmNlIH0gZnJvbSAnLi4vbW9kZWxzL3Byb2Nlc3MtaW5zdGFuY2UubW9kZWwnO1xuaW1wb3J0IHsgUHJvY2Vzc0xpc3RNb2RlbCB9IGZyb20gJy4uL21vZGVscy9wcm9jZXNzLWxpc3QubW9kZWwnO1xuaW1wb3J0IHsgbWFwLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5kZWNsYXJlIGxldCBtb21lbnQ6IGFueTtcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBQcm9jZXNzU2VydmljZSB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFsZnJlc2NvQXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBwcm9jZXNzIGluc3RhbmNlcyBmb3IgYSBmaWx0ZXIgYW5kIG9wdGlvbmFsbHkgYSBwcm9jZXNzIGRlZmluaXRpb24uXG4gICAgICogQHBhcmFtIHJlcXVlc3ROb2RlIEZpbHRlciBmb3IgaW5zdGFuY2VzXG4gICAgICogQHBhcmFtIHByb2Nlc3NEZWZpbml0aW9uS2V5IExpbWl0cyByZXR1cm5lZCBpbnN0YW5jZXMgdG8gYSBwcm9jZXNzIGRlZmluaXRpb25cbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHByb2Nlc3MgaW5zdGFuY2VzXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc0luc3RhbmNlcyhyZXF1ZXN0Tm9kZTogUHJvY2Vzc0ZpbHRlclBhcmFtUmVwcmVzZW50YXRpb25Nb2RlbCwgcHJvY2Vzc0RlZmluaXRpb25LZXk/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb2Nlc3NMaXN0TW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5wcm9jZXNzQXBpLmdldFByb2Nlc3NJbnN0YW5jZXMocmVxdWVzdE5vZGUpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJvY2Vzc0RlZmluaXRpb25LZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlcmVkID0gcmVzLmRhdGEuZmlsdGVyKChwcm9jZXNzKSA9PiBwcm9jZXNzLnByb2Nlc3NEZWZpbml0aW9uS2V5ID09PSBwcm9jZXNzRGVmaW5pdGlvbktleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXMuZGF0YSA9IGZpbHRlcmVkO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXM7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgcHJvY2Vzc2VzIGZvciBhIGZpbHRlciBhbmQgb3B0aW9uYWxseSBhIHByb2Nlc3MgZGVmaW5pdGlvbi5cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgRmlsdGVyIGZvciBpbnN0YW5jZXNcbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0RlZmluaXRpb25LZXkgTGltaXRzIHJldHVybmVkIGluc3RhbmNlcyB0byBhIHByb2Nlc3MgZGVmaW5pdGlvblxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgcHJvY2Vzc2VzXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc2VzKHJlcXVlc3ROb2RlOiBQcm9jZXNzRmlsdGVyUGFyYW1SZXByZXNlbnRhdGlvbk1vZGVsLCBwcm9jZXNzRGVmaW5pdGlvbktleT86IHN0cmluZyk6IE9ic2VydmFibGU8UHJvY2Vzc0xpc3RNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRQcm9jZXNzSW5zdGFuY2VzKHJlcXVlc3ROb2RlLCBwcm9jZXNzRGVmaW5pdGlvbktleSlcbiAgICAgICAgICAgIC5waXBlKGNhdGNoRXJyb3IoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBvZihuZXcgUHJvY2Vzc0xpc3RNb2RlbCh7fSkpO1xuICAgICAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZldGNoZXMgdGhlIFByb2Nlc3MgQXVkaXQgaW5mb3JtYXRpb24gYXMgYSBQREYuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJZCBJRCBvZiB0aGUgdGFyZ2V0IHByb2Nlc3NcbiAgICAgKiBAcmV0dXJucyBCaW5hcnkgUERGIGRhdGFcbiAgICAgKi9cbiAgICBmZXRjaFByb2Nlc3NBdWRpdFBkZkJ5SWQocHJvY2Vzc0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEJsb2I+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5wcm9jZXNzQXBpLmdldFByb2Nlc3NBdWRpdFBkZihwcm9jZXNzSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGZXRjaGVzIHRoZSBQcm9jZXNzIEF1ZGl0IGluZm9ybWF0aW9uIGluIGEgSlNPTiBmb3JtYXQuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJZCBJRCBvZiB0aGUgdGFyZ2V0IHByb2Nlc3NcbiAgICAgKiBAcmV0dXJucyBKU09OIGRhdGFcbiAgICAgKi9cbiAgICBmZXRjaFByb2Nlc3NBdWRpdEpzb25CeUlkKHByb2Nlc3NJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5wcm9jZXNzQXBpLmdldFByb2Nlc3NBdWRpdEpzb24ocHJvY2Vzc0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBQcm9jZXNzIEluc3RhbmNlIG1ldGFkYXRhLlxuICAgICAqIEBwYXJhbSBwcm9jZXNzSW5zdGFuY2VJZCBJRCBvZiB0aGUgdGFyZ2V0IHByb2Nlc3NcbiAgICAgKiBAcmV0dXJucyBNZXRhZGF0YSBmb3IgdGhlIGluc3RhbmNlXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzcyhwcm9jZXNzSW5zdGFuY2VJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxQcm9jZXNzSW5zdGFuY2U+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5wcm9jZXNzQXBpLmdldFByb2Nlc3NJbnN0YW5jZShwcm9jZXNzSW5zdGFuY2VJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGFzayBpbnN0YW5jZXMgZm9yIGEgcHJvY2VzcyBpbnN0YW5jZS5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0luc3RhbmNlSWQgSUQgb2YgdGhlIHByb2Nlc3MgaW5zdGFuY2VcbiAgICAgKiBAcGFyYW0gc3RhdGUgVGFzayBzdGF0ZSBmaWx0ZXIgKGNhbiBiZSBcImFjdGl2ZVwiIG9yIFwiY29tcGxldGVkXCIpXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgdGFzayBpbnN0YW5jZSBkZXRhaWxzXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc1Rhc2tzKHByb2Nlc3NJbnN0YW5jZUlkOiBzdHJpbmcsIHN0YXRlPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsW10+IHtcbiAgICAgICAgY29uc3QgdGFza09wdHMgPSBzdGF0ZSA/IHtcbiAgICAgICAgICAgIHByb2Nlc3NJbnN0YW5jZUlkOiBwcm9jZXNzSW5zdGFuY2VJZCxcbiAgICAgICAgICAgIHN0YXRlOiBzdGF0ZVxuICAgICAgICB9IDoge1xuICAgICAgICAgICAgICAgIHByb2Nlc3NJbnN0YW5jZUlkOiBwcm9jZXNzSW5zdGFuY2VJZFxuICAgICAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS50YXNrQXBpLmxpc3RUYXNrcyh0YXNrT3B0cykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAodGhpcy5leHRyYWN0RGF0YSksXG4gICAgICAgICAgICAgICAgbWFwKCh0YXNrcykgPT4gdGFza3MubWFwKCh0YXNrOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGFzay5jcmVhdGVkID0gbW9tZW50KHRhc2suY3JlYXRlZCwgJ1lZWVktTU0tREQnKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhc2s7XG4gICAgICAgICAgICAgICAgfSkpLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBwcm9jZXNzIGRlZmluaXRpb25zIGFzc29jaWF0ZWQgd2l0aCBhbiBhcHAuXG4gICAgICogQHBhcmFtIGFwcElkIElEIG9mIGEgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIHByb2Nlc3MgZGVmaW5pdGlvbnNcbiAgICAgKi9cbiAgICBnZXRQcm9jZXNzRGVmaW5pdGlvbnMoYXBwSWQ/OiBudW1iZXIpOiBPYnNlcnZhYmxlPFByb2Nlc3NEZWZpbml0aW9uUmVwcmVzZW50YXRpb25bXT4ge1xuICAgICAgICBjb25zdCBvcHRzID0gYXBwSWQgPyB7XG4gICAgICAgICAgICBsYXRlc3Q6IHRydWUsXG4gICAgICAgICAgICBhcHBEZWZpbml0aW9uSWQ6IGFwcElkXG4gICAgICAgIH0gOiB7XG4gICAgICAgICAgICAgICAgbGF0ZXN0OiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkucHJvY2Vzc0FwaS5nZXRQcm9jZXNzRGVmaW5pdGlvbnMob3B0cylcbiAgICAgICAgKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKHRoaXMuZXh0cmFjdERhdGEpLFxuICAgICAgICAgICAgICAgIG1hcCgocHJvY2Vzc0RlZnMpID0+IHByb2Nlc3NEZWZzLm1hcCgocGQpID0+IG5ldyBQcm9jZXNzRGVmaW5pdGlvblJlcHJlc2VudGF0aW9uKHBkKSkpLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnRzIGEgcHJvY2VzcyBiYXNlZCBvbiBhIHByb2Nlc3MgZGVmaW5pdGlvbiwgbmFtZSwgZm9ybSB2YWx1ZXMgb3IgdmFyaWFibGVzLlxuICAgICAqIEBwYXJhbSBwcm9jZXNzRGVmaW5pdGlvbklkIFByb2Nlc3MgZGVmaW5pdGlvbiBJRFxuICAgICAqIEBwYXJhbSBuYW1lIFByb2Nlc3MgbmFtZVxuICAgICAqIEBwYXJhbSBvdXRjb21lIFByb2Nlc3Mgb3V0Y29tZVxuICAgICAqIEBwYXJhbSBzdGFydEZvcm1WYWx1ZXMgVmFsdWVzIGZvciB0aGUgc3RhcnQgZm9ybVxuICAgICAqIEBwYXJhbSB2YXJpYWJsZXMgQXJyYXkgb2YgcHJvY2VzcyBpbnN0YW5jZSB2YXJpYWJsZXNcbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBwcm9jZXNzIGluc3RhbmNlIGp1c3Qgc3RhcnRlZFxuICAgICAqL1xuICAgIHN0YXJ0UHJvY2Vzcyhwcm9jZXNzRGVmaW5pdGlvbklkOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgb3V0Y29tZT86IHN0cmluZywgc3RhcnRGb3JtVmFsdWVzPzogRm9ybVZhbHVlcywgdmFyaWFibGVzPzogUHJvY2Vzc0luc3RhbmNlVmFyaWFibGVbXSk6IE9ic2VydmFibGU8UHJvY2Vzc0luc3RhbmNlPiB7XG4gICAgICAgIGNvbnN0IHN0YXJ0UmVxdWVzdDogYW55ID0ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIHByb2Nlc3NEZWZpbml0aW9uSWQ6IHByb2Nlc3NEZWZpbml0aW9uSWRcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKG91dGNvbWUpIHtcbiAgICAgICAgICAgIHN0YXJ0UmVxdWVzdC5vdXRjb21lID0gb3V0Y29tZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3RhcnRGb3JtVmFsdWVzKSB7XG4gICAgICAgICAgICBzdGFydFJlcXVlc3QudmFsdWVzID0gc3RhcnRGb3JtVmFsdWVzO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YXJpYWJsZXMpIHtcbiAgICAgICAgICAgIHN0YXJ0UmVxdWVzdC52YXJpYWJsZXMgPSB2YXJpYWJsZXM7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgICB0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnByb2Nlc3NBcGkuc3RhcnROZXdQcm9jZXNzSW5zdGFuY2Uoc3RhcnRSZXF1ZXN0KVxuICAgICAgICApXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHBkKSA9PiBuZXcgUHJvY2Vzc0luc3RhbmNlKHBkKSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYW5jZWxzIGEgcHJvY2VzcyBpbnN0YW5jZS5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0luc3RhbmNlSWQgSUQgb2YgcHJvY2VzcyB0byBjYW5jZWxcbiAgICAgKiBAcmV0dXJucyBOdWxsIHJlc3BvbnNlIG5vdGlmeWluZyB3aGVuIHRoZSBvcGVyYXRpb24gaXMgY29tcGxldGVcbiAgICAgKi9cbiAgICBjYW5jZWxQcm9jZXNzKHByb2Nlc3NJbnN0YW5jZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgICB0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnByb2Nlc3NBcGkuZGVsZXRlUHJvY2Vzc0luc3RhbmNlKHByb2Nlc3NJbnN0YW5jZUlkKVxuICAgICAgICApXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHZhcmlhYmxlcyBmb3IgYSBwcm9jZXNzIGluc3RhbmNlLlxuICAgICAqIEBwYXJhbSBwcm9jZXNzSW5zdGFuY2VJZCBJRCBvZiB0aGUgdGFyZ2V0IHByb2Nlc3NcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBpbnN0YW5jZSB2YXJpYWJsZSBpbmZvXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzKHByb2Nlc3NJbnN0YW5jZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlW10+IHtcbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgICB0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaS5nZXRQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXMocHJvY2Vzc0luc3RhbmNlSWQpXG4gICAgICAgIClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocHJvY2Vzc1ZhcnM6IGFueVtdKSA9PiBwcm9jZXNzVmFycy5tYXAoKGN1cnJlbnRQcm9jZXNzVmFyKSA9PiBuZXcgUHJvY2Vzc0luc3RhbmNlVmFyaWFibGUoY3VycmVudFByb2Nlc3NWYXIpKSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIG9yIHVwZGF0ZXMgdmFyaWFibGVzIGZvciBhIHByb2Nlc3MgaW5zdGFuY2UuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJbnN0YW5jZUlkIElEIG9mIHRoZSB0YXJnZXQgcHJvY2Vzc1xuICAgICAqIEBwYXJhbSB2YXJpYWJsZXMgVmFyaWFibGVzIHRvIHVwZGF0ZVxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIGluc3RhbmNlIHZhcmlhYmxlIGluZm9cbiAgICAgKi9cbiAgICBjcmVhdGVPclVwZGF0ZVByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlcyhwcm9jZXNzSW5zdGFuY2VJZDogc3RyaW5nLCB2YXJpYWJsZXM6IFJlc3RWYXJpYWJsZVtdKTogT2JzZXJ2YWJsZTxQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZVtdPiB7XG4gICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgdGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5wcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGkuY3JlYXRlT3JVcGRhdGVQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXMocHJvY2Vzc0luc3RhbmNlSWQsIHZhcmlhYmxlcylcbiAgICAgICAgKS5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVsZXRlcyBhIHZhcmlhYmxlIGZvciBhIHByb2Nlc3MgaW5zdGFuY2UuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJbnN0YW5jZUlkIElEIG9mIHRoZSB0YXJnZXQgcHJvY2Vzc1xuICAgICAqIEBwYXJhbSB2YXJpYWJsZU5hbWUgTmFtZSBvZiB0aGUgdmFyaWFibGUgdG8gZGVsZXRlXG4gICAgICogQHJldHVybnMgTnVsbCByZXNwb25zZSBub3RpZnlpbmcgd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgZGVsZXRlUHJvY2Vzc0luc3RhbmNlVmFyaWFibGUocHJvY2Vzc0luc3RhbmNlSWQ6IHN0cmluZywgdmFyaWFibGVOYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgICB0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaS5kZWxldGVQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZShwcm9jZXNzSW5zdGFuY2VJZCwgdmFyaWFibGVOYW1lKVxuICAgICAgICApXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZXh0cmFjdERhdGEocmVzOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5kYXRhIHx8IHt9O1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlUHJvY2Vzc0Vycm9yKGVycm9yOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IgfHwgJ1NlcnZlciBlcnJvcicpO1xuICAgIH1cbn1cbiJdfQ==