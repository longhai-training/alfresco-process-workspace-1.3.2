/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* tslint:disable:component-selector */
import { Component, ViewEncapsulation } from '@angular/core';
import { UploadWidgetComponent, FormService, LogService, ThumbnailService, ProcessContentService, ActivitiContentService, ContentService, AppConfigValues, AppConfigService } from '@alfresco/adf-core';
import { ContentNodeDialogService } from '@alfresco/adf-content-services';
import { from, zip, of } from 'rxjs';
import { mergeMap } from 'rxjs/operators';
import { AttachFileWidgetDialogService } from './attach-file-widget-dialog.service';
export class AttachFileWidgetComponent extends UploadWidgetComponent {
    /**
     * @param {?} formService
     * @param {?} logger
     * @param {?} thumbnails
     * @param {?} processContentService
     * @param {?} activitiContentService
     * @param {?} contentService
     * @param {?} contentDialog
     * @param {?} appConfigService
     * @param {?} attachDialogService
     */
    constructor(formService, logger, thumbnails, processContentService, activitiContentService, contentService, contentDialog, appConfigService, attachDialogService) {
        super(formService, logger, thumbnails, processContentService);
        this.formService = formService;
        this.logger = logger;
        this.thumbnails = thumbnails;
        this.processContentService = processContentService;
        this.activitiContentService = activitiContentService;
        this.contentService = contentService;
        this.contentDialog = contentDialog;
        this.appConfigService = appConfigService;
        this.attachDialogService = attachDialogService;
        this.repositoryList = [];
        this.tempFilesList = [];
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this.field &&
            this.field.value &&
            this.field.value.length > 0) {
            this.hasFile = true;
        }
        this.getMultipleFileParam();
        this.activitiContentService.getAlfrescoRepositories(null, true).subscribe((/**
         * @param {?} repoList
         * @return {?}
         */
        (repoList) => {
            this.repositoryList = repoList;
        }));
        this.formService.taskSaved.subscribe((/**
         * @param {?} formSaved
         * @return {?}
         */
        (formSaved) => {
            if (formSaved.form.id === this.field.form.id) {
                this.tempFilesList = [];
            }
        }));
    }
    /**
     * @return {?}
     */
    isFileSourceConfigured() {
        return !!this.field.params && !!this.field.params.fileSource;
    }
    /**
     * @return {?}
     */
    isMultipleSourceUpload() {
        return !this.field.readOnly && this.isFileSourceConfigured() && !this.isOnlyLocalSourceSelected();
    }
    /**
     * @return {?}
     */
    isAllFileSourceSelected() {
        return this.field.params &&
            this.field.params.fileSource &&
            this.field.params.fileSource.serviceId === 'all-file-sources';
    }
    /**
     * @return {?}
     */
    isOnlyLocalSourceSelected() {
        return this.field.params &&
            this.field.params.fileSource &&
            this.field.params.fileSource.serviceId === 'local-file';
    }
    /**
     * @return {?}
     */
    isSimpleUploadButton() {
        return this.isUploadButtonVisible() &&
            !this.isFileSourceConfigured() ||
            this.isOnlyLocalSourceSelected();
    }
    /**
     * @return {?}
     */
    isUploadButtonVisible() {
        return (!this.hasFile || this.multipleOption) && !this.field.readOnly;
    }
    /**
     * @return {?}
     */
    isDefinedSourceFolder() {
        return !!this.field.params &&
            !!this.field.params.fileSource &&
            !!this.field.params.fileSource.selectedFolder;
    }
    /**
     * @param {?} file
     * @return {?}
     */
    isTemporaryFile(file) {
        return this.tempFilesList.findIndex((/**
         * @param {?} elem
         * @return {?}
         */
        (elem) => elem.name === file.name)) >= 0;
    }
    /**
     * @return {?}
     */
    openSelectDialogFromFileSource() {
        /** @type {?} */
        const params = this.field.params;
        if (this.isDefinedSourceFolder()) {
            this.contentDialog.openFileBrowseDialogByFolderId(params.fileSource.selectedFolder.pathId).subscribe((/**
             * @param {?} selections
             * @return {?}
             */
            (selections) => {
                this.tempFilesList.push(...selections);
                this.uploadFileFromCS(selections, this.field.params.fileSource.selectedFolder.accountId, this.field.params.fileSource.selectedFolder.siteId);
            }));
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onAttachFileChanged(event) {
        this.tempFilesList.push(...Array.from(event.target.files));
        this.onFileChanged(event);
    }
    /**
     * @param {?} file
     * @return {?}
     */
    onRemoveAttachFile(file) {
        if (this.isTemporaryFile(file)) {
            this.tempFilesList.splice(this.tempFilesList.indexOf(((/** @type {?} */ (file))).contentBlob), 1);
        }
        this.removeFile(file);
    }
    /**
     * @param {?} file
     * @return {?}
     */
    onAttachFileClicked(file) {
        if (file.isExternal) {
            this.logger.info(`The file ${file.name} comes from an external source and cannot be showed at this moment`);
            return;
        }
        if (this.isTemporaryFile(file)) {
            this.formService.formContentClicked.next(file);
        }
        else {
            this.fileClicked(file);
        }
    }
    /**
     * @param {?} file
     * @return {?}
     */
    downloadContent(file) {
        if (this.isTemporaryFile(file)) {
            this.contentService.downloadBlob(((/** @type {?} */ (file))).contentBlob, file.name);
        }
        else {
            this.processContentService.getFileRawContent(((/** @type {?} */ (file))).id).subscribe((/**
             * @param {?} blob
             * @return {?}
             */
            (blob) => {
                this.contentService.downloadBlob(blob, ((/** @type {?} */ (file))).name);
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                this.logger.error('Impossible retrieve content for download');
            }));
        }
    }
    /**
     * @param {?} repository
     * @return {?}
     */
    openSelectDialog(repository) {
        /** @type {?} */
        const accountIdentifier = 'alfresco-' + repository.id + '-' + repository.name;
        /** @type {?} */
        const currentECMHost = this.getDomainHost(this.appConfigService.get(AppConfigValues.ECMHOST));
        /** @type {?} */
        const chosenRepositoryHost = this.getDomainHost(repository.repositoryUrl);
        if (chosenRepositoryHost !== currentECMHost) {
            /** @type {?} */
            const formattedRepositoryHost = repository.repositoryUrl.replace('/alfresco', '');
            this.attachDialogService.openLogin(formattedRepositoryHost).subscribe((/**
             * @param {?} selections
             * @return {?}
             */
            (selections) => {
                selections.forEach((/**
                 * @param {?} node
                 * @return {?}
                 */
                (node) => node.isExternal = true));
                this.tempFilesList.push(...selections);
                this.uploadFileFromCS(selections, accountIdentifier);
            }));
        }
        else {
            this.contentDialog.openFileBrowseDialogBySite().subscribe((/**
             * @param {?} selections
             * @return {?}
             */
            (selections) => {
                this.tempFilesList.push(...selections);
                this.uploadFileFromCS(selections, accountIdentifier);
            }));
        }
    }
    /**
     * @private
     * @param {?} fileNodeList
     * @param {?} accountId
     * @param {?=} siteId
     * @return {?}
     */
    uploadFileFromCS(fileNodeList, accountId, siteId) {
        /** @type {?} */
        const filesSaved = [];
        from(fileNodeList).pipe(mergeMap((/**
         * @param {?} node
         * @return {?}
         */
        (node) => zip(of(node.content.mimeType), this.activitiContentService.applyAlfrescoNode(node, siteId, accountId), of(node.isExternal)))))
            .subscribe((/**
         * @param {?} __0
         * @return {?}
         */
        ([mimeType, res, isExternal]) => {
            res.mimeType = mimeType;
            res.isExternal = isExternal;
            filesSaved.push(res);
        }), (/**
         * @param {?} error
         * @return {?}
         */
        (error) => {
            this.logger.error(error);
        }), (/**
         * @return {?}
         */
        () => {
            this.field.value = filesSaved;
            this.field.json.value = filesSaved;
            this.hasFile = true;
        }));
    }
    /**
     * @private
     * @param {?} urlToCheck
     * @return {?}
     */
    getDomainHost(urlToCheck) {
        /** @type {?} */
        const result = urlToCheck.match('^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/?\n]+)');
        return result[1];
    }
}
AttachFileWidgetComponent.decorators = [
    { type: Component, args: [{
                selector: 'attach-widget',
                template: "<div class=\"adf-attach-widget {{field.className}}\"\n    [class.adf-invalid]=\"!field.isValid\"\n    [class.adf-readonly]=\"field.readOnly\">\n    <label class=\"adf-label\" [attr.for]=\"field.id\">{{field.name}}\n        <span *ngIf=\"isRequired()\">*</span>\n    </label>\n    <div class=\"adf-attach-widget-container\">\n        <div id=\"adf-attach-widget-simple-upload\" *ngIf=\"isSimpleUploadButton() && isUploadButtonVisible()\">\n            <a mat-raised-button color=\"primary\">\n                {{ 'FORM.FIELD.UPLOAD' | translate }}\n                <mat-icon>file_upload</mat-icon>\n                <input #uploadFiles\n                        [multiple]=\"multipleOption\"\n                        type=\"file\"\n                        [id]=\"field.id\"\n                        (change)=\"onAttachFileChanged($event)\" />\n            </a>\n        </div>\n        <div class=\"adf-attach-widget__menu-upload\" *ngIf=\"isUploadButtonVisible() && isMultipleSourceUpload()\">\n            <button mat-raised-button color=\"primary\" [matMenuTriggerFor]=\"menu\" [id]=\"field.id\">\n                    {{ 'FORM.FIELD.UPLOAD' | translate }}\n                    <mat-icon>attach_file</mat-icon>\n            </button>\n            <mat-menu #menu=\"matMenu\" class=\"adf-attach-widget__menu-content\">\n                <button mat-menu-item (click)=\"uploadFile.click()\"\n                        id=\"attach-local-file\"\n                        *ngIf=\"isAllFileSourceSelected()\">\n                    {{ 'FORM.FIELD.LOCALSTORAGE' | translate }}\n                    <mat-icon>file_upload</mat-icon>\n                    <input #uploadFile\n                            class=\"adf-attach-widget__input-type\"\n                            [multiple]=\"multipleOption\"\n                            type=\"file\"\n                            [id]=\"field.id\"\n                            (change)=\"onAttachFileChanged($event)\" />\n                </button>\n                <button mat-menu-item\n                        *ngIf=\"isDefinedSourceFolder()\"\n                        id=\"attach-{{field.params?.fileSource?.name}}\"\n                        (click)=\"openSelectDialogFromFileSource()\">\n                        {{field.params?.fileSource?.name}}\n                        <mat-icon>\n                            <img alt=\"alfresco\" class=\"adf-attach-widget__image-logo\" src=\"../assets/images/alfresco-flower.svg\">\n                        </mat-icon>\n                </button>\n                <div *ngIf=\"!isDefinedSourceFolder()\">\n                    <button mat-menu-item *ngFor=\"let repo of repositoryList\"\n                            id=\"attach-{{repo?.name}}\"\n                           (click)=\"openSelectDialog(repo)\">\n                            {{repo.name}}\n                            <mat-icon>\n                                <img alt=\"alfresco\" class=\"adf-attach-widget__image-logo\" src=\"../assets/images/alfresco-flower.svg\">\n                            </mat-icon>\n                    </button>\n                </div>\n            </mat-menu>\n        </div>\n    </div>\n</div>\n\n<div id=\"adf-attach-widget-readonly-list\">\n    <mat-list *ngIf=\"hasFile\">\n        <mat-list-item class=\"adf-attach-files-row\" *ngFor=\"let file of field.value\">\n            <img mat-list-icon class=\"adf-attach-widget__icon\"\n                 [id]=\"'file-'+file.id+'-icon'\"\n                 [src]=\"file.content ? getIcon(file.content.mimeType) : getIcon(file.mimeType)\"\n                 [alt]=\"mimeTypeIcon\"\n                 (click)=\"onAttachFileClicked(file)\"\n                 (keyup.enter)=\"onAttachFileClicked(file)\"\n                 role=\"button\"\n                 tabindex=\"0\"/>\n            <span matLine id=\"{{'file-'+file.id}}\" (click)=\"onAttachFileClicked(file)\" (keyup.enter)=\"onAttachFileClicked(file)\"\n                  role=\"button\" tabindex=\"0\" class=\"adf-file\">{{file.name}}</span>\n            <button id=\"{{'file-'+file.id+'-option-menu'}}\" mat-icon-button [matMenuTriggerFor]=\"fileActionMenu\">\n                <mat-icon>more_vert</mat-icon>\n            </button>\n            <mat-menu #fileActionMenu=\"matMenu\" xPosition=\"before\">\n                <button id=\"{{'file-'+file.id+'-show-file'}}\"\n                    [disabled]=\"file.isExternal\"\n                    mat-menu-item (click)=\"onAttachFileClicked(file)\">\n                    <mat-icon>image</mat-icon>\n                    <span>{{ 'FORM.FIELD.SHOW_FILE' | translate }}</span>\n                </button>\n                <button id=\"{{'file-'+file.id+'-download-file'}}\"\n                    mat-menu-item (click)=\"downloadContent(file)\">\n                    <mat-icon>file_download</mat-icon>\n                    <span>{{ 'FORM.FIELD.DOWNLOAD_FILE' | translate }}</span>\n                </button>\n                <button *ngIf=\"!field.readOnly\" id=\"{{'file-'+file.id+'-remove-file'}}\"\n                        mat-menu-item [id]=\"'file-'+file.id+'-remove'\"\n                        (click)=\"onRemoveAttachFile(file);\" (keyup.enter)=\"onRemoveAttachFile(file);\">\n                    <mat-icon class=\"mat-24\">highlight_off</mat-icon>\n                    <span>{{ 'FORM.FIELD.REMOVE_FILE' | translate }}</span>\n                </button>\n            </mat-menu>\n        </mat-list-item>\n    </mat-list>\n</div>\n\n<error-widget [error]=\"field.validationSummary\"></error-widget>\n<error-widget *ngIf=\"isInvalidFieldRequired()\" required=\"{{ 'FORM.FIELD.REQUIRED' | translate }}\"></error-widget>\n",
                host: {
                    '(click)': 'event($event)',
                    '(blur)': 'event($event)',
                    '(change)': 'event($event)',
                    '(focus)': 'event($event)',
                    '(focusin)': 'event($event)',
                    '(focusout)': 'event($event)',
                    '(input)': 'event($event)',
                    '(invalid)': 'event($event)',
                    '(select)': 'event($event)'
                },
                encapsulation: ViewEncapsulation.None,
                styles: [".adf-attach-widget-container{margin-bottom:15px;display:flex;align-items:center}.adf-attach-widget-container input{cursor:pointer;height:100%;right:0;opacity:0;position:absolute;top:0;width:300px;z-index:4}.adf-attach-widget__menu-upload{display:flex;align-items:center}.adf-attach-widget__input-type{width:.1px;height:.1px;opacity:0;overflow:hidden;position:absolute;z-index:-1}.adf-attach-widget__image-logo{padding-left:5px}.adf-attach-widget-repo-button{padding-left:10px}.adf-attach-widget-repo-button .mat-button-wrapper{display:inline}.adf-attach-widget-repo-button .mat-mini-fab.mat-accent{background-color:inherit}.adf-attach-widget{width:100%;word-break:break-all;padding:.4375em 0;border-top:.84375em solid transparent}.adf-attach-widget__icon{padding:6px;float:left;cursor:pointer}.adf-attach-widget__reset{margin-top:-2px}.adf-attach-files-row .mat-line{margin-bottom:0}"]
            }] }
];
/** @nocollapse */
AttachFileWidgetComponent.ctorParameters = () => [
    { type: FormService },
    { type: LogService },
    { type: ThumbnailService },
    { type: ProcessContentService },
    { type: ActivitiContentService },
    { type: ContentService },
    { type: ContentNodeDialogService },
    { type: AppConfigService },
    { type: AttachFileWidgetDialogService }
];
if (false) {
    /** @type {?} */
    AttachFileWidgetComponent.prototype.repositoryList;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.tempFilesList;
    /** @type {?} */
    AttachFileWidgetComponent.prototype.formService;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.logger;
    /** @type {?} */
    AttachFileWidgetComponent.prototype.thumbnails;
    /** @type {?} */
    AttachFileWidgetComponent.prototype.processContentService;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.activitiContentService;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.contentService;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.contentDialog;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.appConfigService;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.attachDialogService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNoLWZpbGUtd2lkZ2V0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtcHJvY2Vzcy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImNvbnRlbnQtd2lkZ2V0L2F0dGFjaC1maWxlLXdpZGdldC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBbUJBLE9BQU8sRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDckUsT0FBTyxFQUNILHFCQUFxQixFQUNyQixXQUFXLEVBQ1gsVUFBVSxFQUNWLGdCQUFnQixFQUNoQixxQkFBcUIsRUFDckIsc0JBQXNCLEVBQ3RCLGNBQWMsRUFFZCxlQUFlLEVBQ2YsZ0JBQWdCLEVBQ25CLE1BQU0sb0JBQW9CLENBQUM7QUFDNUIsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFFMUUsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxQyxPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQW1CcEYsTUFBTSxPQUFPLHlCQUEwQixTQUFRLHFCQUFxQjs7Ozs7Ozs7Ozs7O0lBS2hFLFlBQW1CLFdBQXdCLEVBQ3ZCLE1BQWtCLEVBQ25CLFVBQTRCLEVBQzVCLHFCQUE0QyxFQUMzQyxzQkFBOEMsRUFDOUMsY0FBOEIsRUFDOUIsYUFBdUMsRUFDdkMsZ0JBQWtDLEVBQ2xDLG1CQUFrRDtRQUNsRSxLQUFLLENBQUMsV0FBVyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUscUJBQXFCLENBQUMsQ0FBQztRQVQvQyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN2QixXQUFNLEdBQU4sTUFBTSxDQUFZO1FBQ25CLGVBQVUsR0FBVixVQUFVLENB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LFVBQVUsQ0FBQztZQUNuQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUN4QixDQUFDLEVBQUMsQ0FBQztJQUNmLENBQUM7Ozs7OztJQUVPLGFBQWEsQ0FBQyxVQUFVOztjQUN0QixNQUFNLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyx3REFBd0QsQ0FBQztRQUN6RixPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNyQixDQUFDOzs7WUFuTUosU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxlQUFlO2dCQUN6QixrZ0xBQWtEO2dCQUVsRCxJQUFJLEVBQUU7b0JBQ0YsU0FBUyxFQUFFLGVBQWU7b0JBQzFCLFFBQVEsRUFBRSxlQUFlO29CQUN6QixVQUFVLEVBQUUsZUFBZTtvQkFDM0IsU0FBUyxFQUFFLGVBQWU7b0JBQzFCLFdBQVcsRUFBRSxlQUFlO29CQUM1QixZQUFZLEVBQUUsZUFBZTtvQkFDN0IsU0FBUyxFQUFFLGVBQWU7b0JBQzFCLFdBQVcsRUFBRSxlQUFlO29CQUM1QixVQUFVLEVBQUUsZUFBZTtpQkFDOUI7Z0JBQ0QsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUk7O2FBQ3hDOzs7O1lBaENHLFdBQVc7WUFDWCxVQUFVO1lBQ1YsZ0JBQWdCO1lBQ2hCLHFCQUFxQjtZQUNyQixzQkFBc0I7WUFDdEIsY0FBYztZQUtULHdCQUF3QjtZQUY3QixnQkFBZ0I7WUFNWCw2QkFBNkI7Ozs7SUFxQmxDLG1EQUFvQjs7Ozs7SUFDcEIsa0RBQTJCOztJQUVmLGdEQUErQjs7Ozs7SUFDL0IsMkNBQTBCOztJQUMxQiwrQ0FBbUM7O0lBQ25DLDBEQUFtRDs7Ozs7SUFDbkQsMkRBQXNEOzs7OztJQUN0RCxtREFBc0M7Ozs7O0lBQ3RDLGtEQUErQzs7Ozs7SUFDL0MscURBQTBDOzs7OztJQUMxQyx3REFBMEQiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vKiB0c2xpbnQ6ZGlzYWJsZTpjb21wb25lbnQtc2VsZWN0b3IgKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBWaWV3RW5jYXBzdWxhdGlvbiwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIFVwbG9hZFdpZGdldENvbXBvbmVudCxcbiAgICBGb3JtU2VydmljZSxcbiAgICBMb2dTZXJ2aWNlLFxuICAgIFRodW1ibmFpbFNlcnZpY2UsXG4gICAgUHJvY2Vzc0NvbnRlbnRTZXJ2aWNlLFxuICAgIEFjdGl2aXRpQ29udGVudFNlcnZpY2UsXG4gICAgQ29udGVudFNlcnZpY2UsXG4gICAgRm9ybUV2ZW50LFxuICAgIEFwcENvbmZpZ1ZhbHVlcyxcbiAgICBBcHBDb25maWdTZXJ2aWNlXG59IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBDb250ZW50Tm9kZURpYWxvZ1NlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMnO1xuaW1wb3J0IHsgTm9kZSwgUmVsYXRlZENvbnRlbnRSZXByZXNlbnRhdGlvbiB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgZnJvbSwgemlwLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWVyZ2VNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBdHRhY2hGaWxlV2lkZ2V0RGlhbG9nU2VydmljZSB9IGZyb20gJy4vYXR0YWNoLWZpbGUtd2lkZ2V0LWRpYWxvZy5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhdHRhY2gtd2lkZ2V0JyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vYXR0YWNoLWZpbGUtd2lkZ2V0LmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9hdHRhY2gtZmlsZS13aWRnZXQuY29tcG9uZW50LnNjc3MnXSxcbiAgICBob3N0OiB7XG4gICAgICAgICcoY2xpY2spJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGJsdXIpJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGNoYW5nZSknOiAnZXZlbnQoJGV2ZW50KScsXG4gICAgICAgICcoZm9jdXMpJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGZvY3VzaW4pJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGZvY3Vzb3V0KSc6ICdldmVudCgkZXZlbnQpJyxcbiAgICAgICAgJyhpbnB1dCknOiAnZXZlbnQoJGV2ZW50KScsXG4gICAgICAgICcoaW52YWxpZCknOiAnZXZlbnQoJGV2ZW50KScsXG4gICAgICAgICcoc2VsZWN0KSc6ICdldmVudCgkZXZlbnQpJ1xuICAgIH0sXG4gICAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcbmV4cG9ydCBjbGFzcyBBdHRhY2hGaWxlV2lkZ2V0Q29tcG9uZW50IGV4dGVuZHMgVXBsb2FkV2lkZ2V0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcblxuICAgIHJlcG9zaXRvcnlMaXN0ID0gW107XG4gICAgcHJpdmF0ZSB0ZW1wRmlsZXNMaXN0ID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgZm9ybVNlcnZpY2U6IEZvcm1TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbG9nZ2VyOiBMb2dTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHB1YmxpYyB0aHVtYm5haWxzOiBUaHVtYm5haWxTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHB1YmxpYyBwcm9jZXNzQ29udGVudFNlcnZpY2U6IFByb2Nlc3NDb250ZW50U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGFjdGl2aXRpQ29udGVudFNlcnZpY2U6IEFjdGl2aXRpQ29udGVudFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjb250ZW50U2VydmljZTogQ29udGVudFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjb250ZW50RGlhbG9nOiBDb250ZW50Tm9kZURpYWxvZ1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBhcHBDb25maWdTZXJ2aWNlOiBBcHBDb25maWdTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgYXR0YWNoRGlhbG9nU2VydmljZTogQXR0YWNoRmlsZVdpZGdldERpYWxvZ1NlcnZpY2UpIHtcbiAgICAgICAgc3VwZXIoZm9ybVNlcnZpY2UsIGxvZ2dlciwgdGh1bWJuYWlscywgcHJvY2Vzc0NvbnRlbnRTZXJ2aWNlKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZmllbGQgJiZcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWUgJiZcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5oYXNGaWxlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmdldE11bHRpcGxlRmlsZVBhcmFtKCk7XG5cbiAgICAgICAgdGhpcy5hY3Rpdml0aUNvbnRlbnRTZXJ2aWNlLmdldEFsZnJlc2NvUmVwb3NpdG9yaWVzKG51bGwsIHRydWUpLnN1YnNjcmliZSgocmVwb0xpc3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVwb3NpdG9yeUxpc3QgPSByZXBvTGlzdDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5mb3JtU2VydmljZS50YXNrU2F2ZWQuc3Vic2NyaWJlKChmb3JtU2F2ZWQ6IEZvcm1FdmVudCkgPT4ge1xuICAgICAgICAgICAgaWYgKGZvcm1TYXZlZC5mb3JtLmlkID09PSB0aGlzLmZpZWxkLmZvcm0uaWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnRlbXBGaWxlc0xpc3QgPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgaXNGaWxlU291cmNlQ29uZmlndXJlZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5maWVsZC5wYXJhbXMgJiYgISF0aGlzLmZpZWxkLnBhcmFtcy5maWxlU291cmNlO1xuICAgIH1cblxuICAgIGlzTXVsdGlwbGVTb3VyY2VVcGxvYWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhdGhpcy5maWVsZC5yZWFkT25seSAmJiB0aGlzLmlzRmlsZVNvdXJjZUNvbmZpZ3VyZWQoKSAmJiAhdGhpcy5pc09ubHlMb2NhbFNvdXJjZVNlbGVjdGVkKCk7XG4gICAgfVxuXG4gICAgaXNBbGxGaWxlU291cmNlU2VsZWN0ZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpZWxkLnBhcmFtcyAmJlxuICAgICAgICAgICAgdGhpcy5maWVsZC5wYXJhbXMuZmlsZVNvdXJjZSAmJlxuICAgICAgICAgICAgdGhpcy5maWVsZC5wYXJhbXMuZmlsZVNvdXJjZS5zZXJ2aWNlSWQgPT09ICdhbGwtZmlsZS1zb3VyY2VzJztcbiAgICB9XG5cbiAgICBpc09ubHlMb2NhbFNvdXJjZVNlbGVjdGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5maWVsZC5wYXJhbXMgJiZcbiAgICAgICAgICAgIHRoaXMuZmllbGQucGFyYW1zLmZpbGVTb3VyY2UgJiZcbiAgICAgICAgICAgIHRoaXMuZmllbGQucGFyYW1zLmZpbGVTb3VyY2Uuc2VydmljZUlkID09PSAnbG9jYWwtZmlsZSc7XG4gICAgfVxuXG4gICAgaXNTaW1wbGVVcGxvYWRCdXR0b24oKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmlzVXBsb2FkQnV0dG9uVmlzaWJsZSgpICYmXG4gICAgICAgICAgICAhdGhpcy5pc0ZpbGVTb3VyY2VDb25maWd1cmVkKCkgfHxcbiAgICAgICAgICAgIHRoaXMuaXNPbmx5TG9jYWxTb3VyY2VTZWxlY3RlZCgpO1xuICAgIH1cblxuICAgIGlzVXBsb2FkQnV0dG9uVmlzaWJsZSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICghdGhpcy5oYXNGaWxlIHx8IHRoaXMubXVsdGlwbGVPcHRpb24pICYmICF0aGlzLmZpZWxkLnJlYWRPbmx5O1xuICAgIH1cblxuICAgIGlzRGVmaW5lZFNvdXJjZUZvbGRlcigpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5maWVsZC5wYXJhbXMgJiZcbiAgICAgICAgICAgICEhdGhpcy5maWVsZC5wYXJhbXMuZmlsZVNvdXJjZSAmJlxuICAgICAgICAgICAgISF0aGlzLmZpZWxkLnBhcmFtcy5maWxlU291cmNlLnNlbGVjdGVkRm9sZGVyO1xuICAgIH1cblxuICAgIGlzVGVtcG9yYXJ5RmlsZShmaWxlKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRlbXBGaWxlc0xpc3QuZmluZEluZGV4KChlbGVtKSA9PiBlbGVtLm5hbWUgPT09IGZpbGUubmFtZSkgPj0gMDtcbiAgICB9XG5cbiAgICBvcGVuU2VsZWN0RGlhbG9nRnJvbUZpbGVTb3VyY2UoKSB7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuZmllbGQucGFyYW1zO1xuICAgICAgICBpZiAodGhpcy5pc0RlZmluZWRTb3VyY2VGb2xkZXIoKSkge1xuICAgICAgICAgICAgdGhpcy5jb250ZW50RGlhbG9nLm9wZW5GaWxlQnJvd3NlRGlhbG9nQnlGb2xkZXJJZChwYXJhbXMuZmlsZVNvdXJjZS5zZWxlY3RlZEZvbGRlci5wYXRoSWQpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoc2VsZWN0aW9uczogTm9kZVtdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGVtcEZpbGVzTGlzdC5wdXNoKC4uLnNlbGVjdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZEZpbGVGcm9tQ1Moc2VsZWN0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQucGFyYW1zLmZpbGVTb3VyY2Uuc2VsZWN0ZWRGb2xkZXIuYWNjb3VudElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZC5wYXJhbXMuZmlsZVNvdXJjZS5zZWxlY3RlZEZvbGRlci5zaXRlSWQpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25BdHRhY2hGaWxlQ2hhbmdlZChldmVudDogYW55KSB7XG4gICAgICAgIHRoaXMudGVtcEZpbGVzTGlzdC5wdXNoKC4uLkFycmF5LmZyb20oZXZlbnQudGFyZ2V0LmZpbGVzKSk7XG4gICAgICAgIHRoaXMub25GaWxlQ2hhbmdlZChldmVudCk7XG4gICAgfVxuXG4gICAgb25SZW1vdmVBdHRhY2hGaWxlKGZpbGU6IEZpbGUgfCBSZWxhdGVkQ29udGVudFJlcHJlc2VudGF0aW9uKSB7XG4gICAgICAgIGlmICh0aGlzLmlzVGVtcG9yYXJ5RmlsZShmaWxlKSkge1xuICAgICAgICAgICAgdGhpcy50ZW1wRmlsZXNMaXN0LnNwbGljZSh0aGlzLnRlbXBGaWxlc0xpc3QuaW5kZXhPZigoPFJlbGF0ZWRDb250ZW50UmVwcmVzZW50YXRpb24+IGZpbGUpLmNvbnRlbnRCbG9iKSwgMSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZW1vdmVGaWxlKGZpbGUpO1xuICAgIH1cblxuICAgIG9uQXR0YWNoRmlsZUNsaWNrZWQoZmlsZTogYW55KSB7XG4gICAgICAgIGlmIChmaWxlLmlzRXh0ZXJuYWwpIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmluZm8oYFRoZSBmaWxlICR7ZmlsZS5uYW1lfSBjb21lcyBmcm9tIGFuIGV4dGVybmFsIHNvdXJjZSBhbmQgY2Fubm90IGJlIHNob3dlZCBhdCB0aGlzIG1vbWVudGApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmlzVGVtcG9yYXJ5RmlsZShmaWxlKSkge1xuICAgICAgICAgICAgdGhpcy5mb3JtU2VydmljZS5mb3JtQ29udGVudENsaWNrZWQubmV4dChmaWxlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZmlsZUNsaWNrZWQoZmlsZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkb3dubG9hZENvbnRlbnQoZmlsZTogYW55IHwgUmVsYXRlZENvbnRlbnRSZXByZXNlbnRhdGlvbik6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5pc1RlbXBvcmFyeUZpbGUoZmlsZSkpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudFNlcnZpY2UuZG93bmxvYWRCbG9iKCg8UmVsYXRlZENvbnRlbnRSZXByZXNlbnRhdGlvbj4gZmlsZSkuY29udGVudEJsb2IsIGZpbGUubmFtZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NDb250ZW50U2VydmljZS5nZXRGaWxlUmF3Q29udGVudCgoPGFueT4gZmlsZSkuaWQpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoYmxvYjogQmxvYikgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRlbnRTZXJ2aWNlLmRvd25sb2FkQmxvYihibG9iLCAoPGFueT4gZmlsZSkubmFtZSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdJbXBvc3NpYmxlIHJldHJpZXZlIGNvbnRlbnQgZm9yIGRvd25sb2FkJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9wZW5TZWxlY3REaWFsb2cocmVwb3NpdG9yeSkge1xuICAgICAgICBjb25zdCBhY2NvdW50SWRlbnRpZmllciA9ICdhbGZyZXNjby0nICsgcmVwb3NpdG9yeS5pZCArICctJyArIHJlcG9zaXRvcnkubmFtZTtcbiAgICAgICAgY29uc3QgY3VycmVudEVDTUhvc3QgPSB0aGlzLmdldERvbWFpbkhvc3QodGhpcy5hcHBDb25maWdTZXJ2aWNlLmdldChBcHBDb25maWdWYWx1ZXMuRUNNSE9TVCkpO1xuICAgICAgICBjb25zdCBjaG9zZW5SZXBvc2l0b3J5SG9zdCA9IHRoaXMuZ2V0RG9tYWluSG9zdChyZXBvc2l0b3J5LnJlcG9zaXRvcnlVcmwpO1xuICAgICAgICBpZiAoY2hvc2VuUmVwb3NpdG9yeUhvc3QgIT09IGN1cnJlbnRFQ01Ib3N0KSB7XG4gICAgICAgICAgICBjb25zdCBmb3JtYXR0ZWRSZXBvc2l0b3J5SG9zdCA9IHJlcG9zaXRvcnkucmVwb3NpdG9yeVVybC5yZXBsYWNlKCcvYWxmcmVzY28nLCAnJyk7XG4gICAgICAgICAgICB0aGlzLmF0dGFjaERpYWxvZ1NlcnZpY2Uub3BlbkxvZ2luKGZvcm1hdHRlZFJlcG9zaXRvcnlIb3N0KS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKHNlbGVjdGlvbnM6IGFueVtdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbnMuZm9yRWFjaCgobm9kZSkgPT4gbm9kZS5pc0V4dGVybmFsID0gdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGVtcEZpbGVzTGlzdC5wdXNoKC4uLnNlbGVjdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZEZpbGVGcm9tQ1Moc2VsZWN0aW9ucywgYWNjb3VudElkZW50aWZpZXIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jb250ZW50RGlhbG9nLm9wZW5GaWxlQnJvd3NlRGlhbG9nQnlTaXRlKCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChzZWxlY3Rpb25zOiBOb2RlW10pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZW1wRmlsZXNMaXN0LnB1c2goLi4uc2VsZWN0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZUZyb21DUyhzZWxlY3Rpb25zLCBhY2NvdW50SWRlbnRpZmllcik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHVwbG9hZEZpbGVGcm9tQ1MoZmlsZU5vZGVMaXN0OiBhbnlbXSwgYWNjb3VudElkOiBzdHJpbmcsIHNpdGVJZD86IHN0cmluZykge1xuICAgICAgICBjb25zdCBmaWxlc1NhdmVkID0gW107XG4gICAgICAgIGZyb20oZmlsZU5vZGVMaXN0KS5waXBlKFxuICAgICAgICAgICAgbWVyZ2VNYXAoKG5vZGUpID0+XG4gICAgICAgICAgICAgICAgemlwKFxuICAgICAgICAgICAgICAgICAgICBvZihub2RlLmNvbnRlbnQubWltZVR5cGUpLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2aXRpQ29udGVudFNlcnZpY2UuYXBwbHlBbGZyZXNjb05vZGUobm9kZSwgc2l0ZUlkLCBhY2NvdW50SWQpLFxuICAgICAgICAgICAgICAgICAgICBvZihub2RlLmlzRXh0ZXJuYWwpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICApXG4gICAgICAgICAgICAuc3Vic2NyaWJlKChbbWltZVR5cGUsIHJlcywgaXNFeHRlcm5hbF0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzLm1pbWVUeXBlID0gbWltZVR5cGU7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5pc0V4dGVybmFsID0gaXNFeHRlcm5hbDtcbiAgICAgICAgICAgICAgICAgICAgZmlsZXNTYXZlZC5wdXNoKHJlcyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLnZhbHVlID0gZmlsZXNTYXZlZDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZC5qc29uLnZhbHVlID0gZmlsZXNTYXZlZDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYXNGaWxlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldERvbWFpbkhvc3QodXJsVG9DaGVjaykge1xuICAgICAgICBjb25zdCByZXN1bHQgPSB1cmxUb0NoZWNrLm1hdGNoKCdeKD86aHR0cHM/OlxcL1xcLyk/KD86W15AXFwvXFxuXStAKT8oPzp3d3dcXC4pPyhbXjpcXC8/XFxuXSspJyk7XG4gICAgICAgIHJldHVybiByZXN1bHRbMV07XG4gICAgfVxuXG59XG4iXX0=