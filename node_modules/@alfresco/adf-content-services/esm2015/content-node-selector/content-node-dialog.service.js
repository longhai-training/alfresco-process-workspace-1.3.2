/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { MatDialog } from '@angular/material';
import { EventEmitter, Injectable, Output } from '@angular/core';
import { ContentService, ThumbnailService } from '@alfresco/adf-core';
import { Subject, throwError } from 'rxjs';
import { SitesService, TranslationService, AllowableOperationsEnum } from '@alfresco/adf-core';
import { DocumentListService } from '../document-list/services/document-list.service';
import { ContentNodeSelectorComponent } from './content-node-selector.component';
import { NodeLockDialogComponent } from '../dialogs/node-lock.dialog';
import { switchMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/material/dialog";
import * as i2 from "@alfresco/adf-core";
import * as i3 from "../document-list/services/document-list.service";
export class ContentNodeDialogService {
    /**
     * @param {?} dialog
     * @param {?} contentService
     * @param {?} documentListService
     * @param {?} siteService
     * @param {?} translation
     * @param {?} thumbnailService
     */
    constructor(dialog, contentService, documentListService, siteService, translation, thumbnailService) {
        this.dialog = dialog;
        this.contentService = contentService;
        this.documentListService = documentListService;
        this.siteService = siteService;
        this.translation = translation;
        this.thumbnailService = thumbnailService;
        /**
         * Emitted when an error occurs.
         */
        this.error = new EventEmitter();
    }
    /**
     * Opens a file browser at a chosen folder location.
     * @param {?} folderNodeId ID of the folder to use
     * @return {?} Information about the selected file(s)
     */
    openFileBrowseDialogByFolderId(folderNodeId) {
        return this.documentListService.getFolderNode(folderNodeId).pipe(switchMap((/**
         * @param {?} nodeEntry
         * @return {?}
         */
        (nodeEntry) => {
            return this.openUploadFileDialog('Choose', nodeEntry.entry);
        })));
    }
    /**
     * Opens a lock node dialog.
     * @param {?} contentEntry Node to lock
     * @return {?} Error/status message (if any)
     */
    openLockNodeDialog(contentEntry) {
        /** @type {?} */
        const observable = new Subject();
        if (this.contentService.hasAllowableOperations(contentEntry, AllowableOperationsEnum.LOCK)) {
            this.dialog.open(NodeLockDialogComponent, {
                data: {
                    node: contentEntry,
                    onError: (/**
                     * @param {?} error
                     * @return {?}
                     */
                    (error) => {
                        this.error.emit(error);
                        observable.error(error);
                    })
                },
                width: '400px'
            });
        }
        else {
            observable.error('OPERATION.FAIL.NODE.NO_PERMISSION');
        }
        return observable;
    }
    /**
     * Opens a file browser at a chosen site location.
     * @return {?} Information about the selected file(s)
     */
    openFileBrowseDialogBySite() {
        return this.siteService.getSites().pipe(switchMap((/**
         * @param {?} response
         * @return {?}
         */
        (response) => {
            return this.openFileBrowseDialogByFolderId(response.list.entries[0].entry.guid);
        })));
    }
    /**
     * Opens a folder browser at a chosen site location.
     * @return {?} Information about the selected folder(s)
     */
    openFolderBrowseDialogBySite() {
        return this.openFolderBrowseDialogByFolderId('-my-');
    }
    /**
     * Opens a folder browser at a chosen folder location.
     * @param {?} folderNodeId ID of the folder to use
     * @return {?} Information about the selected folder(s)
     */
    openFolderBrowseDialogByFolderId(folderNodeId) {
        return this.documentListService.getFolderNode(folderNodeId).pipe(switchMap((/**
         * @param {?} node
         * @return {?}
         */
        (node) => {
            return this.openUploadFolderDialog('Choose', node.entry);
        })));
    }
    /**
     * Opens a dialog to copy or move an item to a new location.
     * @param {?} action Name of the action (eg, "Copy" or "Move") to show in the title
     * @param {?} contentEntry Item to be copied or moved
     * @param {?=} permission Permission for the operation
     * @param {?=} excludeSiteContent The site content that should be filtered out
     * @return {?} Information about files that were copied/moved
     */
    openCopyMoveDialog(action, contentEntry, permission, excludeSiteContent) {
        if (this.contentService.hasAllowableOperations(contentEntry, permission)) {
            /** @type {?} */
            const select = new Subject();
            select.subscribe({
                complete: this.close.bind(this)
            });
            /** @type {?} */
            const title = this.getTitleTranslation(action, contentEntry.name);
            /** @type {?} */
            const data = {
                title: title,
                actionName: action,
                currentFolderId: contentEntry.parentId,
                imageResolver: this.imageResolver.bind(this),
                where: '(isFolder=true)',
                isSelectionValid: this.isCopyMoveSelectionValid.bind(this),
                excludeSiteContent: excludeSiteContent || ContentNodeDialogService.nonDocumentSiteContent,
                select: select
            };
            this.openContentNodeDialog(data, 'adf-content-node-selector-dialog', '630px');
            return select;
        }
        else {
            /** @type {?} */
            const errors = new Error(JSON.stringify({ error: { statusCode: 403 } }));
            return throwError(errors);
        }
    }
    /**
     * Gets the translation of the dialog title.
     * @param {?} action Name of the action to display in the dialog title
     * @param {?} name Name of the item on which the action is being performed
     * @return {?} Translated version of the title
     */
    getTitleTranslation(action, name) {
        return this.translation.instant(`NODE_SELECTOR.${action.toUpperCase()}_ITEM`, { name });
    }
    /**
     * Opens a dialog to choose folders to upload.
     * @param {?} action Name of the action to show in the title
     * @param {?} contentEntry  Item to upload
     * @return {?} Information about the chosen folder(s)
     */
    openUploadFolderDialog(action, contentEntry) {
        /** @type {?} */
        const select = new Subject();
        select.subscribe({
            complete: this.close.bind(this)
        });
        /** @type {?} */
        const data = {
            title: `${action} '${contentEntry.name}' to ...`,
            actionName: action,
            currentFolderId: contentEntry.id,
            imageResolver: this.imageResolver.bind(this),
            isSelectionValid: this.hasAllowableOperationsOnNodeFolder.bind(this),
            where: '(isFolder=true)',
            select: select
        };
        this.openContentNodeDialog(data, 'adf-content-node-selector-dialog', '630px');
        return select;
    }
    /**
     * Opens a dialog to choose a file to upload.
     * @param {?} action Name of the action to show in the title
     * @param {?} contentEntry Item to upload
     * @return {?} Information about the chosen file(s)
     */
    openUploadFileDialog(action, contentEntry) {
        /** @type {?} */
        const select = new Subject();
        select.subscribe({
            complete: this.close.bind(this)
        });
        /** @type {?} */
        const data = {
            title: `${action} '${contentEntry.name}' to ...`,
            actionName: action,
            currentFolderId: contentEntry.id,
            imageResolver: this.imageResolver.bind(this),
            isSelectionValid: this.isNodeFile.bind(this),
            select: select
        };
        this.openContentNodeDialog(data, 'adf-content-node-selector-dialog', '630px');
        return select;
    }
    /**
     * @private
     * @param {?} data
     * @param {?} currentPanelClass
     * @param {?} chosenWidth
     * @return {?}
     */
    openContentNodeDialog(data, currentPanelClass, chosenWidth) {
        this.dialog.open(ContentNodeSelectorComponent, { data, panelClass: currentPanelClass, width: chosenWidth });
    }
    /**
     * @private
     * @param {?} row
     * @param {?} col
     * @return {?}
     */
    imageResolver(row, col) {
        /** @type {?} */
        const entry = row.node.entry;
        if (!this.contentService.hasAllowableOperations(entry, 'create')) {
            return this.thumbnailService.getMimeTypeIcon('disable/folder');
        }
        return null;
    }
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    isNodeFile(entry) {
        return entry.isFile;
    }
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    hasAllowableOperationsOnNodeFolder(entry) {
        return this.isNodeFolder(entry) && this.contentService.hasAllowableOperations(entry, 'create');
    }
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    isNodeFolder(entry) {
        return entry.isFolder;
    }
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    isCopyMoveSelectionValid(entry) {
        return this.hasEntityCreatePermission(entry) && !this.isSite(entry);
    }
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    hasEntityCreatePermission(entry) {
        return this.contentService.hasAllowableOperations(entry, 'create');
    }
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    isSite(entry) {
        return !!entry.guid || entry.nodeType === 'st:site' || entry.nodeType === 'st:sites';
    }
    /**
     * Closes the currently open dialog.
     * @return {?}
     */
    close() {
        this.dialog.closeAll();
    }
}
ContentNodeDialogService.nonDocumentSiteContent = [
    'blog',
    'calendar',
    'dataLists',
    'discussions',
    'links',
    'wiki'
];
ContentNodeDialogService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
ContentNodeDialogService.ctorParameters = () => [
    { type: MatDialog },
    { type: ContentService },
    { type: DocumentListService },
    { type: SitesService },
    { type: TranslationService },
    { type: ThumbnailService }
];
ContentNodeDialogService.propDecorators = {
    error: [{ type: Output }]
};
/** @nocollapse */ ContentNodeDialogService.ngInjectableDef = i0.defineInjectable({ factory: function ContentNodeDialogService_Factory() { return new ContentNodeDialogService(i0.inject(i1.MatDialog), i0.inject(i2.ContentService), i0.inject(i3.DocumentListService), i0.inject(i2.SitesService), i0.inject(i2.TranslationService), i0.inject(i2.ThumbnailService)); }, token: ContentNodeDialogService, providedIn: "root" });
if (false) {
    /** @type {?} */
    ContentNodeDialogService.nonDocumentSiteContent;
    /**
     * Emitted when an error occurs.
     * @type {?}
     */
    ContentNodeDialogService.prototype.error;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.dialog;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.contentService;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.documentListService;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.siteService;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.translation;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.thumbnailService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1ub2RlLWRpYWxvZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFsZnJlc2NvL2FkZi1jb250ZW50LXNlcnZpY2VzLyIsInNvdXJjZXMiOlsiY29udGVudC1ub2RlLXNlbGVjdG9yL2NvbnRlbnQtbm9kZS1kaWFsb2cuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUMsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN0RSxPQUFPLEVBQUUsT0FBTyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUd2RCxPQUFPLEVBQWMsWUFBWSxFQUFFLGtCQUFrQixFQUFFLHVCQUF1QixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDM0csT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0saURBQWlELENBQUM7QUFDdEYsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFakYsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDdEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQUszQyxNQUFNLE9BQU8sd0JBQXdCOzs7Ozs7Ozs7SUFjakMsWUFBb0IsTUFBaUIsRUFDakIsY0FBOEIsRUFDOUIsbUJBQXdDLEVBQ3hDLFdBQXlCLEVBQ3pCLFdBQStCLEVBQy9CLGdCQUFrQztRQUxsQyxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQ2pCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5Qix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLGdCQUFXLEdBQVgsV0FBVyxDQUFjO1FB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T0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxLQUFLLENBQUMsUUFBUSxLQUFLLFNBQVMsSUFBSSxLQUFLLENBQUMsUUFBUSxLQUFLLFVBQVUsQ0FBQztJQUN6RixDQUFDOzs7OztJQUdELEtBQUs7UUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzNCLENBQUM7O0FBbE9NLCtDQUFzQixHQUFHO0lBQzVCLE1BQU07SUFDTixVQUFVO0lBQ1YsV0FBVztJQUNYLGFBQWE7SUFDYixPQUFPO0lBQ1AsTUFBTTtDQUNULENBQUM7O1lBWEwsVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7O1lBZlEsU0FBUztZQUVULGNBQWM7WUFLZCxtQkFBbUI7WUFEUCxZQUFZO1lBQUUsa0JBQWtCO1lBSjVCLGdCQUFnQjs7O29CQXlCcEMsTUFBTTs7Ozs7SUFWUCxnREFPRTs7Ozs7SUFHRix5Q0FDbUQ7Ozs7O0lBRXZDLDBDQUF5Qjs7Ozs7SUFDekIsa0RBQXNDOzs7OztJQUN0Qyx1REFBZ0Q7Ozs7O0lBQ2hELCtDQUFpQzs7Ozs7SUFDakMsK0NBQXVDOzs7OztJQUN2QyxvREFBMEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBNYXREaWFsb2cgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbCc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdGFibGUsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udGVudFNlcnZpY2UsIFRodW1ibmFpbFNlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCwgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgU2hhcmVEYXRhUm93IH0gZnJvbSAnLi4vZG9jdW1lbnQtbGlzdC9kYXRhL3NoYXJlLWRhdGEtcm93Lm1vZGVsJztcbmltcG9ydCB7IE5vZGUsIE5vZGVFbnRyeSwgU2l0ZVBhZ2luZyB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgRGF0YUNvbHVtbiwgU2l0ZXNTZXJ2aWNlLCBUcmFuc2xhdGlvblNlcnZpY2UsIEFsbG93YWJsZU9wZXJhdGlvbnNFbnVtIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IERvY3VtZW50TGlzdFNlcnZpY2UgfSBmcm9tICcuLi9kb2N1bWVudC1saXN0L3NlcnZpY2VzL2RvY3VtZW50LWxpc3Quc2VydmljZSc7XG5pbXBvcnQgeyBDb250ZW50Tm9kZVNlbGVjdG9yQ29tcG9uZW50IH0gZnJvbSAnLi9jb250ZW50LW5vZGUtc2VsZWN0b3IuY29tcG9uZW50JztcbmltcG9ydCB7IENvbnRlbnROb2RlU2VsZWN0b3JDb21wb25lbnREYXRhIH0gZnJvbSAnLi9jb250ZW50LW5vZGUtc2VsZWN0b3IuY29tcG9uZW50LWRhdGEuaW50ZXJmYWNlJztcbmltcG9ydCB7IE5vZGVMb2NrRGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnLi4vZGlhbG9ncy9ub2RlLWxvY2suZGlhbG9nJztcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBDb250ZW50Tm9kZURpYWxvZ1NlcnZpY2Uge1xuICAgIHN0YXRpYyBub25Eb2N1bWVudFNpdGVDb250ZW50ID0gW1xuICAgICAgICAnYmxvZycsXG4gICAgICAgICdjYWxlbmRhcicsXG4gICAgICAgICdkYXRhTGlzdHMnLFxuICAgICAgICAnZGlzY3Vzc2lvbnMnLFxuICAgICAgICAnbGlua3MnLFxuICAgICAgICAnd2lraSdcbiAgICBdO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiBhbiBlcnJvciBvY2N1cnMuICovXG4gICAgQE91dHB1dCgpXG4gICAgZXJyb3I6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRpYWxvZzogTWF0RGlhbG9nLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgY29udGVudFNlcnZpY2U6IENvbnRlbnRTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgZG9jdW1lbnRMaXN0U2VydmljZTogRG9jdW1lbnRMaXN0U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHNpdGVTZXJ2aWNlOiBTaXRlc1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSB0cmFuc2xhdGlvbjogVHJhbnNsYXRpb25TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdGh1bWJuYWlsU2VydmljZTogVGh1bWJuYWlsU2VydmljZSkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZmlsZSBicm93c2VyIGF0IGEgY2hvc2VuIGZvbGRlciBsb2NhdGlvbi5cbiAgICAgKiBAcGFyYW0gZm9sZGVyTm9kZUlkIElEIG9mIHRoZSBmb2xkZXIgdG8gdXNlXG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgdGhlIHNlbGVjdGVkIGZpbGUocylcbiAgICAgKi9cbiAgICBvcGVuRmlsZUJyb3dzZURpYWxvZ0J5Rm9sZGVySWQoZm9sZGVyTm9kZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPE5vZGVbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudExpc3RTZXJ2aWNlLmdldEZvbGRlck5vZGUoZm9sZGVyTm9kZUlkKS5waXBlKHN3aXRjaE1hcCgobm9kZUVudHJ5OiBOb2RlRW50cnkpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9wZW5VcGxvYWRGaWxlRGlhbG9nKCdDaG9vc2UnLCBub2RlRW50cnkuZW50cnkpO1xuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT3BlbnMgYSBsb2NrIG5vZGUgZGlhbG9nLlxuICAgICAqIEBwYXJhbSBjb250ZW50RW50cnkgTm9kZSB0byBsb2NrXG4gICAgICogQHJldHVybnMgRXJyb3Ivc3RhdHVzIG1lc3NhZ2UgKGlmIGFueSlcbiAgICAgKi9cbiAgICBwdWJsaWMgb3BlbkxvY2tOb2RlRGlhbG9nKGNvbnRlbnRFbnRyeTogTm9kZSk6IFN1YmplY3Q8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IG9ic2VydmFibGU6IFN1YmplY3Q8c3RyaW5nPiA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcblxuICAgICAgICBpZiAodGhpcy5jb250ZW50U2VydmljZS5oYXNBbGxvd2FibGVPcGVyYXRpb25zKGNvbnRlbnRFbnRyeSwgQWxsb3dhYmxlT3BlcmF0aW9uc0VudW0uTE9DSykpIHtcbiAgICAgICAgICAgIHRoaXMuZGlhbG9nLm9wZW4oTm9kZUxvY2tEaWFsb2dDb21wb25lbnQsIHtcbiAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGU6IGNvbnRlbnRFbnRyeSxcbiAgICAgICAgICAgICAgICAgICAgb25FcnJvcjogKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9yLmVtaXQoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2YWJsZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHdpZHRoOiAnNDAwcHgnXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9ic2VydmFibGUuZXJyb3IoJ09QRVJBVElPTi5GQUlMLk5PREUuTk9fUEVSTUlTU0lPTicpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG9ic2VydmFibGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT3BlbnMgYSBmaWxlIGJyb3dzZXIgYXQgYSBjaG9zZW4gc2l0ZSBsb2NhdGlvbi5cbiAgICAgKiBAcmV0dXJucyBJbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VsZWN0ZWQgZmlsZShzKVxuICAgICAqL1xuICAgIG9wZW5GaWxlQnJvd3NlRGlhbG9nQnlTaXRlKCk6IE9ic2VydmFibGU8Tm9kZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnNpdGVTZXJ2aWNlLmdldFNpdGVzKCkucGlwZShzd2l0Y2hNYXAoKHJlc3BvbnNlOiBTaXRlUGFnaW5nKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vcGVuRmlsZUJyb3dzZURpYWxvZ0J5Rm9sZGVySWQocmVzcG9uc2UubGlzdC5lbnRyaWVzWzBdLmVudHJ5Lmd1aWQpO1xuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT3BlbnMgYSBmb2xkZXIgYnJvd3NlciBhdCBhIGNob3NlbiBzaXRlIGxvY2F0aW9uLlxuICAgICAqIEByZXR1cm5zIEluZm9ybWF0aW9uIGFib3V0IHRoZSBzZWxlY3RlZCBmb2xkZXIocylcbiAgICAgKi9cbiAgICBvcGVuRm9sZGVyQnJvd3NlRGlhbG9nQnlTaXRlKCk6IE9ic2VydmFibGU8Tm9kZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLm9wZW5Gb2xkZXJCcm93c2VEaWFsb2dCeUZvbGRlcklkKCctbXktJyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT3BlbnMgYSBmb2xkZXIgYnJvd3NlciBhdCBhIGNob3NlbiBmb2xkZXIgbG9jYXRpb24uXG4gICAgICogQHBhcmFtIGZvbGRlck5vZGVJZCBJRCBvZiB0aGUgZm9sZGVyIHRvIHVzZVxuICAgICAqIEByZXR1cm5zIEluZm9ybWF0aW9uIGFib3V0IHRoZSBzZWxlY3RlZCBmb2xkZXIocylcbiAgICAgKi9cbiAgICBvcGVuRm9sZGVyQnJvd3NlRGlhbG9nQnlGb2xkZXJJZChmb2xkZXJOb2RlSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Tm9kZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50TGlzdFNlcnZpY2UuZ2V0Rm9sZGVyTm9kZShmb2xkZXJOb2RlSWQpLnBpcGUoc3dpdGNoTWFwKChub2RlOiBOb2RlRW50cnkpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9wZW5VcGxvYWRGb2xkZXJEaWFsb2coJ0Nob29zZScsIG5vZGUuZW50cnkpO1xuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT3BlbnMgYSBkaWFsb2cgdG8gY29weSBvciBtb3ZlIGFuIGl0ZW0gdG8gYSBuZXcgbG9jYXRpb24uXG4gICAgICogQHBhcmFtIGFjdGlvbiBOYW1lIG9mIHRoZSBhY3Rpb24gKGVnLCBcIkNvcHlcIiBvciBcIk1vdmVcIikgdG8gc2hvdyBpbiB0aGUgdGl0bGVcbiAgICAgKiBAcGFyYW0gY29udGVudEVudHJ5IEl0ZW0gdG8gYmUgY29waWVkIG9yIG1vdmVkXG4gICAgICogQHBhcmFtIHBlcm1pc3Npb24gUGVybWlzc2lvbiBmb3IgdGhlIG9wZXJhdGlvblxuICAgICAqIEBwYXJhbSBleGNsdWRlU2l0ZUNvbnRlbnQgVGhlIHNpdGUgY29udGVudCB0aGF0IHNob3VsZCBiZSBmaWx0ZXJlZCBvdXRcbiAgICAgKiBAcmV0dXJucyBJbmZvcm1hdGlvbiBhYm91dCBmaWxlcyB0aGF0IHdlcmUgY29waWVkL21vdmVkXG4gICAgICovXG4gICAgb3BlbkNvcHlNb3ZlRGlhbG9nKGFjdGlvbjogc3RyaW5nLCBjb250ZW50RW50cnk6IE5vZGUsIHBlcm1pc3Npb24/OiBzdHJpbmcsIGV4Y2x1ZGVTaXRlQ29udGVudD86IHN0cmluZ1tdKTogT2JzZXJ2YWJsZTxOb2RlW10+IHtcbiAgICAgICAgaWYgKHRoaXMuY29udGVudFNlcnZpY2UuaGFzQWxsb3dhYmxlT3BlcmF0aW9ucyhjb250ZW50RW50cnksIHBlcm1pc3Npb24pKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdCA9IG5ldyBTdWJqZWN0PE5vZGVbXT4oKTtcbiAgICAgICAgICAgIHNlbGVjdC5zdWJzY3JpYmUoe1xuICAgICAgICAgICAgICAgIGNvbXBsZXRlOiB0aGlzLmNsb3NlLmJpbmQodGhpcylcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb25zdCB0aXRsZSA9IHRoaXMuZ2V0VGl0bGVUcmFuc2xhdGlvbihhY3Rpb24sIGNvbnRlbnRFbnRyeS5uYW1lKTtcblxuICAgICAgICAgICAgY29uc3QgZGF0YTogQ29udGVudE5vZGVTZWxlY3RvckNvbXBvbmVudERhdGEgPSB7XG4gICAgICAgICAgICAgICAgdGl0bGU6IHRpdGxlLFxuICAgICAgICAgICAgICAgIGFjdGlvbk5hbWU6IGFjdGlvbixcbiAgICAgICAgICAgICAgICBjdXJyZW50Rm9sZGVySWQ6IGNvbnRlbnRFbnRyeS5wYXJlbnRJZCxcbiAgICAgICAgICAgICAgICBpbWFnZVJlc29sdmVyOiB0aGlzLmltYWdlUmVzb2x2ZXIuYmluZCh0aGlzKSxcbiAgICAgICAgICAgICAgICB3aGVyZTogJyhpc0ZvbGRlcj10cnVlKScsXG4gICAgICAgICAgICAgICAgaXNTZWxlY3Rpb25WYWxpZDogdGhpcy5pc0NvcHlNb3ZlU2VsZWN0aW9uVmFsaWQuYmluZCh0aGlzKSxcbiAgICAgICAgICAgICAgICBleGNsdWRlU2l0ZUNvbnRlbnQ6IGV4Y2x1ZGVTaXRlQ29udGVudCB8fCBDb250ZW50Tm9kZURpYWxvZ1NlcnZpY2Uubm9uRG9jdW1lbnRTaXRlQ29udGVudCxcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHNlbGVjdFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgdGhpcy5vcGVuQ29udGVudE5vZGVEaWFsb2coZGF0YSwgJ2FkZi1jb250ZW50LW5vZGUtc2VsZWN0b3ItZGlhbG9nJywgJzYzMHB4Jyk7XG5cbiAgICAgICAgICAgIHJldHVybiBzZWxlY3Q7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBlcnJvcnMgPSBuZXcgRXJyb3IoSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogeyBzdGF0dXNDb2RlOiA0MDMgfSB9KSk7XG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgdHJhbnNsYXRpb24gb2YgdGhlIGRpYWxvZyB0aXRsZS5cbiAgICAgKiBAcGFyYW0gYWN0aW9uIE5hbWUgb2YgdGhlIGFjdGlvbiB0byBkaXNwbGF5IGluIHRoZSBkaWFsb2cgdGl0bGVcbiAgICAgKiBAcGFyYW0gbmFtZSBOYW1lIG9mIHRoZSBpdGVtIG9uIHdoaWNoIHRoZSBhY3Rpb24gaXMgYmVpbmcgcGVyZm9ybWVkXG4gICAgICogQHJldHVybnMgVHJhbnNsYXRlZCB2ZXJzaW9uIG9mIHRoZSB0aXRsZVxuICAgICAqL1xuICAgIGdldFRpdGxlVHJhbnNsYXRpb24oYWN0aW9uOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0aW9uLmluc3RhbnQoYE5PREVfU0VMRUNUT1IuJHthY3Rpb24udG9VcHBlckNhc2UoKX1fSVRFTWAsIHsgbmFtZSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPcGVucyBhIGRpYWxvZyB0byBjaG9vc2UgZm9sZGVycyB0byB1cGxvYWQuXG4gICAgICogQHBhcmFtIGFjdGlvbiBOYW1lIG9mIHRoZSBhY3Rpb24gdG8gc2hvdyBpbiB0aGUgdGl0bGVcbiAgICAgKiBAcGFyYW0gY29udGVudEVudHJ5ICBJdGVtIHRvIHVwbG9hZFxuICAgICAqIEByZXR1cm5zIEluZm9ybWF0aW9uIGFib3V0IHRoZSBjaG9zZW4gZm9sZGVyKHMpXG4gICAgICovXG4gICAgb3BlblVwbG9hZEZvbGRlckRpYWxvZyhhY3Rpb246IHN0cmluZywgY29udGVudEVudHJ5OiBOb2RlKTogT2JzZXJ2YWJsZTxOb2RlW10+IHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ID0gbmV3IFN1YmplY3Q8Tm9kZVtdPigpO1xuICAgICAgICBzZWxlY3Quc3Vic2NyaWJlKHtcbiAgICAgICAgICAgIGNvbXBsZXRlOiB0aGlzLmNsb3NlLmJpbmQodGhpcylcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgZGF0YTogQ29udGVudE5vZGVTZWxlY3RvckNvbXBvbmVudERhdGEgPSB7XG4gICAgICAgICAgICB0aXRsZTogYCR7YWN0aW9ufSAnJHtjb250ZW50RW50cnkubmFtZX0nIHRvIC4uLmAsXG4gICAgICAgICAgICBhY3Rpb25OYW1lOiBhY3Rpb24sXG4gICAgICAgICAgICBjdXJyZW50Rm9sZGVySWQ6IGNvbnRlbnRFbnRyeS5pZCxcbiAgICAgICAgICAgIGltYWdlUmVzb2x2ZXI6IHRoaXMuaW1hZ2VSZXNvbHZlci5iaW5kKHRoaXMpLFxuICAgICAgICAgICAgaXNTZWxlY3Rpb25WYWxpZDogdGhpcy5oYXNBbGxvd2FibGVPcGVyYXRpb25zT25Ob2RlRm9sZGVyLmJpbmQodGhpcyksXG4gICAgICAgICAgICB3aGVyZTogJyhpc0ZvbGRlcj10cnVlKScsXG4gICAgICAgICAgICBzZWxlY3Q6IHNlbGVjdFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMub3BlbkNvbnRlbnROb2RlRGlhbG9nKGRhdGEsICdhZGYtY29udGVudC1ub2RlLXNlbGVjdG9yLWRpYWxvZycsICc2MzBweCcpO1xuICAgICAgICByZXR1cm4gc2VsZWN0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZGlhbG9nIHRvIGNob29zZSBhIGZpbGUgdG8gdXBsb2FkLlxuICAgICAqIEBwYXJhbSBhY3Rpb24gTmFtZSBvZiB0aGUgYWN0aW9uIHRvIHNob3cgaW4gdGhlIHRpdGxlXG4gICAgICogQHBhcmFtIGNvbnRlbnRFbnRyeSBJdGVtIHRvIHVwbG9hZFxuICAgICAqIEByZXR1cm5zIEluZm9ybWF0aW9uIGFib3V0IHRoZSBjaG9zZW4gZmlsZShzKVxuICAgICAqL1xuICAgIG9wZW5VcGxvYWRGaWxlRGlhbG9nKGFjdGlvbjogc3RyaW5nLCBjb250ZW50RW50cnk6IE5vZGUpOiBPYnNlcnZhYmxlPE5vZGVbXT4ge1xuICAgICAgICBjb25zdCBzZWxlY3QgPSBuZXcgU3ViamVjdDxOb2RlW10+KCk7XG4gICAgICAgIHNlbGVjdC5zdWJzY3JpYmUoe1xuICAgICAgICAgICAgY29tcGxldGU6IHRoaXMuY2xvc2UuYmluZCh0aGlzKVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBkYXRhOiBDb250ZW50Tm9kZVNlbGVjdG9yQ29tcG9uZW50RGF0YSA9IHtcbiAgICAgICAgICAgIHRpdGxlOiBgJHthY3Rpb259ICcke2NvbnRlbnRFbnRyeS5uYW1lfScgdG8gLi4uYCxcbiAgICAgICAgICAgIGFjdGlvbk5hbWU6IGFjdGlvbixcbiAgICAgICAgICAgIGN1cnJlbnRGb2xkZXJJZDogY29udGVudEVudHJ5LmlkLFxuICAgICAgICAgICAgaW1hZ2VSZXNvbHZlcjogdGhpcy5pbWFnZVJlc29sdmVyLmJpbmQodGhpcyksXG4gICAgICAgICAgICBpc1NlbGVjdGlvblZhbGlkOiB0aGlzLmlzTm9kZUZpbGUuYmluZCh0aGlzKSxcbiAgICAgICAgICAgIHNlbGVjdDogc2VsZWN0XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5vcGVuQ29udGVudE5vZGVEaWFsb2coZGF0YSwgJ2FkZi1jb250ZW50LW5vZGUtc2VsZWN0b3ItZGlhbG9nJywgJzYzMHB4Jyk7XG4gICAgICAgIHJldHVybiBzZWxlY3Q7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvcGVuQ29udGVudE5vZGVEaWFsb2coZGF0YTogQ29udGVudE5vZGVTZWxlY3RvckNvbXBvbmVudERhdGEsIGN1cnJlbnRQYW5lbENsYXNzOiBzdHJpbmcsIGNob3NlbldpZHRoOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5kaWFsb2cub3BlbihDb250ZW50Tm9kZVNlbGVjdG9yQ29tcG9uZW50LCB7IGRhdGEsIHBhbmVsQ2xhc3M6IGN1cnJlbnRQYW5lbENsYXNzLCB3aWR0aDogY2hvc2VuV2lkdGggfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbWFnZVJlc29sdmVyKHJvdzogU2hhcmVEYXRhUm93LCBjb2w6IERhdGFDb2x1bW4pOiBzdHJpbmcgfCBudWxsIHtcbiAgICAgICAgY29uc3QgZW50cnk6IE5vZGUgPSByb3cubm9kZS5lbnRyeTtcbiAgICAgICAgaWYgKCF0aGlzLmNvbnRlbnRTZXJ2aWNlLmhhc0FsbG93YWJsZU9wZXJhdGlvbnMoZW50cnksICdjcmVhdGUnKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudGh1bWJuYWlsU2VydmljZS5nZXRNaW1lVHlwZUljb24oJ2Rpc2FibGUvZm9sZGVyJyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzTm9kZUZpbGUoZW50cnk6IE5vZGUpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGVudHJ5LmlzRmlsZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhc0FsbG93YWJsZU9wZXJhdGlvbnNPbk5vZGVGb2xkZXIoZW50cnk6IE5vZGUpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNOb2RlRm9sZGVyKGVudHJ5KSAmJiB0aGlzLmNvbnRlbnRTZXJ2aWNlLmhhc0FsbG93YWJsZU9wZXJhdGlvbnMoZW50cnksICdjcmVhdGUnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzTm9kZUZvbGRlcihlbnRyeTogTm9kZSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZW50cnkuaXNGb2xkZXI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0NvcHlNb3ZlU2VsZWN0aW9uVmFsaWQoZW50cnk6IE5vZGUpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzRW50aXR5Q3JlYXRlUGVybWlzc2lvbihlbnRyeSkgJiYgIXRoaXMuaXNTaXRlKGVudHJ5KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhc0VudGl0eUNyZWF0ZVBlcm1pc3Npb24oZW50cnk6IE5vZGUpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudFNlcnZpY2UuaGFzQWxsb3dhYmxlT3BlcmF0aW9ucyhlbnRyeSwgJ2NyZWF0ZScpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNTaXRlKGVudHJ5KSB7XG4gICAgICAgIHJldHVybiAhIWVudHJ5Lmd1aWQgfHwgZW50cnkubm9kZVR5cGUgPT09ICdzdDpzaXRlJyB8fCBlbnRyeS5ub2RlVHlwZSA9PT0gJ3N0OnNpdGVzJztcbiAgICB9XG5cbiAgICAvKiogQ2xvc2VzIHRoZSBjdXJyZW50bHkgb3BlbiBkaWFsb2cuICovXG4gICAgY2xvc2UoKSB7XG4gICAgICAgIHRoaXMuZGlhbG9nLmNsb3NlQWxsKCk7XG4gICAgfVxuXG59XG4iXX0=