/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Subject, from } from 'rxjs';
import { Component, Output, EventEmitter, ViewEncapsulation } from '@angular/core';
import { FormBuilder, Validators } from '@angular/forms';
import { MatDialogRef } from '@angular/material';
import { AlfrescoApiService } from '@alfresco/adf-core';
import { debounceTime, mergeMap, takeUntil } from 'rxjs/operators';
export class LibraryDialogComponent {
    /**
     * @param {?} alfrescoApiService
     * @param {?} formBuilder
     * @param {?} dialog
     */
    constructor(alfrescoApiService, formBuilder, dialog) {
        this.alfrescoApiService = alfrescoApiService;
        this.formBuilder = formBuilder;
        this.dialog = dialog;
        /**
         * Emitted when an error occurs.
         */
        this.error = new EventEmitter();
        /**
         * Emitted when the new library is created successfully. The
         * event parameter is a SiteEntry object with the details of the
         * newly-created library.
         */
        this.success = new EventEmitter();
        this.onDestroy$ = new Subject();
        this.createTitle = 'LIBRARY.DIALOG.CREATE_TITLE';
        this.libraryTitleExists = false;
        this.visibilityOptions = [
            { value: 'PUBLIC', label: 'LIBRARY.VISIBILITY.PUBLIC', disabled: false },
            { value: 'PRIVATE', label: 'LIBRARY.VISIBILITY.PRIVATE', disabled: false },
            {
                value: 'MODERATED',
                label: 'LIBRARY.VISIBILITY.MODERATED',
                disabled: false
            }
        ];
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        /** @type {?} */
        const validators = {
            id: [
                Validators.required,
                Validators.maxLength(72),
                this.forbidSpecialCharacters
            ],
            title: [
                Validators.required,
                this.forbidOnlySpaces,
                Validators.minLength(2),
                Validators.maxLength(256)
            ],
            description: [Validators.maxLength(512)]
        };
        this.form = this.formBuilder.group({
            title: [null, validators.title],
            id: [null, validators.id, this.createSiteIdValidator()],
            description: ['', validators.description]
        });
        this.visibilityOption = this.visibilityOptions[0].value;
        this.form.controls['title'].valueChanges
            .pipe(debounceTime(300), mergeMap((/**
         * @param {?} title
         * @return {?}
         */
        (title) => this.checkLibraryNameExists(title)), (/**
         * @param {?} title
         * @return {?}
         */
        (title) => title)), takeUntil(this.onDestroy$))
            .subscribe((/**
         * @param {?} title
         * @return {?}
         */
        (title) => {
            if (!this.form.controls['id'].dirty && this.canGenerateId(title)) {
                this.form.patchValue({ id: this.sanitize(title.trim()) });
                this.form.controls['id'].markAsTouched();
            }
        }));
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.onDestroy$.next(true);
        this.onDestroy$.complete();
    }
    /**
     * @return {?}
     */
    get title() {
        const { title } = this.form.value;
        return (title || '').trim();
    }
    /**
     * @return {?}
     */
    get id() {
        const { id } = this.form.value;
        return (id || '').trim();
    }
    /**
     * @return {?}
     */
    get description() {
        const { description } = this.form.value;
        return (description || '').trim();
    }
    /**
     * @return {?}
     */
    get visibility() {
        return this.visibilityOption || '';
    }
    /**
     * @return {?}
     */
    submit() {
        const { form, dialog } = this;
        if (!form.valid) {
            return;
        }
        this.create().subscribe((/**
         * @param {?} node
         * @return {?}
         */
        (node) => {
            this.success.emit(node);
            dialog.close(node);
        }), (/**
         * @param {?} error
         * @return {?}
         */
        (error) => this.handleError(error)));
    }
    /**
     * @param {?} event
     * @return {?}
     */
    visibilityChangeHandler(event) {
        this.visibilityOption = event.value;
    }
    /**
     * @private
     * @return {?}
     */
    create() {
        const { title, id, description, visibility } = this;
        /** @type {?} */
        const siteBody = (/** @type {?} */ ({
            id,
            title,
            description,
            visibility
        }));
        return from(this.alfrescoApiService.sitesApi.createSite(siteBody));
    }
    /**
     * @private
     * @param {?} input
     * @return {?}
     */
    sanitize(input) {
        return input.replace(/[\s\s]+/g, '-').replace(/[^A-Za-z0-9-]/g, '');
    }
    /**
     * @private
     * @param {?} title
     * @return {?}
     */
    canGenerateId(title) {
        return Boolean(title.replace(/[^A-Za-z0-9-]/g, '').length);
    }
    /**
     * @private
     * @param {?} error
     * @return {?}
     */
    handleError(error) {
        const { error: { statusCode } } = JSON.parse(error.message);
        if (statusCode === 409) {
            this.form.controls['id'].setErrors({
                message: 'LIBRARY.ERRORS.CONFLICT'
            });
        }
        return error;
    }
    /**
     * @private
     * @param {?} libraryTitle
     * @return {?}
     */
    checkLibraryNameExists(libraryTitle) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            let entries = [];
            try {
                entries = (yield this.findLibraryByTitle(libraryTitle)).list.entries;
            }
            catch (_a) {
                entries = [];
            }
            if (entries.length) {
                this.libraryTitleExists = entries[0].entry.title.toLowerCase() === libraryTitle.toLowerCase();
            }
            else {
                this.libraryTitleExists = false;
            }
        });
    }
    /**
     * @private
     * @param {?} libraryTitle
     * @return {?}
     */
    findLibraryByTitle(libraryTitle) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return this.alfrescoApiService
                .getInstance()
                .core.queriesApi.findSites(libraryTitle, {
                maxItems: 1,
                fields: ['title']
            });
        });
    }
    /**
     * @private
     * @param {?} __0
     * @return {?}
     */
    forbidSpecialCharacters({ value }) {
        if (value === null || value.length === 0) {
            return null;
        }
        /** @type {?} */
        const validCharacters = /[^A-Za-z0-9-]/;
        /** @type {?} */
        const isValid = !validCharacters.test(value);
        return isValid
            ? null
            : {
                message: 'LIBRARY.ERRORS.ILLEGAL_CHARACTERS'
            };
    }
    /**
     * @private
     * @param {?} __0
     * @return {?}
     */
    forbidOnlySpaces({ value }) {
        if (value === null || value.length === 0) {
            return null;
        }
        /** @type {?} */
        const isValid = !!(value || '').trim();
        return isValid
            ? null
            : {
                message: 'LIBRARY.ERRORS.ONLY_SPACES'
            };
    }
    /**
     * @private
     * @return {?}
     */
    createSiteIdValidator() {
        /** @type {?} */
        let timer;
        return (/**
         * @param {?} control
         * @return {?}
         */
        (control) => {
            if (timer) {
                clearTimeout(timer);
            }
            return new Promise((/**
             * @param {?} resolve
             * @return {?}
             */
            (resolve) => {
                timer = setTimeout((/**
                 * @return {?}
                 */
                () => {
                    return from(this.alfrescoApiService.sitesApi.getSite(control.value)).subscribe((/**
                     * @return {?}
                     */
                    () => resolve({ message: 'LIBRARY.ERRORS.EXISTENT_SITE' })), (/**
                     * @return {?}
                     */
                    () => resolve(null)));
                }), 300);
            }));
        });
    }
}
LibraryDialogComponent.decorators = [
    { type: Component, args: [{
                selector: 'adf-library-dialog',
                template: "<h2 mat-dialog-title>{{ createTitle | translate }}</h2>\n\n<mat-dialog-content>\n  <form novalidate [formGroup]=\"form\" (submit)=\"submit()\">\n    <mat-form-field>\n      <input\n        placeholder=\"{{ 'LIBRARY.DIALOG.FORM.NAME' | translate }}\"\n        required\n        matInput\n        autofocus\n        formControlName=\"title\"\n        autocomplete=\"off\"\n      />\n\n      <mat-hint *ngIf=\"libraryTitleExists\">{{\n        'LIBRARY.HINTS.SITE_TITLE_EXISTS' | translate\n      }}</mat-hint>\n      <mat-error *ngIf=\"form.controls['title'].hasError('maxlength')\">\n        {{ 'LIBRARY.ERRORS.TITLE_TOO_LONG' | translate }}\n      </mat-error>\n\n      <mat-error *ngIf=\"form.controls['title'].hasError('minlength')\">\n        {{ 'LIBRARY.ERRORS.TITLE_TOO_SHORT' | translate }}\n      </mat-error>\n\n      <mat-error *ngIf=\"form.controls['title'].errors?.message\">\n        {{ form.controls['title'].errors?.message | translate }}\n      </mat-error>\n    </mat-form-field>\n\n    <mat-form-field>\n      <input\n        required\n        placeholder=\"{{ 'LIBRARY.DIALOG.FORM.SITE_ID' | translate }}\"\n        matInput\n        formControlName=\"id\"\n        autocomplete=\"off\"\n      />\n\n      <mat-error *ngIf=\"form.controls['id'].errors?.message\">\n        {{ form.controls['id'].errors?.message | translate }}\n      </mat-error>\n\n      <mat-error *ngIf=\"form.controls['id'].hasError('maxlength')\">\n        {{ 'LIBRARY.ERRORS.ID_TOO_LONG' | translate }}\n      </mat-error>\n    </mat-form-field>\n\n    <mat-form-field>\n      <textarea\n        matInput\n        placeholder=\"{{ 'LIBRARY.DIALOG.FORM.DESCRIPTION' | translate }}\"\n        rows=\"3\"\n        formControlName=\"description\"\n      ></textarea>\n\n      <mat-error *ngIf=\"form.controls['description'].hasError('maxlength')\">\n        {{ 'LIBRARY.ERRORS.DESCRIPTION_TOO_LONG' | translate }}\n      </mat-error>\n    </mat-form-field>\n\n    <mat-radio-group\n      [ngModelOptions]=\"{ standalone: true }\"\n      [(ngModel)]=\"visibilityOption\"\n      (change)=\"visibilityChangeHandler($event)\"\n    >\n      <mat-radio-button\n        color=\"primary\"\n        [disabled]=\"option.disabled\"\n        *ngFor=\"let option of visibilityOptions\"\n        [attr.data-automation-id]=\"option.value\"\n        [value]=\"option.value\"\n        [checked]=\"visibilityOption.value === option.value\"\n      >\n        {{ option.label | translate }}\n      </mat-radio-button>\n    </mat-radio-group>\n  </form>\n</mat-dialog-content>\n\n<mat-dialog-actions class=\"adf-action-buttons\">\n  <button mat-button mat-dialog-close data-automation-id=\"cancel-library-id\">\n    {{ 'LIBRARY.DIALOG.CANCEL' | translate }}\n  </button>\n\n  <button\n    color=\"primary\"\n    mat-button\n    (click)=\"submit()\"\n    [disabled]=\"!form.valid\"\n    data-automation-id=\"create-library-id\"\n  >\n    {{ 'LIBRARY.DIALOG.CREATE' | translate }}\n  </button>\n</mat-dialog-actions>\n",
                encapsulation: ViewEncapsulation.None,
                host: { class: 'adf-library-dialog' },
                styles: [".adf-library-dialog .mat-radio-group{display:flex;flex-direction:column;margin:0 0 20px}.adf-library-dialog .mat-radio-group .mat-radio-button{margin:10px 0}.adf-library-dialog .mat-form-field{width:100%}.adf-library-dialog mat-form-field{padding-top:20px}.adf-library-dialog .adf-action-buttons{display:flex;flex-direction:row;justify-content:flex-end}.adf-library-dialog .adf-action-buttons .mat-button{text-transform:uppercase}"]
            }] }
];
/** @nocollapse */
LibraryDialogComponent.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: FormBuilder },
    { type: MatDialogRef }
];
LibraryDialogComponent.propDecorators = {
    error: [{ type: Output }],
    success: [{ type: Output }]
};
if (false) {
    /**
     * Emitted when an error occurs.
     * @type {?}
     */
    LibraryDialogComponent.prototype.error;
    /**
     * Emitted when the new library is created successfully. The
     * event parameter is a SiteEntry object with the details of the
     * newly-created library.
     * @type {?}
     */
    LibraryDialogComponent.prototype.success;
    /** @type {?} */
    LibraryDialogComponent.prototype.onDestroy$;
    /** @type {?} */
    LibraryDialogComponent.prototype.createTitle;
    /** @type {?} */
    LibraryDialogComponent.prototype.libraryTitleExists;
    /** @type {?} */
    LibraryDialogComponent.prototype.form;
    /** @type {?} */
    LibraryDialogComponent.prototype.visibilityOption;
    /** @type {?} */
    LibraryDialogComponent.prototype.visibilityOptions;
    /**
     * @type {?}
     * @private
     */
    LibraryDialogComponent.prototype.alfrescoApiService;
    /**
     * @type {?}
     * @private
     */
    LibraryDialogComponent.prototype.formBuilder;
    /**
     * @type {?}
     * @private
     */
    LibraryDialogComponent.prototype.dialog;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlicmFyeS5kaWFsb2cuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJkaWFsb2dzL2xpYnJhcnkvbGlicmFyeS5kaWFsb2cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBYyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFDTCxTQUFTLEVBRVQsTUFBTSxFQUNOLFlBQVksRUFFWixpQkFBaUIsRUFDbEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNMLFdBQVcsRUFFWCxVQUFVLEVBR1gsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFakQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFTbkUsTUFBTSxPQUFPLHNCQUFzQjs7Ozs7O0lBNEJqQyxZQUNVLGtCQUFzQyxFQUN0QyxXQUF3QixFQUN4QixNQUE0QztRQUY1Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLFdBQU0sR0FBTixNQUFNLENBQXNDOzs7O1FBNUJ0RCxVQUFLLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7Ozs7OztRQU9uRCxZQUFPLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFFckQsZUFBVSxHQUFxQixJQUFJLE9BQU8sRUFBVyxDQUFDO1FBRXRELGdCQUFXLEdBQUcsNkJBQTZCLENBQUM7UUFDNUMsdUJBQWtCLEdBQUcsS0FBSyxDQUFDO1FBRzNCLHNCQUFpQixHQUFHO1lBQ2xCLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFL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Z2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgZnJvbSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBPbkluaXQsXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBPbkRlc3Ryb3ksXG4gIFZpZXdFbmNhcHN1bGF0aW9uXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgRm9ybUJ1aWxkZXIsXG4gIEZvcm1Hcm91cCxcbiAgVmFsaWRhdG9ycyxcbiAgRm9ybUNvbnRyb2wsXG4gIEFic3RyYWN0Q29udHJvbFxufSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBNYXREaWFsb2dSZWYgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbCc7XG5pbXBvcnQgeyBTaXRlQm9keUNyZWF0ZSwgU2l0ZUVudHJ5LCBTaXRlUGFnaW5nIH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBtZXJnZU1hcCwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdhZGYtbGlicmFyeS1kaWFsb2cnLFxuICBzdHlsZVVybHM6IFsnLi9saWJyYXJ5LmRpYWxvZy5zY3NzJ10sXG4gIHRlbXBsYXRlVXJsOiAnLi9saWJyYXJ5LmRpYWxvZy5odG1sJyxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbiAgaG9zdDogeyBjbGFzczogJ2FkZi1saWJyYXJ5LWRpYWxvZycgfVxufSlcbmV4cG9ydCBjbGFzcyBMaWJyYXJ5RGlhbG9nQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICAvKiogRW1pdHRlZCB3aGVuIGFuIGVycm9yIG9jY3Vycy4gKi9cbiAgQE91dHB1dCgpXG4gIGVycm9yOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIC8qKiBFbWl0dGVkIHdoZW4gdGhlIG5ldyBsaWJyYXJ5IGlzIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5LiBUaGVcbiAgICogZXZlbnQgcGFyYW1ldGVyIGlzIGEgU2l0ZUVudHJ5IG9iamVjdCB3aXRoIHRoZSBkZXRhaWxzIG9mIHRoZVxuICAgKiBuZXdseS1jcmVhdGVkIGxpYnJhcnkuXG4gICAqL1xuICBAT3V0cHV0KClcbiAgc3VjY2VzczogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBvbkRlc3Ryb3kkOiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICBjcmVhdGVUaXRsZSA9ICdMSUJSQVJZLkRJQUxPRy5DUkVBVEVfVElUTEUnO1xuICBsaWJyYXJ5VGl0bGVFeGlzdHMgPSBmYWxzZTtcbiAgZm9ybTogRm9ybUdyb3VwO1xuICB2aXNpYmlsaXR5T3B0aW9uOiBhbnk7XG4gIHZpc2liaWxpdHlPcHRpb25zID0gW1xuICAgIHsgdmFsdWU6ICdQVUJMSUMnLCBsYWJlbDogJ0xJQlJBUlkuVklTSUJJTElUWS5QVUJMSUMnLCBkaXNhYmxlZDogZmFsc2UgfSxcbiAgICB7IHZhbHVlOiAnUFJJVkFURScsIGxhYmVsOiAnTElCUkFSWS5WSVNJQklMSVRZLlBSSVZBVEUnLCBkaXNhYmxlZDogZmFsc2UgfSxcbiAgICB7XG4gICAgICB2YWx1ZTogJ01PREVSQVRFRCcsXG4gICAgICBsYWJlbDogJ0xJQlJBUlkuVklTSUJJTElUWS5NT0RFUkFURUQnLFxuICAgICAgZGlzYWJsZWQ6IGZhbHNlXG4gICAgfVxuICBdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWxmcmVzY29BcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBmb3JtQnVpbGRlcjogRm9ybUJ1aWxkZXIsXG4gICAgcHJpdmF0ZSBkaWFsb2c6IE1hdERpYWxvZ1JlZjxMaWJyYXJ5RGlhbG9nQ29tcG9uZW50PlxuICApIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgY29uc3QgdmFsaWRhdG9ycyA9IHtcbiAgICAgIGlkOiBbXG4gICAgICAgIFZhbGlkYXRvcnMucmVxdWlyZWQsXG4gICAgICAgIFZhbGlkYXRvcnMubWF4TGVuZ3RoKDcyKSxcbiAgICAgICAgdGhpcy5mb3JiaWRTcGVjaWFsQ2hhcmFjdGVyc1xuICAgICAgXSxcbiAgICAgIHRpdGxlOiBbXG4gICAgICAgIFZhbGlkYXRvcnMucmVxdWlyZWQsXG4gICAgICAgIHRoaXMuZm9yYmlkT25seVNwYWNlcyxcbiAgICAgICAgVmFsaWRhdG9ycy5taW5MZW5ndGgoMiksXG4gICAgICAgIFZhbGlkYXRvcnMubWF4TGVuZ3RoKDI1NilcbiAgICAgIF0sXG4gICAgICBkZXNjcmlwdGlvbjogW1ZhbGlkYXRvcnMubWF4TGVuZ3RoKDUxMildXG4gICAgfTtcblxuICAgIHRoaXMuZm9ybSA9IHRoaXMuZm9ybUJ1aWxkZXIuZ3JvdXAoe1xuICAgICAgdGl0bGU6IFtudWxsLCB2YWxpZGF0b3JzLnRpdGxlXSxcbiAgICAgIGlkOiBbbnVsbCwgdmFsaWRhdG9ycy5pZCwgdGhpcy5jcmVhdGVTaXRlSWRWYWxpZGF0b3IoKV0sXG4gICAgICBkZXNjcmlwdGlvbjogWycnLCB2YWxpZGF0b3JzLmRlc2NyaXB0aW9uXVxuICAgIH0pO1xuXG4gICAgdGhpcy52aXNpYmlsaXR5T3B0aW9uID0gdGhpcy52aXNpYmlsaXR5T3B0aW9uc1swXS52YWx1ZTtcblxuICAgIHRoaXMuZm9ybS5jb250cm9sc1sndGl0bGUnXS52YWx1ZUNoYW5nZXNcbiAgICAgIC5waXBlKFxuICAgICAgICBkZWJvdW5jZVRpbWUoMzAwKSxcbiAgICAgICAgbWVyZ2VNYXAoXG4gICAgICAgICAgICAodGl0bGUpID0+IHRoaXMuY2hlY2tMaWJyYXJ5TmFtZUV4aXN0cyh0aXRsZSksXG4gICAgICAgICAgICAodGl0bGUpID0+IHRpdGxlXG4gICAgICAgICksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLm9uRGVzdHJveSQpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCh0aXRsZTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5mb3JtLmNvbnRyb2xzWydpZCddLmRpcnR5ICYmIHRoaXMuY2FuR2VuZXJhdGVJZCh0aXRsZSkpIHtcbiAgICAgICAgICB0aGlzLmZvcm0ucGF0Y2hWYWx1ZSh7IGlkOiB0aGlzLnNhbml0aXplKHRpdGxlLnRyaW0oKSkgfSk7XG4gICAgICAgICAgdGhpcy5mb3JtLmNvbnRyb2xzWydpZCddLm1hcmtBc1RvdWNoZWQoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLm9uRGVzdHJveSQubmV4dCh0cnVlKTtcbiAgICB0aGlzLm9uRGVzdHJveSQuY29tcGxldGUoKTtcbiAgfVxuXG4gIGdldCB0aXRsZSgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgdGl0bGUgfSA9IHRoaXMuZm9ybS52YWx1ZTtcblxuICAgIHJldHVybiAodGl0bGUgfHwgJycpLnRyaW0oKTtcbiAgfVxuXG4gIGdldCBpZCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgaWQgfSA9IHRoaXMuZm9ybS52YWx1ZTtcblxuICAgIHJldHVybiAoaWQgfHwgJycpLnRyaW0oKTtcbiAgfVxuXG4gIGdldCBkZXNjcmlwdGlvbigpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgZGVzY3JpcHRpb24gfSA9IHRoaXMuZm9ybS52YWx1ZTtcblxuICAgIHJldHVybiAoZGVzY3JpcHRpb24gfHwgJycpLnRyaW0oKTtcbiAgfVxuXG4gIGdldCB2aXNpYmlsaXR5KCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMudmlzaWJpbGl0eU9wdGlvbiB8fCAnJztcbiAgfVxuXG4gIHN1Ym1pdCgpIHtcbiAgICBjb25zdCB7IGZvcm0sIGRpYWxvZyB9ID0gdGhpcztcblxuICAgIGlmICghZm9ybS52YWxpZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuY3JlYXRlKCkuc3Vic2NyaWJlKFxuICAgICAgKG5vZGU6IFNpdGVFbnRyeSkgPT4ge1xuICAgICAgICB0aGlzLnN1Y2Nlc3MuZW1pdChub2RlKTtcbiAgICAgICAgZGlhbG9nLmNsb3NlKG5vZGUpO1xuICAgICAgfSxcbiAgICAgIChlcnJvcikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnJvcilcbiAgICApO1xuICB9XG5cbiAgdmlzaWJpbGl0eUNoYW5nZUhhbmRsZXIoZXZlbnQpIHtcbiAgICB0aGlzLnZpc2liaWxpdHlPcHRpb24gPSBldmVudC52YWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlKCk6IE9ic2VydmFibGU8U2l0ZUVudHJ5PiB7XG4gICAgY29uc3QgeyB0aXRsZSwgaWQsIGRlc2NyaXB0aW9uLCB2aXNpYmlsaXR5IH0gPSB0aGlzO1xuICAgIGNvbnN0IHNpdGVCb2R5ID0gPFNpdGVCb2R5Q3JlYXRlPiB7XG4gICAgICBpZCxcbiAgICAgIHRpdGxlLFxuICAgICAgZGVzY3JpcHRpb24sXG4gICAgICB2aXNpYmlsaXR5XG4gICAgfTtcblxuICAgIHJldHVybiBmcm9tKHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLnNpdGVzQXBpLmNyZWF0ZVNpdGUoc2l0ZUJvZHkpKTtcbiAgfVxuXG4gIHByaXZhdGUgc2FuaXRpemUoaW5wdXQ6IHN0cmluZykge1xuICAgIHJldHVybiBpbnB1dC5yZXBsYWNlKC9bXFxzXFxzXSsvZywgJy0nKS5yZXBsYWNlKC9bXkEtWmEtejAtOS1dL2csICcnKTtcbiAgfVxuXG4gIHByaXZhdGUgY2FuR2VuZXJhdGVJZCh0aXRsZSkge1xuICAgIHJldHVybiBCb29sZWFuKHRpdGxlLnJlcGxhY2UoL1teQS1aYS16MC05LV0vZywgJycpLmxlbmd0aCk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUVycm9yKGVycm9yOiBhbnkpOiBhbnkge1xuICAgIGNvbnN0IHtcbiAgICAgIGVycm9yOiB7IHN0YXR1c0NvZGUgfVxuICAgIH0gPSBKU09OLnBhcnNlKGVycm9yLm1lc3NhZ2UpO1xuXG4gICAgaWYgKHN0YXR1c0NvZGUgPT09IDQwOSkge1xuICAgICAgdGhpcy5mb3JtLmNvbnRyb2xzWydpZCddLnNldEVycm9ycyh7XG4gICAgICAgIG1lc3NhZ2U6ICdMSUJSQVJZLkVSUk9SUy5DT05GTElDVCdcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY2hlY2tMaWJyYXJ5TmFtZUV4aXN0cyhsaWJyYXJ5VGl0bGU6IHN0cmluZykge1xuICAgIGxldCBlbnRyaWVzID0gW107XG5cbiAgICB0cnkge1xuICAgICAgICBlbnRyaWVzID0gKGF3YWl0IHRoaXMuZmluZExpYnJhcnlCeVRpdGxlKGxpYnJhcnlUaXRsZSkpLmxpc3QuZW50cmllcztcbiAgICB9IGNhdGNoIHtcbiAgICAgICAgZW50cmllcyA9IFtdO1xuICAgIH1cblxuICAgIGlmIChlbnRyaWVzLmxlbmd0aCkge1xuICAgICAgdGhpcy5saWJyYXJ5VGl0bGVFeGlzdHMgPSBlbnRyaWVzWzBdLmVudHJ5LnRpdGxlLnRvTG93ZXJDYXNlKCkgPT09IGxpYnJhcnlUaXRsZS50b0xvd2VyQ2FzZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxpYnJhcnlUaXRsZUV4aXN0cyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZmluZExpYnJhcnlCeVRpdGxlKGxpYnJhcnlUaXRsZTogc3RyaW5nKTogUHJvbWlzZTxTaXRlUGFnaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlXG4gICAgICAuZ2V0SW5zdGFuY2UoKVxuICAgICAgLmNvcmUucXVlcmllc0FwaS5maW5kU2l0ZXMobGlicmFyeVRpdGxlLCB7XG4gICAgICAgIG1heEl0ZW1zOiAxLFxuICAgICAgICBmaWVsZHM6IFsndGl0bGUnXVxuICAgICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGZvcmJpZFNwZWNpYWxDaGFyYWN0ZXJzKHsgdmFsdWUgfTogRm9ybUNvbnRyb2wpIHtcbiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCB2YWxpZENoYXJhY3RlcnM6IFJlZ0V4cCA9IC9bXkEtWmEtejAtOS1dLztcbiAgICBjb25zdCBpc1ZhbGlkOiBib29sZWFuID0gIXZhbGlkQ2hhcmFjdGVycy50ZXN0KHZhbHVlKTtcblxuICAgIHJldHVybiBpc1ZhbGlkXG4gICAgICA/IG51bGxcbiAgICAgIDoge1xuICAgICAgICAgIG1lc3NhZ2U6ICdMSUJSQVJZLkVSUk9SUy5JTExFR0FMX0NIQVJBQ1RFUlMnXG4gICAgICAgIH07XG4gIH1cblxuICBwcml2YXRlIGZvcmJpZE9ubHlTcGFjZXMoeyB2YWx1ZSB9OiBGb3JtQ29udHJvbCkge1xuICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGlzVmFsaWQ6IGJvb2xlYW4gPSAhISh2YWx1ZSB8fCAnJykudHJpbSgpO1xuXG4gICAgcmV0dXJuIGlzVmFsaWRcbiAgICAgID8gbnVsbFxuICAgICAgOiB7XG4gICAgICAgICAgbWVzc2FnZTogJ0xJQlJBUlkuRVJST1JTLk9OTFlfU1BBQ0VTJ1xuICAgICAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVTaXRlSWRWYWxpZGF0b3IoKSB7XG4gICAgbGV0IHRpbWVyO1xuXG4gICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpID0+IHtcbiAgICAgIGlmICh0aW1lcikge1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLnNpdGVzQXBpLmdldFNpdGUoY29udHJvbC52YWx1ZSlcbiAgICAgICAgICApLnN1YnNjcmliZShcbiAgICAgICAgICAgICgpID0+IHJlc29sdmUoeyBtZXNzYWdlOiAnTElCUkFSWS5FUlJPUlMuRVhJU1RFTlRfU0lURScgfSksXG4gICAgICAgICAgICAoKSA9PiByZXNvbHZlKG51bGwpXG4gICAgICAgICAgKTtcbiAgICAgICAgfSwgMzAwKTtcbiAgICAgIH0pO1xuICAgIH07XG4gIH1cbn1cbiJdfQ==