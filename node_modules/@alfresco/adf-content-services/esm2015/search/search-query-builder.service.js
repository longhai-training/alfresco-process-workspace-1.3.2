/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { AlfrescoApiService, AppConfigService } from '@alfresco/adf-core';
import { RequestSortDefinitionInner } from '@alfresco/js-api';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class SearchQueryBuilderService {
    /**
     * @param {?} appConfig
     * @param {?} alfrescoApiService
     */
    constructor(appConfig, alfrescoApiService) {
        this.appConfig = appConfig;
        this.alfrescoApiService = alfrescoApiService;
        this._userQuery = '';
        this.updated = new Subject();
        this.executed = new Subject();
        this.error = new Subject();
        this.categories = [];
        this.queryFragments = {};
        this.filterQueries = [];
        this.paging = null;
        this.sorting = [];
        this.userFacetBuckets = {};
        this.config = {
            categories: []
        };
        // TODO: to be supported in future iterations
        this.ranges = {};
        this.resetToDefaults();
    }
    /**
     * @return {?}
     */
    get userQuery() {
        return this._userQuery;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set userQuery(value) {
        value = (value || '').trim();
        this._userQuery = value ? `(${value})` : '';
    }
    /**
     * Resets the query to the defaults specified in the app config.
     * @return {?}
     */
    resetToDefaults() {
        /** @type {?} */
        const template = this.appConfig.get('search');
        if (template) {
            this.config = JSON.parse(JSON.stringify(template));
            this.categories = (this.config.categories || []).filter((/**
             * @param {?} category
             * @return {?}
             */
            (category) => category.enabled));
            this.filterQueries = this.config.filterQueries || [];
            this.userFacetBuckets = {};
            if (this.config.sorting) {
                this.sorting = this.config.sorting.defaults || [];
            }
        }
    }
    /**
     * Adds a facet bucket to a field.
     * @param {?} field The target field
     * @param {?} bucket Bucket to add
     * @return {?}
     */
    addUserFacetBucket(field, bucket) {
        if (field && field.field && bucket) {
            /** @type {?} */
            const buckets = this.userFacetBuckets[field.field] || [];
            /** @type {?} */
            const existing = buckets.find((/**
             * @param {?} facetBucket
             * @return {?}
             */
            (facetBucket) => facetBucket.label === bucket.label));
            if (!existing) {
                buckets.push(bucket);
            }
            this.userFacetBuckets[field.field] = buckets;
        }
    }
    /**
     * Gets the buckets currently added to a field
     * @param {?} field The target fields
     * @return {?} Bucket array
     */
    getUserFacetBuckets(field) {
        return this.userFacetBuckets[field] || [];
    }
    /**
     * Removes an existing bucket from a field.
     * @param {?} field The target field
     * @param {?} bucket Bucket to remove
     * @return {?}
     */
    removeUserFacetBucket(field, bucket) {
        if (field && field.field && bucket) {
            /** @type {?} */
            const buckets = this.userFacetBuckets[field.field] || [];
            this.userFacetBuckets[field.field] = buckets
                .filter((/**
             * @param {?} facetBucket
             * @return {?}
             */
            (facetBucket) => facetBucket.label !== bucket.label));
        }
    }
    /**
     * Adds a filter query to the current query.
     * @param {?} query Query string to add
     * @return {?}
     */
    addFilterQuery(query) {
        if (query) {
            /** @type {?} */
            const existing = this.filterQueries.find((/**
             * @param {?} filterQuery
             * @return {?}
             */
            (filterQuery) => filterQuery.query === query));
            if (!existing) {
                this.filterQueries.push({ query: query });
            }
        }
    }
    /**
     * Removes an existing filter query.
     * @param {?} query The query to remove
     * @return {?}
     */
    removeFilterQuery(query) {
        if (query) {
            this.filterQueries = this.filterQueries
                .filter((/**
             * @param {?} filterQuery
             * @return {?}
             */
            (filterQuery) => filterQuery.query !== query));
        }
    }
    /**
     * Gets a facet query by label.
     * @param {?} label Label of the query
     * @return {?} Facet query data
     */
    getFacetQuery(label) {
        if (label && this.hasFacetQueries) {
            /** @type {?} */
            const result = this.config.facetQueries.queries.find((/**
             * @param {?} query
             * @return {?}
             */
            (query) => query.label === label));
            if (result) {
                return Object.assign({}, result);
            }
        }
        return null;
    }
    /**
     * Gets a facet field by label.
     * @param {?} label Label of the facet field
     * @return {?} Facet field data
     */
    getFacetField(label) {
        if (label) {
            /** @type {?} */
            const fields = this.config.facetFields.fields || [];
            /** @type {?} */
            const result = fields.find((/**
             * @param {?} field
             * @return {?}
             */
            (field) => field.label === label));
            if (result) {
                result.label = this.getSupportedLabel(result.label);
                return Object.assign({}, result);
            }
        }
        return null;
    }
    /**
     * Builds the current query and triggers the `updated` event.
     * @return {?}
     */
    update() {
        /** @type {?} */
        const query = this.buildQuery();
        this.updated.next(query);
    }
    /**
     * Builds and executes the current query.
     * @return {?} Nothing
     */
    execute() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                /** @type {?} */
                const query = this.buildQuery();
                if (query) {
                    /** @type {?} */
                    const resultSetPaging = yield this.alfrescoApiService.searchApi.search(query);
                    this.executed.next(resultSetPaging);
                }
            }
            catch (error) {
                this.error.next(error);
                this.executed.next({
                    list: {
                        pagination: {
                            totalItems: 0
                        },
                        entries: []
                    }
                });
            }
        });
    }
    /**
     * Builds the current query.
     * @return {?} The finished query
     */
    buildQuery() {
        /** @type {?} */
        const query = this.getFinalQuery();
        /** @type {?} */
        const include = this.config.include || [];
        if (include.length === 0) {
            include.push('path', 'allowableOperations');
        }
        if (query) {
            /** @type {?} */
            const result = (/** @type {?} */ ({
                query: {
                    query: query,
                    language: 'afts'
                },
                include: include,
                paging: this.paging,
                fields: this.config.fields,
                filterQueries: this.filterQueries,
                facetQueries: this.facetQueries,
                facetIntervals: this.facetIntervals,
                facetFields: this.facetFields,
                sort: this.sort,
                highlight: this.highlight
            }));
            result['facetFormat'] = 'V2';
            return result;
        }
        return null;
    }
    /**
     * Gets the primary sorting definition.
     * @return {?} The primary sorting definition
     */
    getPrimarySorting() {
        if (this.sorting && this.sorting.length > 0) {
            return this.sorting[0];
        }
        return null;
    }
    /**
     * Gets all pre-configured sorting options that users can choose from.
     * @return {?} Pre-configured sorting options
     */
    getSortingOptions() {
        if (this.config && this.config.sorting) {
            return this.config.sorting.options || [];
        }
        return [];
    }
    /**
     * Gets the query group.
     * @param {?} query Target query
     * @return {?} Query group
     */
    getQueryGroup(query) {
        return query.group || this.config.facetQueries.label || 'Facet Queries';
    }
    /**
     * Checks if FacetQueries has been defined
     * @return {?} True if defined, false otherwise
     */
    get hasFacetQueries() {
        if (this.config
            && this.config.facetQueries
            && this.config.facetQueries.queries
            && this.config.facetQueries.queries.length > 0) {
            return true;
        }
        return false;
    }
    /**
     * Checks if FacetIntervals has been defined
     * @return {?} True if defined, false otherwise
     */
    get hasFacetIntervals() {
        if (this.config
            && this.config.facetIntervals
            && this.config.facetIntervals.intervals
            && this.config.facetIntervals.intervals.length > 0) {
            return true;
        }
        return false;
    }
    /**
     * @return {?}
     */
    get hasFacetHighlight() {
        return this.config && this.config.highlight ? true : false;
    }
    /**
     * @protected
     * @return {?}
     */
    get sort() {
        return this.sorting.map((/**
         * @param {?} def
         * @return {?}
         */
        (def) => {
            return new RequestSortDefinitionInner({
                type: def.type,
                field: def.field,
                ascending: def.ascending
            });
        }));
    }
    /**
     * @protected
     * @return {?}
     */
    get facetQueries() {
        if (this.hasFacetQueries) {
            return this.config.facetQueries.queries.map((/**
             * @param {?} query
             * @return {?}
             */
            (query) => {
                query.group = this.getQueryGroup(query);
                return (/** @type {?} */ (Object.assign({}, query)));
            }));
        }
        return null;
    }
    /**
     * @protected
     * @return {?}
     */
    get facetIntervals() {
        if (this.hasFacetIntervals) {
            /** @type {?} */
            const configIntervals = this.config.facetIntervals;
            return {
                intervals: configIntervals.intervals.map((/**
                 * @param {?} interval
                 * @return {?}
                 */
                (interval) => (/** @type {?} */ ({
                    label: this.getSupportedLabel(interval.label),
                    field: interval.field,
                    sets: interval.sets.map((/**
                     * @param {?} set
                     * @return {?}
                     */
                    (set) => (/** @type {?} */ ({
                        label: this.getSupportedLabel(set.label),
                        start: set.start,
                        end: set.end,
                        startInclusive: set.startInclusive,
                        endInclusive: set.endInclusive
                    }))))
                }))))
            };
        }
        return null;
    }
    /**
     * @protected
     * @return {?}
     */
    get highlight() {
        return this.hasFacetHighlight ? this.config.highlight : null;
    }
    /**
     * @protected
     * @return {?}
     */
    getFinalQuery() {
        /** @type {?} */
        let query = '';
        this.categories.forEach((/**
         * @param {?} facet
         * @return {?}
         */
        (facet) => {
            /** @type {?} */
            const customQuery = this.queryFragments[facet.id];
            if (customQuery) {
                if (query.length > 0) {
                    query += ' AND ';
                }
                query += `(${customQuery})`;
            }
        }));
        /** @type {?} */
        let result = [this.userQuery, query]
            .filter((/**
         * @param {?} entry
         * @return {?}
         */
        (entry) => entry))
            .join(' AND ');
        if (this.userFacetBuckets) {
            Object.keys(this.userFacetBuckets).forEach((/**
             * @param {?} key
             * @return {?}
             */
            (key) => {
                /** @type {?} */
                const subQuery = (this.userFacetBuckets[key] || [])
                    .filter((/**
                 * @param {?} bucket
                 * @return {?}
                 */
                (bucket) => bucket.filterQuery))
                    .map((/**
                 * @param {?} bucket
                 * @return {?}
                 */
                (bucket) => bucket.filterQuery))
                    .join(' OR ');
                if (subQuery) {
                    if (result.length > 0) {
                        result += ' AND ';
                    }
                    result += `(${subQuery})`;
                }
            }));
        }
        return result;
    }
    /**
     * @protected
     * @return {?}
     */
    get facetFields() {
        /** @type {?} */
        const facetFields = this.config.facetFields && this.config.facetFields.fields;
        if (facetFields && facetFields.length > 0) {
            return {
                facets: facetFields.map((/**
                 * @param {?} facet
                 * @return {?}
                 */
                (facet) => (/** @type {?} */ ({
                    field: facet.field,
                    mincount: facet.mincount,
                    label: this.getSupportedLabel(facet.label),
                    limit: facet.limit,
                    offset: facet.offset,
                    prefix: facet.prefix
                }))))
            };
        }
        return null;
    }
    /**
     * Encloses a label name with double quotes if it contains whitespace characters.
     * @param {?} configLabel Original label text
     * @return {?} Label, possibly with quotes if it contains spaces
     */
    getSupportedLabel(configLabel) {
        /** @type {?} */
        const spaceInsideLabelIndex = configLabel.search(/\s/g);
        if (spaceInsideLabelIndex > -1) {
            return `"${configLabel}"`;
        }
        return configLabel;
    }
}
SearchQueryBuilderService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
SearchQueryBuilderService.ctorParameters = () => [
    { type: AppConfigService },
    { type: AlfrescoApiService }
];
/** @nocollapse */ SearchQueryBuilderService.ngInjectableDef = i0.defineInjectable({ factory: function SearchQueryBuilderService_Factory() { return new SearchQueryBuilderService(i0.inject(i1.AppConfigService), i0.inject(i1.AlfrescoApiService)); }, token: SearchQueryBuilderService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    SearchQueryBuilderService.prototype._userQuery;
    /** @type {?} */
    SearchQueryBuilderService.prototype.updated;
    /** @type {?} */
    SearchQueryBuilderService.prototype.executed;
    /** @type {?} */
    SearchQueryBuilderService.prototype.error;
    /** @type {?} */
    SearchQueryBuilderService.prototype.categories;
    /** @type {?} */
    SearchQueryBuilderService.prototype.queryFragments;
    /** @type {?} */
    SearchQueryBuilderService.prototype.filterQueries;
    /** @type {?} */
    SearchQueryBuilderService.prototype.paging;
    /** @type {?} */
    SearchQueryBuilderService.prototype.sorting;
    /**
     * @type {?}
     * @protected
     */
    SearchQueryBuilderService.prototype.userFacetBuckets;
    /** @type {?} */
    SearchQueryBuilderService.prototype.config;
    /** @type {?} */
    SearchQueryBuilderService.prototype.ranges;
    /**
     * @type {?}
     * @private
     */
    SearchQueryBuilderService.prototype.appConfig;
    /**
     * @type {?}
     * @private
     */
    SearchQueryBuilderService.prototype.alfrescoApiService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXF1ZXJ5LWJ1aWxkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtY29udGVudC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInNlYXJjaC9zZWFyY2gtcXVlcnktYnVpbGRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDMUUsT0FBTyxFQUlILDBCQUEwQixFQUc3QixNQUFNLGtCQUFrQixDQUFDOzs7QUFhMUIsTUFBTSxPQUFPLHlCQUF5Qjs7Ozs7SUFnQ2xDLFlBQW9CLFNBQTJCLEVBQVUsa0JBQXNDO1FBQTNFLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQVUsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQTlCdkYsZUFBVSxHQUFHLEVBQUUsQ0FBQztRQUV4QixZQUFPLEdBQUcsSUFBSSxPQUFPLEVBQWEsQ0FBQztRQUNuQyxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQW1CLENBQUM7UUFDMUMsVUFBSyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFFdEIsZUFBVSxHQUEwQixFQUFFLENBQUM7UUFDdkMsbUJBQWMsR0FBNkIsRUFBRSxDQUFDO1FBQzlDLGtCQUFhLEdBQWtCLEVBQUUsQ0FBQztRQUNsQyxXQUFNLEdBQThDLElBQUksQ0FBQztRQUN6RCxZQUFPLEdBQW1DLEVBQUUsQ0FBQztRQUVuQyxxQkFBZ0IsR0FBK0MsRUFBRSxDQUFDO1FBVzVFLFdBQU0sR0FBd0I7WUFDMUIsVUFBVSxFQUFFLEVBQUU7U0FDakIsQ0FBQzs7UUFHRixXQUFNLEdBQWtDLEVBQUUsQ0FBQztRQUd2QyxJQUFJLENBQUMs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QUFVLEVBQUUsTUFBTTthQUNyQjs7OztZQXBCNEIsZ0JBQWdCO1lBQXBDLGtCQUFrQjs7Ozs7Ozs7SUF1QnZCLCtDQUF3Qjs7SUFFeEIsNENBQW1DOztJQUNuQyw2Q0FBMEM7O0lBQzFDLDBDQUFzQjs7SUFFdEIsK0NBQXVDOztJQUN2QyxtREFBOEM7O0lBQzlDLGtEQUFrQzs7SUFDbEMsMkNBQXlEOztJQUN6RCw0Q0FBNkM7Ozs7O0lBRTdDLHFEQUE0RTs7SUFXNUUsMkNBRUU7O0lBR0YsMkNBQTJDOzs7OztJQUUvQiw4Q0FBbUM7Ozs7O0lBQUUsdURBQThDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBBcHBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7XG4gICAgUXVlcnlCb2R5LFxuICAgIFJlcXVlc3RGYWNldEZpZWxkcyxcbiAgICBSZXF1ZXN0RmFjZXRGaWVsZCxcbiAgICBSZXF1ZXN0U29ydERlZmluaXRpb25Jbm5lcixcbiAgICBSZXN1bHRTZXRQYWdpbmcsXG4gICAgUmVxdWVzdEhpZ2hsaWdodFxufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IFNlYXJjaENhdGVnb3J5IH0gZnJvbSAnLi9zZWFyY2gtY2F0ZWdvcnkuaW50ZXJmYWNlJztcbmltcG9ydCB7IEZpbHRlclF1ZXJ5IH0gZnJvbSAnLi9maWx0ZXItcXVlcnkuaW50ZXJmYWNlJztcbmltcG9ydCB7IFNlYXJjaFJhbmdlIH0gZnJvbSAnLi9zZWFyY2gtcmFuZ2UuaW50ZXJmYWNlJztcbmltcG9ydCB7IFNlYXJjaENvbmZpZ3VyYXRpb24gfSBmcm9tICcuL3NlYXJjaC1jb25maWd1cmF0aW9uLmludGVyZmFjZSc7XG5pbXBvcnQgeyBGYWNldFF1ZXJ5IH0gZnJvbSAnLi9mYWNldC1xdWVyeS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgU2VhcmNoU29ydGluZ0RlZmluaXRpb24gfSBmcm9tICcuL3NlYXJjaC1zb3J0aW5nLWRlZmluaXRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEZhY2V0RmllbGQgfSBmcm9tICcuL2ZhY2V0LWZpZWxkLmludGVyZmFjZSc7XG5pbXBvcnQgeyBGYWNldEZpZWxkQnVja2V0IH0gZnJvbSAnLi9mYWNldC1maWVsZC1idWNrZXQuaW50ZXJmYWNlJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBTZWFyY2hRdWVyeUJ1aWxkZXJTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgX3VzZXJRdWVyeSA9ICcnO1xuXG4gICAgdXBkYXRlZCA9IG5ldyBTdWJqZWN0PFF1ZXJ5Qm9keT4oKTtcbiAgICBleGVjdXRlZCA9IG5ldyBTdWJqZWN0PFJlc3VsdFNldFBhZ2luZz4oKTtcbiAgICBlcnJvciA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgICBjYXRlZ29yaWVzOiBBcnJheTxTZWFyY2hDYXRlZ29yeT4gPSBbXTtcbiAgICBxdWVyeUZyYWdtZW50czogeyBbaWQ6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG4gICAgZmlsdGVyUXVlcmllczogRmlsdGVyUXVlcnlbXSA9IFtdO1xuICAgIHBhZ2luZzogeyBtYXhJdGVtcz86IG51bWJlcjsgc2tpcENvdW50PzogbnVtYmVyIH0gPSBudWxsO1xuICAgIHNvcnRpbmc6IEFycmF5PFNlYXJjaFNvcnRpbmdEZWZpbml0aW9uPiA9IFtdO1xuXG4gICAgcHJvdGVjdGVkIHVzZXJGYWNldEJ1Y2tldHM6IHsgW2tleTogc3RyaW5nXTogQXJyYXk8RmFjZXRGaWVsZEJ1Y2tldD4gfSA9IHt9O1xuXG4gICAgZ2V0IHVzZXJRdWVyeSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fdXNlclF1ZXJ5O1xuICAgIH1cblxuICAgIHNldCB1c2VyUXVlcnkodmFsdWU6IHN0cmluZykge1xuICAgICAgICB2YWx1ZSA9ICh2YWx1ZSB8fCAnJykudHJpbSgpO1xuICAgICAgICB0aGlzLl91c2VyUXVlcnkgPSB2YWx1ZSA/IGAoJHt2YWx1ZX0pYCA6ICcnO1xuICAgIH1cblxuICAgIGNvbmZpZzogU2VhcmNoQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgY2F0ZWdvcmllczogW11cbiAgICB9O1xuXG4gICAgLy8gVE9ETzogdG8gYmUgc3VwcG9ydGVkIGluIGZ1dHVyZSBpdGVyYXRpb25zXG4gICAgcmFuZ2VzOiB7IFtpZDogc3RyaW5nXTogU2VhcmNoUmFuZ2UgfSA9IHt9O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcHBDb25maWc6IEFwcENvbmZpZ1NlcnZpY2UsIHByaXZhdGUgYWxmcmVzY29BcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5yZXNldFRvRGVmYXVsdHMoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXNldHMgdGhlIHF1ZXJ5IHRvIHRoZSBkZWZhdWx0cyBzcGVjaWZpZWQgaW4gdGhlIGFwcCBjb25maWcuXG4gICAgICovXG4gICAgcmVzZXRUb0RlZmF1bHRzKCkge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHRoaXMuYXBwQ29uZmlnLmdldDxTZWFyY2hDb25maWd1cmF0aW9uPignc2VhcmNoJyk7XG4gICAgICAgIGlmICh0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgdGhpcy5jb25maWcgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRlbXBsYXRlKSk7XG4gICAgICAgICAgICB0aGlzLmNhdGVnb3JpZXMgPSAodGhpcy5jb25maWcuY2F0ZWdvcmllcyB8fCBbXSkuZmlsdGVyKChjYXRlZ29yeSkgPT4gY2F0ZWdvcnkuZW5hYmxlZCk7XG4gICAgICAgICAgICB0aGlzLmZpbHRlclF1ZXJpZXMgPSB0aGlzLmNvbmZpZy5maWx0ZXJRdWVyaWVzIHx8IFtdO1xuICAgICAgICAgICAgdGhpcy51c2VyRmFjZXRCdWNrZXRzID0ge307XG4gICAgICAgICAgICBpZiAodGhpcy5jb25maWcuc29ydGluZykge1xuICAgICAgICAgICAgICAgIHRoaXMuc29ydGluZyA9IHRoaXMuY29uZmlnLnNvcnRpbmcuZGVmYXVsdHMgfHwgW107XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgZmFjZXQgYnVja2V0IHRvIGEgZmllbGQuXG4gICAgICogQHBhcmFtIGZpZWxkIFRoZSB0YXJnZXQgZmllbGRcbiAgICAgKiBAcGFyYW0gYnVja2V0IEJ1Y2tldCB0byBhZGRcbiAgICAgKi9cbiAgICBhZGRVc2VyRmFjZXRCdWNrZXQoZmllbGQ6IEZhY2V0RmllbGQsIGJ1Y2tldDogRmFjZXRGaWVsZEJ1Y2tldCkge1xuICAgICAgICBpZiAoZmllbGQgJiYgZmllbGQuZmllbGQgJiYgYnVja2V0KSB7XG4gICAgICAgICAgICBjb25zdCBidWNrZXRzID0gdGhpcy51c2VyRmFjZXRCdWNrZXRzW2ZpZWxkLmZpZWxkXSB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nID0gYnVja2V0cy5maW5kKChmYWNldEJ1Y2tldCkgPT4gZmFjZXRCdWNrZXQubGFiZWwgPT09IGJ1Y2tldC5sYWJlbCk7XG4gICAgICAgICAgICBpZiAoIWV4aXN0aW5nKSB7XG4gICAgICAgICAgICAgICAgYnVja2V0cy5wdXNoKGJ1Y2tldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnVzZXJGYWNldEJ1Y2tldHNbZmllbGQuZmllbGRdID0gYnVja2V0cztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGJ1Y2tldHMgY3VycmVudGx5IGFkZGVkIHRvIGEgZmllbGRcbiAgICAgKiBAcGFyYW0gZmllbGQgVGhlIHRhcmdldCBmaWVsZHNcbiAgICAgKiBAcmV0dXJucyBCdWNrZXQgYXJyYXlcbiAgICAgKi9cbiAgICBnZXRVc2VyRmFjZXRCdWNrZXRzKGZpZWxkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudXNlckZhY2V0QnVja2V0c1tmaWVsZF0gfHwgW107XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlcyBhbiBleGlzdGluZyBidWNrZXQgZnJvbSBhIGZpZWxkLlxuICAgICAqIEBwYXJhbSBmaWVsZCBUaGUgdGFyZ2V0IGZpZWxkXG4gICAgICogQHBhcmFtIGJ1Y2tldCBCdWNrZXQgdG8gcmVtb3ZlXG4gICAgICovXG4gICAgcmVtb3ZlVXNlckZhY2V0QnVja2V0KGZpZWxkOiBGYWNldEZpZWxkLCBidWNrZXQ6IEZhY2V0RmllbGRCdWNrZXQpIHtcbiAgICAgICAgaWYgKGZpZWxkICYmIGZpZWxkLmZpZWxkICYmIGJ1Y2tldCkge1xuICAgICAgICAgICAgY29uc3QgYnVja2V0cyA9IHRoaXMudXNlckZhY2V0QnVja2V0c1tmaWVsZC5maWVsZF0gfHwgW107XG4gICAgICAgICAgICB0aGlzLnVzZXJGYWNldEJ1Y2tldHNbZmllbGQuZmllbGRdID0gYnVja2V0c1xuICAgICAgICAgICAgICAgIC5maWx0ZXIoKGZhY2V0QnVja2V0KSA9PiBmYWNldEJ1Y2tldC5sYWJlbCAhPT0gYnVja2V0LmxhYmVsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBmaWx0ZXIgcXVlcnkgdG8gdGhlIGN1cnJlbnQgcXVlcnkuXG4gICAgICogQHBhcmFtIHF1ZXJ5IFF1ZXJ5IHN0cmluZyB0byBhZGRcbiAgICAgKi9cbiAgICBhZGRGaWx0ZXJRdWVyeShxdWVyeTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLmZpbHRlclF1ZXJpZXMuZmluZCgoZmlsdGVyUXVlcnkpID0+IGZpbHRlclF1ZXJ5LnF1ZXJ5ID09PSBxdWVyeSk7XG4gICAgICAgICAgICBpZiAoIWV4aXN0aW5nKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJRdWVyaWVzLnB1c2goeyBxdWVyeTogcXVlcnkgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmVzIGFuIGV4aXN0aW5nIGZpbHRlciBxdWVyeS5cbiAgICAgKiBAcGFyYW0gcXVlcnkgVGhlIHF1ZXJ5IHRvIHJlbW92ZVxuICAgICAqL1xuICAgIHJlbW92ZUZpbHRlclF1ZXJ5KHF1ZXJ5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICB0aGlzLmZpbHRlclF1ZXJpZXMgPSB0aGlzLmZpbHRlclF1ZXJpZXNcbiAgICAgICAgICAgICAgICAuZmlsdGVyKChmaWx0ZXJRdWVyeSkgPT4gZmlsdGVyUXVlcnkucXVlcnkgIT09IHF1ZXJ5KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBmYWNldCBxdWVyeSBieSBsYWJlbC5cbiAgICAgKiBAcGFyYW0gbGFiZWwgTGFiZWwgb2YgdGhlIHF1ZXJ5XG4gICAgICogQHJldHVybnMgRmFjZXQgcXVlcnkgZGF0YVxuICAgICAqL1xuICAgIGdldEZhY2V0UXVlcnkobGFiZWw6IHN0cmluZyk6IEZhY2V0UXVlcnkge1xuICAgICAgICBpZiAobGFiZWwgJiYgdGhpcy5oYXNGYWNldFF1ZXJpZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuY29uZmlnLmZhY2V0UXVlcmllcy5xdWVyaWVzLmZpbmQoKHF1ZXJ5KSA9PiBxdWVyeS5sYWJlbCA9PT0gbGFiZWwpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IC4uLnJlc3VsdCB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBmYWNldCBmaWVsZCBieSBsYWJlbC5cbiAgICAgKiBAcGFyYW0gbGFiZWwgTGFiZWwgb2YgdGhlIGZhY2V0IGZpZWxkXG4gICAgICogQHJldHVybnMgRmFjZXQgZmllbGQgZGF0YVxuICAgICAqL1xuICAgIGdldEZhY2V0RmllbGQobGFiZWw6IHN0cmluZyk6IEZhY2V0RmllbGQge1xuICAgICAgICBpZiAobGFiZWwpIHtcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkcyA9IHRoaXMuY29uZmlnLmZhY2V0RmllbGRzLmZpZWxkcyB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGZpZWxkcy5maW5kKChmaWVsZCkgPT4gZmllbGQubGFiZWwgPT09IGxhYmVsKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQubGFiZWwgPSB0aGlzLmdldFN1cHBvcnRlZExhYmVsKHJlc3VsdC5sYWJlbCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgLi4ucmVzdWx0IH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQnVpbGRzIHRoZSBjdXJyZW50IHF1ZXJ5IGFuZCB0cmlnZ2VycyB0aGUgYHVwZGF0ZWRgIGV2ZW50LlxuICAgICAqL1xuICAgIHVwZGF0ZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcXVlcnkgPSB0aGlzLmJ1aWxkUXVlcnkoKTtcbiAgICAgICAgdGhpcy51cGRhdGVkLm5leHQocXVlcnkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJ1aWxkcyBhbmQgZXhlY3V0ZXMgdGhlIGN1cnJlbnQgcXVlcnkuXG4gICAgICogQHJldHVybnMgTm90aGluZ1xuICAgICAqL1xuICAgIGFzeW5jIGV4ZWN1dGUoKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyeSA9IHRoaXMuYnVpbGRRdWVyeSgpO1xuICAgICAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0U2V0UGFnaW5nOiBSZXN1bHRTZXRQYWdpbmcgPSBhd2FpdCB0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5zZWFyY2hBcGkuc2VhcmNoKHF1ZXJ5KTtcbiAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGVkLm5leHQocmVzdWx0U2V0UGFnaW5nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuZXJyb3IubmV4dChlcnJvcik7XG5cbiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZWQubmV4dCh7XG4gICAgICAgICAgICAgICAgbGlzdDoge1xuICAgICAgICAgICAgICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbEl0ZW1zOiAwXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGVudHJpZXM6IFtdXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCdWlsZHMgdGhlIGN1cnJlbnQgcXVlcnkuXG4gICAgICogQHJldHVybnMgVGhlIGZpbmlzaGVkIHF1ZXJ5XG4gICAgICovXG4gICAgYnVpbGRRdWVyeSgpOiBRdWVyeUJvZHkge1xuICAgICAgICBjb25zdCBxdWVyeSA9IHRoaXMuZ2V0RmluYWxRdWVyeSgpO1xuXG4gICAgICAgIGNvbnN0IGluY2x1ZGUgPSB0aGlzLmNvbmZpZy5pbmNsdWRlIHx8IFtdO1xuICAgICAgICBpZiAoaW5jbHVkZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGluY2x1ZGUucHVzaCgncGF0aCcsICdhbGxvd2FibGVPcGVyYXRpb25zJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocXVlcnkpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdDogUXVlcnlCb2R5ID0gPFF1ZXJ5Qm9keT4ge1xuICAgICAgICAgICAgICAgIHF1ZXJ5OiB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeSxcbiAgICAgICAgICAgICAgICAgICAgbGFuZ3VhZ2U6ICdhZnRzJ1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgaW5jbHVkZTogaW5jbHVkZSxcbiAgICAgICAgICAgICAgICBwYWdpbmc6IHRoaXMucGFnaW5nLFxuICAgICAgICAgICAgICAgIGZpZWxkczogdGhpcy5jb25maWcuZmllbGRzLFxuICAgICAgICAgICAgICAgIGZpbHRlclF1ZXJpZXM6IHRoaXMuZmlsdGVyUXVlcmllcyxcbiAgICAgICAgICAgICAgICBmYWNldFF1ZXJpZXM6IHRoaXMuZmFjZXRRdWVyaWVzLFxuICAgICAgICAgICAgICAgIGZhY2V0SW50ZXJ2YWxzOiB0aGlzLmZhY2V0SW50ZXJ2YWxzLFxuICAgICAgICAgICAgICAgIGZhY2V0RmllbGRzOiB0aGlzLmZhY2V0RmllbGRzLFxuICAgICAgICAgICAgICAgIHNvcnQ6IHRoaXMuc29ydCxcbiAgICAgICAgICAgICAgICBoaWdobGlnaHQ6IHRoaXMuaGlnaGxpZ2h0XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICByZXN1bHRbJ2ZhY2V0Rm9ybWF0J10gPSAnVjInO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHByaW1hcnkgc29ydGluZyBkZWZpbml0aW9uLlxuICAgICAqIEByZXR1cm5zIFRoZSBwcmltYXJ5IHNvcnRpbmcgZGVmaW5pdGlvblxuICAgICAqL1xuICAgIGdldFByaW1hcnlTb3J0aW5nKCk6IFNlYXJjaFNvcnRpbmdEZWZpbml0aW9uIHtcbiAgICAgICAgaWYgKHRoaXMuc29ydGluZyAmJiB0aGlzLnNvcnRpbmcubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc29ydGluZ1swXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFsbCBwcmUtY29uZmlndXJlZCBzb3J0aW5nIG9wdGlvbnMgdGhhdCB1c2VycyBjYW4gY2hvb3NlIGZyb20uXG4gICAgICogQHJldHVybnMgUHJlLWNvbmZpZ3VyZWQgc29ydGluZyBvcHRpb25zXG4gICAgICovXG4gICAgZ2V0U29ydGluZ09wdGlvbnMoKTogU2VhcmNoU29ydGluZ0RlZmluaXRpb25bXSB7XG4gICAgICAgIGlmICh0aGlzLmNvbmZpZyAmJiB0aGlzLmNvbmZpZy5zb3J0aW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb25maWcuc29ydGluZy5vcHRpb25zIHx8IFtdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBxdWVyeSBncm91cC5cbiAgICAgKiBAcGFyYW0gcXVlcnkgVGFyZ2V0IHF1ZXJ5XG4gICAgICogQHJldHVybnMgUXVlcnkgZ3JvdXBcbiAgICAgKi9cbiAgICBnZXRRdWVyeUdyb3VwKHF1ZXJ5KSB7XG4gICAgICAgIHJldHVybiBxdWVyeS5ncm91cCB8fCB0aGlzLmNvbmZpZy5mYWNldFF1ZXJpZXMubGFiZWwgfHwgJ0ZhY2V0IFF1ZXJpZXMnO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiBGYWNldFF1ZXJpZXMgaGFzIGJlZW4gZGVmaW5lZFxuICAgICAqIEByZXR1cm5zIFRydWUgaWYgZGVmaW5lZCwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgZ2V0IGhhc0ZhY2V0UXVlcmllcygpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMuY29uZmlnXG4gICAgICAgICAgICAmJiB0aGlzLmNvbmZpZy5mYWNldFF1ZXJpZXNcbiAgICAgICAgICAgICYmIHRoaXMuY29uZmlnLmZhY2V0UXVlcmllcy5xdWVyaWVzXG4gICAgICAgICAgICAmJiB0aGlzLmNvbmZpZy5mYWNldFF1ZXJpZXMucXVlcmllcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIEZhY2V0SW50ZXJ2YWxzIGhhcyBiZWVuIGRlZmluZWRcbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIGRlZmluZWQsIGZhbHNlIG90aGVyd2lzZVxuICAgICAqL1xuICAgIGdldCBoYXNGYWNldEludGVydmFscygpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMuY29uZmlnXG4gICAgICAgICAgICAmJiB0aGlzLmNvbmZpZy5mYWNldEludGVydmFsc1xuICAgICAgICAgICAgJiYgdGhpcy5jb25maWcuZmFjZXRJbnRlcnZhbHMuaW50ZXJ2YWxzXG4gICAgICAgICAgICAmJiB0aGlzLmNvbmZpZy5mYWNldEludGVydmFscy5pbnRlcnZhbHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGdldCBoYXNGYWNldEhpZ2hsaWdodCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29uZmlnICYmIHRoaXMuY29uZmlnLmhpZ2hsaWdodCA/IHRydWUgOiBmYWxzZTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0IHNvcnQoKTogUmVxdWVzdFNvcnREZWZpbml0aW9uSW5uZXJbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNvcnRpbmcubWFwKChkZWYpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUmVxdWVzdFNvcnREZWZpbml0aW9uSW5uZXIoe1xuICAgICAgICAgICAgICAgIHR5cGU6IGRlZi50eXBlLFxuICAgICAgICAgICAgICAgIGZpZWxkOiBkZWYuZmllbGQsXG4gICAgICAgICAgICAgICAgYXNjZW5kaW5nOiBkZWYuYXNjZW5kaW5nXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldCBmYWNldFF1ZXJpZXMoKTogRmFjZXRRdWVyeVtdIHtcbiAgICAgICAgaWYgKHRoaXMuaGFzRmFjZXRRdWVyaWVzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb25maWcuZmFjZXRRdWVyaWVzLnF1ZXJpZXMubWFwKChxdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIHF1ZXJ5Lmdyb3VwID0gdGhpcy5nZXRRdWVyeUdyb3VwKHF1ZXJ5KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gPEZhY2V0UXVlcnk+IHsgLi4ucXVlcnkgfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldCBmYWNldEludGVydmFscygpOiBhbnkge1xuICAgICAgICBpZiAodGhpcy5oYXNGYWNldEludGVydmFscykge1xuICAgICAgICAgICAgY29uc3QgY29uZmlnSW50ZXJ2YWxzID0gdGhpcy5jb25maWcuZmFjZXRJbnRlcnZhbHM7XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgaW50ZXJ2YWxzOiBjb25maWdJbnRlcnZhbHMuaW50ZXJ2YWxzLm1hcCgoaW50ZXJ2YWwpID0+IDxhbnk+IHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHRoaXMuZ2V0U3VwcG9ydGVkTGFiZWwoaW50ZXJ2YWwubGFiZWwpLFxuICAgICAgICAgICAgICAgICAgICBmaWVsZDogaW50ZXJ2YWwuZmllbGQsXG4gICAgICAgICAgICAgICAgICAgIHNldHM6IGludGVydmFsLnNldHMubWFwKChzZXQpID0+IDxhbnk+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiB0aGlzLmdldFN1cHBvcnRlZExhYmVsKHNldC5sYWJlbCksXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc2V0LnN0YXJ0LFxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kOiBzZXQuZW5kLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRJbmNsdXNpdmU6IHNldC5zdGFydEluY2x1c2l2ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZEluY2x1c2l2ZTogc2V0LmVuZEluY2x1c2l2ZVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldCBoaWdobGlnaHQoKTogUmVxdWVzdEhpZ2hsaWdodCB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc0ZhY2V0SGlnaGxpZ2h0ID8gdGhpcy5jb25maWcuaGlnaGxpZ2h0IDogbnVsbDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0RmluYWxRdWVyeSgpOiBzdHJpbmcge1xuICAgICAgICBsZXQgcXVlcnkgPSAnJztcblxuICAgICAgICB0aGlzLmNhdGVnb3JpZXMuZm9yRWFjaCgoZmFjZXQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGN1c3RvbVF1ZXJ5ID0gdGhpcy5xdWVyeUZyYWdtZW50c1tmYWNldC5pZF07XG4gICAgICAgICAgICBpZiAoY3VzdG9tUXVlcnkpIHtcbiAgICAgICAgICAgICAgICBpZiAocXVlcnkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeSArPSAnIEFORCAnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBxdWVyeSArPSBgKCR7Y3VzdG9tUXVlcnl9KWA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCByZXN1bHQgPSBbdGhpcy51c2VyUXVlcnksIHF1ZXJ5XVxuICAgICAgICAgICAgLmZpbHRlcigoZW50cnkpID0+IGVudHJ5KVxuICAgICAgICAgICAgLmpvaW4oJyBBTkQgJyk7XG5cbiAgICAgICAgaWYgKHRoaXMudXNlckZhY2V0QnVja2V0cykge1xuICAgICAgICAgICAgT2JqZWN0LmtleXModGhpcy51c2VyRmFjZXRCdWNrZXRzKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdWJRdWVyeSA9ICh0aGlzLnVzZXJGYWNldEJ1Y2tldHNba2V5XSB8fCBbXSlcbiAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigoYnVja2V0KSA9PiBidWNrZXQuZmlsdGVyUXVlcnkpXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoKGJ1Y2tldCkgPT4gYnVja2V0LmZpbHRlclF1ZXJ5KVxuICAgICAgICAgICAgICAgICAgICAuam9pbignIE9SICcpO1xuICAgICAgICAgICAgICAgIGlmIChzdWJRdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSAnIEFORCAnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSBgKCR7c3ViUXVlcnl9KWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXQgZmFjZXRGaWVsZHMoKTogUmVxdWVzdEZhY2V0RmllbGRzIHtcbiAgICAgICAgY29uc3QgZmFjZXRGaWVsZHMgPSB0aGlzLmNvbmZpZy5mYWNldEZpZWxkcyAmJiB0aGlzLmNvbmZpZy5mYWNldEZpZWxkcy5maWVsZHM7XG5cbiAgICAgICAgaWYgKGZhY2V0RmllbGRzICYmIGZhY2V0RmllbGRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgZmFjZXRzOiBmYWNldEZpZWxkcy5tYXAoKGZhY2V0KSA9PiA8UmVxdWVzdEZhY2V0RmllbGQ+IHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQ6IGZhY2V0LmZpZWxkLFxuICAgICAgICAgICAgICAgICAgICBtaW5jb3VudDogZmFjZXQubWluY291bnQsXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOiB0aGlzLmdldFN1cHBvcnRlZExhYmVsKGZhY2V0LmxhYmVsKSxcbiAgICAgICAgICAgICAgICAgICAgbGltaXQ6IGZhY2V0LmxpbWl0LFxuICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IGZhY2V0Lm9mZnNldCxcbiAgICAgICAgICAgICAgICAgICAgcHJlZml4OiBmYWNldC5wcmVmaXhcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEVuY2xvc2VzIGEgbGFiZWwgbmFtZSB3aXRoIGRvdWJsZSBxdW90ZXMgaWYgaXQgY29udGFpbnMgd2hpdGVzcGFjZSBjaGFyYWN0ZXJzLlxuICAgICAqIEBwYXJhbSBjb25maWdMYWJlbCBPcmlnaW5hbCBsYWJlbCB0ZXh0XG4gICAgICogQHJldHVybnMgTGFiZWwsIHBvc3NpYmx5IHdpdGggcXVvdGVzIGlmIGl0IGNvbnRhaW5zIHNwYWNlc1xuICAgICAqL1xuICAgIGdldFN1cHBvcnRlZExhYmVsKGNvbmZpZ0xhYmVsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBzcGFjZUluc2lkZUxhYmVsSW5kZXggPSBjb25maWdMYWJlbC5zZWFyY2goL1xccy9nKTtcbiAgICAgICAgaWYgKHNwYWNlSW5zaWRlTGFiZWxJbmRleCA+IC0xKSB7XG4gICAgICAgICAgICByZXR1cm4gYFwiJHtjb25maWdMYWJlbH1cImA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbmZpZ0xhYmVsO1xuICAgIH1cbn1cbiJdfQ==