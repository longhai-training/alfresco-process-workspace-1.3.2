/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Component, ViewEncapsulation } from '@angular/core';
import { SearchService, TranslationService } from '@alfresco/adf-core';
import { SearchQueryBuilderService } from '../../search-query-builder.service';
import { SearchFilterList } from './models/search-filter-list.model';
import { takeWhile } from 'rxjs/operators';
export class SearchFilterComponent {
    /**
     * @param {?} queryBuilder
     * @param {?} searchService
     * @param {?} translationService
     */
    constructor(queryBuilder, searchService, translationService) {
        this.queryBuilder = queryBuilder;
        this.searchService = searchService;
        this.translationService = translationService;
        this.DEFAULT_PAGE_SIZE = 5;
        this.isAlive = true;
        /**
         * All facet field items to be displayed in the component. These are updated according to the response.
         *  When a new search is performed, the already existing items are updated with the new bucket count values and
         *  the newly received items are added to the responseFacets.
         */
        this.responseFacets = null;
        this.facetQueriesPageSize = this.DEFAULT_PAGE_SIZE;
        this.facetQueriesLabel = 'Facet Queries';
        this.facetExpanded = {
            'default': false
        };
        this.selectedBuckets = [];
        if (queryBuilder.config && queryBuilder.config.facetQueries) {
            this.facetQueriesLabel = queryBuilder.config.facetQueries.label || 'Facet Queries';
            this.facetQueriesPageSize = queryBuilder.config.facetQueries.pageSize || this.DEFAULT_PAGE_SIZE;
            this.facetExpanded['query'] = queryBuilder.config.facetQueries.expanded;
        }
        if (queryBuilder.config && queryBuilder.config.facetFields) {
            this.facetExpanded['field'] = queryBuilder.config.facetFields.expanded;
        }
        if (queryBuilder.config && queryBuilder.config.facetIntervals) {
            this.facetExpanded['interval'] = queryBuilder.config.facetIntervals.expanded;
        }
        this.displayResetButton = this.queryBuilder.config && !!this.queryBuilder.config.resetButton;
        this.queryBuilder.updated.pipe(takeWhile((/**
         * @return {?}
         */
        () => this.isAlive))).subscribe((/**
         * @return {?}
         */
        () => {
            this.queryBuilder.execute();
        }));
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this.queryBuilder) {
            this.queryBuilder.executed.pipe(takeWhile((/**
             * @return {?}
             */
            () => this.isAlive))).subscribe((/**
             * @param {?} resultSetPaging
             * @return {?}
             */
            (resultSetPaging) => {
                this.onDataLoaded(resultSetPaging);
                this.searchService.dataLoaded.next(resultSetPaging);
            }));
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.isAlive = false;
    }
    /**
     * @private
     * @return {?}
     */
    updateSelectedBuckets() {
        if (this.responseFacets) {
            this.selectedBuckets = [];
            for (const field of this.responseFacets) {
                if (field.buckets) {
                    this.selectedBuckets.push(...this.queryBuilder.getUserFacetBuckets(field.field)
                        .filter((/**
                     * @param {?} bucket
                     * @return {?}
                     */
                    (bucket) => bucket.checked))
                        .map((/**
                     * @param {?} bucket
                     * @return {?}
                     */
                    (bucket) => {
                        return { field, bucket };
                    })));
                }
            }
        }
        else {
            this.selectedBuckets = [];
        }
    }
    /**
     * @param {?} event
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    onToggleBucket(event, field, bucket) {
        if (event && bucket) {
            if (event.checked) {
                this.selectFacetBucket(field, bucket);
            }
            else {
                this.unselectFacetBucket(field, bucket);
            }
        }
    }
    /**
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    selectFacetBucket(field, bucket) {
        if (bucket) {
            bucket.checked = true;
            this.queryBuilder.addUserFacetBucket(field, bucket);
            this.updateSelectedBuckets();
            this.queryBuilder.update();
        }
    }
    /**
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    unselectFacetBucket(field, bucket) {
        if (bucket) {
            bucket.checked = false;
            this.queryBuilder.removeUserFacetBucket(field, bucket);
            this.updateSelectedBuckets();
            this.queryBuilder.update();
        }
    }
    /**
     * @param {?} field
     * @return {?}
     */
    canResetSelectedBuckets(field) {
        if (field && field.buckets) {
            return field.buckets.items.some((/**
             * @param {?} bucket
             * @return {?}
             */
            (bucket) => bucket.checked));
        }
        return false;
    }
    /**
     * @param {?} field
     * @return {?}
     */
    resetSelectedBuckets(field) {
        if (field && field.buckets) {
            for (const bucket of field.buckets.items) {
                bucket.checked = false;
                this.queryBuilder.removeUserFacetBucket(field, bucket);
            }
            this.updateSelectedBuckets();
            this.queryBuilder.update();
        }
    }
    /**
     * @return {?}
     */
    resetAllSelectedBuckets() {
        this.responseFacets.forEach((/**
         * @param {?} field
         * @return {?}
         */
        (field) => {
            if (field && field.buckets) {
                for (const bucket of field.buckets.items) {
                    bucket.checked = false;
                    this.queryBuilder.removeUserFacetBucket(field, bucket);
                }
                this.updateSelectedBuckets();
            }
        }));
        this.queryBuilder.update();
    }
    /**
     * @return {?}
     */
    resetAll() {
        this.resetAllSelectedBuckets();
        this.responseFacets = null;
    }
    /**
     * @param {?} field
     * @return {?}
     */
    shouldExpand(field) {
        return this.facetExpanded[field.type] || this.facetExpanded['default'];
    }
    /**
     * @param {?} data
     * @return {?}
     */
    onDataLoaded(data) {
        /** @type {?} */
        const context = data.list.context;
        if (context) {
            this.parseFacets(context);
        }
        else {
            this.responseFacets = null;
        }
    }
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    parseFacets(context) {
        this.parseFacetFields(context);
        this.parseFacetIntervals(context);
        this.parseFacetQueries(context);
    }
    /**
     * @private
     * @param {?} context
     * @param {?} configFacetFields
     * @param {?} itemType
     * @return {?}
     */
    parseFacetItems(context, configFacetFields, itemType) {
        configFacetFields.forEach((/**
         * @param {?} field
         * @return {?}
         */
        (field) => {
            /** @type {?} */
            const responseField = this.findFacet(context, itemType, field.label);
            /** @type {?} */
            const responseBuckets = this.getResponseBuckets(responseField, field)
                .filter(this.getFilterByMinCount(field.mincount));
            /** @type {?} */
            const alreadyExistingField = this.findResponseFacet(itemType, field.label);
            if (alreadyExistingField) {
                /** @type {?} */
                const alreadyExistingBuckets = alreadyExistingField.buckets && alreadyExistingField.buckets.items || [];
                this.updateExistingBuckets(responseField, responseBuckets, alreadyExistingField, alreadyExistingBuckets);
            }
            else if (responseField) {
                /** @type {?} */
                const bucketList = new SearchFilterList(responseBuckets, field.pageSize);
                bucketList.filter = this.getBucketFilterFunction(bucketList);
                if (!this.responseFacets) {
                    this.responseFacets = [];
                }
                this.responseFacets.push((/** @type {?} */ (Object.assign({}, field, { type: responseField.type || itemType, label: field.label, pageSize: field.pageSize | this.DEFAULT_PAGE_SIZE, currentPageSize: field.pageSize | this.DEFAULT_PAGE_SIZE, buckets: bucketList }))));
            }
        }));
    }
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    parseFacetFields(context) {
        /** @type {?} */
        const configFacetFields = this.queryBuilder.config.facetFields && this.queryBuilder.config.facetFields.fields || [];
        this.parseFacetItems(context, configFacetFields, 'field');
    }
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    parseFacetIntervals(context) {
        /** @type {?} */
        const configFacetIntervals = this.queryBuilder.config.facetIntervals && this.queryBuilder.config.facetIntervals.intervals || [];
        this.parseFacetItems(context, configFacetIntervals, 'interval');
    }
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    parseFacetQueries(context) {
        /** @type {?} */
        const configFacetQueries = this.queryBuilder.config.facetQueries && this.queryBuilder.config.facetQueries.queries || [];
        /** @type {?} */
        const configGroups = configFacetQueries.reduce((/**
         * @param {?} acc
         * @param {?} query
         * @return {?}
         */
        (acc, query) => {
            /** @type {?} */
            const group = this.queryBuilder.getQueryGroup(query);
            if (acc[group]) {
                acc[group].push(query);
            }
            else {
                acc[group] = [query];
            }
            return acc;
        }), []);
        /** @type {?} */
        const mincount = this.queryBuilder.config.facetQueries && this.queryBuilder.config.facetQueries.mincount;
        /** @type {?} */
        const mincountFilter = this.getFilterByMinCount(mincount);
        Object.keys(configGroups).forEach((/**
         * @param {?} group
         * @return {?}
         */
        (group) => {
            /** @type {?} */
            const responseField = this.findFacet(context, 'query', group);
            /** @type {?} */
            const responseBuckets = this.getResponseQueryBuckets(responseField, configGroups[group])
                .filter(mincountFilter);
            /** @type {?} */
            const alreadyExistingField = this.findResponseFacet('query', group);
            if (alreadyExistingField) {
                /** @type {?} */
                const alreadyExistingBuckets = alreadyExistingField.buckets && alreadyExistingField.buckets.items || [];
                this.updateExistingBuckets(responseField, responseBuckets, alreadyExistingField, alreadyExistingBuckets);
            }
            else if (responseField) {
                /** @type {?} */
                const bucketList = new SearchFilterList(responseBuckets, this.facetQueriesPageSize);
                bucketList.filter = this.getBucketFilterFunction(bucketList);
                if (!this.responseFacets) {
                    this.responseFacets = [];
                }
                this.responseFacets.push((/** @type {?} */ ({
                    field: group,
                    type: responseField.type || 'query',
                    label: group,
                    pageSize: this.DEFAULT_PAGE_SIZE,
                    currentPageSize: this.DEFAULT_PAGE_SIZE,
                    buckets: bucketList
                })));
            }
        }));
    }
    /**
     * @private
     * @param {?} responseField
     * @param {?} configField
     * @return {?}
     */
    getResponseBuckets(responseField, configField) {
        return ((responseField && responseField.buckets) || []).map((/**
         * @param {?} respBucket
         * @return {?}
         */
        (respBucket) => {
            respBucket['count'] = this.getCountValue(respBucket);
            respBucket.filterQuery = respBucket.filterQuery || this.getCorrespondingFilterQuery(configField, respBucket.label);
            return (/** @type {?} */ (Object.assign({}, respBucket, { checked: false, display: respBucket.display, label: respBucket.label })));
        }));
    }
    /**
     * @private
     * @param {?} responseField
     * @param {?} configGroup
     * @return {?}
     */
    getResponseQueryBuckets(responseField, configGroup) {
        return (configGroup || []).map((/**
         * @param {?} query
         * @return {?}
         */
        (query) => {
            /** @type {?} */
            const respBucket = ((responseField && responseField.buckets) || [])
                .find((/**
             * @param {?} bucket
             * @return {?}
             */
            (bucket) => bucket.label === query.label));
            respBucket['count'] = this.getCountValue(respBucket);
            return (/** @type {?} */ (Object.assign({}, respBucket, { checked: false, display: respBucket.display, label: respBucket.label })));
        }));
    }
    /**
     * @private
     * @param {?} bucket
     * @return {?}
     */
    getCountValue(bucket) {
        return (!!bucket && !!bucket.metrics && bucket.metrics[0] && bucket.metrics[0].value && bucket.metrics[0].value.count)
            || 0;
    }
    /**
     * @param {?} bucket
     * @return {?}
     */
    getBucketCountDisplay(bucket) {
        return bucket.count === null ? '' : `(${bucket.count})`;
    }
    /**
     * @private
     * @param {?} mincountInput
     * @return {?}
     */
    getFilterByMinCount(mincountInput) {
        return (/**
         * @param {?} bucket
         * @return {?}
         */
        (bucket) => {
            /** @type {?} */
            let mincount = mincountInput;
            if (mincount === undefined) {
                mincount = 1;
            }
            return bucket.count >= mincount;
        });
    }
    /**
     * @private
     * @param {?} configFacetItem
     * @param {?} bucketLabel
     * @return {?}
     */
    getCorrespondingFilterQuery(configFacetItem, bucketLabel) {
        /** @type {?} */
        let filterQuery = null;
        if (configFacetItem.field && bucketLabel) {
            if (configFacetItem.sets) {
                /** @type {?} */
                const configSet = configFacetItem.sets.find((/**
                 * @param {?} set
                 * @return {?}
                 */
                (set) => bucketLabel === set.label));
                if (configSet) {
                    filterQuery = this.buildIntervalQuery(configFacetItem.field, configSet);
                }
            }
            else {
                filterQuery = `${configFacetItem.field}:"${bucketLabel}"`;
            }
        }
        return filterQuery;
    }
    /**
     * @private
     * @param {?} fieldName
     * @param {?} interval
     * @return {?}
     */
    buildIntervalQuery(fieldName, interval) {
        /** @type {?} */
        const start = interval.start;
        /** @type {?} */
        const end = interval.end;
        /** @type {?} */
        const startLimit = (interval.startInclusive === undefined || interval.startInclusive === true) ? '[' : '<';
        /** @type {?} */
        const endLimit = (interval.endInclusive === undefined || interval.endInclusive === true) ? ']' : '>';
        return `${fieldName}:${startLimit}"${start}" TO "${end}"${endLimit}`;
    }
    /**
     * @private
     * @param {?} context
     * @param {?} itemType
     * @param {?} fieldLabel
     * @return {?}
     */
    findFacet(context, itemType, fieldLabel) {
        return (context.facets || []).find((/**
         * @param {?} response
         * @return {?}
         */
        (response) => response.type === itemType && response.label === fieldLabel)) || {};
    }
    /**
     * @private
     * @param {?} itemType
     * @param {?} fieldLabel
     * @return {?}
     */
    findResponseFacet(itemType, fieldLabel) {
        return (this.responseFacets || []).find((/**
         * @param {?} response
         * @return {?}
         */
        (response) => response.type === itemType && response.label === fieldLabel));
    }
    /**
     * @private
     * @param {?} responseField
     * @param {?} responseBuckets
     * @param {?} alreadyExistingField
     * @param {?} alreadyExistingBuckets
     * @return {?}
     */
    updateExistingBuckets(responseField, responseBuckets, alreadyExistingField, alreadyExistingBuckets) {
        /** @type {?} */
        const bucketsToDelete = [];
        alreadyExistingBuckets
            .map((/**
         * @param {?} bucket
         * @return {?}
         */
        (bucket) => {
            /** @type {?} */
            const responseBucket = ((responseField && responseField.buckets) || []).find((/**
             * @param {?} respBucket
             * @return {?}
             */
            (respBucket) => respBucket.label === bucket.label));
            if (!responseBucket) {
                bucketsToDelete.push(bucket);
            }
            bucket.count = this.getCountValue(responseBucket);
            return bucket;
        }));
        /** @type {?} */
        const hasSelection = this.selectedBuckets
            .find((/**
         * @param {?} selBuckets
         * @return {?}
         */
        (selBuckets) => alreadyExistingField.label === selBuckets.field.label && alreadyExistingField.type === selBuckets.field.type));
        if (!hasSelection && bucketsToDelete.length) {
            bucketsToDelete.forEach((/**
             * @param {?} bucket
             * @return {?}
             */
            (bucket) => {
                alreadyExistingField.buckets.deleteItem(bucket);
            }));
        }
        responseBuckets.forEach((/**
         * @param {?} respBucket
         * @return {?}
         */
        (respBucket) => {
            /** @type {?} */
            const existingBucket = alreadyExistingBuckets.find((/**
             * @param {?} oldBucket
             * @return {?}
             */
            (oldBucket) => oldBucket.label === respBucket.label));
            if (!existingBucket) {
                alreadyExistingField.buckets.addItem(respBucket);
            }
        }));
    }
    /**
     * @private
     * @param {?} bucketList
     * @return {?}
     */
    getBucketFilterFunction(bucketList) {
        return (/**
         * @param {?} bucket
         * @return {?}
         */
        (bucket) => {
            if (bucket && bucketList.filterText) {
                /** @type {?} */
                const pattern = (bucketList.filterText || '').toLowerCase();
                /** @type {?} */
                const label = (this.translationService.instant(bucket.display) || this.translationService.instant(bucket.label)).toLowerCase();
                return this.queryBuilder.config.filterWithContains ? label.indexOf(pattern) !== -1 : label.startsWith(pattern);
            }
            return true;
        });
    }
}
SearchFilterComponent.decorators = [
    { type: Component, args: [{
                selector: 'adf-search-filter',
                template: "<mat-accordion multi=\"true\" displayMode=\"flat\">\n\n    <button *ngIf=\"displayResetButton && responseFacets\"\n            mat-button\n            color=\"primary\"\n            matTooltip=\"{{ 'SEARCH.FILTER.BUTTONS.RESET-ALL.TOOLTIP' | translate }}\"\n            matTooltipPosition=\"right\"\n            (click)=\"resetAll()\">\n        {{ 'SEARCH.FILTER.BUTTONS.RESET-ALL.LABEL' | translate }}\n    </button>\n    <mat-expansion-panel\n        *ngFor=\"let category of queryBuilder.categories\"\n        [attr.data-automation-id]=\"'expansion-panel-'+category.name\"\n        [(expanded)]=\"category.expanded\">\n        <mat-expansion-panel-header>\n            <mat-panel-title>\n                {{ category.name | translate }}\n            </mat-panel-title>\n        </mat-expansion-panel-header>\n        <adf-search-widget-container\n            [id]=\"category.id\"\n            [selector]=\"category.component.selector\"\n            [settings]=\"category.component.settings\">\n        </adf-search-widget-container>\n    </mat-expansion-panel>\n\n    <ng-container *ngIf=\"responseFacets\">\n        <mat-expansion-panel [attr.data-automation-id]=\"'expansion-panel-'+field.label\" *ngFor=\"let field of responseFacets\"\n                             [expanded]=\"shouldExpand(field)\">\n            <mat-expansion-panel-header>\n                <mat-panel-title>{{ field.label | translate }}</mat-panel-title>\n            </mat-expansion-panel-header>\n\n            <div class=\"adf-facet-result-filter\">\n                <mat-form-field>\n                    <input\n                        matInput\n                        placeholder=\"{{ 'SEARCH.FILTER.ACTIONS.FILTER-CATEGORY' | translate }}\"\n                        [attr.data-automation-id]=\"'facet-result-filter-'+field.label\"\n                        [(ngModel)]=\"field.buckets.filterText\">\n                    <button *ngIf=\"field.buckets.filterText\"\n                        mat-button matSuffix mat-icon-button\n                        (click)=\"field.buckets.filterText = ''\">\n                        <mat-icon>close</mat-icon>\n                    </button>\n                </mat-form-field>\n            </div>\n\n            <div class=\"adf-checklist\">\n                <mat-checkbox\n                    *ngFor=\"let bucket of field.buckets\"\n                    [checked]=\"bucket.checked\"\n                    [attr.data-automation-id]=\"'checkbox-'+field.label+'-'+(bucket.display || bucket.label)\"\n                    (change)=\"onToggleBucket($event, field, bucket)\">\n                    <div \n                        matTooltip=\"{{ bucket.display || bucket.label | translate }} {{ getBucketCountDisplay(bucket) }}\"\n                        matTooltipPosition=\"right\"\n                        class=\"adf-facet-label\">\n                        {{ bucket.display || bucket.label | translate }} {{ getBucketCountDisplay(bucket) }}\n                    </div>\n                </mat-checkbox>\n            </div>\n\n            <div class=\"adf-facet-buttons\" *ngIf=\"field.buckets.fitsPage\">\n                <button *ngIf=\"canResetSelectedBuckets(field)\"\n                    mat-button\n                    color=\"primary\"\n                    (click)=\"resetSelectedBuckets(field)\">\n                    {{ 'SEARCH.FILTER.ACTIONS.CLEAR-ALL' | translate }}\n                </button>\n            </div>\n\n            <div class=\"adf-facet-buttons\" *ngIf=\"!field.buckets.fitsPage\">\n                <button mat-icon-button\n                    *ngIf=\"canResetSelectedBuckets(field)\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.CLEAR-ALL' | translate }}\"\n                    (click)=\"resetSelectedBuckets(field)\">\n                    <mat-icon>clear</mat-icon>\n                </button>\n                <button mat-icon-button\n                    *ngIf=\"field.buckets.canShowLessItems\"\n                    (click)=\"field.buckets.showLessItems()\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.SHOW-LESS' | translate }}\">\n                    <mat-icon>keyboard_arrow_up</mat-icon>\n                </button>\n                <button mat-icon-button\n                    *ngIf=\"field.buckets.canShowMoreItems\"\n                    (click)=\"field.buckets.showMoreItems()\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.SHOW-MORE' | translate }}\">\n                    <mat-icon>keyboard_arrow_down</mat-icon>\n                </button>\n            </div>\n        </mat-expansion-panel>\n    </ng-container>\n</mat-accordion>\n",
                encapsulation: ViewEncapsulation.None,
                host: { class: 'adf-search-filter' },
                styles: [""]
            }] }
];
/** @nocollapse */
SearchFilterComponent.ctorParameters = () => [
    { type: SearchQueryBuilderService },
    { type: SearchService },
    { type: TranslationService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    SearchFilterComponent.prototype.DEFAULT_PAGE_SIZE;
    /** @type {?} */
    SearchFilterComponent.prototype.isAlive;
    /**
     * All facet field items to be displayed in the component. These are updated according to the response.
     *  When a new search is performed, the already existing items are updated with the new bucket count values and
     *  the newly received items are added to the responseFacets.
     * @type {?}
     */
    SearchFilterComponent.prototype.responseFacets;
    /**
     * @type {?}
     * @private
     */
    SearchFilterComponent.prototype.facetQueriesPageSize;
    /** @type {?} */
    SearchFilterComponent.prototype.facetQueriesLabel;
    /** @type {?} */
    SearchFilterComponent.prototype.facetExpanded;
    /** @type {?} */
    SearchFilterComponent.prototype.displayResetButton;
    /** @type {?} */
    SearchFilterComponent.prototype.selectedBuckets;
    /** @type {?} */
    SearchFilterComponent.prototype.queryBuilder;
    /**
     * @type {?}
     * @private
     */
    SearchFilterComponent.prototype.searchService;
    /**
     * @type {?}
     * @private
     */
    SearchFilterComponent.prototype.translationService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWZpbHRlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJzZWFyY2gvY29tcG9uZW50cy9zZWFyY2gtZmlsdGVyL3NlYXJjaC1maWx0ZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBRWhGLE9BQU8sRUFBRSxhQUFhLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN2RSxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUcvRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNyRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFVM0MsTUFBTSxPQUFPLHFCQUFxQjs7Ozs7O0lBb0I5QixZQUFtQixZQUF1QyxFQUN0QyxhQUE0QixFQUM1QixrQkFBc0M7UUFGdkMsaUJBQVksR0FBWixZQUFZLENBQTJCO1FBQ3RDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFwQmxELHNCQUFpQixHQUFHLENBQUMsQ0FBQztRQUU5QixZQUFPLEdBQUcsSUFBSSxDQUFDOzs7Ozs7UUFNZixtQkFBYyxHQUFpQixJQUFJLENBQUM7UUFFNUIseUJBQW9CLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDO1FBQ3RELHNCQUFpQixHQUFXLGVBQWUsQ0FBQztRQUM1QyxrQkFBYSxHQUFHO1lBQ1osU0FBUyxFQUFFLEtBQUs7U0FDbkIsQ0FBQztRQUVGLG9CQUFlLEdBQTJELEVBQUUsQ0FBQztRQUt6RSxJQUFJLFlBQVksQ0FBQyxNQUFNLElBQUksWUFBWSxDQUFDLE1BQU0sQ0FBQyxZ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Q0FBQyxJQUFJO2dCQUNyQyxJQUFJLEVBQUUsRUFBRSxLQUFLLEVBQUUsbUJBQW1CLEVBQUU7O2FBQ3ZDOzs7O1lBYlEseUJBQXlCO1lBRHpCLGFBQWE7WUFBRSxrQkFBa0I7Ozs7Ozs7SUFpQnRDLGtEQUE4Qjs7SUFFOUIsd0NBQWU7Ozs7Ozs7SUFNZiwrQ0FBb0M7Ozs7O0lBRXBDLHFEQUFzRDs7SUFDdEQsa0RBQTRDOztJQUM1Qyw4Q0FFRTs7SUFDRixtREFBNEI7O0lBQzVCLGdEQUE2RTs7SUFFakUsNkNBQThDOzs7OztJQUM5Qyw4Q0FBb0M7Ozs7O0lBQ3BDLG1EQUE4QyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IENvbXBvbmVudCwgVmlld0VuY2Fwc3VsYXRpb24sIE9uSW5pdCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBNYXRDaGVja2JveENoYW5nZSB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsJztcbmltcG9ydCB7IFNlYXJjaFNlcnZpY2UsIFRyYW5zbGF0aW9uU2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBTZWFyY2hRdWVyeUJ1aWxkZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VhcmNoLXF1ZXJ5LWJ1aWxkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBGYWNldEZpZWxkQnVja2V0IH0gZnJvbSAnLi4vLi4vZmFjZXQtZmllbGQtYnVja2V0LmludGVyZmFjZSc7XG5pbXBvcnQgeyBGYWNldEZpZWxkIH0gZnJvbSAnLi4vLi4vZmFjZXQtZmllbGQuaW50ZXJmYWNlJztcbmltcG9ydCB7IFNlYXJjaEZpbHRlckxpc3QgfSBmcm9tICcuL21vZGVscy9zZWFyY2gtZmlsdGVyLWxpc3QubW9kZWwnO1xuaW1wb3J0IHsgdGFrZVdoaWxlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUmVzdWx0U2V0UGFnaW5nLCBHZW5lcmljQnVja2V0LCBHZW5lcmljRmFjZXRSZXNwb25zZSwgUmVzdWx0U2V0Q29udGV4dCB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ2FkZi1zZWFyY2gtZmlsdGVyJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vc2VhcmNoLWZpbHRlci5jb21wb25lbnQuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vc2VhcmNoLWZpbHRlci5jb21wb25lbnQuc2NzcyddLFxuICAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXG4gICAgaG9zdDogeyBjbGFzczogJ2FkZi1zZWFyY2gtZmlsdGVyJyB9XG59KVxuZXhwb3J0IGNsYXNzIFNlYXJjaEZpbHRlckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcblxuICAgIHByaXZhdGUgREVGQVVMVF9QQUdFX1NJWkUgPSA1O1xuXG4gICAgaXNBbGl2ZSA9IHRydWU7XG5cbiAgICAvKiogQWxsIGZhY2V0IGZpZWxkIGl0ZW1zIHRvIGJlIGRpc3BsYXllZCBpbiB0aGUgY29tcG9uZW50LiBUaGVzZSBhcmUgdXBkYXRlZCBhY2NvcmRpbmcgdG8gdGhlIHJlc3BvbnNlLlxuICAgICAqICBXaGVuIGEgbmV3IHNlYXJjaCBpcyBwZXJmb3JtZWQsIHRoZSBhbHJlYWR5IGV4aXN0aW5nIGl0ZW1zIGFyZSB1cGRhdGVkIHdpdGggdGhlIG5ldyBidWNrZXQgY291bnQgdmFsdWVzIGFuZFxuICAgICAqICB0aGUgbmV3bHkgcmVjZWl2ZWQgaXRlbXMgYXJlIGFkZGVkIHRvIHRoZSByZXNwb25zZUZhY2V0cy5cbiAgICAgKi9cbiAgICByZXNwb25zZUZhY2V0czogRmFjZXRGaWVsZFtdID0gbnVsbDtcblxuICAgIHByaXZhdGUgZmFjZXRRdWVyaWVzUGFnZVNpemUgPSB0aGlzLkRFRkFVTFRfUEFHRV9TSVpFO1xuICAgIGZhY2V0UXVlcmllc0xhYmVsOiBzdHJpbmcgPSAnRmFjZXQgUXVlcmllcyc7XG4gICAgZmFjZXRFeHBhbmRlZCA9IHtcbiAgICAgICAgJ2RlZmF1bHQnOiBmYWxzZVxuICAgIH07XG4gICAgZGlzcGxheVJlc2V0QnV0dG9uOiBib29sZWFuO1xuICAgIHNlbGVjdGVkQnVja2V0czogQXJyYXk8eyBmaWVsZDogRmFjZXRGaWVsZCwgYnVja2V0OiBGYWNldEZpZWxkQnVja2V0IH0+ID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgcXVlcnlCdWlsZGVyOiBTZWFyY2hRdWVyeUJ1aWxkZXJTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgc2VhcmNoU2VydmljZTogU2VhcmNoU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRyYW5zbGF0aW9uU2VydmljZTogVHJhbnNsYXRpb25TZXJ2aWNlKSB7XG4gICAgICAgIGlmIChxdWVyeUJ1aWxkZXIuY29uZmlnICYmIHF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRRdWVyaWVzKSB7XG4gICAgICAgICAgICB0aGlzLmZhY2V0UXVlcmllc0xhYmVsID0gcXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMubGFiZWwgfHwgJ0ZhY2V0IFF1ZXJpZXMnO1xuICAgICAgICAgICAgdGhpcy5mYWNldFF1ZXJpZXNQYWdlU2l6ZSA9IHF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRRdWVyaWVzLnBhZ2VTaXplIHx8IHRoaXMuREVGQVVMVF9QQUdFX1NJWkU7XG4gICAgICAgICAgICB0aGlzLmZhY2V0RXhwYW5kZWRbJ3F1ZXJ5J10gPSBxdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0UXVlcmllcy5leHBhbmRlZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAocXVlcnlCdWlsZGVyLmNvbmZpZyAmJiBxdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0RmllbGRzKSB7XG4gICAgICAgICAgICB0aGlzLmZhY2V0RXhwYW5kZWRbJ2ZpZWxkJ10gPSBxdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0RmllbGRzLmV4cGFuZGVkO1xuICAgICAgICB9XG4gICAgICAgIGlmIChxdWVyeUJ1aWxkZXIuY29uZmlnICYmIHF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRJbnRlcnZhbHMpIHtcbiAgICAgICAgICAgIHRoaXMuZmFjZXRFeHBhbmRlZFsnaW50ZXJ2YWwnXSA9IHF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRJbnRlcnZhbHMuZXhwYW5kZWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kaXNwbGF5UmVzZXRCdXR0b24gPSB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcgJiYgISF0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcucmVzZXRCdXR0b247XG5cbiAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIudXBkYXRlZC5waXBlKFxuICAgICAgICAgICAgdGFrZVdoaWxlKCgpID0+IHRoaXMuaXNBbGl2ZSlcbiAgICAgICAgKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIuZXhlY3V0ZSgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgaWYgKHRoaXMucXVlcnlCdWlsZGVyKSB7XG4gICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5leGVjdXRlZC5waXBlKFxuICAgICAgICAgICAgICAgIHRha2VXaGlsZSgoKSA9PiB0aGlzLmlzQWxpdmUpXG4gICAgICAgICAgICApLnN1YnNjcmliZSgocmVzdWx0U2V0UGFnaW5nOiBSZXN1bHRTZXRQYWdpbmcpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uRGF0YUxvYWRlZChyZXN1bHRTZXRQYWdpbmcpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoU2VydmljZS5kYXRhTG9hZGVkLm5leHQocmVzdWx0U2V0UGFnaW5nKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuaXNBbGl2ZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlU2VsZWN0ZWRCdWNrZXRzKCkge1xuICAgICAgICBpZiAodGhpcy5yZXNwb25zZUZhY2V0cykge1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEJ1Y2tldHMgPSBbXTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgZmllbGQgb2YgdGhpcy5yZXNwb25zZUZhY2V0cykge1xuICAgICAgICAgICAgICAgIGlmIChmaWVsZC5idWNrZXRzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRCdWNrZXRzLnB1c2goXG4gICAgICAgICAgICAgICAgICAgICAgICAuLi50aGlzLnF1ZXJ5QnVpbGRlci5nZXRVc2VyRmFjZXRCdWNrZXRzKGZpZWxkLmZpZWxkKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKGJ1Y2tldCkgPT4gYnVja2V0LmNoZWNrZWQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCgoYnVja2V0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7IGZpZWxkLCBidWNrZXQgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRCdWNrZXRzID0gW107XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvblRvZ2dsZUJ1Y2tldChldmVudDogTWF0Q2hlY2tib3hDaGFuZ2UsIGZpZWxkOiBGYWNldEZpZWxkLCBidWNrZXQ6IEZhY2V0RmllbGRCdWNrZXQpIHtcbiAgICAgICAgaWYgKGV2ZW50ICYmIGJ1Y2tldCkge1xuICAgICAgICAgICAgaWYgKGV2ZW50LmNoZWNrZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEZhY2V0QnVja2V0KGZpZWxkLCBidWNrZXQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVuc2VsZWN0RmFjZXRCdWNrZXQoZmllbGQsIGJ1Y2tldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZWxlY3RGYWNldEJ1Y2tldChmaWVsZDogRmFjZXRGaWVsZCwgYnVja2V0OiBGYWNldEZpZWxkQnVja2V0KSB7XG4gICAgICAgIGlmIChidWNrZXQpIHtcbiAgICAgICAgICAgIGJ1Y2tldC5jaGVja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLmFkZFVzZXJGYWNldEJ1Y2tldChmaWVsZCwgYnVja2V0KTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWRCdWNrZXRzKCk7XG4gICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci51cGRhdGUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVuc2VsZWN0RmFjZXRCdWNrZXQoZmllbGQ6IEZhY2V0RmllbGQsIGJ1Y2tldDogRmFjZXRGaWVsZEJ1Y2tldCkge1xuICAgICAgICBpZiAoYnVja2V0KSB7XG4gICAgICAgICAgICBidWNrZXQuY2hlY2tlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIucmVtb3ZlVXNlckZhY2V0QnVja2V0KGZpZWxkLCBidWNrZXQpO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTZWxlY3RlZEJ1Y2tldHMoKTtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLnVwZGF0ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY2FuUmVzZXRTZWxlY3RlZEJ1Y2tldHMoZmllbGQ6IEZhY2V0RmllbGQpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKGZpZWxkICYmIGZpZWxkLmJ1Y2tldHMpIHtcbiAgICAgICAgICAgIHJldHVybiBmaWVsZC5idWNrZXRzLml0ZW1zLnNvbWUoKGJ1Y2tldCkgPT4gYnVja2V0LmNoZWNrZWQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXNldFNlbGVjdGVkQnVja2V0cyhmaWVsZDogRmFjZXRGaWVsZCkge1xuICAgICAgICBpZiAoZmllbGQgJiYgZmllbGQuYnVja2V0cykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBidWNrZXQgb2YgZmllbGQuYnVja2V0cy5pdGVtcykge1xuICAgICAgICAgICAgICAgIGJ1Y2tldC5jaGVja2VkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIucmVtb3ZlVXNlckZhY2V0QnVja2V0KGZpZWxkLCBidWNrZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy51cGRhdGVTZWxlY3RlZEJ1Y2tldHMoKTtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLnVwZGF0ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVzZXRBbGxTZWxlY3RlZEJ1Y2tldHMoKSB7XG4gICAgICAgIHRoaXMucmVzcG9uc2VGYWNldHMuZm9yRWFjaCgoZmllbGQpID0+IHtcbiAgICAgICAgICAgIGlmIChmaWVsZCAmJiBmaWVsZC5idWNrZXRzKSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBidWNrZXQgb2YgZmllbGQuYnVja2V0cy5pdGVtcykge1xuICAgICAgICAgICAgICAgICAgICBidWNrZXQuY2hlY2tlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5yZW1vdmVVc2VyRmFjZXRCdWNrZXQoZmllbGQsIGJ1Y2tldCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWRCdWNrZXRzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci51cGRhdGUoKTtcbiAgICB9XG5cbiAgICByZXNldEFsbCgpIHtcbiAgICAgICAgdGhpcy5yZXNldEFsbFNlbGVjdGVkQnVja2V0cygpO1xuICAgICAgICB0aGlzLnJlc3BvbnNlRmFjZXRzID0gbnVsbDtcbiAgICB9XG5cbiAgICBzaG91bGRFeHBhbmQoZmllbGQ6IEZhY2V0RmllbGQpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmFjZXRFeHBhbmRlZFtmaWVsZC50eXBlXSB8fCB0aGlzLmZhY2V0RXhwYW5kZWRbJ2RlZmF1bHQnXTtcbiAgICB9XG5cbiAgICBvbkRhdGFMb2FkZWQoZGF0YTogYW55KSB7XG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSBkYXRhLmxpc3QuY29udGV4dDtcblxuICAgICAgICBpZiAoY29udGV4dCkge1xuICAgICAgICAgICAgdGhpcy5wYXJzZUZhY2V0cyhjb250ZXh0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VGYWNldHMgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZUZhY2V0cyhjb250ZXh0OiBSZXN1bHRTZXRDb250ZXh0KSB7XG4gICAgICAgIHRoaXMucGFyc2VGYWNldEZpZWxkcyhjb250ZXh0KTtcbiAgICAgICAgdGhpcy5wYXJzZUZhY2V0SW50ZXJ2YWxzKGNvbnRleHQpO1xuICAgICAgICB0aGlzLnBhcnNlRmFjZXRRdWVyaWVzKGNvbnRleHQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VGYWNldEl0ZW1zKGNvbnRleHQ6IFJlc3VsdFNldENvbnRleHQsIGNvbmZpZ0ZhY2V0RmllbGRzOiBGYWNldEZpZWxkW10sIGl0ZW1UeXBlOiBzdHJpbmcpIHtcbiAgICAgICAgY29uZmlnRmFjZXRGaWVsZHMuZm9yRWFjaCgoZmllbGQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlRmllbGQgPSB0aGlzLmZpbmRGYWNldChjb250ZXh0LCBpdGVtVHlwZSwgZmllbGQubGFiZWwpO1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VCdWNrZXRzID0gdGhpcy5nZXRSZXNwb25zZUJ1Y2tldHMocmVzcG9uc2VGaWVsZCwgZmllbGQpXG4gICAgICAgICAgICAgICAgLmZpbHRlcih0aGlzLmdldEZpbHRlckJ5TWluQ291bnQoZmllbGQubWluY291bnQpKTtcbiAgICAgICAgICAgIGNvbnN0IGFscmVhZHlFeGlzdGluZ0ZpZWxkID0gdGhpcy5maW5kUmVzcG9uc2VGYWNldChpdGVtVHlwZSwgZmllbGQubGFiZWwpO1xuXG4gICAgICAgICAgICBpZiAoYWxyZWFkeUV4aXN0aW5nRmllbGQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhbHJlYWR5RXhpc3RpbmdCdWNrZXRzID0gYWxyZWFkeUV4aXN0aW5nRmllbGQuYnVja2V0cyAmJiBhbHJlYWR5RXhpc3RpbmdGaWVsZC5idWNrZXRzLml0ZW1zIHx8IFtdO1xuXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVFeGlzdGluZ0J1Y2tldHMocmVzcG9uc2VGaWVsZCwgcmVzcG9uc2VCdWNrZXRzLCBhbHJlYWR5RXhpc3RpbmdGaWVsZCwgYWxyZWFkeUV4aXN0aW5nQnVja2V0cyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlRmllbGQpIHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGJ1Y2tldExpc3QgPSBuZXcgU2VhcmNoRmlsdGVyTGlzdDxGYWNldEZpZWxkQnVja2V0PihyZXNwb25zZUJ1Y2tldHMsIGZpZWxkLnBhZ2VTaXplKTtcbiAgICAgICAgICAgICAgICBidWNrZXRMaXN0LmZpbHRlciA9IHRoaXMuZ2V0QnVja2V0RmlsdGVyRnVuY3Rpb24oYnVja2V0TGlzdCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMucmVzcG9uc2VGYWNldHMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNwb25zZUZhY2V0cyA9IFtdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlRmFjZXRzLnB1c2goPEZhY2V0RmllbGQ+IHtcbiAgICAgICAgICAgICAgICAgICAgLi4uZmllbGQsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IHJlc3BvbnNlRmllbGQudHlwZSB8fCBpdGVtVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGZpZWxkLmxhYmVsLFxuICAgICAgICAgICAgICAgICAgICBwYWdlU2l6ZTogZmllbGQucGFnZVNpemUgfCB0aGlzLkRFRkFVTFRfUEFHRV9TSVpFLFxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGFnZVNpemU6IGZpZWxkLnBhZ2VTaXplIHwgdGhpcy5ERUZBVUxUX1BBR0VfU0laRSxcbiAgICAgICAgICAgICAgICAgICAgYnVja2V0czogYnVja2V0TGlzdFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlRmFjZXRGaWVsZHMoY29udGV4dDogUmVzdWx0U2V0Q29udGV4dCkge1xuICAgICAgICBjb25zdCBjb25maWdGYWNldEZpZWxkcyA9IHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldEZpZWxkcyAmJiB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRGaWVsZHMuZmllbGRzIHx8IFtdO1xuICAgICAgICB0aGlzLnBhcnNlRmFjZXRJdGVtcyhjb250ZXh0LCBjb25maWdGYWNldEZpZWxkcywgJ2ZpZWxkJyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZUZhY2V0SW50ZXJ2YWxzKGNvbnRleHQ6IFJlc3VsdFNldENvbnRleHQpIHtcbiAgICAgICAgY29uc3QgY29uZmlnRmFjZXRJbnRlcnZhbHMgPSB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRJbnRlcnZhbHMgJiYgdGhpcy5xdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0SW50ZXJ2YWxzLmludGVydmFscyB8fCBbXTtcbiAgICAgICAgdGhpcy5wYXJzZUZhY2V0SXRlbXMoY29udGV4dCwgY29uZmlnRmFjZXRJbnRlcnZhbHMsICdpbnRlcnZhbCcpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VGYWNldFF1ZXJpZXMoY29udGV4dDogUmVzdWx0U2V0Q29udGV4dCkge1xuICAgICAgICBjb25zdCBjb25maWdGYWNldFF1ZXJpZXMgPSB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRRdWVyaWVzICYmIHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMucXVlcmllcyB8fCBbXTtcbiAgICAgICAgY29uc3QgY29uZmlnR3JvdXBzID0gY29uZmlnRmFjZXRRdWVyaWVzLnJlZHVjZSgoYWNjLCBxdWVyeSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSB0aGlzLnF1ZXJ5QnVpbGRlci5nZXRRdWVyeUdyb3VwKHF1ZXJ5KTtcbiAgICAgICAgICAgIGlmIChhY2NbZ3JvdXBdKSB7XG4gICAgICAgICAgICAgICAgYWNjW2dyb3VwXS5wdXNoKHF1ZXJ5KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYWNjW2dyb3VwXSA9IFtxdWVyeV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9LCBbXSk7XG5cbiAgICAgICAgY29uc3QgbWluY291bnQgPSB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRRdWVyaWVzICYmIHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMubWluY291bnQ7XG4gICAgICAgIGNvbnN0IG1pbmNvdW50RmlsdGVyID0gdGhpcy5nZXRGaWx0ZXJCeU1pbkNvdW50KG1pbmNvdW50KTtcblxuICAgICAgICBPYmplY3Qua2V5cyhjb25maWdHcm91cHMpLmZvckVhY2goKGdyb3VwKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZUZpZWxkID0gdGhpcy5maW5kRmFjZXQoY29udGV4dCwgJ3F1ZXJ5JywgZ3JvdXApO1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VCdWNrZXRzID0gdGhpcy5nZXRSZXNwb25zZVF1ZXJ5QnVja2V0cyhyZXNwb25zZUZpZWxkLCBjb25maWdHcm91cHNbZ3JvdXBdKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIobWluY291bnRGaWx0ZXIpO1xuICAgICAgICAgICAgY29uc3QgYWxyZWFkeUV4aXN0aW5nRmllbGQgPSB0aGlzLmZpbmRSZXNwb25zZUZhY2V0KCdxdWVyeScsIGdyb3VwKTtcblxuICAgICAgICAgICAgaWYgKGFscmVhZHlFeGlzdGluZ0ZpZWxkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYWxyZWFkeUV4aXN0aW5nQnVja2V0cyA9IGFscmVhZHlFeGlzdGluZ0ZpZWxkLmJ1Y2tldHMgJiYgYWxyZWFkeUV4aXN0aW5nRmllbGQuYnVja2V0cy5pdGVtcyB8fCBbXTtcblxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRXhpc3RpbmdCdWNrZXRzKHJlc3BvbnNlRmllbGQsIHJlc3BvbnNlQnVja2V0cywgYWxyZWFkeUV4aXN0aW5nRmllbGQsIGFscmVhZHlFeGlzdGluZ0J1Y2tldHMpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZUZpZWxkKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBidWNrZXRMaXN0ID0gbmV3IFNlYXJjaEZpbHRlckxpc3Q8RmFjZXRGaWVsZEJ1Y2tldD4ocmVzcG9uc2VCdWNrZXRzLCB0aGlzLmZhY2V0UXVlcmllc1BhZ2VTaXplKTtcbiAgICAgICAgICAgICAgICBidWNrZXRMaXN0LmZpbHRlciA9IHRoaXMuZ2V0QnVja2V0RmlsdGVyRnVuY3Rpb24oYnVja2V0TGlzdCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMucmVzcG9uc2VGYWNldHMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNwb25zZUZhY2V0cyA9IFtdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlRmFjZXRzLnB1c2goPEZhY2V0RmllbGQ+IHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQ6IGdyb3VwLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiByZXNwb25zZUZpZWxkLnR5cGUgfHwgJ3F1ZXJ5JyxcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGdyb3VwLFxuICAgICAgICAgICAgICAgICAgICBwYWdlU2l6ZTogdGhpcy5ERUZBVUxUX1BBR0VfU0laRSxcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBhZ2VTaXplOiB0aGlzLkRFRkFVTFRfUEFHRV9TSVpFLFxuICAgICAgICAgICAgICAgICAgICBidWNrZXRzOiBidWNrZXRMaXN0XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRSZXNwb25zZUJ1Y2tldHMocmVzcG9uc2VGaWVsZDogR2VuZXJpY0ZhY2V0UmVzcG9uc2UsIGNvbmZpZ0ZpZWxkOiBGYWNldEZpZWxkKTogRmFjZXRGaWVsZEJ1Y2tldFtdIHtcbiAgICAgICAgcmV0dXJuICgocmVzcG9uc2VGaWVsZCAmJiByZXNwb25zZUZpZWxkLmJ1Y2tldHMpIHx8IFtdKS5tYXAoKHJlc3BCdWNrZXQpID0+IHtcblxuICAgICAgICAgICAgcmVzcEJ1Y2tldFsnY291bnQnXSA9IHRoaXMuZ2V0Q291bnRWYWx1ZShyZXNwQnVja2V0KTtcbiAgICAgICAgICAgIHJlc3BCdWNrZXQuZmlsdGVyUXVlcnkgPSByZXNwQnVja2V0LmZpbHRlclF1ZXJ5IHx8IHRoaXMuZ2V0Q29ycmVzcG9uZGluZ0ZpbHRlclF1ZXJ5KGNvbmZpZ0ZpZWxkLCByZXNwQnVja2V0LmxhYmVsKTtcbiAgICAgICAgICAgIHJldHVybiA8RmFjZXRGaWVsZEJ1Y2tldD4ge1xuICAgICAgICAgICAgICAgIC4uLnJlc3BCdWNrZXQsXG4gICAgICAgICAgICAgICAgY2hlY2tlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgZGlzcGxheTogcmVzcEJ1Y2tldC5kaXNwbGF5LFxuICAgICAgICAgICAgICAgIGxhYmVsOiByZXNwQnVja2V0LmxhYmVsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFJlc3BvbnNlUXVlcnlCdWNrZXRzKHJlc3BvbnNlRmllbGQ6IEdlbmVyaWNGYWNldFJlc3BvbnNlLCBjb25maWdHcm91cDogYW55KTogRmFjZXRGaWVsZEJ1Y2tldFtdIHtcbiAgICAgICAgcmV0dXJuIChjb25maWdHcm91cCB8fCBbXSkubWFwKChxdWVyeSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVzcEJ1Y2tldCA9ICgocmVzcG9uc2VGaWVsZCAmJiByZXNwb25zZUZpZWxkLmJ1Y2tldHMpIHx8IFtdKVxuICAgICAgICAgICAgICAgIC5maW5kKChidWNrZXQpID0+IGJ1Y2tldC5sYWJlbCA9PT0gcXVlcnkubGFiZWwpO1xuXG4gICAgICAgICAgICByZXNwQnVja2V0Wydjb3VudCddID0gdGhpcy5nZXRDb3VudFZhbHVlKHJlc3BCdWNrZXQpO1xuICAgICAgICAgICAgcmV0dXJuIDxGYWNldEZpZWxkQnVja2V0PiB7XG4gICAgICAgICAgICAgICAgLi4ucmVzcEJ1Y2tldCxcbiAgICAgICAgICAgICAgICBjaGVja2VkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBkaXNwbGF5OiByZXNwQnVja2V0LmRpc3BsYXksXG4gICAgICAgICAgICAgICAgbGFiZWw6IHJlc3BCdWNrZXQubGFiZWxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Q291bnRWYWx1ZShidWNrZXQ6IEdlbmVyaWNCdWNrZXQpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gKCEhYnVja2V0ICYmICEhYnVja2V0Lm1ldHJpY3MgJiYgYnVja2V0Lm1ldHJpY3NbMF0gJiYgYnVja2V0Lm1ldHJpY3NbMF0udmFsdWUgJiYgYnVja2V0Lm1ldHJpY3NbMF0udmFsdWUuY291bnQpXG4gICAgICAgICAgICB8fCAwO1xuICAgIH1cblxuICAgIGdldEJ1Y2tldENvdW50RGlzcGxheShidWNrZXQ6IEZhY2V0RmllbGRCdWNrZXQpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gYnVja2V0LmNvdW50ID09PSBudWxsID8gJycgOiBgKCR7YnVja2V0LmNvdW50fSlgO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RmlsdGVyQnlNaW5Db3VudChtaW5jb3VudElucHV0OiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIChidWNrZXQpID0+IHtcbiAgICAgICAgICAgIGxldCBtaW5jb3VudCA9IG1pbmNvdW50SW5wdXQ7XG4gICAgICAgICAgICBpZiAobWluY291bnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIG1pbmNvdW50ID0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBidWNrZXQuY291bnQgPj0gbWluY291bnQ7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb3JyZXNwb25kaW5nRmlsdGVyUXVlcnkgKGNvbmZpZ0ZhY2V0SXRlbTogRmFjZXRGaWVsZCwgYnVja2V0TGFiZWw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGxldCBmaWx0ZXJRdWVyeSA9IG51bGw7XG5cbiAgICAgICAgaWYgKGNvbmZpZ0ZhY2V0SXRlbS5maWVsZCAmJiBidWNrZXRMYWJlbCkge1xuXG4gICAgICAgICAgICBpZiAoY29uZmlnRmFjZXRJdGVtLnNldHMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb25maWdTZXQgPSBjb25maWdGYWNldEl0ZW0uc2V0cy5maW5kKChzZXQpID0+IGJ1Y2tldExhYmVsID09PSBzZXQubGFiZWwpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGNvbmZpZ1NldCkge1xuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJRdWVyeSA9IHRoaXMuYnVpbGRJbnRlcnZhbFF1ZXJ5KGNvbmZpZ0ZhY2V0SXRlbS5maWVsZCwgY29uZmlnU2V0KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZmlsdGVyUXVlcnkgPSBgJHtjb25maWdGYWNldEl0ZW0uZmllbGR9OlwiJHtidWNrZXRMYWJlbH1cImA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmlsdGVyUXVlcnk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZEludGVydmFsUXVlcnkoZmllbGROYW1lOiBzdHJpbmcsIGludGVydmFsOiBhbnkpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBzdGFydCA9IGludGVydmFsLnN0YXJ0O1xuICAgICAgICBjb25zdCBlbmQgPSBpbnRlcnZhbC5lbmQ7XG4gICAgICAgIGNvbnN0IHN0YXJ0TGltaXQgPSAoaW50ZXJ2YWwuc3RhcnRJbmNsdXNpdmUgPT09IHVuZGVmaW5lZCB8fCBpbnRlcnZhbC5zdGFydEluY2x1c2l2ZSA9PT0gdHJ1ZSkgPyAnWycgOiAnPCc7XG4gICAgICAgIGNvbnN0IGVuZExpbWl0ID0gKGludGVydmFsLmVuZEluY2x1c2l2ZSA9PT0gdW5kZWZpbmVkIHx8IGludGVydmFsLmVuZEluY2x1c2l2ZSA9PT0gdHJ1ZSkgPyAnXScgOiAnPic7XG5cbiAgICAgICAgcmV0dXJuIGAke2ZpZWxkTmFtZX06JHtzdGFydExpbWl0fVwiJHtzdGFydH1cIiBUTyBcIiR7ZW5kfVwiJHtlbmRMaW1pdH1gO1xuICAgIH1cblxuICAgIHByaXZhdGUgZmluZEZhY2V0KGNvbnRleHQ6IFJlc3VsdFNldENvbnRleHQsIGl0ZW1UeXBlOiBzdHJpbmcsIGZpZWxkTGFiZWw6IHN0cmluZyk6IEdlbmVyaWNGYWNldFJlc3BvbnNlIHtcbiAgICAgICAgcmV0dXJuIChjb250ZXh0LmZhY2V0cyB8fCBbXSkuZmluZCgocmVzcG9uc2UpID0+IHJlc3BvbnNlLnR5cGUgPT09IGl0ZW1UeXBlICYmIHJlc3BvbnNlLmxhYmVsID09PSBmaWVsZExhYmVsKSB8fCB7fTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZpbmRSZXNwb25zZUZhY2V0KGl0ZW1UeXBlOiBzdHJpbmcsIGZpZWxkTGFiZWw6IHN0cmluZyk6IEZhY2V0RmllbGQge1xuICAgICAgICByZXR1cm4gKHRoaXMucmVzcG9uc2VGYWNldHMgfHwgW10pLmZpbmQoKHJlc3BvbnNlKSA9PiByZXNwb25zZS50eXBlID09PSBpdGVtVHlwZSAmJiByZXNwb25zZS5sYWJlbCA9PT0gZmllbGRMYWJlbCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVFeGlzdGluZ0J1Y2tldHMocmVzcG9uc2VGaWVsZCwgcmVzcG9uc2VCdWNrZXRzLCBhbHJlYWR5RXhpc3RpbmdGaWVsZCwgYWxyZWFkeUV4aXN0aW5nQnVja2V0cykge1xuICAgICAgICBjb25zdCBidWNrZXRzVG9EZWxldGUgPSBbXTtcblxuICAgICAgICBhbHJlYWR5RXhpc3RpbmdCdWNrZXRzXG4gICAgICAgICAgICAubWFwKChidWNrZXQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZUJ1Y2tldCA9ICgocmVzcG9uc2VGaWVsZCAmJiByZXNwb25zZUZpZWxkLmJ1Y2tldHMpIHx8IFtdKS5maW5kKChyZXNwQnVja2V0KSA9PiByZXNwQnVja2V0LmxhYmVsID09PSBidWNrZXQubGFiZWwpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZUJ1Y2tldCkge1xuICAgICAgICAgICAgICAgICAgICBidWNrZXRzVG9EZWxldGUucHVzaChidWNrZXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBidWNrZXQuY291bnQgPSB0aGlzLmdldENvdW50VmFsdWUocmVzcG9uc2VCdWNrZXQpO1xuICAgICAgICAgICAgICAgIHJldHVybiBidWNrZXQ7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBoYXNTZWxlY3Rpb24gPSB0aGlzLnNlbGVjdGVkQnVja2V0c1xuICAgICAgICAgICAgLmZpbmQoKHNlbEJ1Y2tldHMpID0+IGFscmVhZHlFeGlzdGluZ0ZpZWxkLmxhYmVsID09PSBzZWxCdWNrZXRzLmZpZWxkLmxhYmVsICYmIGFscmVhZHlFeGlzdGluZ0ZpZWxkLnR5cGUgPT09IHNlbEJ1Y2tldHMuZmllbGQudHlwZSk7XG5cbiAgICAgICAgaWYgKCFoYXNTZWxlY3Rpb24gJiYgYnVja2V0c1RvRGVsZXRlLmxlbmd0aCkge1xuICAgICAgICAgICAgYnVja2V0c1RvRGVsZXRlLmZvckVhY2goKGJ1Y2tldCkgPT4ge1xuICAgICAgICAgICAgICAgIGFscmVhZHlFeGlzdGluZ0ZpZWxkLmJ1Y2tldHMuZGVsZXRlSXRlbShidWNrZXQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXNwb25zZUJ1Y2tldHMuZm9yRWFjaCgocmVzcEJ1Y2tldCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdCdWNrZXQgPSBhbHJlYWR5RXhpc3RpbmdCdWNrZXRzLmZpbmQoKG9sZEJ1Y2tldCkgPT4gb2xkQnVja2V0LmxhYmVsID09PSByZXNwQnVja2V0LmxhYmVsKTtcblxuICAgICAgICAgICAgaWYgKCFleGlzdGluZ0J1Y2tldCkge1xuICAgICAgICAgICAgICAgIGFscmVhZHlFeGlzdGluZ0ZpZWxkLmJ1Y2tldHMuYWRkSXRlbShyZXNwQnVja2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRCdWNrZXRGaWx0ZXJGdW5jdGlvbiAoYnVja2V0TGlzdCkge1xuICAgICAgICByZXR1cm4gKGJ1Y2tldDogRmFjZXRGaWVsZEJ1Y2tldCk6IGJvb2xlYW4gPT4ge1xuICAgICAgICAgICAgaWYgKGJ1Y2tldCAmJiBidWNrZXRMaXN0LmZpbHRlclRleHQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXR0ZXJuID0gKGJ1Y2tldExpc3QuZmlsdGVyVGV4dCB8fCAnJykudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9ICh0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5pbnN0YW50KGJ1Y2tldC5kaXNwbGF5KSB8fCB0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5pbnN0YW50KGJ1Y2tldC5sYWJlbCkpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5maWx0ZXJXaXRoQ29udGFpbnMgPyBsYWJlbC5pbmRleE9mKHBhdHRlcm4pICE9PSAtMSA6IGxhYmVsLnN0YXJ0c1dpdGgocGF0dGVybik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICB9XG59XG4iXX0=