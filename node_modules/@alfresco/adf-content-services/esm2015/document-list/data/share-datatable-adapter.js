/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { DataSorting } from '@alfresco/adf-core';
import { ShareDataRow } from './share-data-row.model';
export class ShareDataTableAdapter {
    /**
     * @param {?} thumbnailService
     * @param {?} contentService
     * @param {?=} schema
     * @param {?=} sorting
     * @param {?=} sortingMode
     */
    constructor(thumbnailService, contentService, schema = [], sorting, sortingMode = 'client') {
        this.thumbnailService = thumbnailService;
        this.contentService = contentService;
        this.ERR_ROW_NOT_FOUND = 'Row not found';
        this.ERR_COL_NOT_FOUND = 'Column not found';
        this.thumbnails = false;
        this.rows = [];
        this.columns = schema || [];
        this.sorting = sorting;
        this.sortingMode = sortingMode;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set sortingMode(value) {
        /** @type {?} */
        let newValue = (value || 'client').toLowerCase();
        if (newValue !== 'client' && newValue !== 'server') {
            newValue = 'client';
        }
        this._sortingMode = newValue;
    }
    /**
     * @return {?}
     */
    get sortingMode() {
        return this._sortingMode;
    }
    /**
     * @return {?}
     */
    getRows() {
        return this.rows;
    }
    // TODO: disable this api
    /**
     * @param {?} rows
     * @return {?}
     */
    setRows(rows) {
        this.rows = rows || [];
        this.sort();
    }
    /**
     * @return {?}
     */
    getColumns() {
        return this.columns;
    }
    /**
     * @param {?} columns
     * @return {?}
     */
    setColumns(columns) {
        this.columns = columns || [];
    }
    /**
     * @param {?} row
     * @param {?} col
     * @return {?}
     */
    getValue(row, col) {
        if (!row) {
            throw new Error(this.ERR_ROW_NOT_FOUND);
        }
        if (!col) {
            throw new Error(this.ERR_COL_NOT_FOUND);
        }
        /** @type {?} */
        const dataRow = (/** @type {?} */ (row));
        /** @type {?} */
        const value = row.getValue(col.key);
        if (dataRow.cache[col.key] !== undefined) {
            return dataRow.cache[col.key];
        }
        if (col.key === '$thumbnail') {
            if (this.imageResolver) {
                /** @type {?} */
                const resolved = this.imageResolver(row, col);
                if (resolved) {
                    return resolved;
                }
            }
            /** @type {?} */
            const node = ((/** @type {?} */ (row))).node;
            if (node.entry.isFolder) {
                return this.getFolderIcon(node);
            }
            if (node.entry.isFile) {
                if (this.thumbnails) {
                    return this.thumbnailService.getDocumentThumbnailUrl(node);
                }
            }
            if (node.entry.content) {
                /** @type {?} */
                const mimeType = node.entry.content.mimeType;
                if (mimeType) {
                    return this.thumbnailService.getMimeTypeIcon(mimeType);
                }
            }
            return this.thumbnailService.getDefaultMimeTypeIcon();
        }
        if (col.type === 'image') {
            if (this.imageResolver) {
                /** @type {?} */
                const resolved = this.imageResolver(row, col);
                if (resolved) {
                    return resolved;
                }
            }
        }
        return dataRow.cacheValue(col.key, value);
    }
    /**
     * @return {?}
     */
    getSorting() {
        return this.sorting;
    }
    /**
     * @param {?} sorting
     * @return {?}
     */
    setSorting(sorting) {
        this.sorting = sorting;
        this.sortRows(this.rows, this.sorting);
    }
    /**
     * @param {?=} key
     * @param {?=} direction
     * @return {?}
     */
    sort(key, direction) {
        /** @type {?} */
        const sorting = this.sorting || new DataSorting();
        if (key) {
            sorting.key = key;
            sorting.direction = direction || 'asc';
        }
        this.setSorting(sorting);
    }
    /**
     * @param {?} filter
     * @return {?}
     */
    setFilter(filter) {
        this.filter = filter;
    }
    /**
     * @param {?} resolver
     * @return {?}
     */
    setImageResolver(resolver) {
        this.imageResolver = resolver;
    }
    /**
     * @private
     * @param {?} node
     * @return {?}
     */
    getFolderIcon(node) {
        if (this.isSmartFolder(node)) {
            return this.thumbnailService.getMimeTypeIcon('smartFolder');
        }
        else if (this.isRuleFolder(node)) {
            return this.thumbnailService.getMimeTypeIcon('ruleFolder');
        }
        else if (this.isALinkFolder(node)) {
            return this.thumbnailService.getMimeTypeIcon('linkFolder');
        }
        else {
            return this.thumbnailService.getMimeTypeIcon('folder');
        }
    }
    /**
     * @param {?} node
     * @return {?}
     */
    isSmartFolder(node) {
        /** @type {?} */
        const nodeAspects = this.getNodeAspectNames(node);
        return nodeAspects.indexOf('smf:customConfigSmartFolder') > -1 ||
            (nodeAspects.indexOf('smf:systemConfigSmartFolder') > -1);
    }
    /**
     * @param {?} node
     * @return {?}
     */
    isRuleFolder(node) {
        /** @type {?} */
        const nodeAspects = this.getNodeAspectNames(node);
        return nodeAspects.indexOf('rule:rules') > -1 ||
            (nodeAspects.indexOf('rule:rules') > -1);
    }
    /**
     * @param {?} node
     * @return {?}
     */
    isALinkFolder(node) {
        /** @type {?} */
        const nodeType = node.entry ? node.entry.nodeType : node.nodeType;
        return nodeType === 'app:folderlink';
    }
    /**
     * @private
     * @param {?} node
     * @return {?}
     */
    getNodeAspectNames(node) {
        return node.entry && node.entry.aspectNames ? node.entry.aspectNames : node.aspectNames ? node.aspectNames : [];
    }
    /**
     * @private
     * @param {?} rows
     * @param {?} sorting
     * @return {?}
     */
    sortRows(rows, sorting) {
        if (this.sortingMode === 'server') {
            return;
        }
        /** @type {?} */
        const options = {};
        if (sorting && sorting.key && rows && rows.length > 0) {
            if (sorting.key.includes('sizeInBytes') || sorting.key === 'name') {
                options.numeric = true;
            }
            rows.sort((/**
             * @param {?} a
             * @param {?} b
             * @return {?}
             */
            (a, b) => {
                if (a.node.entry.isFolder !== b.node.entry.isFolder) {
                    return a.node.entry.isFolder ? -1 : 1;
                }
                /** @type {?} */
                let left = a.getValue(sorting.key);
                if (left) {
                    left = (left instanceof Date) ? left.valueOf().toString() : left.toString();
                }
                else {
                    left = '';
                }
                /** @type {?} */
                let right = b.getValue(sorting.key);
                if (right) {
                    right = (right instanceof Date) ? right.valueOf().toString() : right.toString();
                }
                else {
                    right = '';
                }
                return sorting.direction === 'asc'
                    ? left.localeCompare(right, undefined, options)
                    : right.localeCompare(left, undefined, options);
            }));
        }
    }
    /**
     * @param {?} nodePaging
     * @param {?=} merge
     * @return {?}
     */
    loadPage(nodePaging, merge = false) {
        /** @type {?} */
        let shareDataRows = [];
        if (nodePaging && nodePaging.list) {
            /** @type {?} */
            const nodeEntries = nodePaging.list.entries;
            if (nodeEntries && nodeEntries.length > 0) {
                shareDataRows = nodeEntries.map((/**
                 * @param {?} item
                 * @return {?}
                 */
                (item) => new ShareDataRow(item, this.contentService, this.permissionsStyle, this.thumbnailService)));
                if (this.filter) {
                    shareDataRows = shareDataRows.filter(this.filter);
                }
                if (this.sortingMode !== 'server') {
                    // Sort by first sortable or just first column
                    if (this.columns && this.columns.length > 0) {
                        /** @type {?} */
                        const sorting = this.getSorting();
                        if (sorting) {
                            this.sortRows(shareDataRows, sorting);
                        }
                        else {
                            /** @type {?} */
                            const sortable = this.columns.filter((/**
                             * @param {?} c
                             * @return {?}
                             */
                            (c) => c.sortable));
                            if (sortable.length > 0) {
                                this.sort(sortable[0].key, 'asc');
                            }
                            else {
                                this.sort(this.columns[0].key, 'asc');
                            }
                        }
                    }
                }
            }
        }
        if (merge) {
            /** @type {?} */
            const listPrunedDuplicate = shareDataRows.filter((/**
             * @param {?} elementToFilter
             * @return {?}
             */
            (elementToFilter) => {
                /** @type {?} */
                const isPresent = this.rows.find((/**
                 * @param {?} currentRow
                 * @return {?}
                 */
                (currentRow) => {
                    return currentRow.obj.entry.id === elementToFilter.obj.entry.id;
                }));
                return !isPresent;
            }));
            this.rows = this.rows.concat(listPrunedDuplicate);
        }
        else {
            this.rows = shareDataRows;
        }
    }
}
if (false) {
    /** @type {?} */
    ShareDataTableAdapter.prototype.ERR_ROW_NOT_FOUND;
    /** @type {?} */
    ShareDataTableAdapter.prototype.ERR_COL_NOT_FOUND;
    /**
     * @type {?}
     * @private
     */
    ShareDataTableAdapter.prototype._sortingMode;
    /**
     * @type {?}
     * @private
     */
    ShareDataTableAdapter.prototype.sorting;
    /**
     * @type {?}
     * @private
     */
    ShareDataTableAdapter.prototype.rows;
    /**
     * @type {?}
     * @private
     */
    ShareDataTableAdapter.prototype.columns;
    /**
     * @type {?}
     * @private
     */
    ShareDataTableAdapter.prototype.filter;
    /**
     * @type {?}
     * @private
     */
    ShareDataTableAdapter.prototype.imageResolver;
    /** @type {?} */
    ShareDataTableAdapter.prototype.thumbnails;
    /** @type {?} */
    ShareDataTableAdapter.prototype.permissionsStyle;
    /** @type {?} */
    ShareDataTableAdapter.prototype.selectedRow;
    /**
     * @type {?}
     * @private
     */
    ShareDataTableAdapter.prototype.thumbnailService;
    /**
     * @type {?}
     * @private
     */
    ShareDataTableAdapter.prototype.contentService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUtZGF0YXRhYmxlLWFkYXB0ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJkb2N1bWVudC1saXN0L2RhdGEvc2hhcmUtZGF0YXRhYmxlLWFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsT0FBTyxFQUdILFdBQVcsRUFJZCxNQUFNLG9CQUFvQixDQUFDO0FBRzVCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUl0RCxNQUFNLE9BQU8scUJBQXFCOzs7Ozs7OztJQTZCOUIsWUFBb0IsZ0JBQWtDLEVBQ2xDLGNBQThCLEVBQ3RDLFNBQXVCLEVBQUUsRUFDekIsT0FBcUIsRUFDckIsY0FBc0IsUUFBUTtRQUp0QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQTVCbEQsc0JBQWlCLEdBQVcsZUFBZSxDQUFDO1FBQzVDLHNCQUFpQixHQUFXLGtCQUFrQixDQUFDO1FBVS9DLGVBQVUsR0FBWSxLQUFLLENBQUM7UUFxQnhCLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0lBQ25DLENBQUM7Ozs7O0lBckJELElBQUksV0FBVyxDQUFDLEtBQWE7O1lBQ3JCLFFBQVEsR0FBRyxDQUFDLEtBQUssSUFBSSxRQUFRLENBQUMsQ0FBQyxXQUFXLEVBQUU7UUFDaEQsSUFBSSxRQUFRLEtBQUssUUFBUSxJQUFJLFFBQVEsS0FBSyxRQUFRLEVBQUU7WUFDaEQsUUFBUSxHQUFHLFFBQVEsQ0FBQztTQUN2QjtRQUNELElBQUksQ0FBQyxZQUFZLEdB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LEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztTQUNyRDthQUFNO1lBQ0gsSUFBSSxDQUFDLElBQUksR0FBRyxhQUFhLENBQUM7U0FDN0I7SUFDTCxDQUFDO0NBRUo7OztJQWxRRyxrREFBNEM7O0lBQzVDLGtEQUErQzs7Ozs7SUFFL0MsNkNBQTZCOzs7OztJQUM3Qix3Q0FBNkI7Ozs7O0lBQzdCLHFDQUF3Qjs7Ozs7SUFDeEIsd0NBQThCOzs7OztJQUU5Qix1Q0FBMEI7Ozs7O0lBQzFCLDhDQUEyQjs7SUFFM0IsMkNBQTRCOztJQUM1QixpREFBeUM7O0lBQ3pDLDRDQUFxQjs7Ozs7SUFjVCxpREFBMEM7Ozs7O0lBQzFDLCtDQUFzQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7XG4gICAgRGF0YUNvbHVtbixcbiAgICBEYXRhUm93LFxuICAgIERhdGFTb3J0aW5nLFxuICAgIERhdGFUYWJsZUFkYXB0ZXIsXG4gICAgVGh1bWJuYWlsU2VydmljZSxcbiAgICBDb250ZW50U2VydmljZVxufSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgTm9kZVBhZ2luZyB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgUGVybWlzc2lvblN0eWxlTW9kZWwgfSBmcm9tICcuLy4uL21vZGVscy9wZXJtaXNzaW9ucy1zdHlsZS5tb2RlbCc7XG5pbXBvcnQgeyBTaGFyZURhdGFSb3cgfSBmcm9tICcuL3NoYXJlLWRhdGEtcm93Lm1vZGVsJztcbmltcG9ydCB7IE5vZGVFbnRyeSB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGkvc3JjL2FwaS9jb250ZW50LXJlc3QtYXBpL21vZGVsL25vZGVFbnRyeSc7XG5pbXBvcnQgeyBSb3dGaWx0ZXIgfSBmcm9tICcuL3Jvdy1maWx0ZXIubW9kZWwnO1xuXG5leHBvcnQgY2xhc3MgU2hhcmVEYXRhVGFibGVBZGFwdGVyIGltcGxlbWVudHMgRGF0YVRhYmxlQWRhcHRlciB7XG5cbiAgICBFUlJfUk9XX05PVF9GT1VORDogc3RyaW5nID0gJ1JvdyBub3QgZm91bmQnO1xuICAgIEVSUl9DT0xfTk9UX0ZPVU5EOiBzdHJpbmcgPSAnQ29sdW1uIG5vdCBmb3VuZCc7XG5cbiAgICBwcml2YXRlIF9zb3J0aW5nTW9kZTogc3RyaW5nO1xuICAgIHByaXZhdGUgc29ydGluZzogRGF0YVNvcnRpbmc7XG4gICAgcHJpdmF0ZSByb3dzOiBEYXRhUm93W107XG4gICAgcHJpdmF0ZSBjb2x1bW5zOiBEYXRhQ29sdW1uW107XG5cbiAgICBwcml2YXRlIGZpbHRlcjogUm93RmlsdGVyO1xuICAgIHByaXZhdGUgaW1hZ2VSZXNvbHZlcjogYW55O1xuXG4gICAgdGh1bWJuYWlsczogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHBlcm1pc3Npb25zU3R5bGU6IFBlcm1pc3Npb25TdHlsZU1vZGVsW107XG4gICAgc2VsZWN0ZWRSb3c6IERhdGFSb3c7XG5cbiAgICBzZXQgc29ydGluZ01vZGUodmFsdWU6IHN0cmluZykge1xuICAgICAgICBsZXQgbmV3VmFsdWUgPSAodmFsdWUgfHwgJ2NsaWVudCcpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmIChuZXdWYWx1ZSAhPT0gJ2NsaWVudCcgJiYgbmV3VmFsdWUgIT09ICdzZXJ2ZXInKSB7XG4gICAgICAgICAgICBuZXdWYWx1ZSA9ICdjbGllbnQnO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3NvcnRpbmdNb2RlID0gbmV3VmFsdWU7XG4gICAgfVxuXG4gICAgZ2V0IHNvcnRpbmdNb2RlKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zb3J0aW5nTW9kZTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRodW1ibmFpbFNlcnZpY2U6IFRodW1ibmFpbFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjb250ZW50U2VydmljZTogQ29udGVudFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgc2NoZW1hOiBEYXRhQ29sdW1uW10gPSBbXSxcbiAgICAgICAgICAgICAgICBzb3J0aW5nPzogRGF0YVNvcnRpbmcsXG4gICAgICAgICAgICAgICAgc29ydGluZ01vZGU6IHN0cmluZyA9ICdjbGllbnQnKSB7XG4gICAgICAgIHRoaXMucm93cyA9IFtdO1xuICAgICAgICB0aGlzLmNvbHVtbnMgPSBzY2hlbWEgfHwgW107XG4gICAgICAgIHRoaXMuc29ydGluZyA9IHNvcnRpbmc7XG4gICAgICAgIHRoaXMuc29ydGluZ01vZGUgPSBzb3J0aW5nTW9kZTtcbiAgICB9XG5cbiAgICBnZXRSb3dzKCk6IEFycmF5PERhdGFSb3c+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucm93cztcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBkaXNhYmxlIHRoaXMgYXBpXG4gICAgc2V0Um93cyhyb3dzOiBBcnJheTxEYXRhUm93Pikge1xuICAgICAgICB0aGlzLnJvd3MgPSByb3dzIHx8IFtdO1xuICAgICAgICB0aGlzLnNvcnQoKTtcbiAgICB9XG5cbiAgICBnZXRDb2x1bW5zKCk6IEFycmF5PERhdGFDb2x1bW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29sdW1ucztcbiAgICB9XG5cbiAgICBzZXRDb2x1bW5zKGNvbHVtbnM6IEFycmF5PERhdGFDb2x1bW4+KSB7XG4gICAgICAgIHRoaXMuY29sdW1ucyA9IGNvbHVtbnMgfHwgW107XG4gICAgfVxuXG4gICAgZ2V0VmFsdWUocm93OiBEYXRhUm93LCBjb2w6IERhdGFDb2x1bW4pOiBhbnkge1xuICAgICAgICBpZiAoIXJvdykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHRoaXMuRVJSX1JPV19OT1RfRk9VTkQpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghY29sKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5FUlJfQ09MX05PVF9GT1VORCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGF0YVJvdzogU2hhcmVEYXRhUm93ID0gPFNoYXJlRGF0YVJvdz4gcm93O1xuICAgICAgICBjb25zdCB2YWx1ZTogYW55ID0gcm93LmdldFZhbHVlKGNvbC5rZXkpO1xuICAgICAgICBpZiAoZGF0YVJvdy5jYWNoZVtjb2wua2V5XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YVJvdy5jYWNoZVtjb2wua2V5XTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb2wua2V5ID09PSAnJHRodW1ibmFpbCcpIHtcblxuICAgICAgICAgICAgaWYgKHRoaXMuaW1hZ2VSZXNvbHZlcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc29sdmVkID0gdGhpcy5pbWFnZVJlc29sdmVyKHJvdywgY29sKTtcbiAgICAgICAgICAgICAgICBpZiAocmVzb2x2ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3Qgbm9kZSA9ICg8U2hhcmVEYXRhUm93PiByb3cpLm5vZGU7XG5cbiAgICAgICAgICAgIGlmIChub2RlLmVudHJ5LmlzRm9sZGVyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Rm9sZGVySWNvbihub2RlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG5vZGUuZW50cnkuaXNGaWxlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudGh1bWJuYWlscykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50aHVtYm5haWxTZXJ2aWNlLmdldERvY3VtZW50VGh1bWJuYWlsVXJsKG5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG5vZGUuZW50cnkuY29udGVudCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1pbWVUeXBlID0gbm9kZS5lbnRyeS5jb250ZW50Lm1pbWVUeXBlO1xuICAgICAgICAgICAgICAgIGlmIChtaW1lVHlwZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50aHVtYm5haWxTZXJ2aWNlLmdldE1pbWVUeXBlSWNvbihtaW1lVHlwZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy50aHVtYm5haWxTZXJ2aWNlLmdldERlZmF1bHRNaW1lVHlwZUljb24oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb2wudHlwZSA9PT0gJ2ltYWdlJykge1xuXG4gICAgICAgICAgICBpZiAodGhpcy5pbWFnZVJlc29sdmVyKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSB0aGlzLmltYWdlUmVzb2x2ZXIocm93LCBjb2wpO1xuICAgICAgICAgICAgICAgIGlmIChyZXNvbHZlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGRhdGFSb3cuY2FjaGVWYWx1ZShjb2wua2V5LCB2YWx1ZSk7XG4gICAgfVxuXG4gICAgZ2V0U29ydGluZygpOiBEYXRhU29ydGluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLnNvcnRpbmc7XG4gICAgfVxuXG4gICAgc2V0U29ydGluZyhzb3J0aW5nOiBEYXRhU29ydGluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLnNvcnRpbmcgPSBzb3J0aW5nO1xuXG4gICAgICAgIHRoaXMuc29ydFJvd3ModGhpcy5yb3dzLCB0aGlzLnNvcnRpbmcpO1xuICAgIH1cblxuICAgIHNvcnQoa2V5Pzogc3RyaW5nLCBkaXJlY3Rpb24/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3Qgc29ydGluZyA9IHRoaXMuc29ydGluZyB8fCBuZXcgRGF0YVNvcnRpbmcoKTtcbiAgICAgICAgaWYgKGtleSkge1xuICAgICAgICAgICAgc29ydGluZy5rZXkgPSBrZXk7XG4gICAgICAgICAgICBzb3J0aW5nLmRpcmVjdGlvbiA9IGRpcmVjdGlvbiB8fCAnYXNjJztcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFNvcnRpbmcoc29ydGluZyk7XG4gICAgfVxuXG4gICAgc2V0RmlsdGVyKGZpbHRlcjogUm93RmlsdGVyKSB7XG4gICAgICAgIHRoaXMuZmlsdGVyID0gZmlsdGVyO1xuICAgIH1cblxuICAgIHNldEltYWdlUmVzb2x2ZXIocmVzb2x2ZXI6IGFueSkge1xuICAgICAgICB0aGlzLmltYWdlUmVzb2x2ZXIgPSByZXNvbHZlcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEZvbGRlckljb24obm9kZTogYW55KSB7XG4gICAgICAgIGlmICh0aGlzLmlzU21hcnRGb2xkZXIobm9kZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRodW1ibmFpbFNlcnZpY2UuZ2V0TWltZVR5cGVJY29uKCdzbWFydEZvbGRlcicpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNSdWxlRm9sZGVyKG5vZGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50aHVtYm5haWxTZXJ2aWNlLmdldE1pbWVUeXBlSWNvbigncnVsZUZvbGRlcicpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNBTGlua0ZvbGRlcihub2RlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudGh1bWJuYWlsU2VydmljZS5nZXRNaW1lVHlwZUljb24oJ2xpbmtGb2xkZXInKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRodW1ibmFpbFNlcnZpY2UuZ2V0TWltZVR5cGVJY29uKCdmb2xkZXInKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzU21hcnRGb2xkZXIobm9kZTogYW55KSB7XG4gICAgICAgIGNvbnN0IG5vZGVBc3BlY3RzID0gdGhpcy5nZXROb2RlQXNwZWN0TmFtZXMobm9kZSk7XG4gICAgICAgIHJldHVybiBub2RlQXNwZWN0cy5pbmRleE9mKCdzbWY6Y3VzdG9tQ29uZmlnU21hcnRGb2xkZXInKSA+IC0xIHx8XG4gICAgICAgICAgICAobm9kZUFzcGVjdHMuaW5kZXhPZignc21mOnN5c3RlbUNvbmZpZ1NtYXJ0Rm9sZGVyJykgPiAtMSk7XG4gICAgfVxuXG4gICAgaXNSdWxlRm9sZGVyKG5vZGU6IGFueSkge1xuICAgICAgICBjb25zdCBub2RlQXNwZWN0cyA9IHRoaXMuZ2V0Tm9kZUFzcGVjdE5hbWVzKG5vZGUpO1xuICAgICAgICByZXR1cm4gbm9kZUFzcGVjdHMuaW5kZXhPZigncnVsZTpydWxlcycpID4gLTEgfHxcbiAgICAgICAgICAgIChub2RlQXNwZWN0cy5pbmRleE9mKCdydWxlOnJ1bGVzJykgPiAtMSk7XG4gICAgfVxuXG4gICAgaXNBTGlua0ZvbGRlcihub2RlOiBhbnkpIHtcbiAgICAgICAgY29uc3Qgbm9kZVR5cGUgPSBub2RlLmVudHJ5ID8gbm9kZS5lbnRyeS5ub2RlVHlwZSA6IG5vZGUubm9kZVR5cGU7XG4gICAgICAgIHJldHVybiBub2RlVHlwZSA9PT0gJ2FwcDpmb2xkZXJsaW5rJztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldE5vZGVBc3BlY3ROYW1lcyhub2RlOiBhbnkpOiBhbnlbXSB7XG4gICAgICAgIHJldHVybiBub2RlLmVudHJ5ICYmIG5vZGUuZW50cnkuYXNwZWN0TmFtZXMgPyBub2RlLmVudHJ5LmFzcGVjdE5hbWVzIDogbm9kZS5hc3BlY3ROYW1lcyA/IG5vZGUuYXNwZWN0TmFtZXMgOiBbXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNvcnRSb3dzKHJvd3M6IERhdGFSb3dbXSwgc29ydGluZzogRGF0YVNvcnRpbmcpIHtcbiAgICAgICAgaWYgKHRoaXMuc29ydGluZ01vZGUgPT09ICdzZXJ2ZXInKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBvcHRpb25zOiBJbnRsLkNvbGxhdG9yT3B0aW9ucyA9IHt9O1xuXG4gICAgICAgIGlmIChzb3J0aW5nICYmIHNvcnRpbmcua2V5ICYmIHJvd3MgJiYgcm93cy5sZW5ndGggPiAwKSB7XG5cbiAgICAgICAgICAgIGlmIChzb3J0aW5nLmtleS5pbmNsdWRlcygnc2l6ZUluQnl0ZXMnKSB8fCBzb3J0aW5nLmtleSA9PT0gJ25hbWUnKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5udW1lcmljID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcm93cy5zb3J0KChhOiBTaGFyZURhdGFSb3csIGI6IFNoYXJlRGF0YVJvdykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChhLm5vZGUuZW50cnkuaXNGb2xkZXIgIT09IGIubm9kZS5lbnRyeS5pc0ZvbGRlcikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5ub2RlLmVudHJ5LmlzRm9sZGVyID8gLTEgOiAxO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gYS5nZXRWYWx1ZShzb3J0aW5nLmtleSk7XG4gICAgICAgICAgICAgICAgaWYgKGxlZnQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IChsZWZ0IGluc3RhbmNlb2YgRGF0ZSkgPyBsZWZ0LnZhbHVlT2YoKS50b1N0cmluZygpIDogbGVmdC50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxlZnQgPSAnJztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBiLmdldFZhbHVlKHNvcnRpbmcua2V5KTtcbiAgICAgICAgICAgICAgICBpZiAocmlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmlnaHQgPSAocmlnaHQgaW5zdGFuY2VvZiBEYXRlKSA/IHJpZ2h0LnZhbHVlT2YoKS50b1N0cmluZygpIDogcmlnaHQudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByaWdodCA9ICcnO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBzb3J0aW5nLmRpcmVjdGlvbiA9PT0gJ2FzYydcbiAgICAgICAgICAgICAgICAgICAgPyBsZWZ0LmxvY2FsZUNvbXBhcmUocmlnaHQsIHVuZGVmaW5lZCwgb3B0aW9ucylcbiAgICAgICAgICAgICAgICAgICAgOiByaWdodC5sb2NhbGVDb21wYXJlKGxlZnQsIHVuZGVmaW5lZCwgb3B0aW9ucyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBsb2FkUGFnZShub2RlUGFnaW5nOiBOb2RlUGFnaW5nLCBtZXJnZTogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgICAgIGxldCBzaGFyZURhdGFSb3dzOiBTaGFyZURhdGFSb3dbXSA9IFtdO1xuXG4gICAgICAgIGlmIChub2RlUGFnaW5nICYmIG5vZGVQYWdpbmcubGlzdCkge1xuICAgICAgICAgICAgY29uc3Qgbm9kZUVudHJpZXM6IE5vZGVFbnRyeVtdID0gbm9kZVBhZ2luZy5saXN0LmVudHJpZXM7XG4gICAgICAgICAgICBpZiAobm9kZUVudHJpZXMgJiYgbm9kZUVudHJpZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHNoYXJlRGF0YVJvd3MgPSBub2RlRW50cmllcy5tYXAoKGl0ZW0pID0+IG5ldyBTaGFyZURhdGFSb3coaXRlbSwgdGhpcy5jb250ZW50U2VydmljZSwgdGhpcy5wZXJtaXNzaW9uc1N0eWxlLCB0aGlzLnRodW1ibmFpbFNlcnZpY2UpKTtcblxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmZpbHRlcikge1xuICAgICAgICAgICAgICAgICAgICBzaGFyZURhdGFSb3dzID0gc2hhcmVEYXRhUm93cy5maWx0ZXIodGhpcy5maWx0ZXIpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnNvcnRpbmdNb2RlICE9PSAnc2VydmVyJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBTb3J0IGJ5IGZpcnN0IHNvcnRhYmxlIG9yIGp1c3QgZmlyc3QgY29sdW1uXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbHVtbnMgJiYgdGhpcy5jb2x1bW5zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvcnRpbmcgPSB0aGlzLmdldFNvcnRpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzb3J0aW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zb3J0Um93cyhzaGFyZURhdGFSb3dzLCBzb3J0aW5nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc29ydGFibGUgPSB0aGlzLmNvbHVtbnMuZmlsdGVyKChjKSA9PiBjLnNvcnRhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc29ydGFibGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNvcnQoc29ydGFibGVbMF0ua2V5LCAnYXNjJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zb3J0KHRoaXMuY29sdW1uc1swXS5rZXksICdhc2MnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobWVyZ2UpIHtcbiAgICAgICAgICAgIGNvbnN0IGxpc3RQcnVuZWREdXBsaWNhdGUgPSBzaGFyZURhdGFSb3dzLmZpbHRlcigoZWxlbWVudFRvRmlsdGVyOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpc1ByZXNlbnQgPSB0aGlzLnJvd3MuZmluZCgoY3VycmVudFJvdzogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50Um93Lm9iai5lbnRyeS5pZCA9PT0gZWxlbWVudFRvRmlsdGVyLm9iai5lbnRyeS5pZDtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHJldHVybiAhaXNQcmVzZW50O1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMucm93cyA9IHRoaXMucm93cy5jb25jYXQobGlzdFBydW5lZER1cGxpY2F0ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJvd3MgPSBzaGFyZURhdGFSb3dzO1xuICAgICAgICB9XG4gICAgfVxuXG59XG4iXX0=