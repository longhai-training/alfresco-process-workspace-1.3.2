/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { FileUploadStatus, NodesApiService, TranslationService, UploadService } from '@alfresco/adf-core';
import { Component, ContentChild, Input, Output, TemplateRef, EventEmitter } from '@angular/core';
import { forkJoin, of } from 'rxjs';
import { map, catchError } from 'rxjs/operators';
var FileUploadingListComponent = /** @class */ (function () {
    function FileUploadingListComponent(uploadService, nodesApi, translateService) {
        this.uploadService = uploadService;
        this.nodesApi = nodesApi;
        this.translateService = translateService;
        this.FileUploadStatus = FileUploadStatus;
        this.files = [];
        /**
         * Emitted when a file in the list has an error.
         */
        this.error = new EventEmitter();
    }
    /**
     * Cancel file upload
     *
     * @param file File model to cancel upload for.
     *
     * @memberOf FileUploadingListComponent
     */
    /**
     * Cancel file upload
     *
     * \@memberOf FileUploadingListComponent
     * @param {?} file File model to cancel upload for.
     *
     * @return {?}
     */
    FileUploadingListComponent.prototype.cancelFile = /**
     * Cancel file upload
     *
     * \@memberOf FileUploadingListComponent
     * @param {?} file File model to cancel upload for.
     *
     * @return {?}
     */
    function (file) {
        this.uploadService.cancelUpload(file);
    };
    /**
     * Remove uploaded file
     *
     * @param file File model to remove upload for.
     *
     * @memberOf FileUploadingListComponent
     */
    /**
     * Remove uploaded file
     *
     * \@memberOf FileUploadingListComponent
     * @param {?} file File model to remove upload for.
     *
     * @return {?}
     */
    FileUploadingListComponent.prototype.removeFile = /**
     * Remove uploaded file
     *
     * \@memberOf FileUploadingListComponent
     * @param {?} file File model to remove upload for.
     *
     * @return {?}
     */
    function (file) {
        var _this = this;
        this.deleteNode(file).subscribe((/**
         * @return {?}
         */
        function () {
            if (file.status === FileUploadStatus.Error) {
                _this.notifyError(file);
            }
            _this.cancelNodeVersionInstances(file);
            _this.uploadService.cancelUpload(file);
        }));
    };
    /**
     * Call the appropriate method for each file, depending on state
     */
    /**
     * Call the appropriate method for each file, depending on state
     * @return {?}
     */
    FileUploadingListComponent.prototype.cancelAllFiles = /**
     * Call the appropriate method for each file, depending on state
     * @return {?}
     */
    function () {
        var _this = this;
        this.getUploadingFiles().forEach((/**
         * @param {?} file
         * @return {?}
         */
        function (file) {
            return _this.uploadService.cancelUpload(file);
        }));
        /** @type {?} */
        var deletedFiles = this.files
            .filter((/**
         * @param {?} file
         * @return {?}
         */
        function (file) { return file.status === FileUploadStatus.Complete; }))
            .map((/**
         * @param {?} file
         * @return {?}
         */
        function (file) { return _this.deleteNode(file); }));
        forkJoin.apply(void 0, tslib_1.__spread(deletedFiles)).subscribe((/**
         * @param {?} files
         * @return {?}
         */
        function (files) {
            var _a;
            /** @type {?} */
            var errors = files.filter((/**
             * @param {?} file
             * @return {?}
             */
            function (file) { return file.status === FileUploadStatus.Error; }));
            if (errors.length) {
                _this.notifyError.apply(_this, tslib_1.__spread(errors));
            }
            (_a = _this.uploadService).cancelUpload.apply(_a, tslib_1.__spread(files));
        }));
    };
    /**
     * Checks if all the files are uploaded false if there is at least one file in Progress | Starting | Pending
     */
    /**
     * Checks if all the files are uploaded false if there is at least one file in Progress | Starting | Pending
     * @return {?}
     */
    FileUploadingListComponent.prototype.isUploadCompleted = /**
     * Checks if all the files are uploaded false if there is at least one file in Progress | Starting | Pending
     * @return {?}
     */
    function () {
        return (!this.isUploadCancelled() &&
            Boolean(this.files.length) &&
            !this.files.some((/**
             * @param {?} __0
             * @return {?}
             */
            function (_a) {
                var status = _a.status;
                return status === FileUploadStatus.Starting ||
                    status === FileUploadStatus.Progress ||
                    status === FileUploadStatus.Pending;
            })));
    };
    /**
     * Check if all the files are Cancelled | Aborted | Error. false if there is at least one file in uploading states
     */
    /**
     * Check if all the files are Cancelled | Aborted | Error. false if there is at least one file in uploading states
     * @return {?}
     */
    FileUploadingListComponent.prototype.isUploadCancelled = /**
     * Check if all the files are Cancelled | Aborted | Error. false if there is at least one file in uploading states
     * @return {?}
     */
    function () {
        return (!!this.files.length &&
            this.files.every((/**
             * @param {?} __0
             * @return {?}
             */
            function (_a) {
                var status = _a.status;
                return status === FileUploadStatus.Aborted ||
                    status === FileUploadStatus.Cancelled ||
                    status === FileUploadStatus.Deleted;
            })));
    };
    /**
     * @private
     * @param {?} file
     * @return {?}
     */
    FileUploadingListComponent.prototype.deleteNode = /**
     * @private
     * @param {?} file
     * @return {?}
     */
    function (file) {
        var id = file.data.entry.id;
        return this.nodesApi.deleteNode(id, { permanent: true }).pipe(map((/**
         * @return {?}
         */
        function () {
            file.status = FileUploadStatus.Deleted;
            return file;
        })), catchError((/**
         * @return {?}
         */
        function () {
            file.status = FileUploadStatus.Error;
            return of(file);
        })));
    };
    /**
     * @private
     * @param {?} file
     * @return {?}
     */
    FileUploadingListComponent.prototype.cancelNodeVersionInstances = /**
     * @private
     * @param {?} file
     * @return {?}
     */
    function (file) {
        this.files
            .filter((/**
         * @param {?} item
         * @return {?}
         */
        function (item) {
            return item.data.entry.id === file.data.entry.id &&
                item.options.newVersion;
        }))
            .map((/**
         * @param {?} item
         * @return {?}
         */
        function (item) {
            item.status = FileUploadStatus.Deleted;
        }));
    };
    /**
     * @private
     * @param {...?} files
     * @return {?}
     */
    FileUploadingListComponent.prototype.notifyError = /**
     * @private
     * @param {...?} files
     * @return {?}
     */
    function () {
        var files = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            files[_i] = arguments[_i];
        }
        /** @type {?} */
        var messageError = null;
        if (files.length === 1) {
            messageError = this.translateService.instant('FILE_UPLOAD.MESSAGES.REMOVE_FILE_ERROR', { fileName: files[0].name });
        }
        else {
            messageError = this.translateService.instant('FILE_UPLOAD.MESSAGES.REMOVE_FILES_ERROR', { total: files.length });
        }
        this.error.emit(messageError);
    };
    /**
     * @private
     * @return {?}
     */
    FileUploadingListComponent.prototype.getUploadingFiles = /**
     * @private
     * @return {?}
     */
    function () {
        return this.files.filter((/**
         * @param {?} item
         * @return {?}
         */
        function (item) {
            if (item.status === FileUploadStatus.Pending ||
                item.status === FileUploadStatus.Progress ||
                item.status === FileUploadStatus.Starting) {
                return item;
            }
        }));
    };
    FileUploadingListComponent.decorators = [
        { type: Component, args: [{
                    selector: 'adf-file-uploading-list',
                    template: "<div class=\"upload-list\">\n    <ng-template\n        ngFor\n        [ngForOf]=\"files\"\n        [ngForTemplate]=\"template\">\n    </ng-template>\n</div>\n",
                    styles: [":host{display:flex;flex-direction:column}"]
                }] }
    ];
    /** @nocollapse */
    FileUploadingListComponent.ctorParameters = function () { return [
        { type: UploadService },
        { type: NodesApiService },
        { type: TranslationService }
    ]; };
    FileUploadingListComponent.propDecorators = {
        template: [{ type: ContentChild, args: [TemplateRef,] }],
        files: [{ type: Input }],
        error: [{ type: Output }]
    };
    return FileUploadingListComponent;
}());
export { FileUploadingListComponent };
if (false) {
    /** @type {?} */
    FileUploadingListComponent.prototype.FileUploadStatus;
    /** @type {?} */
    FileUploadingListComponent.prototype.template;
    /** @type {?} */
    FileUploadingListComponent.prototype.files;
    /**
     * Emitted when a file in the list has an error.
     * @type {?}
     */
    FileUploadingListComponent.prototype.error;
    /**
     * @type {?}
     * @private
     */
    FileUploadingListComponent.prototype.uploadService;
    /**
     * @type {?}
     * @private
     */
    FileUploadingListComponent.prototype.nodesApi;
    /**
     * @type {?}
     * @private
     */
    FileUploadingListComponent.prototype.translateService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWRpbmctbGlzdC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJ1cGxvYWQvY29tcG9uZW50cy9maWxlLXVwbG9hZGluZy1saXN0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsT0FBTyxFQUVILGdCQUFnQixFQUNoQixlQUFlLEVBQ2Ysa0JBQWtCLEVBQ2xCLGFBQWEsRUFDaEIsTUFBTSxvQkFBb0IsQ0FBQztBQUM1QixPQUFPLEVBQ0gsU0FBUyxFQUNULFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUNOLFdBQVcsRUFDWCxZQUFZLEVBQ2YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFjLFFBQVEsRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRDtJQWtCSSxvQ0FDWSxhQUE0QixFQUM1QixRQUF5QixFQUN6QixnQkFBb0M7UUFGcEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFDekIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFvQjtRQWZoRCxxQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQU1wQyxVQUFLLEdBQWdCLEVBQUUsQ0FBQzs7OztRQUl4QixVQUFLLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7SUFNM0MsQ0FBQztJQUVKOzs7Ozs7T0FNRzs7Ozs7Ozs7O0lBQ0gsK0NBQVU7Ozs7Ozs7O0lBQVYsVUFBVyxJQUFlO1FBQ3RCLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFRDs7Ozs7O09BTUc7Ozs7Ozs7OztJQUNILCtDQUFVOzs7Ozs7OztJQUFWLFVB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QXlDLEVBQ3pDLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FDMUIsQ0FBQztTQUNMO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDbEMsQ0FBQzs7Ozs7SUFFTyxzREFBaUI7Ozs7SUFBekI7UUFDSSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTTs7OztRQUFDLFVBQUMsSUFBSTtZQUMxQixJQUNJLElBQUksQ0FBQyxNQUFNLEtBQUssZ0JBQWdCLENBQUMsT0FBTztnQkFDeEMsSUFBSSxDQUFDLE1BQU0sS0FBSyxnQkFBZ0IsQ0FBQyxRQUFRO2dCQUN6QyxJQUFJLENBQUMsTUFBTSxLQUFLLGdCQUFnQixDQUFDLFFBQVEsRUFDM0M7Z0JBQ0UsT0FBTyxJQUFJLENBQUM7YUFDZjtRQUNMLENBQUMsRUFBQyxDQUFDO0lBQ1AsQ0FBQzs7Z0JBcEtKLFNBQVMsU0FBQztvQkFDUCxRQUFRLEVBQUUseUJBQXlCO29CQUNuQywwS0FBbUQ7O2lCQUV0RDs7OztnQkFqQkcsYUFBYTtnQkFGYixlQUFlO2dCQUNmLGtCQUFrQjs7OzJCQXNCakIsWUFBWSxTQUFDLFdBQVc7d0JBR3hCLEtBQUs7d0JBSUwsTUFBTTs7SUFzSlgsaUNBQUM7Q0FBQSxBQXJLRCxJQXFLQztTQWhLWSwwQkFBMEI7OztJQUNuQyxzREFBb0M7O0lBRXBDLDhDQUNjOztJQUVkLDJDQUN3Qjs7Ozs7SUFHeEIsMkNBQzhDOzs7OztJQUcxQyxtREFBb0M7Ozs7O0lBQ3BDLDhDQUFpQzs7Ozs7SUFDakMsc0RBQTRDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHtcbiAgICBGaWxlTW9kZWwsXG4gICAgRmlsZVVwbG9hZFN0YXR1cyxcbiAgICBOb2Rlc0FwaVNlcnZpY2UsXG4gICAgVHJhbnNsYXRpb25TZXJ2aWNlLFxuICAgIFVwbG9hZFNlcnZpY2Vcbn0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7XG4gICAgQ29tcG9uZW50LFxuICAgIENvbnRlbnRDaGlsZCxcbiAgICBJbnB1dCxcbiAgICBPdXRwdXQsXG4gICAgVGVtcGxhdGVSZWYsXG4gICAgRXZlbnRFbWl0dGVyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZm9ya0pvaW4sIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnYWRmLWZpbGUtdXBsb2FkaW5nLWxpc3QnLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9maWxlLXVwbG9hZGluZy1saXN0LmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9maWxlLXVwbG9hZGluZy1saXN0LmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgRmlsZVVwbG9hZGluZ0xpc3RDb21wb25lbnQge1xuICAgIEZpbGVVcGxvYWRTdGF0dXMgPSBGaWxlVXBsb2FkU3RhdHVzO1xuXG4gICAgQENvbnRlbnRDaGlsZChUZW1wbGF0ZVJlZilcbiAgICB0ZW1wbGF0ZTogYW55O1xuXG4gICAgQElucHV0KClcbiAgICBmaWxlczogRmlsZU1vZGVsW10gPSBbXTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gYSBmaWxlIGluIHRoZSBsaXN0IGhhcyBhbiBlcnJvci4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBlcnJvcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSB1cGxvYWRTZXJ2aWNlOiBVcGxvYWRTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIG5vZGVzQXBpOiBOb2Rlc0FwaVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRpb25TZXJ2aWNlXG4gICAgKSB7fVxuXG4gICAgLyoqXG4gICAgICogQ2FuY2VsIGZpbGUgdXBsb2FkXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZmlsZSBGaWxlIG1vZGVsIHRvIGNhbmNlbCB1cGxvYWQgZm9yLlxuICAgICAqXG4gICAgICogQG1lbWJlck9mIEZpbGVVcGxvYWRpbmdMaXN0Q29tcG9uZW50XG4gICAgICovXG4gICAgY2FuY2VsRmlsZShmaWxlOiBGaWxlTW9kZWwpOiB2b2lkIHtcbiAgICAgICAgdGhpcy51cGxvYWRTZXJ2aWNlLmNhbmNlbFVwbG9hZChmaWxlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgdXBsb2FkZWQgZmlsZVxuICAgICAqXG4gICAgICogQHBhcmFtIGZpbGUgRmlsZSBtb2RlbCB0byByZW1vdmUgdXBsb2FkIGZvci5cbiAgICAgKlxuICAgICAqIEBtZW1iZXJPZiBGaWxlVXBsb2FkaW5nTGlzdENvbXBvbmVudFxuICAgICAqL1xuICAgIHJlbW92ZUZpbGUoZmlsZTogRmlsZU1vZGVsKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZGVsZXRlTm9kZShmaWxlKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKGZpbGUuc3RhdHVzID09PSBGaWxlVXBsb2FkU3RhdHVzLkVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlFcnJvcihmaWxlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5jYW5jZWxOb2RlVmVyc2lvbkluc3RhbmNlcyhmaWxlKTtcbiAgICAgICAgICAgIHRoaXMudXBsb2FkU2VydmljZS5jYW5jZWxVcGxvYWQoZmlsZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGwgdGhlIGFwcHJvcHJpYXRlIG1ldGhvZCBmb3IgZWFjaCBmaWxlLCBkZXBlbmRpbmcgb24gc3RhdGVcbiAgICAgKi9cbiAgICBjYW5jZWxBbGxGaWxlcygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5nZXRVcGxvYWRpbmdGaWxlcygpLmZvckVhY2goKGZpbGUpID0+XG4gICAgICAgICAgICB0aGlzLnVwbG9hZFNlcnZpY2UuY2FuY2VsVXBsb2FkKGZpbGUpXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgZGVsZXRlZEZpbGVzID0gdGhpcy5maWxlc1xuICAgICAgICAgICAgLmZpbHRlcigoZmlsZSkgPT4gZmlsZS5zdGF0dXMgPT09IEZpbGVVcGxvYWRTdGF0dXMuQ29tcGxldGUpXG4gICAgICAgICAgICAubWFwKChmaWxlKSA9PiB0aGlzLmRlbGV0ZU5vZGUoZmlsZSkpO1xuXG4gICAgICAgIGZvcmtKb2luKC4uLmRlbGV0ZWRGaWxlcykuc3Vic2NyaWJlKChmaWxlczogRmlsZU1vZGVsW10pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9ycyA9IGZpbGVzLmZpbHRlcihcbiAgICAgICAgICAgICAgICAoZmlsZSkgPT4gZmlsZS5zdGF0dXMgPT09IEZpbGVVcGxvYWRTdGF0dXMuRXJyb3JcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChlcnJvcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlFcnJvciguLi5lcnJvcnMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLnVwbG9hZFNlcnZpY2UuY2FuY2VsVXBsb2FkKC4uLmZpbGVzKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIGFsbCB0aGUgZmlsZXMgYXJlIHVwbG9hZGVkIGZhbHNlIGlmIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBmaWxlIGluIFByb2dyZXNzIHwgU3RhcnRpbmcgfCBQZW5kaW5nXG4gICAgICovXG4gICAgaXNVcGxvYWRDb21wbGV0ZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAhdGhpcy5pc1VwbG9hZENhbmNlbGxlZCgpICYmXG4gICAgICAgICAgICBCb29sZWFuKHRoaXMuZmlsZXMubGVuZ3RoKSAmJlxuICAgICAgICAgICAgIXRoaXMuZmlsZXMuc29tZShcbiAgICAgICAgICAgICAgICAoeyBzdGF0dXMgfSkgPT5cbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzID09PSBGaWxlVXBsb2FkU3RhdHVzLlN0YXJ0aW5nIHx8XG4gICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9PT0gRmlsZVVwbG9hZFN0YXR1cy5Qcm9ncmVzcyB8fFxuICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPT09IEZpbGVVcGxvYWRTdGF0dXMuUGVuZGluZ1xuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIGFsbCB0aGUgZmlsZXMgYXJlIENhbmNlbGxlZCB8IEFib3J0ZWQgfCBFcnJvci4gZmFsc2UgaWYgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIGZpbGUgaW4gdXBsb2FkaW5nIHN0YXRlc1xuICAgICAqL1xuICAgIGlzVXBsb2FkQ2FuY2VsbGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgISF0aGlzLmZpbGVzLmxlbmd0aCAmJlxuICAgICAgICAgICAgdGhpcy5maWxlcy5ldmVyeShcbiAgICAgICAgICAgICAgICAoeyBzdGF0dXMgfSkgPT5cbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzID09PSBGaWxlVXBsb2FkU3RhdHVzLkFib3J0ZWQgfHxcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzID09PSBGaWxlVXBsb2FkU3RhdHVzLkNhbmNlbGxlZCB8fFxuICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPT09IEZpbGVVcGxvYWRTdGF0dXMuRGVsZXRlZFxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGVsZXRlTm9kZShmaWxlOiBGaWxlTW9kZWwpOiBPYnNlcnZhYmxlPEZpbGVNb2RlbD4ge1xuICAgICAgICBjb25zdCB7IGlkIH0gPSBmaWxlLmRhdGEuZW50cnk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZXNBcGkuZGVsZXRlTm9kZShpZCwgeyBwZXJtYW5lbnQ6IHRydWUgfSkucGlwZShcbiAgICAgICAgICAgIG1hcCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgZmlsZS5zdGF0dXMgPSBGaWxlVXBsb2FkU3RhdHVzLkRlbGV0ZWQ7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbGU7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGZpbGUuc3RhdHVzID0gRmlsZVVwbG9hZFN0YXR1cy5FcnJvcjtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmlsZSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FuY2VsTm9kZVZlcnNpb25JbnN0YW5jZXMoZmlsZSkge1xuICAgICAgICB0aGlzLmZpbGVzXG4gICAgICAgICAgICAuZmlsdGVyKFxuICAgICAgICAgICAgICAgIChpdGVtKSA9PlxuICAgICAgICAgICAgICAgICAgICBpdGVtLmRhdGEuZW50cnkuaWQgPT09IGZpbGUuZGF0YS5lbnRyeS5pZCAmJlxuICAgICAgICAgICAgICAgICAgICBpdGVtLm9wdGlvbnMubmV3VmVyc2lvblxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLm1hcCgoaXRlbSkgPT4ge1xuICAgICAgICAgICAgICAgIGl0ZW0uc3RhdHVzID0gRmlsZVVwbG9hZFN0YXR1cy5EZWxldGVkO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBub3RpZnlFcnJvciguLi5maWxlczogRmlsZU1vZGVsW10pIHtcbiAgICAgICAgbGV0IG1lc3NhZ2VFcnJvcjogc3RyaW5nID0gbnVsbDtcblxuICAgICAgICBpZiAoZmlsZXMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICBtZXNzYWdlRXJyb3IgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChcbiAgICAgICAgICAgICAgICAnRklMRV9VUExPQUQuTUVTU0FHRVMuUkVNT1ZFX0ZJTEVfRVJST1InLFxuICAgICAgICAgICAgICAgIHsgZmlsZU5hbWU6IGZpbGVzWzBdLm5hbWUgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1lc3NhZ2VFcnJvciA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgICAgICAgICAgICdGSUxFX1VQTE9BRC5NRVNTQUdFUy5SRU1PVkVfRklMRVNfRVJST1InLFxuICAgICAgICAgICAgICAgIHsgdG90YWw6IGZpbGVzLmxlbmd0aCB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5lcnJvci5lbWl0KG1lc3NhZ2VFcnJvcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRVcGxvYWRpbmdGaWxlcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXMuZmlsdGVyKChpdGVtKSA9PiB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgaXRlbS5zdGF0dXMgPT09IEZpbGVVcGxvYWRTdGF0dXMuUGVuZGluZyB8fFxuICAgICAgICAgICAgICAgIGl0ZW0uc3RhdHVzID09PSBGaWxlVXBsb2FkU3RhdHVzLlByb2dyZXNzIHx8XG4gICAgICAgICAgICAgICAgaXRlbS5zdGF0dXMgPT09IEZpbGVVcGxvYWRTdGF0dXMuU3RhcnRpbmdcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=