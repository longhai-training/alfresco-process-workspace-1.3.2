/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Subject, from } from 'rxjs';
import { Component, Output, EventEmitter, ViewEncapsulation } from '@angular/core';
import { FormBuilder, Validators } from '@angular/forms';
import { MatDialogRef } from '@angular/material';
import { AlfrescoApiService } from '@alfresco/adf-core';
import { debounceTime, mergeMap, takeUntil } from 'rxjs/operators';
var LibraryDialogComponent = /** @class */ (function () {
    function LibraryDialogComponent(alfrescoApiService, formBuilder, dialog) {
        this.alfrescoApiService = alfrescoApiService;
        this.formBuilder = formBuilder;
        this.dialog = dialog;
        /**
         * Emitted when an error occurs.
         */
        this.error = new EventEmitter();
        /**
         * Emitted when the new library is created successfully. The
         * event parameter is a SiteEntry object with the details of the
         * newly-created library.
         */
        this.success = new EventEmitter();
        this.onDestroy$ = new Subject();
        this.createTitle = 'LIBRARY.DIALOG.CREATE_TITLE';
        this.libraryTitleExists = false;
        this.visibilityOptions = [
            { value: 'PUBLIC', label: 'LIBRARY.VISIBILITY.PUBLIC', disabled: false },
            { value: 'PRIVATE', label: 'LIBRARY.VISIBILITY.PRIVATE', disabled: false },
            {
                value: 'MODERATED',
                label: 'LIBRARY.VISIBILITY.MODERATED',
                disabled: false
            }
        ];
    }
    /**
     * @return {?}
     */
    LibraryDialogComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var validators = {
            id: [
                Validators.required,
                Validators.maxLength(72),
                this.forbidSpecialCharacters
            ],
            title: [
                Validators.required,
                this.forbidOnlySpaces,
                Validators.minLength(2),
                Validators.maxLength(256)
            ],
            description: [Validators.maxLength(512)]
        };
        this.form = this.formBuilder.group({
            title: [null, validators.title],
            id: [null, validators.id, this.createSiteIdValidator()],
            description: ['', validators.description]
        });
        this.visibilityOption = this.visibilityOptions[0].value;
        this.form.controls['title'].valueChanges
            .pipe(debounceTime(300), mergeMap((/**
         * @param {?} title
         * @return {?}
         */
        function (title) { return _this.checkLibraryNameExists(title); }), (/**
         * @param {?} title
         * @return {?}
         */
        function (title) { return title; })), takeUntil(this.onDestroy$))
            .subscribe((/**
         * @param {?} title
         * @return {?}
         */
        function (title) {
            if (!_this.form.controls['id'].dirty && _this.canGenerateId(title)) {
                _this.form.patchValue({ id: _this.sanitize(title.trim()) });
                _this.form.controls['id'].markAsTouched();
            }
        }));
    };
    /**
     * @return {?}
     */
    LibraryDialogComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.onDestroy$.next(true);
        this.onDestroy$.complete();
    };
    Object.defineProperty(LibraryDialogComponent.prototype, "title", {
        get: /**
         * @return {?}
         */
        function () {
            var title = this.form.value.title;
            return (title || '').trim();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LibraryDialogComponent.prototype, "id", {
        get: /**
         * @return {?}
         */
        function () {
            var id = this.form.value.id;
            return (id || '').trim();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LibraryDialogComponent.prototype, "description", {
        get: /**
         * @return {?}
         */
        function () {
            var description = this.form.value.description;
            return (description || '').trim();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LibraryDialogComponent.prototype, "visibility", {
        get: /**
         * @return {?}
         */
        function () {
            return this.visibilityOption || '';
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    LibraryDialogComponent.prototype.submit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        var _a = this, form = _a.form, dialog = _a.dialog;
        if (!form.valid) {
            return;
        }
        this.create().subscribe((/**
         * @param {?} node
         * @return {?}
         */
        function (node) {
            _this.success.emit(node);
            dialog.close(node);
        }), (/**
         * @param {?} error
         * @return {?}
         */
        function (error) { return _this.handleError(error); }));
    };
    /**
     * @param {?} event
     * @return {?}
     */
    LibraryDialogComponent.prototype.visibilityChangeHandler = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        this.visibilityOption = event.value;
    };
    /**
     * @private
     * @return {?}
     */
    LibraryDialogComponent.prototype.create = /**
     * @private
     * @return {?}
     */
    function () {
        var _a = this, title = _a.title, id = _a.id, description = _a.description, visibility = _a.visibility;
        /** @type {?} */
        var siteBody = (/** @type {?} */ ({
            id: id,
            title: title,
            description: description,
            visibility: visibility
        }));
        return from(this.alfrescoApiService.sitesApi.createSite(siteBody));
    };
    /**
     * @private
     * @param {?} input
     * @return {?}
     */
    LibraryDialogComponent.prototype.sanitize = /**
     * @private
     * @param {?} input
     * @return {?}
     */
    function (input) {
        return input.replace(/[\s\s]+/g, '-').replace(/[^A-Za-z0-9-]/g, '');
    };
    /**
     * @private
     * @param {?} title
     * @return {?}
     */
    LibraryDialogComponent.prototype.canGenerateId = /**
     * @private
     * @param {?} title
     * @return {?}
     */
    function (title) {
        return Boolean(title.replace(/[^A-Za-z0-9-]/g, '').length);
    };
    /**
     * @private
     * @param {?} error
     * @return {?}
     */
    LibraryDialogComponent.prototype.handleError = /**
     * @private
     * @param {?} error
     * @return {?}
     */
    function (error) {
        var statusCode = JSON.parse(error.message).error.statusCode;
        if (statusCode === 409) {
            this.form.controls['id'].setErrors({
                message: 'LIBRARY.ERRORS.CONFLICT'
            });
        }
        return error;
    };
    /**
     * @private
     * @param {?} libraryTitle
     * @return {?}
     */
    LibraryDialogComponent.prototype.checkLibraryNameExists = /**
     * @private
     * @param {?} libraryTitle
     * @return {?}
     */
    function (libraryTitle) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var entries, _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        entries = [];
                        _b.label = 1;
                    case 1:
                        _b.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, this.findLibraryByTitle(libraryTitle)];
                    case 2:
                        entries = (_b.sent()).list.entries;
                        return [3 /*break*/, 4];
                    case 3:
                        _a = _b.sent();
                        entries = [];
                        return [3 /*break*/, 4];
                    case 4:
                        if (entries.length) {
                            this.libraryTitleExists = entries[0].entry.title.toLowerCase() === libraryTitle.toLowerCase();
                        }
                        else {
                            this.libraryTitleExists = false;
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * @private
     * @param {?} libraryTitle
     * @return {?}
     */
    LibraryDialogComponent.prototype.findLibraryByTitle = /**
     * @private
     * @param {?} libraryTitle
     * @return {?}
     */
    function (libraryTitle) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.alfrescoApiService
                        .getInstance()
                        .core.queriesApi.findSites(libraryTitle, {
                        maxItems: 1,
                        fields: ['title']
                    })];
            });
        });
    };
    /**
     * @private
     * @param {?} __0
     * @return {?}
     */
    LibraryDialogComponent.prototype.forbidSpecialCharacters = /**
     * @private
     * @param {?} __0
     * @return {?}
     */
    function (_a) {
        var value = _a.value;
        if (value === null || value.length === 0) {
            return null;
        }
        /** @type {?} */
        var validCharacters = /[^A-Za-z0-9-]/;
        /** @type {?} */
        var isValid = !validCharacters.test(value);
        return isValid
            ? null
            : {
                message: 'LIBRARY.ERRORS.ILLEGAL_CHARACTERS'
            };
    };
    /**
     * @private
     * @param {?} __0
     * @return {?}
     */
    LibraryDialogComponent.prototype.forbidOnlySpaces = /**
     * @private
     * @param {?} __0
     * @return {?}
     */
    function (_a) {
        var value = _a.value;
        if (value === null || value.length === 0) {
            return null;
        }
        /** @type {?} */
        var isValid = !!(value || '').trim();
        return isValid
            ? null
            : {
                message: 'LIBRARY.ERRORS.ONLY_SPACES'
            };
    };
    /**
     * @private
     * @return {?}
     */
    LibraryDialogComponent.prototype.createSiteIdValidator = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var timer;
        return (/**
         * @param {?} control
         * @return {?}
         */
        function (control) {
            if (timer) {
                clearTimeout(timer);
            }
            return new Promise((/**
             * @param {?} resolve
             * @return {?}
             */
            function (resolve) {
                timer = setTimeout((/**
                 * @return {?}
                 */
                function () {
                    return from(_this.alfrescoApiService.sitesApi.getSite(control.value)).subscribe((/**
                     * @return {?}
                     */
                    function () { return resolve({ message: 'LIBRARY.ERRORS.EXISTENT_SITE' }); }), (/**
                     * @return {?}
                     */
                    function () { return resolve(null); }));
                }), 300);
            }));
        });
    };
    LibraryDialogComponent.decorators = [
        { type: Component, args: [{
                    selector: 'adf-library-dialog',
                    template: "<h2 mat-dialog-title>{{ createTitle | translate }}</h2>\n\n<mat-dialog-content>\n  <form novalidate [formGroup]=\"form\" (submit)=\"submit()\">\n    <mat-form-field>\n      <input\n        placeholder=\"{{ 'LIBRARY.DIALOG.FORM.NAME' | translate }}\"\n        required\n        matInput\n        autofocus\n        formControlName=\"title\"\n        autocomplete=\"off\"\n      />\n\n      <mat-hint *ngIf=\"libraryTitleExists\">{{\n        'LIBRARY.HINTS.SITE_TITLE_EXISTS' | translate\n      }}</mat-hint>\n      <mat-error *ngIf=\"form.controls['title'].hasError('maxlength')\">\n        {{ 'LIBRARY.ERRORS.TITLE_TOO_LONG' | translate }}\n      </mat-error>\n\n      <mat-error *ngIf=\"form.controls['title'].hasError('minlength')\">\n        {{ 'LIBRARY.ERRORS.TITLE_TOO_SHORT' | translate }}\n      </mat-error>\n\n      <mat-error *ngIf=\"form.controls['title'].errors?.message\">\n        {{ form.controls['title'].errors?.message | translate }}\n      </mat-error>\n    </mat-form-field>\n\n    <mat-form-field>\n      <input\n        required\n        placeholder=\"{{ 'LIBRARY.DIALOG.FORM.SITE_ID' | translate }}\"\n        matInput\n        formControlName=\"id\"\n        autocomplete=\"off\"\n      />\n\n      <mat-error *ngIf=\"form.controls['id'].errors?.message\">\n        {{ form.controls['id'].errors?.message | translate }}\n      </mat-error>\n\n      <mat-error *ngIf=\"form.controls['id'].hasError('maxlength')\">\n        {{ 'LIBRARY.ERRORS.ID_TOO_LONG' | translate }}\n      </mat-error>\n    </mat-form-field>\n\n    <mat-form-field>\n      <textarea\n        matInput\n        placeholder=\"{{ 'LIBRARY.DIALOG.FORM.DESCRIPTION' | translate }}\"\n        rows=\"3\"\n        formControlName=\"description\"\n      ></textarea>\n\n      <mat-error *ngIf=\"form.controls['description'].hasError('maxlength')\">\n        {{ 'LIBRARY.ERRORS.DESCRIPTION_TOO_LONG' | translate }}\n      </mat-error>\n    </mat-form-field>\n\n    <mat-radio-group\n      [ngModelOptions]=\"{ standalone: true }\"\n      [(ngModel)]=\"visibilityOption\"\n      (change)=\"visibilityChangeHandler($event)\"\n    >\n      <mat-radio-button\n        color=\"primary\"\n        [disabled]=\"option.disabled\"\n        *ngFor=\"let option of visibilityOptions\"\n        [attr.data-automation-id]=\"option.value\"\n        [value]=\"option.value\"\n        [checked]=\"visibilityOption.value === option.value\"\n      >\n        {{ option.label | translate }}\n      </mat-radio-button>\n    </mat-radio-group>\n  </form>\n</mat-dialog-content>\n\n<mat-dialog-actions class=\"adf-action-buttons\">\n  <button mat-button mat-dialog-close data-automation-id=\"cancel-library-id\">\n    {{ 'LIBRARY.DIALOG.CANCEL' | translate }}\n  </button>\n\n  <button\n    color=\"primary\"\n    mat-button\n    (click)=\"submit()\"\n    [disabled]=\"!form.valid\"\n    data-automation-id=\"create-library-id\"\n  >\n    {{ 'LIBRARY.DIALOG.CREATE' | translate }}\n  </button>\n</mat-dialog-actions>\n",
                    encapsulation: ViewEncapsulation.None,
                    host: { class: 'adf-library-dialog' },
                    styles: [".adf-library-dialog .mat-radio-group{display:flex;flex-direction:column;margin:0 0 20px}.adf-library-dialog .mat-radio-group .mat-radio-button{margin:10px 0}.adf-library-dialog .mat-form-field{width:100%}.adf-library-dialog mat-form-field{padding-top:20px}.adf-library-dialog .adf-action-buttons{display:flex;flex-direction:row;justify-content:flex-end}.adf-library-dialog .adf-action-buttons .mat-button{text-transform:uppercase}"]
                }] }
    ];
    /** @nocollapse */
    LibraryDialogComponent.ctorParameters = function () { return [
        { type: AlfrescoApiService },
        { type: FormBuilder },
        { type: MatDialogRef }
    ]; };
    LibraryDialogComponent.propDecorators = {
        error: [{ type: Output }],
        success: [{ type: Output }]
    };
    return LibraryDialogComponent;
}());
export { LibraryDialogComponent };
if (false) {
    /**
     * Emitted when an error occurs.
     * @type {?}
     */
    LibraryDialogComponent.prototype.error;
    /**
     * Emitted when the new library is created successfully. The
     * event parameter is a SiteEntry object with the details of the
     * newly-created library.
     * @type {?}
     */
    LibraryDialogComponent.prototype.success;
    /** @type {?} */
    LibraryDialogComponent.prototype.onDestroy$;
    /** @type {?} */
    LibraryDialogComponent.prototype.createTitle;
    /** @type {?} */
    LibraryDialogComponent.prototype.libraryTitleExists;
    /** @type {?} */
    LibraryDialogComponent.prototype.form;
    /** @type {?} */
    LibraryDialogComponent.prototype.visibilityOption;
    /** @type {?} */
    LibraryDialogComponent.prototype.visibilityOptions;
    /**
     * @type {?}
     * @private
     */
    LibraryDialogComponent.prototype.alfrescoApiService;
    /**
     * @type {?}
     * @private
     */
    LibraryDialogComponent.prototype.formBuilder;
    /**
     * @type {?}
     * @private
     */
    LibraryDialogComponent.prototype.dialog;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlicmFyeS5kaWFsb2cuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJkaWFsb2dzL2xpYnJhcnkvbGlicmFyeS5kaWFsb2cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBYyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFDTCxTQUFTLEVBRVQsTUFBTSxFQUNOLFlBQVksRUFFWixpQkFBaUIsRUFDbEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNMLFdBQVcsRUFFWCxVQUFVLEVBR1gsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFakQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbkU7SUFtQ0UsZ0NBQ1Usa0JBQXNDLEVBQ3RDLFdBQXdCLEVBQ3hCLE1BQTRDO1FBRjVDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsV0FBTSxHQUFOLE1BQU0sQ0FBc0M7Ozs7UUE1QnRELFVBQUssR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQzs7Ozs7O1FBT25ELFlBQU8sR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUVyRCxlQUFVLEdBQXFCLElBQUksT0FBTyxFQUFXLENBQUM7UUFFdEQsZ0JBQVcsR0FBRyw2QkFBNkIsQ0FBQztRQUM1Qyx1QkFBa0IsR0FBRyxLQUFLLENBQUM7UUFHM0Isc0JBQWlCLEdBQUc7WUFDbEIsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSwyQkFBMkIsRUFBRSxRQUFR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Qyw2Q0FBZ0M7Ozs7O0lBQ2hDLHdDQUFvRCIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIGZyb20gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgT25EZXN0cm95LFxuICBWaWV3RW5jYXBzdWxhdGlvblxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEZvcm1CdWlsZGVyLFxuICBGb3JtR3JvdXAsXG4gIFZhbGlkYXRvcnMsXG4gIEZvcm1Db250cm9sLFxuICBBYnN0cmFjdENvbnRyb2xcbn0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgTWF0RGlhbG9nUmVmIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwnO1xuaW1wb3J0IHsgU2l0ZUJvZHlDcmVhdGUsIFNpdGVFbnRyeSwgU2l0ZVBhZ2luZyB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgbWVyZ2VNYXAsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYWRmLWxpYnJhcnktZGlhbG9nJyxcbiAgc3R5bGVVcmxzOiBbJy4vbGlicmFyeS5kaWFsb2cuc2NzcyddLFxuICB0ZW1wbGF0ZVVybDogJy4vbGlicmFyeS5kaWFsb2cuaHRtbCcsXG4gIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXG4gIGhvc3Q6IHsgY2xhc3M6ICdhZGYtbGlicmFyeS1kaWFsb2cnIH1cbn0pXG5leHBvcnQgY2xhc3MgTGlicmFyeURpYWxvZ0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgLyoqIEVtaXR0ZWQgd2hlbiBhbiBlcnJvciBvY2N1cnMuICovXG4gIEBPdXRwdXQoKVxuICBlcnJvcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAvKiogRW1pdHRlZCB3aGVuIHRoZSBuZXcgbGlicmFyeSBpcyBjcmVhdGVkIHN1Y2Nlc3NmdWxseS4gVGhlXG4gICAqIGV2ZW50IHBhcmFtZXRlciBpcyBhIFNpdGVFbnRyeSBvYmplY3Qgd2l0aCB0aGUgZGV0YWlscyBvZiB0aGVcbiAgICogbmV3bHktY3JlYXRlZCBsaWJyYXJ5LlxuICAgKi9cbiAgQE91dHB1dCgpXG4gIHN1Y2Nlc3M6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgb25EZXN0cm95JDogU3ViamVjdDxib29sZWFuPiA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG5cbiAgY3JlYXRlVGl0bGUgPSAnTElCUkFSWS5ESUFMT0cuQ1JFQVRFX1RJVExFJztcbiAgbGlicmFyeVRpdGxlRXhpc3RzID0gZmFsc2U7XG4gIGZvcm06IEZvcm1Hcm91cDtcbiAgdmlzaWJpbGl0eU9wdGlvbjogYW55O1xuICB2aXNpYmlsaXR5T3B0aW9ucyA9IFtcbiAgICB7IHZhbHVlOiAnUFVCTElDJywgbGFiZWw6ICdMSUJSQVJZLlZJU0lCSUxJVFkuUFVCTElDJywgZGlzYWJsZWQ6IGZhbHNlIH0sXG4gICAgeyB2YWx1ZTogJ1BSSVZBVEUnLCBsYWJlbDogJ0xJQlJBUlkuVklTSUJJTElUWS5QUklWQVRFJywgZGlzYWJsZWQ6IGZhbHNlIH0sXG4gICAge1xuICAgICAgdmFsdWU6ICdNT0RFUkFURUQnLFxuICAgICAgbGFiZWw6ICdMSUJSQVJZLlZJU0lCSUxJVFkuTU9ERVJBVEVEJyxcbiAgICAgIGRpc2FibGVkOiBmYWxzZVxuICAgIH1cbiAgXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFsZnJlc2NvQXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgIHByaXZhdGUgZm9ybUJ1aWxkZXI6IEZvcm1CdWlsZGVyLFxuICAgIHByaXZhdGUgZGlhbG9nOiBNYXREaWFsb2dSZWY8TGlicmFyeURpYWxvZ0NvbXBvbmVudD5cbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGNvbnN0IHZhbGlkYXRvcnMgPSB7XG4gICAgICBpZDogW1xuICAgICAgICBWYWxpZGF0b3JzLnJlcXVpcmVkLFxuICAgICAgICBWYWxpZGF0b3JzLm1heExlbmd0aCg3MiksXG4gICAgICAgIHRoaXMuZm9yYmlkU3BlY2lhbENoYXJhY3RlcnNcbiAgICAgIF0sXG4gICAgICB0aXRsZTogW1xuICAgICAgICBWYWxpZGF0b3JzLnJlcXVpcmVkLFxuICAgICAgICB0aGlzLmZvcmJpZE9ubHlTcGFjZXMsXG4gICAgICAgIFZhbGlkYXRvcnMubWluTGVuZ3RoKDIpLFxuICAgICAgICBWYWxpZGF0b3JzLm1heExlbmd0aCgyNTYpXG4gICAgICBdLFxuICAgICAgZGVzY3JpcHRpb246IFtWYWxpZGF0b3JzLm1heExlbmd0aCg1MTIpXVxuICAgIH07XG5cbiAgICB0aGlzLmZvcm0gPSB0aGlzLmZvcm1CdWlsZGVyLmdyb3VwKHtcbiAgICAgIHRpdGxlOiBbbnVsbCwgdmFsaWRhdG9ycy50aXRsZV0sXG4gICAgICBpZDogW251bGwsIHZhbGlkYXRvcnMuaWQsIHRoaXMuY3JlYXRlU2l0ZUlkVmFsaWRhdG9yKCldLFxuICAgICAgZGVzY3JpcHRpb246IFsnJywgdmFsaWRhdG9ycy5kZXNjcmlwdGlvbl1cbiAgICB9KTtcblxuICAgIHRoaXMudmlzaWJpbGl0eU9wdGlvbiA9IHRoaXMudmlzaWJpbGl0eU9wdGlvbnNbMF0udmFsdWU7XG5cbiAgICB0aGlzLmZvcm0uY29udHJvbHNbJ3RpdGxlJ10udmFsdWVDaGFuZ2VzXG4gICAgICAucGlwZShcbiAgICAgICAgZGVib3VuY2VUaW1lKDMwMCksXG4gICAgICAgIG1lcmdlTWFwKFxuICAgICAgICAgICAgKHRpdGxlKSA9PiB0aGlzLmNoZWNrTGlicmFyeU5hbWVFeGlzdHModGl0bGUpLFxuICAgICAgICAgICAgKHRpdGxlKSA9PiB0aXRsZVxuICAgICAgICApLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5vbkRlc3Ryb3kkKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgodGl0bGU6IHN0cmluZykgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuZm9ybS5jb250cm9sc1snaWQnXS5kaXJ0eSAmJiB0aGlzLmNhbkdlbmVyYXRlSWQodGl0bGUpKSB7XG4gICAgICAgICAgdGhpcy5mb3JtLnBhdGNoVmFsdWUoeyBpZDogdGhpcy5zYW5pdGl6ZSh0aXRsZS50cmltKCkpIH0pO1xuICAgICAgICAgIHRoaXMuZm9ybS5jb250cm9sc1snaWQnXS5tYXJrQXNUb3VjaGVkKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5vbkRlc3Ryb3kkLm5leHQodHJ1ZSk7XG4gICAgdGhpcy5vbkRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBnZXQgdGl0bGUoKTogc3RyaW5nIHtcbiAgICBjb25zdCB7IHRpdGxlIH0gPSB0aGlzLmZvcm0udmFsdWU7XG5cbiAgICByZXR1cm4gKHRpdGxlIHx8ICcnKS50cmltKCk7XG4gIH1cblxuICBnZXQgaWQoKTogc3RyaW5nIHtcbiAgICBjb25zdCB7IGlkIH0gPSB0aGlzLmZvcm0udmFsdWU7XG5cbiAgICByZXR1cm4gKGlkIHx8ICcnKS50cmltKCk7XG4gIH1cblxuICBnZXQgZGVzY3JpcHRpb24oKTogc3RyaW5nIHtcbiAgICBjb25zdCB7IGRlc2NyaXB0aW9uIH0gPSB0aGlzLmZvcm0udmFsdWU7XG5cbiAgICByZXR1cm4gKGRlc2NyaXB0aW9uIHx8ICcnKS50cmltKCk7XG4gIH1cblxuICBnZXQgdmlzaWJpbGl0eSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnZpc2liaWxpdHlPcHRpb24gfHwgJyc7XG4gIH1cblxuICBzdWJtaXQoKSB7XG4gICAgY29uc3QgeyBmb3JtLCBkaWFsb2cgfSA9IHRoaXM7XG5cbiAgICBpZiAoIWZvcm0udmFsaWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmNyZWF0ZSgpLnN1YnNjcmliZShcbiAgICAgIChub2RlOiBTaXRlRW50cnkpID0+IHtcbiAgICAgICAgdGhpcy5zdWNjZXNzLmVtaXQobm9kZSk7XG4gICAgICAgIGRpYWxvZy5jbG9zZShub2RlKTtcbiAgICAgIH0sXG4gICAgICAoZXJyb3IpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpXG4gICAgKTtcbiAgfVxuXG4gIHZpc2liaWxpdHlDaGFuZ2VIYW5kbGVyKGV2ZW50KSB7XG4gICAgdGhpcy52aXNpYmlsaXR5T3B0aW9uID0gZXZlbnQudmFsdWU7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZSgpOiBPYnNlcnZhYmxlPFNpdGVFbnRyeT4ge1xuICAgIGNvbnN0IHsgdGl0bGUsIGlkLCBkZXNjcmlwdGlvbiwgdmlzaWJpbGl0eSB9ID0gdGhpcztcbiAgICBjb25zdCBzaXRlQm9keSA9IDxTaXRlQm9keUNyZWF0ZT4ge1xuICAgICAgaWQsXG4gICAgICB0aXRsZSxcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgdmlzaWJpbGl0eVxuICAgIH07XG5cbiAgICByZXR1cm4gZnJvbSh0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5zaXRlc0FwaS5jcmVhdGVTaXRlKHNpdGVCb2R5KSk7XG4gIH1cblxuICBwcml2YXRlIHNhbml0aXplKGlucHV0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gaW5wdXQucmVwbGFjZSgvW1xcc1xcc10rL2csICctJykucmVwbGFjZSgvW15BLVphLXowLTktXS9nLCAnJyk7XG4gIH1cblxuICBwcml2YXRlIGNhbkdlbmVyYXRlSWQodGl0bGUpIHtcbiAgICByZXR1cm4gQm9vbGVhbih0aXRsZS5yZXBsYWNlKC9bXkEtWmEtejAtOS1dL2csICcnKS5sZW5ndGgpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVFcnJvcihlcnJvcjogYW55KTogYW55IHtcbiAgICBjb25zdCB7XG4gICAgICBlcnJvcjogeyBzdGF0dXNDb2RlIH1cbiAgICB9ID0gSlNPTi5wYXJzZShlcnJvci5tZXNzYWdlKTtcblxuICAgIGlmIChzdGF0dXNDb2RlID09PSA0MDkpIHtcbiAgICAgIHRoaXMuZm9ybS5jb250cm9sc1snaWQnXS5zZXRFcnJvcnMoe1xuICAgICAgICBtZXNzYWdlOiAnTElCUkFSWS5FUlJPUlMuQ09ORkxJQ1QnXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gZXJyb3I7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNoZWNrTGlicmFyeU5hbWVFeGlzdHMobGlicmFyeVRpdGxlOiBzdHJpbmcpIHtcbiAgICBsZXQgZW50cmllcyA9IFtdO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgZW50cmllcyA9IChhd2FpdCB0aGlzLmZpbmRMaWJyYXJ5QnlUaXRsZShsaWJyYXJ5VGl0bGUpKS5saXN0LmVudHJpZXM7XG4gICAgfSBjYXRjaCB7XG4gICAgICAgIGVudHJpZXMgPSBbXTtcbiAgICB9XG5cbiAgICBpZiAoZW50cmllcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMubGlicmFyeVRpdGxlRXhpc3RzID0gZW50cmllc1swXS5lbnRyeS50aXRsZS50b0xvd2VyQ2FzZSgpID09PSBsaWJyYXJ5VGl0bGUudG9Mb3dlckNhc2UoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5saWJyYXJ5VGl0bGVFeGlzdHMgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZpbmRMaWJyYXJ5QnlUaXRsZShsaWJyYXJ5VGl0bGU6IHN0cmluZyk6IFByb21pc2U8U2l0ZVBhZ2luZz4ge1xuICAgIHJldHVybiB0aGlzLmFsZnJlc2NvQXBpU2VydmljZVxuICAgICAgLmdldEluc3RhbmNlKClcbiAgICAgIC5jb3JlLnF1ZXJpZXNBcGkuZmluZFNpdGVzKGxpYnJhcnlUaXRsZSwge1xuICAgICAgICBtYXhJdGVtczogMSxcbiAgICAgICAgZmllbGRzOiBbJ3RpdGxlJ11cbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBmb3JiaWRTcGVjaWFsQ2hhcmFjdGVycyh7IHZhbHVlIH06IEZvcm1Db250cm9sKSB7XG4gICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgdmFsaWRDaGFyYWN0ZXJzOiBSZWdFeHAgPSAvW15BLVphLXowLTktXS87XG4gICAgY29uc3QgaXNWYWxpZDogYm9vbGVhbiA9ICF2YWxpZENoYXJhY3RlcnMudGVzdCh2YWx1ZSk7XG5cbiAgICByZXR1cm4gaXNWYWxpZFxuICAgICAgPyBudWxsXG4gICAgICA6IHtcbiAgICAgICAgICBtZXNzYWdlOiAnTElCUkFSWS5FUlJPUlMuSUxMRUdBTF9DSEFSQUNURVJTJ1xuICAgICAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBmb3JiaWRPbmx5U3BhY2VzKHsgdmFsdWUgfTogRm9ybUNvbnRyb2wpIHtcbiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBpc1ZhbGlkOiBib29sZWFuID0gISEodmFsdWUgfHwgJycpLnRyaW0oKTtcblxuICAgIHJldHVybiBpc1ZhbGlkXG4gICAgICA/IG51bGxcbiAgICAgIDoge1xuICAgICAgICAgIG1lc3NhZ2U6ICdMSUJSQVJZLkVSUk9SUy5PTkxZX1NQQUNFUydcbiAgICAgICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlU2l0ZUlkVmFsaWRhdG9yKCkge1xuICAgIGxldCB0aW1lcjtcblxuICAgIHJldHVybiAoY29udHJvbDogQWJzdHJhY3RDb250cm9sKSA9PiB7XG4gICAgICBpZiAodGltZXIpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgICB0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5zaXRlc0FwaS5nZXRTaXRlKGNvbnRyb2wudmFsdWUpXG4gICAgICAgICAgKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAoKSA9PiByZXNvbHZlKHsgbWVzc2FnZTogJ0xJQlJBUlkuRVJST1JTLkVYSVNURU5UX1NJVEUnIH0pLFxuICAgICAgICAgICAgKCkgPT4gcmVzb2x2ZShudWxsKVxuICAgICAgICAgICk7XG4gICAgICAgIH0sIDMwMCk7XG4gICAgICB9KTtcbiAgICB9O1xuICB9XG59XG4iXX0=