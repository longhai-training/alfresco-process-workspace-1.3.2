/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
import { of, from, throwError } from 'rxjs';
import { AlfrescoApiService, SearchService, NodesApiService, TranslationService } from '@alfresco/adf-core';
import { switchMap, map } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
var NodePermissionService = /** @class */ (function () {
    function NodePermissionService(apiService, searchApiService, nodeService, translation) {
        this.apiService = apiService;
        this.searchApiService = searchApiService;
        this.nodeService = nodeService;
        this.translation = translation;
    }
    /**
     * Gets a list of roles for the current node.
     * @param node The target node
     * @returns Array of strings representing the roles
     */
    /**
     * Gets a list of roles for the current node.
     * @param {?} node The target node
     * @return {?} Array of strings representing the roles
     */
    NodePermissionService.prototype.getNodeRoles = /**
     * Gets a list of roles for the current node.
     * @param {?} node The target node
     * @return {?} Array of strings representing the roles
     */
    function (node) {
        var _this = this;
        /** @type {?} */
        var retrieveSiteQueryBody = this.buildRetrieveSiteQueryBody(node.path.elements);
        return this.searchApiService.searchByQueryBody(retrieveSiteQueryBody)
            .pipe(switchMap((/**
         * @param {?} siteNodeList
         * @return {?}
         */
        function (siteNodeList) {
            if (siteNodeList.list.entries.length > 0) {
                /** @type {?} */
                var siteName = siteNodeList.list.entries[0].entry.name;
                return _this.getGroupMembersBySiteName(siteName);
            }
            else {
                return of(node.permissions.settable);
            }
        })));
    };
    /**
     * Updates the permission role for a node.
     * @param node Target node
     * @param updatedPermissionRole Permission role to update or add
     * @returns Node with updated permission
     */
    /**
     * Updates the permission role for a node.
     * @param {?} node Target node
     * @param {?} updatedPermissionRole Permission role to update or add
     * @return {?} Node with updated permission
     */
    NodePermissionService.prototype.updatePermissionRole = /**
     * Updates the permission role for a node.
     * @param {?} node Target node
     * @param {?} updatedPermissionRole Permission role to update or add
     * @return {?} Node with updated permission
     */
    function (node, updatedPermissionRole) {
        /** @type {?} */
        var permissionBody = { permissions: { locallySet: [] } };
        /** @type {?} */
        var index = node.permissions.locallySet.map((/**
         * @param {?} permission
         * @return {?}
         */
        function (permission) { return permission.authorityId; })).indexOf(updatedPermissionRole.authorityId);
        permissionBody.permissions.locallySet = permissionBody.permissions.locallySet.concat(node.permissions.locallySet);
        if (index !== -1) {
            permissionBody.permissions.locallySet[index] = updatedPermissionRole;
        }
        else {
            permissionBody.permissions.locallySet.push(updatedPermissionRole);
        }
        return this.nodeService.updateNode(node.id, permissionBody);
    };
    /**
     * Update permissions for a node.
     * @param nodeId ID of the target node
     * @param permissionList New permission settings
     * @returns Node with updated permissions
     */
    /**
     * Update permissions for a node.
     * @param {?} nodeId ID of the target node
     * @param {?} permissionList New permission settings
     * @return {?} Node with updated permissions
     */
    NodePermissionService.prototype.updateNodePermissions = /**
     * Update permissions for a node.
     * @param {?} nodeId ID of the target node
     * @param {?} permissionList New permission settings
     * @return {?} Node with updated permissions
     */
    function (nodeId, permissionList) {
        var _this = this;
        return this.nodeService.getNode(nodeId).pipe(switchMap((/**
         * @param {?} node
         * @return {?}
         */
        function (node) {
            return _this.getNodeRoles(node).pipe(switchMap((/**
             * @param {?} nodeRoles
             * @return {?}
             */
            function (nodeRoles) { return of({ node: node, nodeRoles: nodeRoles }); })));
        })), switchMap((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var node = _a.node, nodeRoles = _a.nodeRoles;
            return _this.updateLocallySetPermissions(node, permissionList, nodeRoles);
        })));
    };
    /**
     * Updates the locally set permissions for a node.
     * @param node ID of the target node
     * @param nodes Permission settings
     * @param nodeRole Permission role
     * @returns Node with updated permissions
     */
    /**
     * Updates the locally set permissions for a node.
     * @param {?} node ID of the target node
     * @param {?} nodes Permission settings
     * @param {?} nodeRole Permission role
     * @return {?} Node with updated permissions
     */
    NodePermissionService.prototype.updateLocallySetPermissions = /**
     * Updates the locally set permissions for a node.
     * @param {?} node ID of the target node
     * @param {?} nodes Permission settings
     * @param {?} nodeRole Permission role
     * @return {?} Node with updated permissions
     */
    function (node, nodes, nodeRole) {
        /** @type {?} */
        var permissionBody = { permissions: { locallySet: [] } };
        /** @type {?} */
        var permissionList = this.transformNodeToPermissionElement(nodes, nodeRole[0]);
        /** @type {?} */
        var duplicatedPermissions = this.getDuplicatedPermissions(node.permissions.locallySet, permissionList);
        if (duplicatedPermissions.length > 0) {
            /** @type {?} */
            var list = duplicatedPermissions.map((/**
             * @param {?} permission
             * @return {?}
             */
            function (permission) { return 'authority -> ' + permission.authorityId + ' / role -> ' + permission.name; })).join(', ');
            /** @type {?} */
            var duplicatePermissionMessage = this.translation.instant('PERMISSION_MANAGER.ERROR.DUPLICATE-PERMISSION', { list: list });
            return throwError(duplicatePermissionMessage);
        }
        permissionBody.permissions.locallySet = node.permissions.locallySet ? node.permissions.locallySet.concat(permissionList) : permissionList;
        return this.nodeService.updateNode(node.id, permissionBody);
    };
    /**
     * @private
     * @param {?} nodeLocallySet
     * @param {?} permissionListAdded
     * @return {?}
     */
    NodePermissionService.prototype.getDuplicatedPermissions = /**
     * @private
     * @param {?} nodeLocallySet
     * @param {?} permissionListAdded
     * @return {?}
     */
    function (nodeLocallySet, permissionListAdded) {
        var _this = this;
        /** @type {?} */
        var duplicatePermissions = [];
        if (nodeLocallySet) {
            permissionListAdded.forEach((/**
             * @param {?} permission
             * @return {?}
             */
            function (permission) {
                /** @type {?} */
                var duplicate = nodeLocallySet.find((/**
                 * @param {?} localPermission
                 * @return {?}
                 */
                function (localPermission) { return _this.isEqualPermission(localPermission, permission); }));
                if (duplicate) {
                    duplicatePermissions.push(duplicate);
                }
            }));
        }
        return duplicatePermissions;
    };
    /**
     * @private
     * @param {?} oldPermission
     * @param {?} newPermission
     * @return {?}
     */
    NodePermissionService.prototype.isEqualPermission = /**
     * @private
     * @param {?} oldPermission
     * @param {?} newPermission
     * @return {?}
     */
    function (oldPermission, newPermission) {
        return oldPermission.accessStatus === newPermission.accessStatus &&
            oldPermission.authorityId === newPermission.authorityId &&
            oldPermission.name === newPermission.name;
    };
    /**
     * @private
     * @param {?} nodes
     * @param {?} nodeRole
     * @return {?}
     */
    NodePermissionService.prototype.transformNodeToPermissionElement = /**
     * @private
     * @param {?} nodes
     * @param {?} nodeRole
     * @return {?}
     */
    function (nodes, nodeRole) {
        return nodes.map((/**
         * @param {?} node
         * @return {?}
         */
        function (node) {
            /** @type {?} */
            var newPermissionElement = (/** @type {?} */ ({
                'authorityId': node.entry.properties['cm:authorityName'] ?
                    node.entry.properties['cm:authorityName'] :
                    node.entry.properties['cm:userName'],
                'name': nodeRole,
                'accessStatus': 'ALLOWED'
            }));
            return newPermissionElement;
        }));
    };
    /**
     * Removes a permission setting from a node.
     * @param node ID of the target node
     * @param permissionToRemove Permission setting to remove
     * @returns Node with modified permissions
     */
    /**
     * Removes a permission setting from a node.
     * @param {?} node ID of the target node
     * @param {?} permissionToRemove Permission setting to remove
     * @return {?} Node with modified permissions
     */
    NodePermissionService.prototype.removePermission = /**
     * Removes a permission setting from a node.
     * @param {?} node ID of the target node
     * @param {?} permissionToRemove Permission setting to remove
     * @return {?} Node with modified permissions
     */
    function (node, permissionToRemove) {
        /** @type {?} */
        var permissionBody = { permissions: { locallySet: [] } };
        /** @type {?} */
        var index = node.permissions.locallySet.map((/**
         * @param {?} permission
         * @return {?}
         */
        function (permission) { return permission.authorityId; })).indexOf(permissionToRemove.authorityId);
        if (index !== -1) {
            node.permissions.locallySet.splice(index, 1);
            permissionBody.permissions.locallySet = node.permissions.locallySet;
            return this.nodeService.updateNode(node.id, permissionBody);
        }
    };
    /**
     * @private
     * @param {?} siteName
     * @return {?}
     */
    NodePermissionService.prototype.getGroupMembersBySiteName = /**
     * @private
     * @param {?} siteName
     * @return {?}
     */
    function (siteName) {
        var _this = this;
        /** @type {?} */
        var groupName = 'GROUP_site_' + siteName;
        return this.getGroupMemberByGroupName(groupName)
            .pipe(map((/**
         * @param {?} groupMemberPaging
         * @return {?}
         */
        function (groupMemberPaging) {
            /** @type {?} */
            var displayResult = [];
            groupMemberPaging.list.entries.forEach((/**
             * @param {?} member
             * @return {?}
             */
            function (member) {
                displayResult.push(_this.formattedRoleName(member.entry.displayName, 'site_' + siteName));
            }));
            return displayResult;
        })));
    };
    /**
     * Gets all members related to a group name.
     * @param groupName Name of group to look for members
     * @param opts Extra options supported by JS-API
     * @returns List of members
     */
    /**
     * Gets all members related to a group name.
     * @param {?} groupName Name of group to look for members
     * @param {?=} opts Extra options supported by JS-API
     * @return {?} List of members
     */
    NodePermissionService.prototype.getGroupMemberByGroupName = /**
     * Gets all members related to a group name.
     * @param {?} groupName Name of group to look for members
     * @param {?=} opts Extra options supported by JS-API
     * @return {?} List of members
     */
    function (groupName, opts) {
        return from(this.apiService.groupsApi.getGroupMembers(groupName, opts));
    };
    /**
     * @private
     * @param {?} displayName
     * @param {?} siteName
     * @return {?}
     */
    NodePermissionService.prototype.formattedRoleName = /**
     * @private
     * @param {?} displayName
     * @param {?} siteName
     * @return {?}
     */
    function (displayName, siteName) {
        return displayName.replace(siteName + '_', '');
    };
    /**
     * @private
     * @param {?} nodePath
     * @return {?}
     */
    NodePermissionService.prototype.buildRetrieveSiteQueryBody = /**
     * @private
     * @param {?} nodePath
     * @return {?}
     */
    function (nodePath) {
        /** @type {?} */
        var pathNames = nodePath.map((/**
         * @param {?} node
         * @return {?}
         */
        function (node) { return 'name: "' + node.name + '"'; }));
        /** @type {?} */
        var buildedPathNames = pathNames.join(' OR ');
        return {
            'query': {
                'query': buildedPathNames
            },
            'paging': {
                'maxItems': 100,
                'skipCount': 0
            },
            'include': ['aspectNames', 'properties'],
            'filterQueries': [
                {
                    'query': "TYPE:'st:site'"
                }
            ]
        };
    };
    NodePermissionService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    NodePermissionService.ctorParameters = function () { return [
        { type: AlfrescoApiService },
        { type: SearchService },
        { type: NodesApiService },
        { type: TranslationService }
    ]; };
    /** @nocollapse */ NodePermissionService.ngInjectableDef = i0.defineInjectable({ factory: function NodePermissionService_Factory() { return new NodePermissionService(i0.inject(i1.AlfrescoApiService), i0.inject(i1.SearchService), i0.inject(i1.NodesApiService), i0.inject(i1.TranslationService)); }, token: NodePermissionService, providedIn: "root" });
    return NodePermissionService;
}());
export { NodePermissionService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    NodePermissionService.prototype.apiService;
    /**
     * @type {?}
     * @private
     */
    NodePermissionService.prototype.searchApiService;
    /**
     * @type {?}
     * @private
     */
    NodePermissionService.prototype.nodeService;
    /**
     * @type {?}
     * @private
     */
    NodePermissionService.prototype.translation;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1wZXJtaXNzaW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJwZXJtaXNzaW9uLW1hbmFnZXIvc2VydmljZXMvbm9kZS1wZXJtaXNzaW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUU1RyxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7QUFFaEQ7SUFLSSwrQkFBb0IsVUFBOEIsRUFDOUIsZ0JBQStCLEVBQy9CLFdBQTRCLEVBQzVCLFdBQStCO1FBSC9CLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzlCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBZTtRQUMvQixnQkFBVyxHQUFYLFdBQVcsQ0FBaUI7UUFDNUIsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO0lBQ25ELENBQUM7SUFFRDs7OztPQUlHOzs7Ozs7SUFDSCw0Q0FBWTs7Ozs7SUFBWixVQUFhLElBQVU7UUFBdkIsaUJBYUM7O1lBWlMscUJBQXFCLEdBQWMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQzVGLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDLHFCQUFxQixDQUFDO2FBQ2hFLElBQUksQ0FDRCxTQUFTOzs7O1FBQUMsVUFBQyxZQUFpQjtZQUN4QixJQUFLLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFD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Q0FBQyxRQUFRLEdBQUcsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ25ELENBQUM7Ozs7OztJQUVPLDBEQUEwQjs7Ozs7SUFBbEMsVUFBbUMsUUFBdUI7O1lBQ2hELFNBQVMsR0FBRyxRQUFRLENBQUMsR0FBRzs7OztRQUFDLFVBQUMsSUFBaUIsSUFBSyxPQUFBLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsRUFBM0IsQ0FBMkIsRUFBQzs7WUFDNUUsZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDL0MsT0FBTztZQUNILE9BQU8sRUFBRTtnQkFDTCxPQUFPLEVBQUUsZ0JBQWdCO2FBQzVCO1lBQ0QsUUFBUSxFQUFFO2dCQUNOLFVBQVUsRUFBRSxHQUFHO2dCQUNmLFdBQVcsRUFBRSxDQUFDO2FBQ2pCO1lBQ0QsU0FBUyxFQUFFLENBQUMsYUFBYSxFQUFFLFlBQVksQ0FBQztZQUN4QyxlQUFlLEVBQUU7Z0JBQ2I7b0JBQ0ksT0FBTyxFQUNILGdCQUFnQjtpQkFDdkI7YUFDSjtTQUNKLENBQUM7SUFDTixDQUFDOztnQkFyTEosVUFBVSxTQUFDO29CQUNSLFVBQVUsRUFBRSxNQUFNO2lCQUNyQjs7OztnQkFOUSxrQkFBa0I7Z0JBQUUsYUFBYTtnQkFBRSxlQUFlO2dCQUFFLGtCQUFrQjs7O2dDQW5CL0U7Q0E4TUMsQUF2TEQsSUF1TEM7U0FwTFkscUJBQXFCOzs7Ozs7SUFFbEIsMkNBQXNDOzs7OztJQUN0QyxpREFBdUM7Ozs7O0lBQ3ZDLDRDQUFvQzs7Ozs7SUFDcEMsNENBQXVDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIGZyb20sIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgU2VhcmNoU2VydmljZSwgTm9kZXNBcGlTZXJ2aWNlLCBUcmFuc2xhdGlvblNlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgUXVlcnlCb2R5LCBOb2RlLCBOb2RlRW50cnksIFBhdGhFbGVtZW50LCBHcm91cE1lbWJlckVudHJ5LCBHcm91cE1lbWJlclBhZ2luZywgUGVybWlzc2lvbkVsZW1lbnQgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IHN3aXRjaE1hcCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIE5vZGVQZXJtaXNzaW9uU2VydmljZSB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHNlYXJjaEFwaVNlcnZpY2U6IFNlYXJjaFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBub2RlU2VydmljZTogTm9kZXNBcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdHJhbnNsYXRpb246IFRyYW5zbGF0aW9uU2VydmljZSkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBsaXN0IG9mIHJvbGVzIGZvciB0aGUgY3VycmVudCBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIFRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIHN0cmluZ3MgcmVwcmVzZW50aW5nIHRoZSByb2xlc1xuICAgICAqL1xuICAgIGdldE5vZGVSb2xlcyhub2RlOiBOb2RlKTogT2JzZXJ2YWJsZTxzdHJpbmdbXT4ge1xuICAgICAgICBjb25zdCByZXRyaWV2ZVNpdGVRdWVyeUJvZHk6IFF1ZXJ5Qm9keSA9IHRoaXMuYnVpbGRSZXRyaWV2ZVNpdGVRdWVyeUJvZHkobm9kZS5wYXRoLmVsZW1lbnRzKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VhcmNoQXBpU2VydmljZS5zZWFyY2hCeVF1ZXJ5Qm9keShyZXRyaWV2ZVNpdGVRdWVyeUJvZHkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKHNpdGVOb2RlTGlzdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICggc2l0ZU5vZGVMaXN0Lmxpc3QuZW50cmllcy5sZW5ndGggPiAwICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2l0ZU5hbWUgPSBzaXRlTm9kZUxpc3QubGlzdC5lbnRyaWVzWzBdLmVudHJ5Lm5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRHcm91cE1lbWJlcnNCeVNpdGVOYW1lKHNpdGVOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihub2RlLnBlcm1pc3Npb25zLnNldHRhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZXMgdGhlIHBlcm1pc3Npb24gcm9sZSBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIFRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIHVwZGF0ZWRQZXJtaXNzaW9uUm9sZSBQZXJtaXNzaW9uIHJvbGUgdG8gdXBkYXRlIG9yIGFkZFxuICAgICAqIEByZXR1cm5zIE5vZGUgd2l0aCB1cGRhdGVkIHBlcm1pc3Npb25cbiAgICAgKi9cbiAgICB1cGRhdGVQZXJtaXNzaW9uUm9sZShub2RlOiBOb2RlLCB1cGRhdGVkUGVybWlzc2lvblJvbGU6IFBlcm1pc3Npb25FbGVtZW50KTogT2JzZXJ2YWJsZTxOb2RlPiB7XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25Cb2R5ID0geyBwZXJtaXNzaW9uczogeyBsb2NhbGx5U2V0OiBbXX0gfTtcbiAgICAgICAgY29uc3QgaW5kZXggPSBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQubWFwKChwZXJtaXNzaW9uKSA9PiBwZXJtaXNzaW9uLmF1dGhvcml0eUlkKS5pbmRleE9mKHVwZGF0ZWRQZXJtaXNzaW9uUm9sZS5hdXRob3JpdHlJZCk7XG4gICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPSBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LmNvbmNhdChub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQpO1xuICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0W2luZGV4XSA9IHVwZGF0ZWRQZXJtaXNzaW9uUm9sZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQucHVzaCh1cGRhdGVkUGVybWlzc2lvblJvbGUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm5vZGVTZXJ2aWNlLnVwZGF0ZU5vZGUobm9kZS5pZCwgcGVybWlzc2lvbkJvZHkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBwZXJtaXNzaW9ucyBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlSWQgSUQgb2YgdGhlIHRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIHBlcm1pc3Npb25MaXN0IE5ldyBwZXJtaXNzaW9uIHNldHRpbmdzXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIHVwZGF0ZWQgcGVybWlzc2lvbnNcbiAgICAgKi9cbiAgICB1cGRhdGVOb2RlUGVybWlzc2lvbnMobm9kZUlkOiBzdHJpbmcsIHBlcm1pc3Npb25MaXN0OiBOb2RlRW50cnlbXSk6IE9ic2VydmFibGU8Tm9kZT4ge1xuICAgICAgIHJldHVybiB0aGlzLm5vZGVTZXJ2aWNlLmdldE5vZGUobm9kZUlkKS5waXBlKFxuICAgICAgICAgICBzd2l0Y2hNYXAoKG5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXROb2RlUm9sZXMobm9kZSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKChub2RlUm9sZXMpID0+IG9mKHtub2RlLCBub2RlUm9sZXN9KSApXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgc3dpdGNoTWFwKCh7bm9kZSwgbm9kZVJvbGVzfSkgPT4gdGhpcy51cGRhdGVMb2NhbGx5U2V0UGVybWlzc2lvbnMobm9kZSwgcGVybWlzc2lvbkxpc3QsIG5vZGVSb2xlcykpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyB0aGUgbG9jYWxseSBzZXQgcGVybWlzc2lvbnMgZm9yIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBJRCBvZiB0aGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcGFyYW0gbm9kZXMgUGVybWlzc2lvbiBzZXR0aW5nc1xuICAgICAqIEBwYXJhbSBub2RlUm9sZSBQZXJtaXNzaW9uIHJvbGVcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggdXBkYXRlZCBwZXJtaXNzaW9uc1xuICAgICAqL1xuICAgIHVwZGF0ZUxvY2FsbHlTZXRQZXJtaXNzaW9ucyhub2RlOiBOb2RlLCBub2RlczogTm9kZUVudHJ5W10sIG5vZGVSb2xlOiBzdHJpbmdbXSk6IE9ic2VydmFibGU8Tm9kZT4ge1xuICAgICAgICBjb25zdCBwZXJtaXNzaW9uQm9keSA9IHsgcGVybWlzc2lvbnM6IHsgbG9jYWxseVNldDogW119IH07XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25MaXN0ID0gdGhpcy50cmFuc2Zvcm1Ob2RlVG9QZXJtaXNzaW9uRWxlbWVudChub2Rlcywgbm9kZVJvbGVbMF0pO1xuICAgICAgICBjb25zdCBkdXBsaWNhdGVkUGVybWlzc2lvbnMgPSB0aGlzLmdldER1cGxpY2F0ZWRQZXJtaXNzaW9ucyhub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQsIHBlcm1pc3Npb25MaXN0KTtcbiAgICAgICAgaWYgKGR1cGxpY2F0ZWRQZXJtaXNzaW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBsaXN0ID0gZHVwbGljYXRlZFBlcm1pc3Npb25zLm1hcCgocGVybWlzc2lvbikgPT4gJ2F1dGhvcml0eSAtPiAnICsgcGVybWlzc2lvbi5hdXRob3JpdHlJZCArICcgLyByb2xlIC0+ICcgKyBwZXJtaXNzaW9uLm5hbWUpLmpvaW4oJywgJyk7XG4gICAgICAgICAgICBjb25zdCBkdXBsaWNhdGVQZXJtaXNzaW9uTWVzc2FnZTogc3RyaW5nID0gdGhpcy50cmFuc2xhdGlvbi5pbnN0YW50KCdQRVJNSVNTSU9OX01BTkFHRVIuRVJST1IuRFVQTElDQVRFLVBFUk1JU1NJT04nLCAge2xpc3R9KTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGR1cGxpY2F0ZVBlcm1pc3Npb25NZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0ID0gbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0ID8gbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LmNvbmNhdChwZXJtaXNzaW9uTGlzdCkgOiBwZXJtaXNzaW9uTGlzdDtcbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UudXBkYXRlTm9kZShub2RlLmlkLCBwZXJtaXNzaW9uQm9keSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXREdXBsaWNhdGVkUGVybWlzc2lvbnMobm9kZUxvY2FsbHlTZXQ6IFBlcm1pc3Npb25FbGVtZW50W10sIHBlcm1pc3Npb25MaXN0QWRkZWQ6IFBlcm1pc3Npb25FbGVtZW50W10pOiBQZXJtaXNzaW9uRWxlbWVudFtdIHtcbiAgICAgICAgY29uc3QgZHVwbGljYXRlUGVybWlzc2lvbnM6IFBlcm1pc3Npb25FbGVtZW50W10gPSBbXTtcbiAgICAgICAgaWYgKG5vZGVMb2NhbGx5U2V0KSB7XG4gICAgICAgICAgICBwZXJtaXNzaW9uTGlzdEFkZGVkLmZvckVhY2goKHBlcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZHVwbGljYXRlID0gbm9kZUxvY2FsbHlTZXQuZmluZCgobG9jYWxQZXJtaXNzaW9uKSA9PiB0aGlzLmlzRXF1YWxQZXJtaXNzaW9uKGxvY2FsUGVybWlzc2lvbiwgcGVybWlzc2lvbikpO1xuICAgICAgICAgICAgICAgIGlmIChkdXBsaWNhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZHVwbGljYXRlUGVybWlzc2lvbnMucHVzaChkdXBsaWNhdGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkdXBsaWNhdGVQZXJtaXNzaW9ucztcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzRXF1YWxQZXJtaXNzaW9uKG9sZFBlcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50LCBuZXdQZXJtaXNzaW9uOiBQZXJtaXNzaW9uRWxlbWVudCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gb2xkUGVybWlzc2lvbi5hY2Nlc3NTdGF0dXMgPT09IG5ld1Blcm1pc3Npb24uYWNjZXNzU3RhdHVzICYmXG4gICAgICAgICAgICAgICBvbGRQZXJtaXNzaW9uLmF1dGhvcml0eUlkID09PSBuZXdQZXJtaXNzaW9uLmF1dGhvcml0eUlkICYmXG4gICAgICAgICAgICAgICBvbGRQZXJtaXNzaW9uLm5hbWUgPT09IG5ld1Blcm1pc3Npb24ubmFtZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybU5vZGVUb1Blcm1pc3Npb25FbGVtZW50KG5vZGVzOiBOb2RlRW50cnlbXSwgbm9kZVJvbGU6IGFueSk6IFBlcm1pc3Npb25FbGVtZW50W10ge1xuICAgICAgICByZXR1cm4gbm9kZXMubWFwKChub2RlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBuZXdQZXJtaXNzaW9uRWxlbWVudDogUGVybWlzc2lvbkVsZW1lbnQgPSA8UGVybWlzc2lvbkVsZW1lbnQ+IHtcbiAgICAgICAgICAgICAgICAnYXV0aG9yaXR5SWQnOiBub2RlLmVudHJ5LnByb3BlcnRpZXNbJ2NtOmF1dGhvcml0eU5hbWUnXSA/XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuZW50cnkucHJvcGVydGllc1snY206YXV0aG9yaXR5TmFtZSddIDpcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5lbnRyeS5wcm9wZXJ0aWVzWydjbTp1c2VyTmFtZSddLFxuICAgICAgICAgICAgICAgICduYW1lJzogbm9kZVJvbGUsXG4gICAgICAgICAgICAgICAgJ2FjY2Vzc1N0YXR1cyc6ICdBTExPV0VEJ1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJldHVybiBuZXdQZXJtaXNzaW9uRWxlbWVudDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlcyBhIHBlcm1pc3Npb24gc2V0dGluZyBmcm9tIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBJRCBvZiB0aGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcGFyYW0gcGVybWlzc2lvblRvUmVtb3ZlIFBlcm1pc3Npb24gc2V0dGluZyB0byByZW1vdmVcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggbW9kaWZpZWQgcGVybWlzc2lvbnNcbiAgICAgKi9cbiAgICByZW1vdmVQZXJtaXNzaW9uKG5vZGU6IE5vZGUsIHBlcm1pc3Npb25Ub1JlbW92ZTogUGVybWlzc2lvbkVsZW1lbnQpOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkJvZHkgPSB7IHBlcm1pc3Npb25zOiB7IGxvY2FsbHlTZXQ6IFtdIH0gfTtcbiAgICAgICAgY29uc3QgaW5kZXggPSBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQubWFwKChwZXJtaXNzaW9uKSA9PiBwZXJtaXNzaW9uLmF1dGhvcml0eUlkKS5pbmRleE9mKHBlcm1pc3Npb25Ub1JlbW92ZS5hdXRob3JpdHlJZCk7XG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldDtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm5vZGVTZXJ2aWNlLnVwZGF0ZU5vZGUobm9kZS5pZCwgcGVybWlzc2lvbkJvZHkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRHcm91cE1lbWJlcnNCeVNpdGVOYW1lKHNpdGVOYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZ1tdPiB7XG4gICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9ICdHUk9VUF9zaXRlXycgKyBzaXRlTmFtZTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0R3JvdXBNZW1iZXJCeUdyb3VwTmFtZShncm91cE5hbWUpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKGdyb3VwTWVtYmVyUGFnaW5nOiBHcm91cE1lbWJlclBhZ2luZykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXNwbGF5UmVzdWx0OiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBncm91cE1lbWJlclBhZ2luZy5saXN0LmVudHJpZXMuZm9yRWFjaCgobWVtYmVyOiBHcm91cE1lbWJlckVudHJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5UmVzdWx0LnB1c2godGhpcy5mb3JtYXR0ZWRSb2xlTmFtZShtZW1iZXIuZW50cnkuZGlzcGxheU5hbWUsICdzaXRlXycgKyBzaXRlTmFtZSkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlSZXN1bHQ7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgbWVtYmVycyByZWxhdGVkIHRvIGEgZ3JvdXAgbmFtZS5cbiAgICAgKiBAcGFyYW0gZ3JvdXBOYW1lIE5hbWUgb2YgZ3JvdXAgdG8gbG9vayBmb3IgbWVtYmVyc1xuICAgICAqIEBwYXJhbSBvcHRzIEV4dHJhIG9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgbWVtYmVyc1xuICAgICAqL1xuICAgIGdldEdyb3VwTWVtYmVyQnlHcm91cE5hbWUoZ3JvdXBOYW1lOiBzdHJpbmcsIG9wdHM/OiBhbnkpOiBPYnNlcnZhYmxlPEdyb3VwTWVtYmVyUGFnaW5nPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuYXBpU2VydmljZS5ncm91cHNBcGkuZ2V0R3JvdXBNZW1iZXJzKGdyb3VwTmFtZSwgb3B0cykpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9ybWF0dGVkUm9sZU5hbWUoZGlzcGxheU5hbWUsIHNpdGVOYW1lKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lLnJlcGxhY2Uoc2l0ZU5hbWUgKyAnXycsICcnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkUmV0cmlldmVTaXRlUXVlcnlCb2R5KG5vZGVQYXRoOiBQYXRoRWxlbWVudFtdKTogUXVlcnlCb2R5IHtcbiAgICAgICAgY29uc3QgcGF0aE5hbWVzID0gbm9kZVBhdGgubWFwKChub2RlOiBQYXRoRWxlbWVudCkgPT4gJ25hbWU6IFwiJyArIG5vZGUubmFtZSArICdcIicpO1xuICAgICAgICBjb25zdCBidWlsZGVkUGF0aE5hbWVzID0gcGF0aE5hbWVzLmpvaW4oJyBPUiAnKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdxdWVyeSc6IHtcbiAgICAgICAgICAgICAgICAncXVlcnknOiBidWlsZGVkUGF0aE5hbWVzXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ3BhZ2luZyc6IHtcbiAgICAgICAgICAgICAgICAnbWF4SXRlbXMnOiAxMDAsXG4gICAgICAgICAgICAgICAgJ3NraXBDb3VudCc6IDBcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnaW5jbHVkZSc6IFsnYXNwZWN0TmFtZXMnLCAncHJvcGVydGllcyddLFxuICAgICAgICAgICAgJ2ZpbHRlclF1ZXJpZXMnOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAncXVlcnknOlxuICAgICAgICAgICAgICAgICAgICAgICAgXCJUWVBFOidzdDpzaXRlJ1wiXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXVxuICAgICAgICB9O1xuICAgIH1cblxufVxuIl19